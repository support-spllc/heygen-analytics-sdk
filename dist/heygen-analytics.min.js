var jt=Object.defineProperty;var Rt=Re=>{throw TypeError(Re)};var $t=(Re,Pe,Ie)=>Pe in Re?jt(Re,Pe,{enumerable:!0,configurable:!0,writable:!0,value:Ie}):Re[Pe]=Ie;var Ne=(Re,Pe,Ie)=>$t(Re,typeof Pe!="symbol"?Pe+"":Pe,Ie),Pt=(Re,Pe,Ie)=>Pe.has(Re)||Rt("Cannot "+Ie);var Te=(Re,Pe,Ie)=>(Pt(Re,Pe,"read from private field"),Ie?Ie.call(Re):Pe.get(Re)),xe=(Re,Pe,Ie)=>Pe.has(Re)?Rt("Cannot add the same private member more than once"):Pe instanceof WeakSet?Pe.add(Re):Pe.set(Re,Ie),Me=(Re,Pe,Ie,Ge)=>(Pt(Re,Pe,"write to private field"),Ge?Ge.call(Re,Ie):Pe.set(Re,Ie),Ie);(function(){"use strict";var Pe,Ie,Ge,Ze,et,tt,it,nt,rt,st,ot,at,Qe,ct,ut,dt,lt,ht,ft,Je,ze,He,Ke;function _mergeNamespaces$1(B,F){return F.forEach(function(U){U&&typeof U!="string"&&!Array.isArray(U)&&Object.keys(U).forEach(function(q){if(q!=="default"&&!(q in B)){var V=Object.getOwnPropertyDescriptor(U,q);Object.defineProperty(B,q,V.get?V:{enumerable:!0,get:function(){return U[q]}})}})}),Object.freeze(B)}var e$1=Object.defineProperty,h$1=(B,F,U)=>F in B?e$1(B,F,{enumerable:!0,configurable:!0,writable:!0,value:U}):B[F]=U,o$1=(B,F,U)=>h$1(B,typeof F!="symbol"?F+"":F,U);let _$1=class{constructor(){o$1(this,"_locking"),o$1(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let F;const U=new Promise(V=>F=()=>{this._locks-=1,V()}),q=this._locking.then(()=>F);return this._locking=this._locking.then(()=>U),q}};function assert(B,F){if(!B)throw new Error(F)}const FLOAT32_MAX=34028234663852886e22,FLOAT32_MIN=-34028234663852886e22,UINT32_MAX=4294967295,INT32_MAX=2147483647,INT32_MIN=-2147483648;function assertInt32(B){if(typeof B!="number")throw new Error("invalid int 32: "+typeof B);if(!Number.isInteger(B)||B>INT32_MAX||B<INT32_MIN)throw new Error("invalid int 32: "+B)}function assertUInt32(B){if(typeof B!="number")throw new Error("invalid uint 32: "+typeof B);if(!Number.isInteger(B)||B>UINT32_MAX||B<0)throw new Error("invalid uint 32: "+B)}function assertFloat32(B){if(typeof B!="number")throw new Error("invalid float 32: "+typeof B);if(Number.isFinite(B)&&(B>FLOAT32_MAX||B<FLOAT32_MIN))throw new Error("invalid float 32: "+B)}const enumTypeSymbol=Symbol("@bufbuild/protobuf/enum-type");function getEnumType(B){const F=B[enumTypeSymbol];return assert(F,"missing enum type on enum object"),F}function setEnumType(B,F,U,q){B[enumTypeSymbol]=makeEnumType(F,U.map(V=>({no:V.no,name:V.name,localName:B[V.no]})))}function makeEnumType(B,F,U){const q=Object.create(null),V=Object.create(null),j=[];for(const $ of F){const W=normalizeEnumValue($);j.push(W),q[$.name]=W,V[$.no]=W}return{typeName:B,values:j,findName($){return q[$]},findNumber($){return V[$]}}}function makeEnum(B,F,U){const q={};for(const V of F){const j=normalizeEnumValue(V);q[j.localName]=j.no,q[j.no]=j.localName}return setEnumType(q,B,F),q}function normalizeEnumValue(B){return"localName"in B?B:Object.assign(Object.assign({},B),{localName:B.name})}class Message{equals(F){return this.getType().runtime.util.equals(this.getType(),this,F)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(F,U){const q=this.getType(),V=q.runtime.bin,j=V.makeReadOptions(U);return V.readMessage(this,j.readerFactory(F),F.byteLength,j),this}fromJson(F,U){const q=this.getType(),V=q.runtime.json,j=V.makeReadOptions(U);return V.readMessage(q,F,j,this),this}fromJsonString(F,U){let q;try{q=JSON.parse(F)}catch(V){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(V instanceof Error?V.message:String(V)))}return this.fromJson(q,U)}toBinary(F){const U=this.getType(),q=U.runtime.bin,V=q.makeWriteOptions(F),j=V.writerFactory();return q.writeMessage(this,j,V),j.finish()}toJson(F){const U=this.getType(),q=U.runtime.json,V=q.makeWriteOptions(F);return q.writeMessage(this,V)}toJsonString(F){var U;const q=this.toJson(F);return JSON.stringify(q,null,(U=F==null?void 0:F.prettySpaces)!==null&&U!==void 0?U:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function makeMessageType(B,F,U,q){var V;const j=(V=q==null?void 0:q.localName)!==null&&V!==void 0?V:F.substring(F.lastIndexOf(".")+1),$={[j]:function(W){B.util.initFields(this),B.util.initPartial(W,this)}}[j];return Object.setPrototypeOf($.prototype,new Message),Object.assign($,{runtime:B,typeName:F,fields:B.util.newFieldList(U),fromBinary(W,K){return new $().fromBinary(W,K)},fromJson(W,K){return new $().fromJson(W,K)},fromJsonString(W,K){return new $().fromJsonString(W,K)},equals(W,K){return B.util.equals($,W,K)}}),$}function varint64read(){let B=0,F=0;for(let q=0;q<28;q+=7){let V=this.buf[this.pos++];if(B|=(V&127)<<q,(V&128)==0)return this.assertBounds(),[B,F]}let U=this.buf[this.pos++];if(B|=(U&15)<<28,F=(U&112)>>4,(U&128)==0)return this.assertBounds(),[B,F];for(let q=3;q<=31;q+=7){let V=this.buf[this.pos++];if(F|=(V&127)<<q,(V&128)==0)return this.assertBounds(),[B,F]}throw new Error("invalid varint")}function varint64write(B,F,U){for(let j=0;j<28;j=j+7){const $=B>>>j,W=!(!($>>>7)&&F==0),K=(W?$|128:$)&255;if(U.push(K),!W)return}const q=B>>>28&15|(F&7)<<4,V=F>>3!=0;if(U.push((V?q|128:q)&255),!!V){for(let j=3;j<31;j=j+7){const $=F>>>j,W=!!($>>>7),K=(W?$|128:$)&255;if(U.push(K),!W)return}U.push(F>>>31&1)}}const TWO_PWR_32_DBL=4294967296;function int64FromString(B){const F=B[0]==="-";F&&(B=B.slice(1));const U=1e6;let q=0,V=0;function j($,W){const K=Number(B.slice($,W));V*=U,q=q*U+K,q>=TWO_PWR_32_DBL&&(V=V+(q/TWO_PWR_32_DBL|0),q=q%TWO_PWR_32_DBL)}return j(-24,-18),j(-18,-12),j(-12,-6),j(-6),F?negate(q,V):newBits(q,V)}function int64ToString(B,F){let U=newBits(B,F);const q=U.hi&2147483648;q&&(U=negate(U.lo,U.hi));const V=uInt64ToString(U.lo,U.hi);return q?"-"+V:V}function uInt64ToString(B,F){if({lo:B,hi:F}=toUnsigned(B,F),F<=2097151)return String(TWO_PWR_32_DBL*F+B);const U=B&16777215,q=(B>>>24|F<<8)&16777215,V=F>>16&65535;let j=U+q*6777216+V*6710656,$=q+V*8147497,W=V*2;const K=1e7;return j>=K&&($+=Math.floor(j/K),j%=K),$>=K&&(W+=Math.floor($/K),$%=K),W.toString()+decimalFrom1e7WithLeadingZeros($)+decimalFrom1e7WithLeadingZeros(j)}function toUnsigned(B,F){return{lo:B>>>0,hi:F>>>0}}function newBits(B,F){return{lo:B|0,hi:F|0}}function negate(B,F){return F=~F,B?B=~B+1:F+=1,newBits(B,F)}const decimalFrom1e7WithLeadingZeros=B=>{const F=String(B);return"0000000".slice(F.length)+F};function varint32write(B,F){if(B>=0){for(;B>127;)F.push(B&127|128),B=B>>>7;F.push(B)}else{for(let U=0;U<9;U++)F.push(B&127|128),B=B>>7;F.push(1)}}function varint32read(){let B=this.buf[this.pos++],F=B&127;if((B&128)==0)return this.assertBounds(),F;if(B=this.buf[this.pos++],F|=(B&127)<<7,(B&128)==0)return this.assertBounds(),F;if(B=this.buf[this.pos++],F|=(B&127)<<14,(B&128)==0)return this.assertBounds(),F;if(B=this.buf[this.pos++],F|=(B&127)<<21,(B&128)==0)return this.assertBounds(),F;B=this.buf[this.pos++],F|=(B&15)<<28;for(let U=5;(B&128)!==0&&U<10;U++)B=this.buf[this.pos++];if((B&128)!=0)throw new Error("invalid varint");return this.assertBounds(),F>>>0}function makeInt64Support(){const B=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof B.getBigInt64=="function"&&typeof B.getBigUint64=="function"&&typeof B.setBigInt64=="function"&&typeof B.setBigUint64=="function"&&(typeof process!="object"||typeof process.env!="object"||process.env.BUF_BIGINT_DISABLE!=="1")){const V=BigInt("-9223372036854775808"),j=BigInt("9223372036854775807"),$=BigInt("0"),W=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(K){const G=typeof K=="bigint"?K:BigInt(K);if(G>j||G<V)throw new Error("int64 invalid: ".concat(K));return G},uParse(K){const G=typeof K=="bigint"?K:BigInt(K);if(G>W||G<$)throw new Error("uint64 invalid: ".concat(K));return G},enc(K){return B.setBigInt64(0,this.parse(K),!0),{lo:B.getInt32(0,!0),hi:B.getInt32(4,!0)}},uEnc(K){return B.setBigInt64(0,this.uParse(K),!0),{lo:B.getInt32(0,!0),hi:B.getInt32(4,!0)}},dec(K,G){return B.setInt32(0,K,!0),B.setInt32(4,G,!0),B.getBigInt64(0,!0)},uDec(K,G){return B.setInt32(0,K,!0),B.setInt32(4,G,!0),B.getBigUint64(0,!0)}}}const U=V=>assert(/^-?[0-9]+$/.test(V),"int64 invalid: ".concat(V)),q=V=>assert(/^[0-9]+$/.test(V),"uint64 invalid: ".concat(V));return{zero:"0",supported:!1,parse(V){return typeof V!="string"&&(V=V.toString()),U(V),V},uParse(V){return typeof V!="string"&&(V=V.toString()),q(V),V},enc(V){return typeof V!="string"&&(V=V.toString()),U(V),int64FromString(V)},uEnc(V){return typeof V!="string"&&(V=V.toString()),q(V),int64FromString(V)},dec(V,j){return int64ToString(V,j)},uDec(V,j){return uInt64ToString(V,j)}}}const protoInt64=makeInt64Support();var ScalarType;(function(B){B[B.DOUBLE=1]="DOUBLE",B[B.FLOAT=2]="FLOAT",B[B.INT64=3]="INT64",B[B.UINT64=4]="UINT64",B[B.INT32=5]="INT32",B[B.FIXED64=6]="FIXED64",B[B.FIXED32=7]="FIXED32",B[B.BOOL=8]="BOOL",B[B.STRING=9]="STRING",B[B.BYTES=12]="BYTES",B[B.UINT32=13]="UINT32",B[B.SFIXED32=15]="SFIXED32",B[B.SFIXED64=16]="SFIXED64",B[B.SINT32=17]="SINT32",B[B.SINT64=18]="SINT64"})(ScalarType||(ScalarType={}));var LongType;(function(B){B[B.BIGINT=0]="BIGINT",B[B.STRING=1]="STRING"})(LongType||(LongType={}));function scalarEquals(B,F,U){if(F===U)return!0;if(B==ScalarType.BYTES){if(!(F instanceof Uint8Array)||!(U instanceof Uint8Array)||F.length!==U.length)return!1;for(let q=0;q<F.length;q++)if(F[q]!==U[q])return!1;return!0}switch(B){case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return F==U}return!1}function scalarZeroValue(B,F){switch(B){case ScalarType.BOOL:return!1;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return F==0?protoInt64.zero:"0";case ScalarType.DOUBLE:case ScalarType.FLOAT:return 0;case ScalarType.BYTES:return new Uint8Array(0);case ScalarType.STRING:return"";default:return 0}}function isScalarZeroValue(B,F){switch(B){case ScalarType.BOOL:return F===!1;case ScalarType.STRING:return F==="";case ScalarType.BYTES:return F instanceof Uint8Array&&!F.byteLength;default:return F==0}}var WireType;(function(B){B[B.Varint=0]="Varint",B[B.Bit64=1]="Bit64",B[B.LengthDelimited=2]="LengthDelimited",B[B.StartGroup=3]="StartGroup",B[B.EndGroup=4]="EndGroup",B[B.Bit32=5]="Bit32"})(WireType||(WireType={}));class BinaryWriter{constructor(F){this.stack=[],this.textEncoder=F??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let F=0;for(let V=0;V<this.chunks.length;V++)F+=this.chunks[V].length;let U=new Uint8Array(F),q=0;for(let V=0;V<this.chunks.length;V++)U.set(this.chunks[V],q),q+=this.chunks[V].length;return this.chunks=[],U}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let F=this.finish(),U=this.stack.pop();if(!U)throw new Error("invalid state, fork stack empty");return this.chunks=U.chunks,this.buf=U.buf,this.uint32(F.byteLength),this.raw(F)}tag(F,U){return this.uint32((F<<3|U)>>>0)}raw(F){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(F),this}uint32(F){for(assertUInt32(F);F>127;)this.buf.push(F&127|128),F=F>>>7;return this.buf.push(F),this}int32(F){return assertInt32(F),varint32write(F,this.buf),this}bool(F){return this.buf.push(F?1:0),this}bytes(F){return this.uint32(F.byteLength),this.raw(F)}string(F){let U=this.textEncoder.encode(F);return this.uint32(U.byteLength),this.raw(U)}float(F){assertFloat32(F);let U=new Uint8Array(4);return new DataView(U.buffer).setFloat32(0,F,!0),this.raw(U)}double(F){let U=new Uint8Array(8);return new DataView(U.buffer).setFloat64(0,F,!0),this.raw(U)}fixed32(F){assertUInt32(F);let U=new Uint8Array(4);return new DataView(U.buffer).setUint32(0,F,!0),this.raw(U)}sfixed32(F){assertInt32(F);let U=new Uint8Array(4);return new DataView(U.buffer).setInt32(0,F,!0),this.raw(U)}sint32(F){return assertInt32(F),F=(F<<1^F>>31)>>>0,varint32write(F,this.buf),this}sfixed64(F){let U=new Uint8Array(8),q=new DataView(U.buffer),V=protoInt64.enc(F);return q.setInt32(0,V.lo,!0),q.setInt32(4,V.hi,!0),this.raw(U)}fixed64(F){let U=new Uint8Array(8),q=new DataView(U.buffer),V=protoInt64.uEnc(F);return q.setInt32(0,V.lo,!0),q.setInt32(4,V.hi,!0),this.raw(U)}int64(F){let U=protoInt64.enc(F);return varint64write(U.lo,U.hi,this.buf),this}sint64(F){let U=protoInt64.enc(F),q=U.hi>>31,V=U.lo<<1^q,j=(U.hi<<1|U.lo>>>31)^q;return varint64write(V,j,this.buf),this}uint64(F){let U=protoInt64.uEnc(F);return varint64write(U.lo,U.hi,this.buf),this}}class BinaryReader{constructor(F,U){this.varint64=varint64read,this.uint32=varint32read,this.buf=F,this.len=F.length,this.pos=0,this.view=new DataView(F.buffer,F.byteOffset,F.byteLength),this.textDecoder=U??new TextDecoder}tag(){let F=this.uint32(),U=F>>>3,q=F&7;if(U<=0||q<0||q>5)throw new Error("illegal tag: field no "+U+" wire type "+q);return[U,q]}skip(F,U){let q=this.pos;switch(F){case WireType.Varint:for(;this.buf[this.pos++]&128;);break;case WireType.Bit64:this.pos+=4;case WireType.Bit32:this.pos+=4;break;case WireType.LengthDelimited:let V=this.uint32();this.pos+=V;break;case WireType.StartGroup:for(;;){const[j,$]=this.tag();if($===WireType.EndGroup){if(U!==void 0&&j!==U)throw new Error("invalid end group tag");break}this.skip($,j)}break;default:throw new Error("cant skip wire type "+F)}return this.assertBounds(),this.buf.subarray(q,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let F=this.uint32();return F>>>1^-(F&1)}int64(){return protoInt64.dec(...this.varint64())}uint64(){return protoInt64.uDec(...this.varint64())}sint64(){let[F,U]=this.varint64(),q=-(F&1);return F=(F>>>1|(U&1)<<31)^q,U=U>>>1^q,protoInt64.dec(F,U)}bool(){let[F,U]=this.varint64();return F!==0||U!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return protoInt64.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return protoInt64.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let F=this.uint32(),U=this.pos;return this.pos+=F,this.assertBounds(),this.buf.subarray(U,U+F)}string(){return this.textDecoder.decode(this.bytes())}}function makeExtension(B,F,U,q){let V;return{typeName:F,extendee:U,get field(){if(!V){const j=typeof q=="function"?q():q;j.name=F.split(".").pop(),j.jsonName="[".concat(F,"]"),V=B.util.newFieldList([j]).list()[0]}return V},runtime:B}}function createExtensionContainer(B){const F=B.field.localName,U=Object.create(null);return U[F]=initExtensionField(B),[U,()=>U[F]]}function initExtensionField(B){const F=B.field;if(F.repeated)return[];if(F.default!==void 0)return F.default;switch(F.kind){case"enum":return F.T.values[0].no;case"scalar":return scalarZeroValue(F.T,F.L);case"message":const U=F.T,q=new U;return U.fieldWrapper?U.fieldWrapper.unwrapField(q):q;case"map":throw"map fields are not allowed to be extensions"}}function filterUnknownFields(B,F){if(!F.repeated&&(F.kind=="enum"||F.kind=="scalar")){for(let U=B.length-1;U>=0;--U)if(B[U].no==F.no)return[B[U]];return[]}return B.filter(U=>U.no===F.no)}let encTable="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),decTable=[];for(let B=0;B<encTable.length;B++)decTable[encTable[B].charCodeAt(0)]=B;decTable[45]=encTable.indexOf("+"),decTable[95]=encTable.indexOf("/");const protoBase64={dec(B){let F=B.length*3/4;B[B.length-2]=="="?F-=2:B[B.length-1]=="="&&(F-=1);let U=new Uint8Array(F),q=0,V=0,j,$=0;for(let W=0;W<B.length;W++){if(j=decTable[B.charCodeAt(W)],j===void 0)switch(B[W]){case"=":V=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(V){case 0:$=j,V=1;break;case 1:U[q++]=$<<2|(j&48)>>4,$=j,V=2;break;case 2:U[q++]=($&15)<<4|(j&60)>>2,$=j,V=3;break;case 3:U[q++]=($&3)<<6|j,V=0;break}}if(V==1)throw Error("invalid base64 string.");return U.subarray(0,q)},enc(B){let F="",U=0,q,V=0;for(let j=0;j<B.length;j++)switch(q=B[j],U){case 0:F+=encTable[q>>2],V=(q&3)<<4,U=1;break;case 1:F+=encTable[V|q>>4],V=(q&15)<<2,U=2;break;case 2:F+=encTable[V|q>>6],F+=encTable[q&63],U=0;break}return U&&(F+=encTable[V],F+="=",U==1&&(F+="=")),F}};function getExtension(B,F,U){assertExtendee(F,B);const q=F.runtime.bin.makeReadOptions(U),V=filterUnknownFields(B.getType().runtime.bin.listUnknownFields(B),F.field),[j,$]=createExtensionContainer(F);for(const W of V)F.runtime.bin.readField(j,q.readerFactory(W.data),F.field,W.wireType,q);return $()}function setExtension(B,F,U,q){assertExtendee(F,B);const V=F.runtime.bin.makeReadOptions(q),j=F.runtime.bin.makeWriteOptions(q);if(hasExtension(B,F)){const G=B.getType().runtime.bin.listUnknownFields(B).filter(Q=>Q.no!=F.field.no);B.getType().runtime.bin.discardUnknownFields(B);for(const Q of G)B.getType().runtime.bin.onUnknownField(B,Q.no,Q.wireType,Q.data)}const $=j.writerFactory();let W=F.field;!W.opt&&!W.repeated&&(W.kind=="enum"||W.kind=="scalar")&&(W=Object.assign(Object.assign({},F.field),{opt:!0})),F.runtime.bin.writeField(W,U,$,j);const K=V.readerFactory($.finish());for(;K.pos<K.len;){const[G,Q]=K.tag(),z=K.skip(Q,G);B.getType().runtime.bin.onUnknownField(B,G,Q,z)}}function hasExtension(B,F){const U=B.getType();return F.extendee.typeName===U.typeName&&!!U.runtime.bin.listUnknownFields(B).find(q=>q.no==F.field.no)}function assertExtendee(B,F){assert(B.extendee.typeName==F.getType().typeName,"extension ".concat(B.typeName," can only be applied to message ").concat(B.extendee.typeName))}function isFieldSet(B,F){const U=B.localName;if(B.repeated)return F[U].length>0;if(B.oneof)return F[B.oneof.localName].case===U;switch(B.kind){case"enum":case"scalar":return B.opt||B.req?F[U]!==void 0:B.kind=="enum"?F[U]!==B.T.values[0].no:!isScalarZeroValue(B.T,F[U]);case"message":return F[U]!==void 0;case"map":return Object.keys(F[U]).length>0}}function clearField(B,F){const U=B.localName,q=!B.opt&&!B.req;if(B.repeated)F[U]=[];else if(B.oneof)F[B.oneof.localName]={case:void 0};else switch(B.kind){case"map":F[U]={};break;case"enum":F[U]=q?B.T.values[0].no:void 0;break;case"scalar":F[U]=q?scalarZeroValue(B.T,B.L):void 0;break;case"message":F[U]=void 0;break}}function isMessage(B,F){if(B===null||typeof B!="object"||!Object.getOwnPropertyNames(Message.prototype).every(q=>q in B&&typeof B[q]=="function"))return!1;const U=B.getType();return U===null||typeof U!="function"||!("typeName"in U)||typeof U.typeName!="string"?!1:F===void 0?!0:U.typeName==F.typeName}function wrapField(B,F){return isMessage(F)||!B.fieldWrapper?F:B.fieldWrapper.wrapField(F)}ScalarType.DOUBLE,ScalarType.FLOAT,ScalarType.INT64,ScalarType.UINT64,ScalarType.INT32,ScalarType.UINT32,ScalarType.BOOL,ScalarType.STRING,ScalarType.BYTES;const jsonReadDefaults={ignoreUnknownFields:!1},jsonWriteDefaults={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function makeReadOptions$1(B){return B?Object.assign(Object.assign({},jsonReadDefaults),B):jsonReadDefaults}function makeWriteOptions$1(B){return B?Object.assign(Object.assign({},jsonWriteDefaults),B):jsonWriteDefaults}const tokenNull=Symbol(),tokenIgnoredUnknownEnum=Symbol();function makeJsonFormat(){return{makeReadOptions:makeReadOptions$1,makeWriteOptions:makeWriteOptions$1,readMessage(B,F,U,q){if(F==null||Array.isArray(F)||typeof F!="object")throw new Error("cannot decode message ".concat(B.typeName," from JSON: ").concat(debugJsonValue(F)));q=q??new B;const V=new Map,j=U.typeRegistry;for(const[$,W]of Object.entries(F)){const K=B.fields.findJsonName($);if(K){if(K.oneof){if(W===null&&K.kind=="scalar")continue;const G=V.get(K.oneof);if(G!==void 0)throw new Error("cannot decode message ".concat(B.typeName,' from JSON: multiple keys for oneof "').concat(K.oneof.name,'" present: "').concat(G,'", "').concat($,'"'));V.set(K.oneof,$)}readField$1(q,W,K,U,B)}else{let G=!1;if(j!=null&&j.findExtension&&$.startsWith("[")&&$.endsWith("]")){const Q=j.findExtension($.substring(1,$.length-1));if(Q&&Q.extendee.typeName==B.typeName){G=!0;const[z,H]=createExtensionContainer(Q);readField$1(z,W,Q.field,U,Q),setExtension(q,Q,H(),U)}}if(!G&&!U.ignoreUnknownFields)throw new Error("cannot decode message ".concat(B.typeName,' from JSON: key "').concat($,'" is unknown'))}}return q},writeMessage(B,F){const U=B.getType(),q={};let V;try{for(V of U.fields.byNumber()){if(!isFieldSet(V,B)){if(V.req)throw"required field not set";if(!F.emitDefaultValues||!canEmitFieldDefaultValue(V))continue}const $=V.oneof?B[V.oneof.localName].value:B[V.localName],W=writeField$1(V,$,F);W!==void 0&&(q[F.useProtoFieldName?V.name:V.jsonName]=W)}const j=F.typeRegistry;if(j!=null&&j.findExtensionFor)for(const $ of U.runtime.bin.listUnknownFields(B)){const W=j.findExtensionFor(U.typeName,$.no);if(W&&hasExtension(B,W)){const K=getExtension(B,W,F),G=writeField$1(W.field,K,F);G!==void 0&&(q[W.field.jsonName]=G)}}}catch(j){const $=V?"cannot encode field ".concat(U.typeName,".").concat(V.name," to JSON"):"cannot encode message ".concat(U.typeName," to JSON"),W=j instanceof Error?j.message:String(j);throw new Error($+(W.length>0?": ".concat(W):""))}return q},readScalar(B,F,U){return readScalar$1(B,F,U??LongType.BIGINT,!0)},writeScalar(B,F,U){if(F!==void 0&&(U||isScalarZeroValue(B,F)))return writeScalar$1(B,F)},debug:debugJsonValue}}function debugJsonValue(B){if(B===null)return"null";switch(typeof B){case"object":return Array.isArray(B)?"array":"object";case"string":return B.length>100?"string":'"'.concat(B.split('"').join('\\"'),'"');default:return String(B)}}function readField$1(B,F,U,q,V){let j=U.localName;if(U.repeated){if(assert(U.kind!="map"),F===null)return;if(!Array.isArray(F))throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(F)));const $=B[j];for(const W of F){if(W===null)throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(W)));switch(U.kind){case"message":$.push(U.T.fromJson(W,q));break;case"enum":const K=readEnum(U.T,W,q.ignoreUnknownFields,!0);K!==tokenIgnoredUnknownEnum&&$.push(K);break;case"scalar":try{$.push(readScalar$1(U.T,W,U.L,!0))}catch(G){let Q="cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(W));throw G instanceof Error&&G.message.length>0&&(Q+=": ".concat(G.message)),new Error(Q)}break}}}else if(U.kind=="map"){if(F===null)return;if(typeof F!="object"||Array.isArray(F))throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(F)));const $=B[j];for(const[W,K]of Object.entries(F)){if(K===null)throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: map value null"));let G;try{G=readMapKey(U.K,W)}catch(Q){let z="cannot decode map key for field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(F));throw Q instanceof Error&&Q.message.length>0&&(z+=": ".concat(Q.message)),new Error(z)}switch(U.V.kind){case"message":$[G]=U.V.T.fromJson(K,q);break;case"enum":const Q=readEnum(U.V.T,K,q.ignoreUnknownFields,!0);Q!==tokenIgnoredUnknownEnum&&($[G]=Q);break;case"scalar":try{$[G]=readScalar$1(U.V.T,K,LongType.BIGINT,!0)}catch(z){let H="cannot decode map value for field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(F));throw z instanceof Error&&z.message.length>0&&(H+=": ".concat(z.message)),new Error(H)}break}}}else switch(U.oneof&&(B=B[U.oneof.localName]={case:j},j="value"),U.kind){case"message":const $=U.T;if(F===null&&$.typeName!="google.protobuf.Value")return;let W=B[j];isMessage(W)?W.fromJson(F,q):(B[j]=W=$.fromJson(F,q),$.fieldWrapper&&!U.oneof&&(B[j]=$.fieldWrapper.unwrapField(W)));break;case"enum":const K=readEnum(U.T,F,q.ignoreUnknownFields,!1);switch(K){case tokenNull:clearField(U,B);break;case tokenIgnoredUnknownEnum:break;default:B[j]=K;break}break;case"scalar":try{const G=readScalar$1(U.T,F,U.L,!1);switch(G){case tokenNull:clearField(U,B);break;default:B[j]=G;break}}catch(G){let Q="cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(F));throw G instanceof Error&&G.message.length>0&&(Q+=": ".concat(G.message)),new Error(Q)}break}}function readMapKey(B,F){if(B===ScalarType.BOOL)switch(F){case"true":F=!0;break;case"false":F=!1;break}return readScalar$1(B,F,LongType.BIGINT,!0).toString()}function readScalar$1(B,F,U,q){if(F===null)return q?scalarZeroValue(B,U):tokenNull;switch(B){case ScalarType.DOUBLE:case ScalarType.FLOAT:if(F==="NaN")return Number.NaN;if(F==="Infinity")return Number.POSITIVE_INFINITY;if(F==="-Infinity")return Number.NEGATIVE_INFINITY;if(F===""||typeof F=="string"&&F.trim().length!==F.length||typeof F!="string"&&typeof F!="number")break;const V=Number(F);if(Number.isNaN(V)||!Number.isFinite(V))break;return B==ScalarType.FLOAT&&assertFloat32(V),V;case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.UINT32:let j;if(typeof F=="number"?j=F:typeof F=="string"&&F.length>0&&F.trim().length===F.length&&(j=Number(F)),j===void 0)break;return B==ScalarType.UINT32||B==ScalarType.FIXED32?assertUInt32(j):assertInt32(j),j;case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:if(typeof F!="number"&&typeof F!="string")break;const $=protoInt64.parse(F);return U?$.toString():$;case ScalarType.FIXED64:case ScalarType.UINT64:if(typeof F!="number"&&typeof F!="string")break;const W=protoInt64.uParse(F);return U?W.toString():W;case ScalarType.BOOL:if(typeof F!="boolean")break;return F;case ScalarType.STRING:if(typeof F!="string")break;try{encodeURIComponent(F)}catch{throw new Error("invalid UTF8")}return F;case ScalarType.BYTES:if(F==="")return new Uint8Array(0);if(typeof F!="string")break;return protoBase64.dec(F)}throw new Error}function readEnum(B,F,U,q){if(F===null)return B.typeName=="google.protobuf.NullValue"?0:q?B.values[0].no:tokenNull;switch(typeof F){case"number":if(Number.isInteger(F))return F;break;case"string":const V=B.findName(F);if(V!==void 0)return V.no;if(U)return tokenIgnoredUnknownEnum;break}throw new Error("cannot decode enum ".concat(B.typeName," from JSON: ").concat(debugJsonValue(F)))}function canEmitFieldDefaultValue(B){return B.repeated||B.kind=="map"?!0:!(B.oneof||B.kind=="message"||B.opt||B.req)}function writeField$1(B,F,U){if(B.kind=="map"){assert(typeof F=="object"&&F!=null);const q={},V=Object.entries(F);switch(B.V.kind){case"scalar":for(const[$,W]of V)q[$.toString()]=writeScalar$1(B.V.T,W);break;case"message":for(const[$,W]of V)q[$.toString()]=W.toJson(U);break;case"enum":const j=B.V.T;for(const[$,W]of V)q[$.toString()]=writeEnum(j,W,U.enumAsInteger);break}return U.emitDefaultValues||V.length>0?q:void 0}if(B.repeated){assert(Array.isArray(F));const q=[];switch(B.kind){case"scalar":for(let V=0;V<F.length;V++)q.push(writeScalar$1(B.T,F[V]));break;case"enum":for(let V=0;V<F.length;V++)q.push(writeEnum(B.T,F[V],U.enumAsInteger));break;case"message":for(let V=0;V<F.length;V++)q.push(F[V].toJson(U));break}return U.emitDefaultValues||q.length>0?q:void 0}switch(B.kind){case"scalar":return writeScalar$1(B.T,F);case"enum":return writeEnum(B.T,F,U.enumAsInteger);case"message":return wrapField(B.T,F).toJson(U)}}function writeEnum(B,F,U){var q;if(assert(typeof F=="number"),B.typeName=="google.protobuf.NullValue")return null;if(U)return F;const V=B.findNumber(F);return(q=V==null?void 0:V.name)!==null&&q!==void 0?q:F}function writeScalar$1(B,F){switch(B){case ScalarType.INT32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.FIXED32:case ScalarType.UINT32:return assert(typeof F=="number"),F;case ScalarType.FLOAT:case ScalarType.DOUBLE:return assert(typeof F=="number"),Number.isNaN(F)?"NaN":F===Number.POSITIVE_INFINITY?"Infinity":F===Number.NEGATIVE_INFINITY?"-Infinity":F;case ScalarType.STRING:return assert(typeof F=="string"),F;case ScalarType.BOOL:return assert(typeof F=="boolean"),F;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return assert(typeof F=="bigint"||typeof F=="string"||typeof F=="number"),F.toString();case ScalarType.BYTES:return assert(F instanceof Uint8Array),protoBase64.enc(F)}}const unknownFieldsSymbol=Symbol("@bufbuild/protobuf/unknown-fields"),readDefaults={readUnknownFields:!0,readerFactory:B=>new BinaryReader(B)},writeDefaults={writeUnknownFields:!0,writerFactory:()=>new BinaryWriter};function makeReadOptions(B){return B?Object.assign(Object.assign({},readDefaults),B):readDefaults}function makeWriteOptions(B){return B?Object.assign(Object.assign({},writeDefaults),B):writeDefaults}function makeBinaryFormat(){return{makeReadOptions,makeWriteOptions,listUnknownFields(B){var F;return(F=B[unknownFieldsSymbol])!==null&&F!==void 0?F:[]},discardUnknownFields(B){delete B[unknownFieldsSymbol]},writeUnknownFields(B,F){const q=B[unknownFieldsSymbol];if(q)for(const V of q)F.tag(V.no,V.wireType).raw(V.data)},onUnknownField(B,F,U,q){const V=B;Array.isArray(V[unknownFieldsSymbol])||(V[unknownFieldsSymbol]=[]),V[unknownFieldsSymbol].push({no:F,wireType:U,data:q})},readMessage(B,F,U,q,V){const j=B.getType(),$=V?F.len:F.pos+U;let W,K;for(;F.pos<$&&([W,K]=F.tag(),!(V===!0&&K==WireType.EndGroup));){const G=j.fields.find(W);if(!G){const Q=F.skip(K,W);q.readUnknownFields&&this.onUnknownField(B,W,K,Q);continue}readField(B,F,G,K,q)}if(V&&(K!=WireType.EndGroup||W!==U))throw new Error("invalid end group tag")},readField,writeMessage(B,F,U){const q=B.getType();for(const V of q.fields.byNumber()){if(!isFieldSet(V,B)){if(V.req)throw new Error("cannot encode field ".concat(q.typeName,".").concat(V.name," to binary: required field not set"));continue}const j=V.oneof?B[V.oneof.localName].value:B[V.localName];writeField(V,j,F,U)}return U.writeUnknownFields&&this.writeUnknownFields(B,F),F},writeField(B,F,U,q){F!==void 0&&writeField(B,F,U,q)}}}function readField(B,F,U,q,V){let{repeated:j,localName:$}=U;switch(U.oneof&&(B=B[U.oneof.localName],B.case!=$&&delete B.value,B.case=$,$="value"),U.kind){case"scalar":case"enum":const W=U.kind=="enum"?ScalarType.INT32:U.T;let K=readScalar;if(U.kind=="scalar"&&U.L>0&&(K=readScalarLTString),j){let H=B[$];if(q==WireType.LengthDelimited&&W!=ScalarType.STRING&&W!=ScalarType.BYTES){let X=F.uint32()+F.pos;for(;F.pos<X;)H.push(K(F,W))}else H.push(K(F,W))}else B[$]=K(F,W);break;case"message":const G=U.T;j?B[$].push(readMessageField(F,new G,V,U)):isMessage(B[$])?readMessageField(F,B[$],V,U):(B[$]=readMessageField(F,new G,V,U),G.fieldWrapper&&!U.oneof&&!U.repeated&&(B[$]=G.fieldWrapper.unwrapField(B[$])));break;case"map":let[Q,z]=readMapEntry(U,F,V);B[$][Q]=z;break}}function readMessageField(B,F,U,q){const V=F.getType().runtime.bin,j=q==null?void 0:q.delimited;return V.readMessage(F,B,j?q.no:B.uint32(),U,j),F}function readMapEntry(B,F,U){const q=F.uint32(),V=F.pos+q;let j,$;for(;F.pos<V;){const[W]=F.tag();switch(W){case 1:j=readScalar(F,B.K);break;case 2:switch(B.V.kind){case"scalar":$=readScalar(F,B.V.T);break;case"enum":$=F.int32();break;case"message":$=readMessageField(F,new B.V.T,U,void 0);break}break}}if(j===void 0&&(j=scalarZeroValue(B.K,LongType.BIGINT)),typeof j!="string"&&typeof j!="number"&&(j=j.toString()),$===void 0)switch(B.V.kind){case"scalar":$=scalarZeroValue(B.V.T,LongType.BIGINT);break;case"enum":$=B.V.T.values[0].no;break;case"message":$=new B.V.T;break}return[j,$]}function readScalarLTString(B,F){const U=readScalar(B,F);return typeof U=="bigint"?U.toString():U}function readScalar(B,F){switch(F){case ScalarType.STRING:return B.string();case ScalarType.BOOL:return B.bool();case ScalarType.DOUBLE:return B.double();case ScalarType.FLOAT:return B.float();case ScalarType.INT32:return B.int32();case ScalarType.INT64:return B.int64();case ScalarType.UINT64:return B.uint64();case ScalarType.FIXED64:return B.fixed64();case ScalarType.BYTES:return B.bytes();case ScalarType.FIXED32:return B.fixed32();case ScalarType.SFIXED32:return B.sfixed32();case ScalarType.SFIXED64:return B.sfixed64();case ScalarType.SINT64:return B.sint64();case ScalarType.UINT32:return B.uint32();case ScalarType.SINT32:return B.sint32()}}function writeField(B,F,U,q){assert(F!==void 0);const V=B.repeated;switch(B.kind){case"scalar":case"enum":let j=B.kind=="enum"?ScalarType.INT32:B.T;if(V)if(assert(Array.isArray(F)),B.packed)writePacked(U,j,B.no,F);else for(const $ of F)writeScalar(U,j,B.no,$);else writeScalar(U,j,B.no,F);break;case"message":if(V){assert(Array.isArray(F));for(const $ of F)writeMessageField(U,q,B,$)}else writeMessageField(U,q,B,F);break;case"map":assert(typeof F=="object"&&F!=null);for(const[$,W]of Object.entries(F))writeMapEntry(U,q,B,$,W);break}}function writeMapEntry(B,F,U,q,V){B.tag(U.no,WireType.LengthDelimited),B.fork();let j=q;switch(U.K){case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.UINT32:case ScalarType.SFIXED32:case ScalarType.SINT32:j=Number.parseInt(q);break;case ScalarType.BOOL:assert(q=="true"||q=="false"),j=q=="true";break}switch(writeScalar(B,U.K,1,j),U.V.kind){case"scalar":writeScalar(B,U.V.T,2,V);break;case"enum":writeScalar(B,ScalarType.INT32,2,V);break;case"message":assert(V!==void 0),B.tag(2,WireType.LengthDelimited).bytes(V.toBinary(F));break}B.join()}function writeMessageField(B,F,U,q){const V=wrapField(U.T,q);U.delimited?B.tag(U.no,WireType.StartGroup).raw(V.toBinary(F)).tag(U.no,WireType.EndGroup):B.tag(U.no,WireType.LengthDelimited).bytes(V.toBinary(F))}function writeScalar(B,F,U,q){assert(q!==void 0);let[V,j]=scalarTypeInfo(F);B.tag(U,V)[j](q)}function writePacked(B,F,U,q){if(!q.length)return;B.tag(U,WireType.LengthDelimited).fork();let[,V]=scalarTypeInfo(F);for(let j=0;j<q.length;j++)B[V](q[j]);B.join()}function scalarTypeInfo(B){let F=WireType.Varint;switch(B){case ScalarType.BYTES:case ScalarType.STRING:F=WireType.LengthDelimited;break;case ScalarType.DOUBLE:case ScalarType.FIXED64:case ScalarType.SFIXED64:F=WireType.Bit64;break;case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.FLOAT:F=WireType.Bit32;break}const U=ScalarType[B].toLowerCase();return[F,U]}function makeUtilCommon(){return{setEnumType,initPartial(B,F){if(B===void 0)return;const U=F.getType();for(const q of U.fields.byMember()){const V=q.localName,j=F,$=B;if($[V]!=null)switch(q.kind){case"oneof":const W=$[V].case;if(W===void 0)continue;const K=q.findField(W);let G=$[V].value;K&&K.kind=="message"&&!isMessage(G,K.T)?G=new K.T(G):K&&K.kind==="scalar"&&K.T===ScalarType.BYTES&&(G=toU8Arr(G)),j[V]={case:W,value:G};break;case"scalar":case"enum":let Q=$[V];q.T===ScalarType.BYTES&&(Q=q.repeated?Q.map(toU8Arr):toU8Arr(Q)),j[V]=Q;break;case"map":switch(q.V.kind){case"scalar":case"enum":if(q.V.T===ScalarType.BYTES)for(const[Y,X]of Object.entries($[V]))j[V][Y]=toU8Arr(X);else Object.assign(j[V],$[V]);break;case"message":const H=q.V.T;for(const Y of Object.keys($[V])){let X=$[V][Y];H.fieldWrapper||(X=new H(X)),j[V][Y]=X}break}break;case"message":const z=q.T;if(q.repeated)j[V]=$[V].map(H=>isMessage(H,z)?H:new z(H));else{const H=$[V];z.fieldWrapper?z.typeName==="google.protobuf.BytesValue"?j[V]=toU8Arr(H):j[V]=H:j[V]=isMessage(H,z)?H:new z(H)}break}}},equals(B,F,U){return F===U?!0:!F||!U?!1:B.fields.byMember().every(q=>{const V=F[q.localName],j=U[q.localName];if(q.repeated){if(V.length!==j.length)return!1;switch(q.kind){case"message":return V.every(($,W)=>q.T.equals($,j[W]));case"scalar":return V.every(($,W)=>scalarEquals(q.T,$,j[W]));case"enum":return V.every(($,W)=>scalarEquals(ScalarType.INT32,$,j[W]))}throw new Error("repeated cannot contain ".concat(q.kind))}switch(q.kind){case"message":return q.T.equals(V,j);case"enum":return scalarEquals(ScalarType.INT32,V,j);case"scalar":return scalarEquals(q.T,V,j);case"oneof":if(V.case!==j.case)return!1;const $=q.findField(V.case);if($===void 0)return!0;switch($.kind){case"message":return $.T.equals(V.value,j.value);case"enum":return scalarEquals(ScalarType.INT32,V.value,j.value);case"scalar":return scalarEquals($.T,V.value,j.value)}throw new Error("oneof cannot contain ".concat($.kind));case"map":const W=Object.keys(V).concat(Object.keys(j));switch(q.V.kind){case"message":const K=q.V.T;return W.every(Q=>K.equals(V[Q],j[Q]));case"enum":return W.every(Q=>scalarEquals(ScalarType.INT32,V[Q],j[Q]));case"scalar":const G=q.V.T;return W.every(Q=>scalarEquals(G,V[Q],j[Q]))}break}})},clone(B){const F=B.getType(),U=new F,q=U;for(const V of F.fields.byMember()){const j=B[V.localName];let $;if(V.repeated)$=j.map(cloneSingularField);else if(V.kind=="map"){$=q[V.localName];for(const[W,K]of Object.entries(j))$[W]=cloneSingularField(K)}else V.kind=="oneof"?$=V.findField(j.case)?{case:j.case,value:cloneSingularField(j.value)}:{case:void 0}:$=cloneSingularField(j);q[V.localName]=$}for(const V of F.runtime.bin.listUnknownFields(B))F.runtime.bin.onUnknownField(q,V.no,V.wireType,V.data);return U}}}function cloneSingularField(B){if(B===void 0)return B;if(isMessage(B))return B.clone();if(B instanceof Uint8Array){const F=new Uint8Array(B.byteLength);return F.set(B),F}return B}function toU8Arr(B){return B instanceof Uint8Array?B:new Uint8Array(B)}function makeProtoRuntime(B,F,U){return{syntax:B,json:makeJsonFormat(),bin:makeBinaryFormat(),util:Object.assign(Object.assign({},makeUtilCommon()),{newFieldList:F,initFields:U}),makeMessageType(q,V,j){return makeMessageType(this,q,V,j)},makeEnum,makeEnumType,getEnumType,makeExtension(q,V,j){return makeExtension(this,q,V,j)}}}class InternalFieldList{constructor(F,U){this._fields=F,this._normalizer=U}findJsonName(F){if(!this.jsonNames){const U={};for(const q of this.list())U[q.jsonName]=U[q.name]=q;this.jsonNames=U}return this.jsonNames[F]}find(F){if(!this.numbers){const U={};for(const q of this.list())U[q.no]=q;this.numbers=U}return this.numbers[F]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((F,U)=>F.no-U.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const F=this.members;let U;for(const q of this.list())q.oneof?q.oneof!==U&&(U=q.oneof,F.push(U)):F.push(q)}return this.members}}function localFieldName(B,F){const U=protoCamelCase(B);return F?U:safeObjectProperty(safeMessageProperty(U))}function localOneofName(B){return localFieldName(B,!1)}const fieldJsonName=protoCamelCase;function protoCamelCase(B){let F=!1;const U=[];for(let q=0;q<B.length;q++){let V=B.charAt(q);switch(V){case"_":F=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":U.push(V),F=!1;break;default:F&&(F=!1,V=V.toUpperCase()),U.push(V);break}}return U.join("")}const reservedObjectProperties=new Set(["constructor","toString","toJSON","valueOf"]),reservedMessageProperties=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),fallback=B=>"".concat(B,"$"),safeMessageProperty=B=>reservedMessageProperties.has(B)?fallback(B):B,safeObjectProperty=B=>reservedObjectProperties.has(B)?fallback(B):B;class InternalOneofInfo{constructor(F){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=F,this.localName=localOneofName(F)}addField(F){assert(F.oneof===this,"field ".concat(F.name," not one of ").concat(this.name)),this.fields.push(F)}findField(F){if(!this._lookup){this._lookup=Object.create(null);for(let U=0;U<this.fields.length;U++)this._lookup[this.fields[U].localName]=this.fields[U]}return this._lookup[F]}}function normalizeFieldInfos(B,F){var U,q,V,j,$,W;const K=[];let G;for(const Q of typeof B=="function"?B():B){const z=Q;if(z.localName=localFieldName(Q.name,Q.oneof!==void 0),z.jsonName=(U=Q.jsonName)!==null&&U!==void 0?U:fieldJsonName(Q.name),z.repeated=(q=Q.repeated)!==null&&q!==void 0?q:!1,Q.kind=="scalar"&&(z.L=(V=Q.L)!==null&&V!==void 0?V:LongType.BIGINT),z.delimited=(j=Q.delimited)!==null&&j!==void 0?j:!1,z.req=($=Q.req)!==null&&$!==void 0?$:!1,z.opt=(W=Q.opt)!==null&&W!==void 0?W:!1,Q.packed===void 0&&(z.packed=Q.kind=="enum"||Q.kind=="scalar"&&Q.T!=ScalarType.BYTES&&Q.T!=ScalarType.STRING),Q.oneof!==void 0){const H=typeof Q.oneof=="string"?Q.oneof:Q.oneof.name;(!G||G.name!=H)&&(G=new InternalOneofInfo(H)),z.oneof=G,G.addField(z)}K.push(z)}return K}const proto3=makeProtoRuntime("proto3",B=>new InternalFieldList(B,F=>normalizeFieldInfos(F)),B=>{for(const F of B.getType().fields.byMember()){if(F.opt)continue;const U=F.localName,q=B;if(F.repeated){q[U]=[];continue}switch(F.kind){case"oneof":q[U]={case:void 0};break;case"enum":q[U]=0;break;case"map":q[U]={};break;case"scalar":q[U]=scalarZeroValue(F.T,F.L);break}}});class Timestamp extends Message{constructor(F){super(),this.seconds=protoInt64.zero,this.nanos=0,proto3.util.initPartial(F,this)}fromJson(F,U){if(typeof F!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(proto3.json.debug(F)));const q=F.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!q)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const V=Date.parse(q[1]+"-"+q[2]+"-"+q[3]+"T"+q[4]+":"+q[5]+":"+q[6]+(q[8]?q[8]:"Z"));if(Number.isNaN(V))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(V<Date.parse("0001-01-01T00:00:00Z")||V>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=protoInt64.parse(V/1e3),this.nanos=0,q[7]&&(this.nanos=parseInt("1"+q[7]+"0".repeat(9-q[7].length))-1e9),this}toJson(F){const U=Number(this.seconds)*1e3;if(U<Date.parse("0001-01-01T00:00:00Z")||U>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let q="Z";if(this.nanos>0){const V=(this.nanos+1e9).toString().substring(1);V.substring(3)==="000000"?q="."+V.substring(0,3)+"Z":V.substring(6)==="000"?q="."+V.substring(0,6)+"Z":q="."+V+"Z"}return new Date(U).toISOString().replace(".000Z",q)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Timestamp.fromDate(new Date)}static fromDate(F){const U=F.getTime();return new Timestamp({seconds:protoInt64.parse(Math.floor(U/1e3)),nanos:U%1e3*1e6})}static fromBinary(F,U){return new Timestamp().fromBinary(F,U)}static fromJson(F,U){return new Timestamp().fromJson(F,U)}static fromJsonString(F,U){return new Timestamp().fromJsonString(F,U)}static equals(F,U){return proto3.util.equals(Timestamp,F,U)}}Timestamp.runtime=proto3,Timestamp.typeName="google.protobuf.Timestamp",Timestamp.fields=proto3.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const MetricsBatch=proto3.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:TimeSeriesMetric,repeated:!0},{no:5,name:"events",kind:"message",T:EventMetric,repeated:!0}]),TimeSeriesMetric=proto3.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:MetricSample,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),MetricSample=proto3.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"value",kind:"scalar",T:2}]),EventMetric=proto3.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Timestamp},{no:7,name:"normalized_end_timestamp",kind:"message",T:Timestamp,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),BackupCodecPolicy$1=proto3.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),TrackType=proto3.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),TrackSource=proto3.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),VideoQuality$1=proto3.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),ConnectionQuality$1=proto3.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),ClientConfigSetting=proto3.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),DisconnectReason=proto3.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"}]),ReconnectReason=proto3.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),SubscriptionError=proto3.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),AudioTrackFeature=proto3.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),Room$1=proto3.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Codec,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:TimedVersion}]),Codec=proto3.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),ParticipantPermission=proto3.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:proto3.getEnumType(TrackSource),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ParticipantInfo=proto3.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(ParticipantInfo_State)},{no:4,name:"tracks",kind:"message",T:TrackInfo,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ParticipantPermission},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:proto3.getEnumType(ParticipantInfo_Kind)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)},{no:18,name:"kind_details",kind:"enum",T:proto3.getEnumType(ParticipantInfo_KindDetail),repeated:!0}]),ParticipantInfo_State=proto3.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),ParticipantInfo_Kind=proto3.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),ParticipantInfo_KindDetail=proto3.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),Encryption_Type=proto3.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),SimulcastCodecInfo=proto3.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),TrackInfo=proto3.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:10,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:SimulcastCodecInfo,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:TimedVersion},{no:19,name:"audio_features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:proto3.getEnumType(BackupCodecPolicy$1)}]),VideoLayer=proto3.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]),DataPacket=proto3.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:proto3.getEnumType(DataPacket_Kind)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:UserPacket,oneof:"value"},{no:3,name:"speaker",kind:"message",T:ActiveSpeakerUpdate,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:SipDTMF,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Transcription,oneof:"value"},{no:8,name:"metrics",kind:"message",T:MetricsBatch,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:ChatMessage,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:RpcRequest,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:RpcAck,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:RpcResponse,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:DataStream_Header,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:DataStream_Chunk,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:DataStream_Trailer,oneof:"value"}]),DataPacket_Kind=proto3.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),ActiveSpeakerUpdate=proto3.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),SpeakerInfo=proto3.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),UserPacket=proto3.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),SipDTMF=proto3.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Transcription=proto3.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:TranscriptionSegment,repeated:!0}]),TranscriptionSegment=proto3.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),ChatMessage=proto3.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),RpcRequest=proto3.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),RpcAck=proto3.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),RpcResponse=proto3.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:RpcError$1,oneof:"value"}]),RpcError$1=proto3.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),ParticipantTracks=proto3.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),ServerInfo=proto3.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:proto3.getEnumType(ServerInfo_Edition)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),ServerInfo_Edition=proto3.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),ClientInfo=proto3.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:proto3.getEnumType(ClientInfo_SDK)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),ClientInfo_SDK=proto3.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"}]),ClientConfiguration=proto3.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:VideoConfiguration},{no:2,name:"screen",kind:"message",T:VideoConfiguration},{no:3,name:"resume_connection",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)},{no:4,name:"disabled_codecs",kind:"message",T:DisabledCodecs},{no:5,name:"force_relay",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),VideoConfiguration=proto3.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),DisabledCodecs=proto3.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Codec,repeated:!0},{no:2,name:"publish",kind:"message",T:Codec,repeated:!0}]),TimedVersion=proto3.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),DataStream_OperationType=proto3.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),DataStream_TextHeader=proto3.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:proto3.getEnumType(DataStream_OperationType)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),DataStream_ByteHeader=proto3.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),DataStream_Header=proto3.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:DataStream_TextHeader,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:DataStream_ByteHeader,oneof:"content_header"}],{localName:"DataStream_Header"}),DataStream_Chunk=proto3.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),DataStream_Trailer=proto3.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),SignalTarget=proto3.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),StreamState=proto3.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),CandidateProtocol=proto3.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),SignalRequest=proto3.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:4,name:"add_track",kind:"message",T:AddTrackRequest,oneof:"message"},{no:5,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:6,name:"subscription",kind:"message",T:UpdateSubscription,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:UpdateTrackSettings,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:UpdateVideoLayers,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:SubscriptionPermission,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:SyncState,oneof:"message"},{no:13,name:"simulate",kind:"message",T:SimulateScenario,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:UpdateParticipantMetadata,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Ping,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:UpdateLocalAudioTrack,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:UpdateLocalVideoTrack,oneof:"message"}]),SignalResponse=proto3.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:JoinResponse,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:4,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:5,name:"update",kind:"message",T:ParticipantUpdate,oneof:"message"},{no:6,name:"track_published",kind:"message",T:TrackPublishedResponse,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:9,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:SpeakersChanged,oneof:"message"},{no:11,name:"room_update",kind:"message",T:RoomUpdate,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:ConnectionQualityUpdate,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:StreamStateUpdate,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:SubscribedQualityUpdate,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:SubscriptionPermissionUpdate,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:TrackUnpublishedResponse,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:ReconnectResponse,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Pong,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:SubscriptionResponse,oneof:"message"},{no:22,name:"request_response",kind:"message",T:RequestResponse,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:TrackSubscribed,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:RoomMovedResponse,oneof:"message"}]),SimulcastCodec=proto3.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),AddTrackRequest=proto3.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:9,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:SimulcastCodec,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:proto3.getEnumType(BackupCodecPolicy$1)},{no:17,name:"audio_features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),TrickleRequest=proto3.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)},{no:3,name:"final",kind:"scalar",T:8}]),MuteTrackRequest=proto3.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),JoinResponse=proto3.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1},{no:2,name:"participant",kind:"message",T:ParticipantInfo},{no:3,name:"other_participants",kind:"message",T:ParticipantInfo,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:ClientConfiguration},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:ServerInfo},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Codec,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),ReconnectResponse=proto3.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:ClientConfiguration}]),TrackPublishedResponse=proto3.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:TrackInfo}]),TrackUnpublishedResponse=proto3.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),SessionDescription=proto3.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]),ParticipantUpdate=proto3.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ParticipantInfo,repeated:!0}]),UpdateSubscription=proto3.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:ParticipantTracks,repeated:!0}]),UpdateTrackSettings=proto3.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),UpdateLocalAudioTrack=proto3.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),UpdateLocalVideoTrack=proto3.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),LeaveRequest=proto3.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)},{no:3,name:"action",kind:"enum",T:proto3.getEnumType(LeaveRequest_Action)},{no:4,name:"regions",kind:"message",T:RegionSettings}]),LeaveRequest_Action=proto3.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),UpdateVideoLayers=proto3.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),UpdateParticipantMetadata=proto3.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),ICEServer=proto3.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),SpeakersChanged=proto3.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),RoomUpdate=proto3.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Room$1}]),ConnectionQualityInfo=proto3.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:proto3.getEnumType(ConnectionQuality$1)},{no:3,name:"score",kind:"scalar",T:2}]),ConnectionQualityUpdate=proto3.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:ConnectionQualityInfo,repeated:!0}]),StreamStateInfo=proto3.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(StreamState)}]),StreamStateUpdate=proto3.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:StreamStateInfo,repeated:!0}]),SubscribedQuality=proto3.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"enabled",kind:"scalar",T:8}]),SubscribedCodec=proto3.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:SubscribedQuality,repeated:!0}]),SubscribedQualityUpdate=proto3.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:SubscribedQuality,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:SubscribedCodec,repeated:!0}]),TrackPermission=proto3.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),SubscriptionPermission=proto3.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:TrackPermission,repeated:!0}]),SubscriptionPermissionUpdate=proto3.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),RoomMovedResponse=proto3.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:ParticipantInfo},{no:4,name:"other_participants",kind:"message",T:ParticipantInfo,repeated:!0}]),SyncState=proto3.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:SessionDescription},{no:2,name:"subscription",kind:"message",T:UpdateSubscription},{no:3,name:"publish_tracks",kind:"message",T:TrackPublishedResponse,repeated:!0},{no:4,name:"data_channels",kind:"message",T:DataChannelInfo,repeated:!0},{no:5,name:"offer",kind:"message",T:SessionDescription},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0}]),DataChannelInfo=proto3.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)}]),SimulateScenario=proto3.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:proto3.getEnumType(CandidateProtocol),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Ping=proto3.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Pong=proto3.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),RegionSettings=proto3.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:RegionInfo,repeated:!0}]),RegionInfo=proto3.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),SubscriptionResponse=proto3.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:proto3.getEnumType(SubscriptionError)}]),RequestResponse=proto3.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(RequestResponse_Reason)},{no:3,name:"message",kind:"scalar",T:9}]),RequestResponse_Reason=proto3.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),TrackSubscribed=proto3.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function getDefaultExportFromCjs$1(B){return B&&B.__esModule&&Object.prototype.hasOwnProperty.call(B,"default")?B.default:B}var loglevel$1={exports:{}},loglevel=loglevel$1.exports,hasRequiredLoglevel;function requireLoglevel(){return hasRequiredLoglevel||(hasRequiredLoglevel=1,function(B){(function(F,U){B.exports?B.exports=U():F.log=U()})(loglevel,function(){var F=function(){},U="undefined",q=typeof window!==U&&typeof window.navigator!==U&&/Trident\/|MSIE /.test(window.navigator.userAgent),V=["trace","debug","info","warn","error"],j={},$=null;function W(Z,ie){var ee=Z[ie];if(typeof ee.bind=="function")return ee.bind(Z);try{return Function.prototype.bind.call(ee,Z)}catch{return function(){return Function.prototype.apply.apply(ee,[Z,arguments])}}}function K(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function G(Z){return Z==="debug"&&(Z="log"),typeof console===U?!1:Z==="trace"&&q?K:console[Z]!==void 0?W(console,Z):console.log!==void 0?W(console,"log"):F}function Q(){for(var Z=this.getLevel(),ie=0;ie<V.length;ie++){var ee=V[ie];this[ee]=ie<Z?F:this.methodFactory(ee,Z,this.name)}if(this.log=this.debug,typeof console===U&&Z<this.levels.SILENT)return"No console available for logging"}function z(Z){return function(){typeof console!==U&&(Q.call(this),this[Z].apply(this,arguments))}}function H(Z,ie,ee){return G(Z)||z.apply(this,arguments)}function Y(Z,ie){var ee=this,te,re,ne,se="loglevel";typeof Z=="string"?se+=":"+Z:typeof Z=="symbol"&&(se=void 0);function oe(ae){var ye=(V[ae]||"silent").toUpperCase();if(!(typeof window===U||!se)){try{window.localStorage[se]=ye;return}catch{}try{window.document.cookie=encodeURIComponent(se)+"="+ye+";"}catch{}}}function fe(){var ae;if(!(typeof window===U||!se)){try{ae=window.localStorage[se]}catch{}if(typeof ae===U)try{var ye=window.document.cookie,Ce=encodeURIComponent(se),me=ye.indexOf(Ce+"=");me!==-1&&(ae=/^([^;]+)/.exec(ye.slice(me+Ce.length+1))[1])}catch{}return ee.levels[ae]===void 0&&(ae=void 0),ae}}function pe(){if(!(typeof window===U||!se)){try{window.localStorage.removeItem(se)}catch{}try{window.document.cookie=encodeURIComponent(se)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function le(ae){var ye=ae;if(typeof ye=="string"&&ee.levels[ye.toUpperCase()]!==void 0&&(ye=ee.levels[ye.toUpperCase()]),typeof ye=="number"&&ye>=0&&ye<=ee.levels.SILENT)return ye;throw new TypeError("log.setLevel() called with invalid level: "+ae)}ee.name=Z,ee.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},ee.methodFactory=ie||H,ee.getLevel=function(){return ne??re??te},ee.setLevel=function(ae,ye){return ne=le(ae),ye!==!1&&oe(ne),Q.call(ee)},ee.setDefaultLevel=function(ae){re=le(ae),fe()||ee.setLevel(ae,!1)},ee.resetLevel=function(){ne=null,pe(),Q.call(ee)},ee.enableAll=function(ae){ee.setLevel(ee.levels.TRACE,ae)},ee.disableAll=function(ae){ee.setLevel(ee.levels.SILENT,ae)},ee.rebuild=function(){if($!==ee&&(te=le($.getLevel())),Q.call(ee),$===ee)for(var ae in j)j[ae].rebuild()},te=le($?$.getLevel():"WARN");var he=fe();he!=null&&(ne=le(he)),Q.call(ee)}$=new Y,$.getLogger=function(ie){if(typeof ie!="symbol"&&typeof ie!="string"||ie==="")throw new TypeError("You must supply a name when creating a logger.");var ee=j[ie];return ee||(ee=j[ie]=new Y(ie,$.methodFactory)),ee};var X=typeof window!==U?window.log:void 0;return $.noConflict=function(){return typeof window!==U&&window.log===$&&(window.log=X),$},$.getLoggers=function(){return j},$.default=$,$})}(loglevel$1)),loglevel$1.exports}var loglevelExports=requireLoglevel(),LogLevel;(function(B){B[B.trace=0]="trace",B[B.debug=1]="debug",B[B.info=2]="info",B[B.warn=3]="warn",B[B.error=4]="error",B[B.silent=5]="silent"})(LogLevel||(LogLevel={}));var LoggerNames;(function(B){B.Default="livekit",B.Room="livekit-room",B.Participant="livekit-participant",B.Track="livekit-track",B.Publication="livekit-track-publication",B.Engine="livekit-engine",B.Signal="livekit-signal",B.PCManager="livekit-pc-manager",B.PCTransport="livekit-pc-transport",B.E2EE="lk-e2ee"})(LoggerNames||(LoggerNames={}));let livekitLogger=loglevelExports.getLogger("livekit");Object.values(LoggerNames).map(B=>loglevelExports.getLogger(B)),livekitLogger.setDefaultLevel(LogLevel.info);function getLogger(B){const F=loglevelExports.getLogger(B);return F.setDefaultLevel(livekitLogger.getLevel()),F}const workerLogger=loglevelExports.getLogger("lk-e2ee"),maxRetryDelay=7e3,DEFAULT_RETRY_DELAYS_IN_MS=[0,300,2*2*300,3*3*300,4*4*300,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay];class DefaultReconnectPolicy{constructor(F){this._retryDelays=F!==void 0?[...F]:DEFAULT_RETRY_DELAYS_IN_MS}nextRetryDelayInMs(F){if(F.retryCount>=this._retryDelays.length)return null;const U=this._retryDelays[F.retryCount];return F.retryCount<=1?U:U+Math.random()*1e3}}function __rest(B,F){var U={};for(var q in B)Object.prototype.hasOwnProperty.call(B,q)&&F.indexOf(q)<0&&(U[q]=B[q]);if(B!=null&&typeof Object.getOwnPropertySymbols=="function")for(var V=0,q=Object.getOwnPropertySymbols(B);V<q.length;V++)F.indexOf(q[V])<0&&Object.prototype.propertyIsEnumerable.call(B,q[V])&&(U[q[V]]=B[q[V]]);return U}function __awaiter$1(B,F,U,q){function V(j){return j instanceof U?j:new U(function($){$(j)})}return new(U||(U=Promise))(function(j,$){function W(Q){try{G(q.next(Q))}catch(z){$(z)}}function K(Q){try{G(q.throw(Q))}catch(z){$(z)}}function G(Q){Q.done?j(Q.value):V(Q.value).then(W,K)}G((q=q.apply(B,F||[])).next())})}function __values(B){var F=typeof Symbol=="function"&&Symbol.iterator,U=F&&B[F],q=0;if(U)return U.call(B);if(B&&typeof B.length=="number")return{next:function(){return B&&q>=B.length&&(B=void 0),{value:B&&B[q++],done:!B}}};throw new TypeError(F?"Object is not iterable.":"Symbol.iterator is not defined.")}function __asyncValues(B){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var F=B[Symbol.asyncIterator],U;return F?F.call(B):(B=typeof __values=="function"?__values(B):B[Symbol.iterator](),U={},q("next"),q("throw"),q("return"),U[Symbol.asyncIterator]=function(){return this},U);function q(j){U[j]=B[j]&&function($){return new Promise(function(W,K){$=B[j]($),V(W,K,$.done,$.value)})}}function V(j,$,W,K){Promise.resolve(K).then(function(G){j({value:G,done:W})},$)}}typeof SuppressedError=="function"&&SuppressedError;var events={exports:{}},hasRequiredEvents;function requireEvents(){if(hasRequiredEvents)return events.exports;hasRequiredEvents=1;var B=typeof Reflect=="object"?Reflect:null,F=B&&typeof B.apply=="function"?B.apply:function(se,oe,fe){return Function.prototype.apply.call(se,oe,fe)},U;B&&typeof B.ownKeys=="function"?U=B.ownKeys:Object.getOwnPropertySymbols?U=function(se){return Object.getOwnPropertyNames(se).concat(Object.getOwnPropertySymbols(se))}:U=function(se){return Object.getOwnPropertyNames(se)};function q(ne){console&&console.warn&&console.warn(ne)}var V=Number.isNaN||function(se){return se!==se};function j(){j.init.call(this)}events.exports=j,events.exports.once=ee,j.EventEmitter=j,j.prototype._events=void 0,j.prototype._eventsCount=0,j.prototype._maxListeners=void 0;var $=10;function W(ne){if(typeof ne!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof ne)}Object.defineProperty(j,"defaultMaxListeners",{enumerable:!0,get:function(){return $},set:function(ne){if(typeof ne!="number"||ne<0||V(ne))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+ne+".");$=ne}}),j.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},j.prototype.setMaxListeners=function(se){if(typeof se!="number"||se<0||V(se))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+se+".");return this._maxListeners=se,this};function K(ne){return ne._maxListeners===void 0?j.defaultMaxListeners:ne._maxListeners}j.prototype.getMaxListeners=function(){return K(this)},j.prototype.emit=function(se){for(var oe=[],fe=1;fe<arguments.length;fe++)oe.push(arguments[fe]);var pe=se==="error",le=this._events;if(le!==void 0)pe=pe&&le.error===void 0;else if(!pe)return!1;if(pe){var he;if(oe.length>0&&(he=oe[0]),he instanceof Error)throw he;var ae=new Error("Unhandled error."+(he?" ("+he.message+")":""));throw ae.context=he,ae}var ye=le[se];if(ye===void 0)return!1;if(typeof ye=="function")F(ye,this,oe);else for(var Ce=ye.length,me=X(ye,Ce),fe=0;fe<Ce;++fe)F(me[fe],this,oe);return!0};function G(ne,se,oe,fe){var pe,le,he;if(W(oe),le=ne._events,le===void 0?(le=ne._events=Object.create(null),ne._eventsCount=0):(le.newListener!==void 0&&(ne.emit("newListener",se,oe.listener?oe.listener:oe),le=ne._events),he=le[se]),he===void 0)he=le[se]=oe,++ne._eventsCount;else if(typeof he=="function"?he=le[se]=fe?[oe,he]:[he,oe]:fe?he.unshift(oe):he.push(oe),pe=K(ne),pe>0&&he.length>pe&&!he.warned){he.warned=!0;var ae=new Error("Possible EventEmitter memory leak detected. "+he.length+" "+String(se)+" listeners added. Use emitter.setMaxListeners() to increase limit");ae.name="MaxListenersExceededWarning",ae.emitter=ne,ae.type=se,ae.count=he.length,q(ae)}return ne}j.prototype.addListener=function(se,oe){return G(this,se,oe,!1)},j.prototype.on=j.prototype.addListener,j.prototype.prependListener=function(se,oe){return G(this,se,oe,!0)};function Q(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function z(ne,se,oe){var fe={fired:!1,wrapFn:void 0,target:ne,type:se,listener:oe},pe=Q.bind(fe);return pe.listener=oe,fe.wrapFn=pe,pe}j.prototype.once=function(se,oe){return W(oe),this.on(se,z(this,se,oe)),this},j.prototype.prependOnceListener=function(se,oe){return W(oe),this.prependListener(se,z(this,se,oe)),this},j.prototype.removeListener=function(se,oe){var fe,pe,le,he,ae;if(W(oe),pe=this._events,pe===void 0)return this;if(fe=pe[se],fe===void 0)return this;if(fe===oe||fe.listener===oe)--this._eventsCount===0?this._events=Object.create(null):(delete pe[se],pe.removeListener&&this.emit("removeListener",se,fe.listener||oe));else if(typeof fe!="function"){for(le=-1,he=fe.length-1;he>=0;he--)if(fe[he]===oe||fe[he].listener===oe){ae=fe[he].listener,le=he;break}if(le<0)return this;le===0?fe.shift():Z(fe,le),fe.length===1&&(pe[se]=fe[0]),pe.removeListener!==void 0&&this.emit("removeListener",se,ae||oe)}return this},j.prototype.off=j.prototype.removeListener,j.prototype.removeAllListeners=function(se){var oe,fe,pe;if(fe=this._events,fe===void 0)return this;if(fe.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):fe[se]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete fe[se]),this;if(arguments.length===0){var le=Object.keys(fe),he;for(pe=0;pe<le.length;++pe)he=le[pe],he!=="removeListener"&&this.removeAllListeners(he);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(oe=fe[se],typeof oe=="function")this.removeListener(se,oe);else if(oe!==void 0)for(pe=oe.length-1;pe>=0;pe--)this.removeListener(se,oe[pe]);return this};function H(ne,se,oe){var fe=ne._events;if(fe===void 0)return[];var pe=fe[se];return pe===void 0?[]:typeof pe=="function"?oe?[pe.listener||pe]:[pe]:oe?ie(pe):X(pe,pe.length)}j.prototype.listeners=function(se){return H(this,se,!0)},j.prototype.rawListeners=function(se){return H(this,se,!1)},j.listenerCount=function(ne,se){return typeof ne.listenerCount=="function"?ne.listenerCount(se):Y.call(ne,se)},j.prototype.listenerCount=Y;function Y(ne){var se=this._events;if(se!==void 0){var oe=se[ne];if(typeof oe=="function")return 1;if(oe!==void 0)return oe.length}return 0}j.prototype.eventNames=function(){return this._eventsCount>0?U(this._events):[]};function X(ne,se){for(var oe=new Array(se),fe=0;fe<se;++fe)oe[fe]=ne[fe];return oe}function Z(ne,se){for(;se+1<ne.length;se++)ne[se]=ne[se+1];ne.pop()}function ie(ne){for(var se=new Array(ne.length),oe=0;oe<se.length;++oe)se[oe]=ne[oe].listener||ne[oe];return se}function ee(ne,se){return new Promise(function(oe,fe){function pe(he){ne.removeListener(se,le),fe(he)}function le(){typeof ne.removeListener=="function"&&ne.removeListener("error",pe),oe([].slice.call(arguments))}re(ne,se,le,{once:!0}),se!=="error"&&te(ne,pe,{once:!0})})}function te(ne,se,oe){typeof ne.on=="function"&&re(ne,"error",se,oe)}function re(ne,se,oe,fe){if(typeof ne.on=="function")fe.once?ne.once(se,oe):ne.on(se,oe);else if(typeof ne.addEventListener=="function")ne.addEventListener(se,function pe(le){fe.once&&ne.removeEventListener(se,pe),oe(le)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof ne)}return events.exports}var eventsExports=requireEvents();let logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(B,F,U){const q=B.match(F);return q&&q.length>=U&&parseFloat(q[U],10)}function wrapPeerConnectionEvent(B,F,U){if(!B.RTCPeerConnection)return;const q=B.RTCPeerConnection.prototype,V=q.addEventListener;q.addEventListener=function($,W){if($!==F)return V.apply(this,arguments);const K=G=>{const Q=U(G);Q&&(W.handleEvent?W.handleEvent(Q):W(Q))};return this._eventMap=this._eventMap||{},this._eventMap[F]||(this._eventMap[F]=new Map),this._eventMap[F].set(W,K),V.apply(this,[$,K])};const j=q.removeEventListener;q.removeEventListener=function($,W){if($!==F||!this._eventMap||!this._eventMap[F])return j.apply(this,arguments);if(!this._eventMap[F].has(W))return j.apply(this,arguments);const K=this._eventMap[F].get(W);return this._eventMap[F].delete(W),this._eventMap[F].size===0&&delete this._eventMap[F],Object.keys(this._eventMap).length===0&&delete this._eventMap,j.apply(this,[$,K])},Object.defineProperty(q,"on"+F,{get(){return this["_on"+F]},set($){this["_on"+F]&&(this.removeEventListener(F,this["_on"+F]),delete this["_on"+F]),$&&this.addEventListener(F,this["_on"+F]=$)},enumerable:!0,configurable:!0})}function disableLog(B){return typeof B!="boolean"?new Error("Argument type: "+typeof B+". Please use a boolean."):(logDisabled_=B,B?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings(B){return typeof B!="boolean"?new Error("Argument type: "+typeof B+". Please use a boolean."):(deprecationWarnings_=!B,"adapter.js deprecation warnings "+(B?"disabled":"enabled"))}function log(){if(typeof window=="object"){if(logDisabled_)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function deprecated(B,F){deprecationWarnings_&&console.warn(B+" is deprecated, please use "+F+" instead.")}function detectBrowser(B){const F={browser:null,version:null};if(typeof B>"u"||!B.navigator||!B.navigator.userAgent)return F.browser="Not a browser.",F;const{navigator:U}=B;if(U.userAgentData&&U.userAgentData.brands){const q=U.userAgentData.brands.find(V=>V.brand==="Chromium");if(q)return{browser:"chrome",version:parseInt(q.version,10)}}if(U.mozGetUserMedia)F.browser="firefox",F.version=parseInt(extractVersion(U.userAgent,/Firefox\/(\d+)\./,1));else if(U.webkitGetUserMedia||B.isSecureContext===!1&&B.webkitRTCPeerConnection)F.browser="chrome",F.version=parseInt(extractVersion(U.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(B.RTCPeerConnection&&U.userAgent.match(/AppleWebKit\/(\d+)\./))F.browser="safari",F.version=parseInt(extractVersion(U.userAgent,/AppleWebKit\/(\d+)\./,1)),F.supportsUnifiedPlan=B.RTCRtpTransceiver&&"currentDirection"in B.RTCRtpTransceiver.prototype,F._safariVersion=extractVersion(U.userAgent,/Version\/(\d+(\.?\d+))/,1);else return F.browser="Not a supported browser.",F;return F}function isObject(B){return Object.prototype.toString.call(B)==="[object Object]"}function compactObject(B){return isObject(B)?Object.keys(B).reduce(function(F,U){const q=isObject(B[U]),V=q?compactObject(B[U]):B[U],j=q&&!Object.keys(V).length;return V===void 0||j?F:Object.assign(F,{[U]:V})},{}):B}function walkStats(B,F,U){!F||U.has(F.id)||(U.set(F.id,F),Object.keys(F).forEach(q=>{q.endsWith("Id")?walkStats(B,B.get(F[q]),U):q.endsWith("Ids")&&F[q].forEach(V=>{walkStats(B,B.get(V),U)})}))}function filterStats(B,F,U){const q=U?"outbound-rtp":"inbound-rtp",V=new Map;if(F===null)return V;const j=[];return B.forEach($=>{$.type==="track"&&$.trackIdentifier===F.id&&j.push($)}),j.forEach($=>{B.forEach(W=>{W.type===q&&W.trackId===$.id&&walkStats(B,W,V)})}),V}const logging=log;function shimGetUserMedia$2(B,F){const U=B&&B.navigator;if(!U.mediaDevices)return;const q=function(W){if(typeof W!="object"||W.mandatory||W.optional)return W;const K={};return Object.keys(W).forEach(G=>{if(G==="require"||G==="advanced"||G==="mediaSource")return;const Q=typeof W[G]=="object"?W[G]:{ideal:W[G]};Q.exact!==void 0&&typeof Q.exact=="number"&&(Q.min=Q.max=Q.exact);const z=function(H,Y){return H?H+Y.charAt(0).toUpperCase()+Y.slice(1):Y==="deviceId"?"sourceId":Y};if(Q.ideal!==void 0){K.optional=K.optional||[];let H={};typeof Q.ideal=="number"?(H[z("min",G)]=Q.ideal,K.optional.push(H),H={},H[z("max",G)]=Q.ideal,K.optional.push(H)):(H[z("",G)]=Q.ideal,K.optional.push(H))}Q.exact!==void 0&&typeof Q.exact!="number"?(K.mandatory=K.mandatory||{},K.mandatory[z("",G)]=Q.exact):["min","max"].forEach(H=>{Q[H]!==void 0&&(K.mandatory=K.mandatory||{},K.mandatory[z(H,G)]=Q[H])})}),W.advanced&&(K.optional=(K.optional||[]).concat(W.advanced)),K},V=function(W,K){if(F.version>=61)return K(W);if(W=JSON.parse(JSON.stringify(W)),W&&typeof W.audio=="object"){const G=function(Q,z,H){z in Q&&!(H in Q)&&(Q[H]=Q[z],delete Q[z])};W=JSON.parse(JSON.stringify(W)),G(W.audio,"autoGainControl","googAutoGainControl"),G(W.audio,"noiseSuppression","googNoiseSuppression"),W.audio=q(W.audio)}if(W&&typeof W.video=="object"){let G=W.video.facingMode;G=G&&(typeof G=="object"?G:{ideal:G});const Q=F.version<66;if(G&&(G.exact==="user"||G.exact==="environment"||G.ideal==="user"||G.ideal==="environment")&&!(U.mediaDevices.getSupportedConstraints&&U.mediaDevices.getSupportedConstraints().facingMode&&!Q)){delete W.video.facingMode;let z;if(G.exact==="environment"||G.ideal==="environment"?z=["back","rear"]:(G.exact==="user"||G.ideal==="user")&&(z=["front"]),z)return U.mediaDevices.enumerateDevices().then(H=>{H=H.filter(X=>X.kind==="videoinput");let Y=H.find(X=>z.some(Z=>X.label.toLowerCase().includes(Z)));return!Y&&H.length&&z.includes("back")&&(Y=H[H.length-1]),Y&&(W.video.deviceId=G.exact?{exact:Y.deviceId}:{ideal:Y.deviceId}),W.video=q(W.video),logging("chrome: "+JSON.stringify(W)),K(W)})}W.video=q(W.video)}return logging("chrome: "+JSON.stringify(W)),K(W)},j=function(W){return F.version>=64?W:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[W.name]||W.name,message:W.message,constraint:W.constraint||W.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},$=function(W,K,G){V(W,Q=>{U.webkitGetUserMedia(Q,K,z=>{G&&G(j(z))})})};if(U.getUserMedia=$.bind(U),U.mediaDevices.getUserMedia){const W=U.mediaDevices.getUserMedia.bind(U.mediaDevices);U.mediaDevices.getUserMedia=function(K){return V(K,G=>W(G).then(Q=>{if(G.audio&&!Q.getAudioTracks().length||G.video&&!Q.getVideoTracks().length)throw Q.getTracks().forEach(z=>{z.stop()}),new DOMException("","NotFoundError");return Q},Q=>Promise.reject(j(Q))))}}}function shimMediaStream(B){B.MediaStream=B.MediaStream||B.webkitMediaStream}function shimOnTrack$1(B){if(typeof B=="object"&&B.RTCPeerConnection&&!("ontrack"in B.RTCPeerConnection.prototype)){Object.defineProperty(B.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(U){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=U)},enumerable:!0,configurable:!0});const F=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=q=>{q.stream.addEventListener("addtrack",V=>{let j;B.RTCPeerConnection.prototype.getReceivers?j=this.getReceivers().find(W=>W.track&&W.track.id===V.track.id):j={track:V.track};const $=new Event("track");$.track=V.track,$.receiver=j,$.transceiver={receiver:j},$.streams=[q.stream],this.dispatchEvent($)}),q.stream.getTracks().forEach(V=>{let j;B.RTCPeerConnection.prototype.getReceivers?j=this.getReceivers().find(W=>W.track&&W.track.id===V.id):j={track:V};const $=new Event("track");$.track=V,$.receiver=j,$.transceiver={receiver:j},$.streams=[q.stream],this.dispatchEvent($)})},this.addEventListener("addstream",this._ontrackpoly)),F.apply(this,arguments)}}else wrapPeerConnectionEvent(B,"track",F=>(F.transceiver||Object.defineProperty(F,"transceiver",{value:{receiver:F.receiver}}),F))}function shimGetSendersWithDtmf(B){if(typeof B=="object"&&B.RTCPeerConnection&&!("getSenders"in B.RTCPeerConnection.prototype)&&"createDTMFSender"in B.RTCPeerConnection.prototype){const F=function(V,j){return{track:j,get dtmf(){return this._dtmf===void 0&&(j.kind==="audio"?this._dtmf=V.createDTMFSender(j):this._dtmf=null),this._dtmf},_pc:V}};if(!B.RTCPeerConnection.prototype.getSenders){B.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const V=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addTrack=function(W,K){let G=V.apply(this,arguments);return G||(G=F(this,W),this._senders.push(G)),G};const j=B.RTCPeerConnection.prototype.removeTrack;B.RTCPeerConnection.prototype.removeTrack=function(W){j.apply(this,arguments);const K=this._senders.indexOf(W);K!==-1&&this._senders.splice(K,1)}}const U=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(j){this._senders=this._senders||[],U.apply(this,[j]),j.getTracks().forEach($=>{this._senders.push(F(this,$))})};const q=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(j){this._senders=this._senders||[],q.apply(this,[j]),j.getTracks().forEach($=>{const W=this._senders.find(K=>K.track===$);W&&this._senders.splice(this._senders.indexOf(W),1)})}}else if(typeof B=="object"&&B.RTCPeerConnection&&"getSenders"in B.RTCPeerConnection.prototype&&"createDTMFSender"in B.RTCPeerConnection.prototype&&B.RTCRtpSender&&!("dtmf"in B.RTCRtpSender.prototype)){const F=B.RTCPeerConnection.prototype.getSenders;B.RTCPeerConnection.prototype.getSenders=function(){const q=F.apply(this,[]);return q.forEach(V=>V._pc=this),q},Object.defineProperty(B.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimSenderReceiverGetStats(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender&&B.RTCRtpReceiver))return;if(!("getStats"in B.RTCRtpSender.prototype)){const U=B.RTCPeerConnection.prototype.getSenders;U&&(B.RTCPeerConnection.prototype.getSenders=function(){const j=U.apply(this,[]);return j.forEach($=>$._pc=this),j});const q=B.RTCPeerConnection.prototype.addTrack;q&&(B.RTCPeerConnection.prototype.addTrack=function(){const j=q.apply(this,arguments);return j._pc=this,j}),B.RTCRtpSender.prototype.getStats=function(){const j=this;return this._pc.getStats().then($=>filterStats($,j.track,!0))}}if(!("getStats"in B.RTCRtpReceiver.prototype)){const U=B.RTCPeerConnection.prototype.getReceivers;U&&(B.RTCPeerConnection.prototype.getReceivers=function(){const V=U.apply(this,[]);return V.forEach(j=>j._pc=this),V}),wrapPeerConnectionEvent(B,"track",q=>(q.receiver._pc=q.srcElement,q)),B.RTCRtpReceiver.prototype.getStats=function(){const V=this;return this._pc.getStats().then(j=>filterStats(j,V.track,!1))}}if(!("getStats"in B.RTCRtpSender.prototype&&"getStats"in B.RTCRtpReceiver.prototype))return;const F=B.RTCPeerConnection.prototype.getStats;B.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof B.MediaStreamTrack){const q=arguments[0];let V,j,$;return this.getSenders().forEach(W=>{W.track===q&&(V?$=!0:V=W)}),this.getReceivers().forEach(W=>(W.track===q&&(j?$=!0:j=W),W.track===q)),$||V&&j?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):V?V.getStats():j?j.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return F.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(B){B.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map($=>this._shimmedLocalStreams[$][0])};const F=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addTrack=function($,W){if(!W)return F.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const K=F.apply(this,arguments);return this._shimmedLocalStreams[W.id]?this._shimmedLocalStreams[W.id].indexOf(K)===-1&&this._shimmedLocalStreams[W.id].push(K):this._shimmedLocalStreams[W.id]=[W,K],K};const U=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function($){this._shimmedLocalStreams=this._shimmedLocalStreams||{},$.getTracks().forEach(G=>{if(this.getSenders().find(z=>z.track===G))throw new DOMException("Track already exists.","InvalidAccessError")});const W=this.getSenders();U.apply(this,arguments);const K=this.getSenders().filter(G=>W.indexOf(G)===-1);this._shimmedLocalStreams[$.id]=[$].concat(K)};const q=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function($){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[$.id],q.apply(this,arguments)};const V=B.RTCPeerConnection.prototype.removeTrack;B.RTCPeerConnection.prototype.removeTrack=function($){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},$&&Object.keys(this._shimmedLocalStreams).forEach(W=>{const K=this._shimmedLocalStreams[W].indexOf($);K!==-1&&this._shimmedLocalStreams[W].splice(K,1),this._shimmedLocalStreams[W].length===1&&delete this._shimmedLocalStreams[W]}),V.apply(this,arguments)}}function shimAddTrackRemoveTrack(B,F){if(!B.RTCPeerConnection)return;if(B.RTCPeerConnection.prototype.addTrack&&F.version>=65)return shimAddTrackRemoveTrackWithNative(B);const U=B.RTCPeerConnection.prototype.getLocalStreams;B.RTCPeerConnection.prototype.getLocalStreams=function(){const Q=U.apply(this);return this._reverseStreams=this._reverseStreams||{},Q.map(z=>this._reverseStreams[z.id])};const q=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(Q){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},Q.getTracks().forEach(z=>{if(this.getSenders().find(Y=>Y.track===z))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[Q.id]){const z=new B.MediaStream(Q.getTracks());this._streams[Q.id]=z,this._reverseStreams[z.id]=Q,Q=z}q.apply(this,[Q])};const V=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(Q){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},V.apply(this,[this._streams[Q.id]||Q]),delete this._reverseStreams[this._streams[Q.id]?this._streams[Q.id].id:Q.id],delete this._streams[Q.id]},B.RTCPeerConnection.prototype.addTrack=function(Q,z){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const H=[].slice.call(arguments,1);if(H.length!==1||!H[0].getTracks().find(Z=>Z===Q))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(Z=>Z.track===Q))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const X=this._streams[z.id];if(X)X.addTrack(Q),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const Z=new B.MediaStream([Q]);this._streams[z.id]=Z,this._reverseStreams[Z.id]=z,this.addStream(Z)}return this.getSenders().find(Z=>Z.track===Q)};function j(G,Q){let z=Q.sdp;return Object.keys(G._reverseStreams||[]).forEach(H=>{const Y=G._reverseStreams[H],X=G._streams[Y.id];z=z.replace(new RegExp(X.id,"g"),Y.id)}),new RTCSessionDescription({type:Q.type,sdp:z})}function $(G,Q){let z=Q.sdp;return Object.keys(G._reverseStreams||[]).forEach(H=>{const Y=G._reverseStreams[H],X=G._streams[Y.id];z=z.replace(new RegExp(Y.id,"g"),X.id)}),new RTCSessionDescription({type:Q.type,sdp:z})}["createOffer","createAnswer"].forEach(function(G){const Q=B.RTCPeerConnection.prototype[G],z={[G](){const H=arguments;return arguments.length&&typeof arguments[0]=="function"?Q.apply(this,[X=>{const Z=j(this,X);H[0].apply(null,[Z])},X=>{H[1]&&H[1].apply(null,X)},arguments[2]]):Q.apply(this,arguments).then(X=>j(this,X))}};B.RTCPeerConnection.prototype[G]=z[G]});const W=B.RTCPeerConnection.prototype.setLocalDescription;B.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?W.apply(this,arguments):(arguments[0]=$(this,arguments[0]),W.apply(this,arguments))};const K=Object.getOwnPropertyDescriptor(B.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(B.RTCPeerConnection.prototype,"localDescription",{get(){const G=K.get.apply(this);return G.type===""?G:j(this,G)}}),B.RTCPeerConnection.prototype.removeTrack=function(Q){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!Q._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(Q._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let H;Object.keys(this._streams).forEach(Y=>{this._streams[Y].getTracks().find(Z=>Q.track===Z)&&(H=this._streams[Y])}),H&&(H.getTracks().length===1?this.removeStream(this._reverseStreams[H.id]):H.removeTrack(Q.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection$1(B,F){!B.RTCPeerConnection&&B.webkitRTCPeerConnection&&(B.RTCPeerConnection=B.webkitRTCPeerConnection),B.RTCPeerConnection&&F.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(U){const q=B.RTCPeerConnection.prototype[U],V={[U](){return arguments[0]=new(U==="addIceCandidate"?B.RTCIceCandidate:B.RTCSessionDescription)(arguments[0]),q.apply(this,arguments)}};B.RTCPeerConnection.prototype[U]=V[U]})}function fixNegotiationNeeded(B,F){wrapPeerConnectionEvent(B,"negotiationneeded",U=>{const q=U.target;if(!((F.version<72||q.getConfiguration&&q.getConfiguration().sdpSemantics==="plan-b")&&q.signalingState!=="stable"))return U})}var chromeShim=Object.freeze({__proto__:null,fixNegotiationNeeded,shimAddTrackRemoveTrack,shimAddTrackRemoveTrackWithNative,shimGetSendersWithDtmf,shimGetUserMedia:shimGetUserMedia$2,shimMediaStream,shimOnTrack:shimOnTrack$1,shimPeerConnection:shimPeerConnection$1,shimSenderReceiverGetStats});function shimGetUserMedia$1(B,F){const U=B&&B.navigator,q=B&&B.MediaStreamTrack;if(U.getUserMedia=function(V,j,$){deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),U.mediaDevices.getUserMedia(V).then(j,$)},!(F.version>55&&"autoGainControl"in U.mediaDevices.getSupportedConstraints())){const V=function($,W,K){W in $&&!(K in $)&&($[K]=$[W],delete $[W])},j=U.mediaDevices.getUserMedia.bind(U.mediaDevices);if(U.mediaDevices.getUserMedia=function($){return typeof $=="object"&&typeof $.audio=="object"&&($=JSON.parse(JSON.stringify($)),V($.audio,"autoGainControl","mozAutoGainControl"),V($.audio,"noiseSuppression","mozNoiseSuppression")),j($)},q&&q.prototype.getSettings){const $=q.prototype.getSettings;q.prototype.getSettings=function(){const W=$.apply(this,arguments);return V(W,"mozAutoGainControl","autoGainControl"),V(W,"mozNoiseSuppression","noiseSuppression"),W}}if(q&&q.prototype.applyConstraints){const $=q.prototype.applyConstraints;q.prototype.applyConstraints=function(W){return this.kind==="audio"&&typeof W=="object"&&(W=JSON.parse(JSON.stringify(W)),V(W,"autoGainControl","mozAutoGainControl"),V(W,"noiseSuppression","mozNoiseSuppression")),$.apply(this,[W])}}}}function shimGetDisplayMedia(B,F){B.navigator.mediaDevices&&"getDisplayMedia"in B.navigator.mediaDevices||B.navigator.mediaDevices&&(B.navigator.mediaDevices.getDisplayMedia=function(q){if(!(q&&q.video)){const V=new DOMException("getDisplayMedia without video constraints is undefined");return V.name="NotFoundError",V.code=8,Promise.reject(V)}return q.video===!0?q.video={mediaSource:F}:q.video.mediaSource=F,B.navigator.mediaDevices.getUserMedia(q)})}function shimOnTrack(B){typeof B=="object"&&B.RTCTrackEvent&&"receiver"in B.RTCTrackEvent.prototype&&!("transceiver"in B.RTCTrackEvent.prototype)&&Object.defineProperty(B.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimPeerConnection(B,F){if(typeof B!="object"||!(B.RTCPeerConnection||B.mozRTCPeerConnection))return;!B.RTCPeerConnection&&B.mozRTCPeerConnection&&(B.RTCPeerConnection=B.mozRTCPeerConnection),F.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(V){const j=B.RTCPeerConnection.prototype[V],$={[V](){return arguments[0]=new(V==="addIceCandidate"?B.RTCIceCandidate:B.RTCSessionDescription)(arguments[0]),j.apply(this,arguments)}};B.RTCPeerConnection.prototype[V]=$[V]});const U={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},q=B.RTCPeerConnection.prototype.getStats;B.RTCPeerConnection.prototype.getStats=function(){const[j,$,W]=arguments;return q.apply(this,[j||null]).then(K=>{if(F.version<53&&!$)try{K.forEach(G=>{G.type=U[G.type]||G.type})}catch(G){if(G.name!=="TypeError")throw G;K.forEach((Q,z)=>{K.set(z,Object.assign({},Q,{type:U[Q.type]||Q.type}))})}return K}).then($,W)}}function shimSenderGetStats(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender)||B.RTCRtpSender&&"getStats"in B.RTCRtpSender.prototype)return;const F=B.RTCPeerConnection.prototype.getSenders;F&&(B.RTCPeerConnection.prototype.getSenders=function(){const V=F.apply(this,[]);return V.forEach(j=>j._pc=this),V});const U=B.RTCPeerConnection.prototype.addTrack;U&&(B.RTCPeerConnection.prototype.addTrack=function(){const V=U.apply(this,arguments);return V._pc=this,V}),B.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender)||B.RTCRtpSender&&"getStats"in B.RTCRtpReceiver.prototype)return;const F=B.RTCPeerConnection.prototype.getReceivers;F&&(B.RTCPeerConnection.prototype.getReceivers=function(){const q=F.apply(this,[]);return q.forEach(V=>V._pc=this),q}),wrapPeerConnectionEvent(B,"track",U=>(U.receiver._pc=U.srcElement,U)),B.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream(B){!B.RTCPeerConnection||"removeStream"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.removeStream=function(U){deprecated("removeStream","removeTrack"),this.getSenders().forEach(q=>{q.track&&U.getTracks().includes(q.track)&&this.removeTrack(q)})})}function shimRTCDataChannel(B){B.DataChannel&&!B.RTCDataChannel&&(B.RTCDataChannel=B.DataChannel)}function shimAddTransceiver(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const F=B.RTCPeerConnection.prototype.addTransceiver;F&&(B.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let q=arguments[1]&&arguments[1].sendEncodings;q===void 0&&(q=[]),q=[...q];const V=q.length>0;V&&q.forEach($=>{if("rid"in $&&!/^[a-z0-9]{0,16}$/i.test($.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in $&&!(parseFloat($.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in $&&!(parseFloat($.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const j=F.apply(this,arguments);if(V){const{sender:$}=j,W=$.getParameters();(!("encodings"in W)||W.encodings.length===1&&Object.keys(W.encodings[0]).length===0)&&(W.encodings=q,$.sendEncodings=q,this.setParametersPromises.push($.setParameters(W).then(()=>{delete $.sendEncodings}).catch(()=>{delete $.sendEncodings})))}return j})}function shimGetParameters(B){if(!(typeof B=="object"&&B.RTCRtpSender))return;const F=B.RTCRtpSender.prototype.getParameters;F&&(B.RTCRtpSender.prototype.getParameters=function(){const q=F.apply(this,arguments);return"encodings"in q||(q.encodings=[].concat(this.sendEncodings||[{}])),q})}function shimCreateOffer(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const F=B.RTCPeerConnection.prototype.createOffer;B.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>F.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):F.apply(this,arguments)}}function shimCreateAnswer(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const F=B.RTCPeerConnection.prototype.createAnswer;B.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>F.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):F.apply(this,arguments)}}var firefoxShim=Object.freeze({__proto__:null,shimAddTransceiver,shimCreateAnswer,shimCreateOffer,shimGetDisplayMedia,shimGetParameters,shimGetUserMedia:shimGetUserMedia$1,shimOnTrack,shimPeerConnection,shimRTCDataChannel,shimReceiverGetStats,shimRemoveStream,shimSenderGetStats});function shimLocalStreamsAPI(B){if(!(typeof B!="object"||!B.RTCPeerConnection)){if("getLocalStreams"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in B.RTCPeerConnection.prototype)){const F=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addStream=function(q){this._localStreams||(this._localStreams=[]),this._localStreams.includes(q)||this._localStreams.push(q),q.getAudioTracks().forEach(V=>F.call(this,V,q)),q.getVideoTracks().forEach(V=>F.call(this,V,q))},B.RTCPeerConnection.prototype.addTrack=function(q){for(var V=arguments.length,j=new Array(V>1?V-1:0),$=1;$<V;$++)j[$-1]=arguments[$];return j&&j.forEach(W=>{this._localStreams?this._localStreams.includes(W)||this._localStreams.push(W):this._localStreams=[W]}),F.apply(this,arguments)}}"removeStream"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.removeStream=function(U){this._localStreams||(this._localStreams=[]);const q=this._localStreams.indexOf(U);if(q===-1)return;this._localStreams.splice(q,1);const V=U.getTracks();this.getSenders().forEach(j=>{V.includes(j.track)&&this.removeTrack(j)})})}}function shimRemoteStreamsAPI(B){if(!(typeof B!="object"||!B.RTCPeerConnection)&&("getRemoteStreams"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in B.RTCPeerConnection.prototype))){Object.defineProperty(B.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(U){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=U),this.addEventListener("track",this._onaddstreampoly=q=>{q.streams.forEach(V=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(V))return;this._remoteStreams.push(V);const j=new Event("addstream");j.stream=V,this.dispatchEvent(j)})})}});const F=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){const q=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(V){V.streams.forEach(j=>{if(q._remoteStreams||(q._remoteStreams=[]),q._remoteStreams.indexOf(j)>=0)return;q._remoteStreams.push(j);const $=new Event("addstream");$.stream=j,q.dispatchEvent($)})}),F.apply(q,arguments)}}}function shimCallbacksAPI(B){if(typeof B!="object"||!B.RTCPeerConnection)return;const F=B.RTCPeerConnection.prototype,U=F.createOffer,q=F.createAnswer,V=F.setLocalDescription,j=F.setRemoteDescription,$=F.addIceCandidate;F.createOffer=function(G,Q){const z=arguments.length>=2?arguments[2]:arguments[0],H=U.apply(this,[z]);return Q?(H.then(G,Q),Promise.resolve()):H},F.createAnswer=function(G,Q){const z=arguments.length>=2?arguments[2]:arguments[0],H=q.apply(this,[z]);return Q?(H.then(G,Q),Promise.resolve()):H};let W=function(K,G,Q){const z=V.apply(this,[K]);return Q?(z.then(G,Q),Promise.resolve()):z};F.setLocalDescription=W,W=function(K,G,Q){const z=j.apply(this,[K]);return Q?(z.then(G,Q),Promise.resolve()):z},F.setRemoteDescription=W,W=function(K,G,Q){const z=$.apply(this,[K]);return Q?(z.then(G,Q),Promise.resolve()):z},F.addIceCandidate=W}function shimGetUserMedia(B){const F=B&&B.navigator;if(F.mediaDevices&&F.mediaDevices.getUserMedia){const U=F.mediaDevices,q=U.getUserMedia.bind(U);F.mediaDevices.getUserMedia=V=>q(shimConstraints(V))}!F.getUserMedia&&F.mediaDevices&&F.mediaDevices.getUserMedia&&(F.getUserMedia=(function(q,V,j){F.mediaDevices.getUserMedia(q).then(V,j)}).bind(F))}function shimConstraints(B){return B&&B.video!==void 0?Object.assign({},B,{video:compactObject(B.video)}):B}function shimRTCIceServerUrls(B){if(!B.RTCPeerConnection)return;const F=B.RTCPeerConnection;B.RTCPeerConnection=function(q,V){if(q&&q.iceServers){const j=[];for(let $=0;$<q.iceServers.length;$++){let W=q.iceServers[$];W.urls===void 0&&W.url?(deprecated("RTCIceServer.url","RTCIceServer.urls"),W=JSON.parse(JSON.stringify(W)),W.urls=W.url,delete W.url,j.push(W)):j.push(q.iceServers[$])}q.iceServers=j}return new F(q,V)},B.RTCPeerConnection.prototype=F.prototype,"generateCertificate"in F&&Object.defineProperty(B.RTCPeerConnection,"generateCertificate",{get(){return F.generateCertificate}})}function shimTrackEventTransceiver(B){typeof B=="object"&&B.RTCTrackEvent&&"receiver"in B.RTCTrackEvent.prototype&&!("transceiver"in B.RTCTrackEvent.prototype)&&Object.defineProperty(B.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy(B){const F=B.RTCPeerConnection.prototype.createOffer;B.RTCPeerConnection.prototype.createOffer=function(q){if(q){typeof q.offerToReceiveAudio<"u"&&(q.offerToReceiveAudio=!!q.offerToReceiveAudio);const V=this.getTransceivers().find($=>$.receiver.track.kind==="audio");q.offerToReceiveAudio===!1&&V?V.direction==="sendrecv"?V.setDirection?V.setDirection("sendonly"):V.direction="sendonly":V.direction==="recvonly"&&(V.setDirection?V.setDirection("inactive"):V.direction="inactive"):q.offerToReceiveAudio===!0&&!V&&this.addTransceiver("audio",{direction:"recvonly"}),typeof q.offerToReceiveVideo<"u"&&(q.offerToReceiveVideo=!!q.offerToReceiveVideo);const j=this.getTransceivers().find($=>$.receiver.track.kind==="video");q.offerToReceiveVideo===!1&&j?j.direction==="sendrecv"?j.setDirection?j.setDirection("sendonly"):j.direction="sendonly":j.direction==="recvonly"&&(j.setDirection?j.setDirection("inactive"):j.direction="inactive"):q.offerToReceiveVideo===!0&&!j&&this.addTransceiver("video",{direction:"recvonly"})}return F.apply(this,arguments)}}function shimAudioContext(B){typeof B!="object"||B.AudioContext||(B.AudioContext=B.webkitAudioContext)}var safariShim=Object.freeze({__proto__:null,shimAudioContext,shimCallbacksAPI,shimConstraints,shimCreateOfferLegacy,shimGetUserMedia,shimLocalStreamsAPI,shimRTCIceServerUrls,shimRemoteStreamsAPI,shimTrackEventTransceiver}),sdp$1={exports:{}},hasRequiredSdp;function requireSdp(){return hasRequiredSdp||(hasRequiredSdp=1,function(B){const F={};F.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},F.localCName=F.generateIdentifier(),F.splitLines=function(U){return U.trim().split(`
`).map(q=>q.trim())},F.splitSections=function(U){return U.split(`
m=`).map((V,j)=>(j>0?"m="+V:V).trim()+`\r
`)},F.getDescription=function(U){const q=F.splitSections(U);return q&&q[0]},F.getMediaSections=function(U){const q=F.splitSections(U);return q.shift(),q},F.matchPrefix=function(U,q){return F.splitLines(U).filter(V=>V.indexOf(q)===0)},F.parseCandidate=function(U){let q;U.indexOf("a=candidate:")===0?q=U.substring(12).split(" "):q=U.substring(10).split(" ");const V={foundation:q[0],component:{1:"rtp",2:"rtcp"}[q[1]]||q[1],protocol:q[2].toLowerCase(),priority:parseInt(q[3],10),ip:q[4],address:q[4],port:parseInt(q[5],10),type:q[7]};for(let j=8;j<q.length;j+=2)switch(q[j]){case"raddr":V.relatedAddress=q[j+1];break;case"rport":V.relatedPort=parseInt(q[j+1],10);break;case"tcptype":V.tcpType=q[j+1];break;case"ufrag":V.ufrag=q[j+1],V.usernameFragment=q[j+1];break;default:V[q[j]]===void 0&&(V[q[j]]=q[j+1]);break}return V},F.writeCandidate=function(U){const q=[];q.push(U.foundation);const V=U.component;V==="rtp"?q.push(1):V==="rtcp"?q.push(2):q.push(V),q.push(U.protocol.toUpperCase()),q.push(U.priority),q.push(U.address||U.ip),q.push(U.port);const j=U.type;return q.push("typ"),q.push(j),j!=="host"&&U.relatedAddress&&U.relatedPort&&(q.push("raddr"),q.push(U.relatedAddress),q.push("rport"),q.push(U.relatedPort)),U.tcpType&&U.protocol.toLowerCase()==="tcp"&&(q.push("tcptype"),q.push(U.tcpType)),(U.usernameFragment||U.ufrag)&&(q.push("ufrag"),q.push(U.usernameFragment||U.ufrag)),"candidate:"+q.join(" ")},F.parseIceOptions=function(U){return U.substring(14).split(" ")},F.parseRtpMap=function(U){let q=U.substring(9).split(" ");const V={payloadType:parseInt(q.shift(),10)};return q=q[0].split("/"),V.name=q[0],V.clockRate=parseInt(q[1],10),V.channels=q.length===3?parseInt(q[2],10):1,V.numChannels=V.channels,V},F.writeRtpMap=function(U){let q=U.payloadType;U.preferredPayloadType!==void 0&&(q=U.preferredPayloadType);const V=U.channels||U.numChannels||1;return"a=rtpmap:"+q+" "+U.name+"/"+U.clockRate+(V!==1?"/"+V:"")+`\r
`},F.parseExtmap=function(U){const q=U.substring(9).split(" ");return{id:parseInt(q[0],10),direction:q[0].indexOf("/")>0?q[0].split("/")[1]:"sendrecv",uri:q[1],attributes:q.slice(2).join(" ")}},F.writeExtmap=function(U){return"a=extmap:"+(U.id||U.preferredId)+(U.direction&&U.direction!=="sendrecv"?"/"+U.direction:"")+" "+U.uri+(U.attributes?" "+U.attributes:"")+`\r
`},F.parseFmtp=function(U){const q={};let V;const j=U.substring(U.indexOf(" ")+1).split(";");for(let $=0;$<j.length;$++)V=j[$].trim().split("="),q[V[0].trim()]=V[1];return q},F.writeFmtp=function(U){let q="",V=U.payloadType;if(U.preferredPayloadType!==void 0&&(V=U.preferredPayloadType),U.parameters&&Object.keys(U.parameters).length){const j=[];Object.keys(U.parameters).forEach($=>{U.parameters[$]!==void 0?j.push($+"="+U.parameters[$]):j.push($)}),q+="a=fmtp:"+V+" "+j.join(";")+`\r
`}return q},F.parseRtcpFb=function(U){const q=U.substring(U.indexOf(" ")+1).split(" ");return{type:q.shift(),parameter:q.join(" ")}},F.writeRtcpFb=function(U){let q="",V=U.payloadType;return U.preferredPayloadType!==void 0&&(V=U.preferredPayloadType),U.rtcpFeedback&&U.rtcpFeedback.length&&U.rtcpFeedback.forEach(j=>{q+="a=rtcp-fb:"+V+" "+j.type+(j.parameter&&j.parameter.length?" "+j.parameter:"")+`\r
`}),q},F.parseSsrcMedia=function(U){const q=U.indexOf(" "),V={ssrc:parseInt(U.substring(7,q),10)},j=U.indexOf(":",q);return j>-1?(V.attribute=U.substring(q+1,j),V.value=U.substring(j+1)):V.attribute=U.substring(q+1),V},F.parseSsrcGroup=function(U){const q=U.substring(13).split(" ");return{semantics:q.shift(),ssrcs:q.map(V=>parseInt(V,10))}},F.getMid=function(U){const q=F.matchPrefix(U,"a=mid:")[0];if(q)return q.substring(6)},F.parseFingerprint=function(U){const q=U.substring(14).split(" ");return{algorithm:q[0].toLowerCase(),value:q[1].toUpperCase()}},F.getDtlsParameters=function(U,q){return{role:"auto",fingerprints:F.matchPrefix(U+q,"a=fingerprint:").map(F.parseFingerprint)}},F.writeDtlsParameters=function(U,q){let V="a=setup:"+q+`\r
`;return U.fingerprints.forEach(j=>{V+="a=fingerprint:"+j.algorithm+" "+j.value+`\r
`}),V},F.parseCryptoLine=function(U){const q=U.substring(9).split(" ");return{tag:parseInt(q[0],10),cryptoSuite:q[1],keyParams:q[2],sessionParams:q.slice(3)}},F.writeCryptoLine=function(U){return"a=crypto:"+U.tag+" "+U.cryptoSuite+" "+(typeof U.keyParams=="object"?F.writeCryptoKeyParams(U.keyParams):U.keyParams)+(U.sessionParams?" "+U.sessionParams.join(" "):"")+`\r
`},F.parseCryptoKeyParams=function(U){if(U.indexOf("inline:")!==0)return null;const q=U.substring(7).split("|");return{keyMethod:"inline",keySalt:q[0],lifeTime:q[1],mkiValue:q[2]?q[2].split(":")[0]:void 0,mkiLength:q[2]?q[2].split(":")[1]:void 0}},F.writeCryptoKeyParams=function(U){return U.keyMethod+":"+U.keySalt+(U.lifeTime?"|"+U.lifeTime:"")+(U.mkiValue&&U.mkiLength?"|"+U.mkiValue+":"+U.mkiLength:"")},F.getCryptoParameters=function(U,q){return F.matchPrefix(U+q,"a=crypto:").map(F.parseCryptoLine)},F.getIceParameters=function(U,q){const V=F.matchPrefix(U+q,"a=ice-ufrag:")[0],j=F.matchPrefix(U+q,"a=ice-pwd:")[0];return V&&j?{usernameFragment:V.substring(12),password:j.substring(10)}:null},F.writeIceParameters=function(U){let q="a=ice-ufrag:"+U.usernameFragment+`\r
a=ice-pwd:`+U.password+`\r
`;return U.iceLite&&(q+=`a=ice-lite\r
`),q},F.parseRtpParameters=function(U){const q={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},j=F.splitLines(U)[0].split(" ");q.profile=j[2];for(let W=3;W<j.length;W++){const K=j[W],G=F.matchPrefix(U,"a=rtpmap:"+K+" ")[0];if(G){const Q=F.parseRtpMap(G),z=F.matchPrefix(U,"a=fmtp:"+K+" ");switch(Q.parameters=z.length?F.parseFmtp(z[0]):{},Q.rtcpFeedback=F.matchPrefix(U,"a=rtcp-fb:"+K+" ").map(F.parseRtcpFb),q.codecs.push(Q),Q.name.toUpperCase()){case"RED":case"ULPFEC":q.fecMechanisms.push(Q.name.toUpperCase());break}}}F.matchPrefix(U,"a=extmap:").forEach(W=>{q.headerExtensions.push(F.parseExtmap(W))});const $=F.matchPrefix(U,"a=rtcp-fb:* ").map(F.parseRtcpFb);return q.codecs.forEach(W=>{$.forEach(K=>{W.rtcpFeedback.find(Q=>Q.type===K.type&&Q.parameter===K.parameter)||W.rtcpFeedback.push(K)})}),q},F.writeRtpDescription=function(U,q){let V="";V+="m="+U+" ",V+=q.codecs.length>0?"9":"0",V+=" "+(q.profile||"UDP/TLS/RTP/SAVPF")+" ",V+=q.codecs.map($=>$.preferredPayloadType!==void 0?$.preferredPayloadType:$.payloadType).join(" ")+`\r
`,V+=`c=IN IP4 0.0.0.0\r
`,V+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,q.codecs.forEach($=>{V+=F.writeRtpMap($),V+=F.writeFmtp($),V+=F.writeRtcpFb($)});let j=0;return q.codecs.forEach($=>{$.maxptime>j&&(j=$.maxptime)}),j>0&&(V+="a=maxptime:"+j+`\r
`),q.headerExtensions&&q.headerExtensions.forEach($=>{V+=F.writeExtmap($)}),V},F.parseRtpEncodingParameters=function(U){const q=[],V=F.parseRtpParameters(U),j=V.fecMechanisms.indexOf("RED")!==-1,$=V.fecMechanisms.indexOf("ULPFEC")!==-1,W=F.matchPrefix(U,"a=ssrc:").map(H=>F.parseSsrcMedia(H)).filter(H=>H.attribute==="cname"),K=W.length>0&&W[0].ssrc;let G;const Q=F.matchPrefix(U,"a=ssrc-group:FID").map(H=>H.substring(17).split(" ").map(X=>parseInt(X,10)));Q.length>0&&Q[0].length>1&&Q[0][0]===K&&(G=Q[0][1]),V.codecs.forEach(H=>{if(H.name.toUpperCase()==="RTX"&&H.parameters.apt){let Y={ssrc:K,codecPayloadType:parseInt(H.parameters.apt,10)};K&&G&&(Y.rtx={ssrc:G}),q.push(Y),j&&(Y=JSON.parse(JSON.stringify(Y)),Y.fec={ssrc:K,mechanism:$?"red+ulpfec":"red"},q.push(Y))}}),q.length===0&&K&&q.push({ssrc:K});let z=F.matchPrefix(U,"b=");return z.length&&(z[0].indexOf("b=TIAS:")===0?z=parseInt(z[0].substring(7),10):z[0].indexOf("b=AS:")===0?z=parseInt(z[0].substring(5),10)*1e3*.95-50*40*8:z=void 0,q.forEach(H=>{H.maxBitrate=z})),q},F.parseRtcpParameters=function(U){const q={},V=F.matchPrefix(U,"a=ssrc:").map(W=>F.parseSsrcMedia(W)).filter(W=>W.attribute==="cname")[0];V&&(q.cname=V.value,q.ssrc=V.ssrc);const j=F.matchPrefix(U,"a=rtcp-rsize");q.reducedSize=j.length>0,q.compound=j.length===0;const $=F.matchPrefix(U,"a=rtcp-mux");return q.mux=$.length>0,q},F.writeRtcpParameters=function(U){let q="";return U.reducedSize&&(q+=`a=rtcp-rsize\r
`),U.mux&&(q+=`a=rtcp-mux\r
`),U.ssrc!==void 0&&U.cname&&(q+="a=ssrc:"+U.ssrc+" cname:"+U.cname+`\r
`),q},F.parseMsid=function(U){let q;const V=F.matchPrefix(U,"a=msid:");if(V.length===1)return q=V[0].substring(7).split(" "),{stream:q[0],track:q[1]};const j=F.matchPrefix(U,"a=ssrc:").map($=>F.parseSsrcMedia($)).filter($=>$.attribute==="msid");if(j.length>0)return q=j[0].value.split(" "),{stream:q[0],track:q[1]}},F.parseSctpDescription=function(U){const q=F.parseMLine(U),V=F.matchPrefix(U,"a=max-message-size:");let j;V.length>0&&(j=parseInt(V[0].substring(19),10)),isNaN(j)&&(j=65536);const $=F.matchPrefix(U,"a=sctp-port:");if($.length>0)return{port:parseInt($[0].substring(12),10),protocol:q.fmt,maxMessageSize:j};const W=F.matchPrefix(U,"a=sctpmap:");if(W.length>0){const K=W[0].substring(10).split(" ");return{port:parseInt(K[0],10),protocol:K[1],maxMessageSize:j}}},F.writeSctpDescription=function(U,q){let V=[];return U.protocol!=="DTLS/SCTP"?V=["m="+U.kind+" 9 "+U.protocol+" "+q.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+q.port+`\r
`]:V=["m="+U.kind+" 9 "+U.protocol+" "+q.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+q.port+" "+q.protocol+` 65535\r
`],q.maxMessageSize!==void 0&&V.push("a=max-message-size:"+q.maxMessageSize+`\r
`),V.join("")},F.generateSessionId=function(){return Math.random().toString().substr(2,22)},F.writeSessionBoilerplate=function(U,q,V){let j;const $=q!==void 0?q:2;return U?j=U:j=F.generateSessionId(),`v=0\r
o=`+(V||"thisisadapterortc")+" "+j+" "+$+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},F.getDirection=function(U,q){const V=F.splitLines(U);for(let j=0;j<V.length;j++)switch(V[j]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return V[j].substring(2)}return q?F.getDirection(q):"sendrecv"},F.getKind=function(U){return F.splitLines(U)[0].split(" ")[0].substring(2)},F.isRejected=function(U){return U.split(" ",2)[1]==="0"},F.parseMLine=function(U){const V=F.splitLines(U)[0].substring(2).split(" ");return{kind:V[0],port:parseInt(V[1],10),protocol:V[2],fmt:V.slice(3).join(" ")}},F.parseOLine=function(U){const V=F.matchPrefix(U,"o=")[0].substring(2).split(" ");return{username:V[0],sessionId:V[1],sessionVersion:parseInt(V[2],10),netType:V[3],addressType:V[4],address:V[5]}},F.isValidSDP=function(U){if(typeof U!="string"||U.length===0)return!1;const q=F.splitLines(U);for(let V=0;V<q.length;V++)if(q[V].length<2||q[V].charAt(1)!=="=")return!1;return!0},B.exports=F}(sdp$1)),sdp$1.exports}var sdpExports=requireSdp(),SDPUtils=getDefaultExportFromCjs$1(sdpExports),sdp=_mergeNamespaces$1({__proto__:null,default:SDPUtils},[sdpExports]);function shimRTCIceCandidate(B){if(!B.RTCIceCandidate||B.RTCIceCandidate&&"foundation"in B.RTCIceCandidate.prototype)return;const F=B.RTCIceCandidate;B.RTCIceCandidate=function(q){if(typeof q=="object"&&q.candidate&&q.candidate.indexOf("a=")===0&&(q=JSON.parse(JSON.stringify(q)),q.candidate=q.candidate.substring(2)),q.candidate&&q.candidate.length){const V=new F(q),j=SDPUtils.parseCandidate(q.candidate);for(const $ in j)$ in V||Object.defineProperty(V,$,{value:j[$]});return V.toJSON=function(){return{candidate:V.candidate,sdpMid:V.sdpMid,sdpMLineIndex:V.sdpMLineIndex,usernameFragment:V.usernameFragment}},V}return new F(q)},B.RTCIceCandidate.prototype=F.prototype,wrapPeerConnectionEvent(B,"icecandidate",U=>(U.candidate&&Object.defineProperty(U,"candidate",{value:new B.RTCIceCandidate(U.candidate),writable:"false"}),U))}function shimRTCIceCandidateRelayProtocol(B){!B.RTCIceCandidate||B.RTCIceCandidate&&"relayProtocol"in B.RTCIceCandidate.prototype||wrapPeerConnectionEvent(B,"icecandidate",F=>{if(F.candidate){const U=SDPUtils.parseCandidate(F.candidate.candidate);U.type==="relay"&&(F.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[U.priority>>24])}return F})}function shimMaxMessageSize(B,F){if(!B.RTCPeerConnection)return;"sctp"in B.RTCPeerConnection.prototype||Object.defineProperty(B.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const U=function(W){if(!W||!W.sdp)return!1;const K=SDPUtils.splitSections(W.sdp);return K.shift(),K.some(G=>{const Q=SDPUtils.parseMLine(G);return Q&&Q.kind==="application"&&Q.protocol.indexOf("SCTP")!==-1})},q=function(W){const K=W.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(K===null||K.length<2)return-1;const G=parseInt(K[1],10);return G!==G?-1:G},V=function(W){let K=65536;return F.browser==="firefox"&&(F.version<57?W===-1?K=16384:K=2147483637:F.version<60?K=F.version===57?65535:65536:K=2147483637),K},j=function(W,K){let G=65536;F.browser==="firefox"&&F.version===57&&(G=65535);const Q=SDPUtils.matchPrefix(W.sdp,"a=max-message-size:");return Q.length>0?G=parseInt(Q[0].substring(19),10):F.browser==="firefox"&&K!==-1&&(G=2147483637),G},$=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,F.browser==="chrome"&&F.version>=76){const{sdpSemantics:K}=this.getConfiguration();K==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(U(arguments[0])){const K=q(arguments[0]),G=V(K),Q=j(arguments[0],K);let z;G===0&&Q===0?z=Number.POSITIVE_INFINITY:G===0||Q===0?z=Math.max(G,Q):z=Math.min(G,Q);const H={};Object.defineProperty(H,"maxMessageSize",{get(){return z}}),this._sctp=H}return $.apply(this,arguments)}}function shimSendThrowTypeError(B){if(!(B.RTCPeerConnection&&"createDataChannel"in B.RTCPeerConnection.prototype))return;function F(q,V){const j=q.send;q.send=function(){const W=arguments[0],K=W.length||W.size||W.byteLength;if(q.readyState==="open"&&V.sctp&&K>V.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+V.sctp.maxMessageSize+" bytes)");return j.apply(q,arguments)}}const U=B.RTCPeerConnection.prototype.createDataChannel;B.RTCPeerConnection.prototype.createDataChannel=function(){const V=U.apply(this,arguments);return F(V,this),V},wrapPeerConnectionEvent(B,"datachannel",q=>(F(q.channel,q.target),q))}function shimConnectionState(B){if(!B.RTCPeerConnection||"connectionState"in B.RTCPeerConnection.prototype)return;const F=B.RTCPeerConnection.prototype;Object.defineProperty(F,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(F,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(U){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),U&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=U)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(U=>{const q=F[U];F[U]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=V=>{const j=V.target;if(j._lastConnectionState!==j.connectionState){j._lastConnectionState=j.connectionState;const $=new Event("connectionstatechange",V);j.dispatchEvent($)}return V},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),q.apply(this,arguments)}})}function removeExtmapAllowMixed(B,F){if(!B.RTCPeerConnection||F.browser==="chrome"&&F.version>=71||F.browser==="safari"&&F._safariVersion>=13.1)return;const U=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(V){if(V&&V.sdp&&V.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const j=V.sdp.split(`
`).filter($=>$.trim()!=="a=extmap-allow-mixed").join(`
`);B.RTCSessionDescription&&V instanceof B.RTCSessionDescription?arguments[0]=new B.RTCSessionDescription({type:V.type,sdp:j}):V.sdp=j}return U.apply(this,arguments)}}function shimAddIceCandidateNullOrEmpty(B,F){if(!(B.RTCPeerConnection&&B.RTCPeerConnection.prototype))return;const U=B.RTCPeerConnection.prototype.addIceCandidate;!U||U.length===0||(B.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(F.browser==="chrome"&&F.version<78||F.browser==="firefox"&&F.version<68||F.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():U.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function shimParameterlessSetLocalDescription(B,F){if(!(B.RTCPeerConnection&&B.RTCPeerConnection.prototype))return;const U=B.RTCPeerConnection.prototype.setLocalDescription;!U||U.length===0||(B.RTCPeerConnection.prototype.setLocalDescription=function(){let V=arguments[0]||{};if(typeof V!="object"||V.type&&V.sdp)return U.apply(this,arguments);if(V={type:V.type,sdp:V.sdp},!V.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":V.type="offer";break;default:V.type="answer";break}return V.sdp||V.type!=="offer"&&V.type!=="answer"?U.apply(this,[V]):(V.type==="offer"?this.createOffer:this.createAnswer).apply(this).then($=>U.apply(this,[$]))})}var commonShim=Object.freeze({__proto__:null,removeExtmapAllowMixed,shimAddIceCandidateNullOrEmpty,shimConnectionState,shimMaxMessageSize,shimParameterlessSetLocalDescription,shimRTCIceCandidate,shimRTCIceCandidateRelayProtocol,shimSendThrowTypeError});function adapterFactory(){let{window:B}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},F=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const U=log,q=detectBrowser(B),V={browserDetails:q,commonShim,extractVersion,disableLog,disableWarnings,sdp};switch(q.browser){case"chrome":if(!chromeShim||!shimPeerConnection$1||!F.shimChrome)return U("Chrome shim is not included in this adapter release."),V;if(q.version===null)return U("Chrome shim can not determine version, not shimming."),V;U("adapter.js shimming chrome."),V.browserShim=chromeShim,shimAddIceCandidateNullOrEmpty(B,q),shimParameterlessSetLocalDescription(B),shimGetUserMedia$2(B,q),shimMediaStream(B),shimPeerConnection$1(B,q),shimOnTrack$1(B),shimAddTrackRemoveTrack(B,q),shimGetSendersWithDtmf(B),shimSenderReceiverGetStats(B),fixNegotiationNeeded(B,q),shimRTCIceCandidate(B),shimRTCIceCandidateRelayProtocol(B),shimConnectionState(B),shimMaxMessageSize(B,q),shimSendThrowTypeError(B),removeExtmapAllowMixed(B,q);break;case"firefox":if(!firefoxShim||!shimPeerConnection||!F.shimFirefox)return U("Firefox shim is not included in this adapter release."),V;U("adapter.js shimming firefox."),V.browserShim=firefoxShim,shimAddIceCandidateNullOrEmpty(B,q),shimParameterlessSetLocalDescription(B),shimGetUserMedia$1(B,q),shimPeerConnection(B,q),shimOnTrack(B),shimRemoveStream(B),shimSenderGetStats(B),shimReceiverGetStats(B),shimRTCDataChannel(B),shimAddTransceiver(B),shimGetParameters(B),shimCreateOffer(B),shimCreateAnswer(B),shimRTCIceCandidate(B),shimConnectionState(B),shimMaxMessageSize(B,q),shimSendThrowTypeError(B);break;case"safari":if(!safariShim||!F.shimSafari)return U("Safari shim is not included in this adapter release."),V;U("adapter.js shimming safari."),V.browserShim=safariShim,shimAddIceCandidateNullOrEmpty(B,q),shimParameterlessSetLocalDescription(B),shimRTCIceServerUrls(B),shimCreateOfferLegacy(B),shimCallbacksAPI(B),shimLocalStreamsAPI(B),shimRemoteStreamsAPI(B),shimTrackEventTransceiver(B),shimGetUserMedia(B),shimAudioContext(B),shimRTCIceCandidate(B),shimRTCIceCandidateRelayProtocol(B),shimMaxMessageSize(B,q),shimSendThrowTypeError(B),removeExtmapAllowMixed(B,q);break;default:U("Unsupported browser!");break}return V}adapterFactory({window:typeof window>"u"?void 0:window});const DECRYPTION_FAILURE_TOLERANCE=10,E2EE_FLAG="lk_e2ee",SALT="LKFrameEncryptionKey",KEY_PROVIDER_DEFAULTS={sharedKey:!1,ratchetSalt:SALT,ratchetWindowSize:8,failureTolerance:DECRYPTION_FAILURE_TOLERANCE,keyringSize:16};var KeyProviderEvent;(function(B){B.SetKey="setKey",B.RatchetRequest="ratchetRequest",B.KeyRatcheted="keyRatcheted"})(KeyProviderEvent||(KeyProviderEvent={}));var KeyHandlerEvent;(function(B){B.KeyRatcheted="keyRatcheted"})(KeyHandlerEvent||(KeyHandlerEvent={}));var EncryptionEvent;(function(B){B.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",B.EncryptionError="encryptionError"})(EncryptionEvent||(EncryptionEvent={}));var CryptorEvent;(function(B){B.Error="cryptorError"})(CryptorEvent||(CryptorEvent={}));function isE2EESupported(){return isInsertableStreamSupported()||isScriptTransformSupported()}function isScriptTransformSupported(){return typeof window.RTCRtpScriptTransform<"u"}function isInsertableStreamSupported(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}class BaseKeyProvider extends eventsExports.EventEmitter{constructor(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(U,q,V)=>{livekitLogger.debug("key ratcheted event received",{ratchetResult:U,participantId:q,keyIndex:V})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},KEY_PROVIDER_DEFAULTS),F),this.on(KeyProviderEvent.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(F,U,q){const V={key:F,participantIdentity:U,keyIndex:q};if(!this.options.sharedKey&&!U)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(U??"shared","-").concat(q??0),V),this.emit(KeyProviderEvent.SetKey,V)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(F,U){this.emit(KeyProviderEvent.RatchetRequest,F,U)}}class LivekitError extends Error{constructor(F,U){super(U||"an error has occured"),this.name="LiveKitError",this.code=F}}var ConnectionErrorReason;(function(B){B[B.NotAllowed=0]="NotAllowed",B[B.ServerUnreachable=1]="ServerUnreachable",B[B.InternalError=2]="InternalError",B[B.Cancelled=3]="Cancelled",B[B.LeaveRequest=4]="LeaveRequest",B[B.Timeout=5]="Timeout"})(ConnectionErrorReason||(ConnectionErrorReason={}));class ConnectionError extends LivekitError{constructor(F,U,q,V){super(1,F),this.name="ConnectionError",this.status=q,this.reason=U,this.context=V,this.reasonName=ConnectionErrorReason[U]}}class DeviceUnsupportedError extends LivekitError{constructor(F){super(21,F??"device is unsupported"),this.name="DeviceUnsupportedError"}}class TrackInvalidError extends LivekitError{constructor(F){super(20,F??"track is invalid"),this.name="TrackInvalidError"}}class UnsupportedServer extends LivekitError{constructor(F){super(10,F??"unsupported server"),this.name="UnsupportedServer"}}class UnexpectedConnectionState extends LivekitError{constructor(F){super(12,F??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class NegotiationError extends LivekitError{constructor(F){super(13,F??"unable to negotiate"),this.name="NegotiationError"}}class PublishTrackError extends LivekitError{constructor(F,U){super(15,F),this.name="PublishTrackError",this.status=U}}class SignalRequestError extends LivekitError{constructor(F,U){super(15,F),this.reason=U,this.reasonName=typeof U=="string"?U:RequestResponse_Reason[U]}}var MediaDeviceFailure;(function(B){B.PermissionDenied="PermissionDenied",B.NotFound="NotFound",B.DeviceInUse="DeviceInUse",B.Other="Other"})(MediaDeviceFailure||(MediaDeviceFailure={})),function(B){function F(U){if(U&&"name"in U)return U.name==="NotFoundError"||U.name==="DevicesNotFoundError"?B.NotFound:U.name==="NotAllowedError"||U.name==="PermissionDeniedError"?B.PermissionDenied:U.name==="NotReadableError"||U.name==="TrackStartError"?B.DeviceInUse:B.Other}B.getFailure=F}(MediaDeviceFailure||(MediaDeviceFailure={}));var CryptorErrorReason;(function(B){B[B.InvalidKey=0]="InvalidKey",B[B.MissingKey=1]="MissingKey",B[B.InternalError=2]="InternalError"})(CryptorErrorReason||(CryptorErrorReason={}));var RoomEvent;(function(B){B.Connected="connected",B.Reconnecting="reconnecting",B.SignalReconnecting="signalReconnecting",B.Reconnected="reconnected",B.Disconnected="disconnected",B.ConnectionStateChanged="connectionStateChanged",B.Moved="moved",B.MediaDevicesChanged="mediaDevicesChanged",B.ParticipantConnected="participantConnected",B.ParticipantDisconnected="participantDisconnected",B.TrackPublished="trackPublished",B.TrackSubscribed="trackSubscribed",B.TrackSubscriptionFailed="trackSubscriptionFailed",B.TrackUnpublished="trackUnpublished",B.TrackUnsubscribed="trackUnsubscribed",B.TrackMuted="trackMuted",B.TrackUnmuted="trackUnmuted",B.LocalTrackPublished="localTrackPublished",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalAudioSilenceDetected="localAudioSilenceDetected",B.ActiveSpeakersChanged="activeSpeakersChanged",B.ParticipantMetadataChanged="participantMetadataChanged",B.ParticipantNameChanged="participantNameChanged",B.ParticipantAttributesChanged="participantAttributesChanged",B.ParticipantActive="participantActive",B.RoomMetadataChanged="roomMetadataChanged",B.DataReceived="dataReceived",B.SipDTMFReceived="sipDTMFReceived",B.TranscriptionReceived="transcriptionReceived",B.ConnectionQualityChanged="connectionQualityChanged",B.TrackStreamStateChanged="trackStreamStateChanged",B.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",B.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",B.AudioPlaybackStatusChanged="audioPlaybackChanged",B.VideoPlaybackStatusChanged="videoPlaybackChanged",B.MediaDevicesError="mediaDevicesError",B.ParticipantPermissionsChanged="participantPermissionsChanged",B.SignalConnected="signalConnected",B.RecordingStatusChanged="recordingStatusChanged",B.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",B.EncryptionError="encryptionError",B.DCBufferStatusChanged="dcBufferStatusChanged",B.ActiveDeviceChanged="activeDeviceChanged",B.ChatMessage="chatMessage",B.LocalTrackSubscribed="localTrackSubscribed",B.MetricsReceived="metricsReceived"})(RoomEvent||(RoomEvent={}));var ParticipantEvent;(function(B){B.TrackPublished="trackPublished",B.TrackSubscribed="trackSubscribed",B.TrackSubscriptionFailed="trackSubscriptionFailed",B.TrackUnpublished="trackUnpublished",B.TrackUnsubscribed="trackUnsubscribed",B.TrackMuted="trackMuted",B.TrackUnmuted="trackUnmuted",B.LocalTrackPublished="localTrackPublished",B.LocalTrackUnpublished="localTrackUnpublished",B.ParticipantMetadataChanged="participantMetadataChanged",B.ParticipantNameChanged="participantNameChanged",B.DataReceived="dataReceived",B.SipDTMFReceived="sipDTMFReceived",B.TranscriptionReceived="transcriptionReceived",B.IsSpeakingChanged="isSpeakingChanged",B.ConnectionQualityChanged="connectionQualityChanged",B.TrackStreamStateChanged="trackStreamStateChanged",B.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",B.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",B.MediaDevicesError="mediaDevicesError",B.AudioStreamAcquired="audioStreamAcquired",B.ParticipantPermissionsChanged="participantPermissionsChanged",B.PCTrackAdded="pcTrackAdded",B.AttributesChanged="attributesChanged",B.LocalTrackSubscribed="localTrackSubscribed",B.ChatMessage="chatMessage",B.Active="active"})(ParticipantEvent||(ParticipantEvent={}));var EngineEvent;(function(B){B.TransportsCreated="transportsCreated",B.Connected="connected",B.Disconnected="disconnected",B.Resuming="resuming",B.Resumed="resumed",B.Restarting="restarting",B.Restarted="restarted",B.SignalResumed="signalResumed",B.SignalRestarted="signalRestarted",B.Closing="closing",B.MediaTrackAdded="mediaTrackAdded",B.ActiveSpeakersUpdate="activeSpeakersUpdate",B.DataPacketReceived="dataPacketReceived",B.RTPVideoMapUpdate="rtpVideoMapUpdate",B.DCBufferStatusChanged="dcBufferStatusChanged",B.ParticipantUpdate="participantUpdate",B.RoomUpdate="roomUpdate",B.SpeakersChanged="speakersChanged",B.StreamStateChanged="streamStateChanged",B.ConnectionQualityUpdate="connectionQualityUpdate",B.SubscriptionError="subscriptionError",B.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",B.RemoteMute="remoteMute",B.SubscribedQualityUpdate="subscribedQualityUpdate",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalTrackSubscribed="localTrackSubscribed",B.Offline="offline",B.SignalRequestResponse="signalRequestResponse",B.SignalConnected="signalConnected",B.RoomMoved="roomMoved"})(EngineEvent||(EngineEvent={}));var TrackEvent;(function(B){B.Message="message",B.Muted="muted",B.Unmuted="unmuted",B.Restarted="restarted",B.Ended="ended",B.Subscribed="subscribed",B.Unsubscribed="unsubscribed",B.UpdateSettings="updateSettings",B.UpdateSubscription="updateSubscription",B.AudioPlaybackStarted="audioPlaybackStarted",B.AudioPlaybackFailed="audioPlaybackFailed",B.AudioSilenceDetected="audioSilenceDetected",B.VisibilityChanged="visibilityChanged",B.VideoDimensionsChanged="videoDimensionsChanged",B.VideoPlaybackStarted="videoPlaybackStarted",B.VideoPlaybackFailed="videoPlaybackFailed",B.ElementAttached="elementAttached",B.ElementDetached="elementDetached",B.UpstreamPaused="upstreamPaused",B.UpstreamResumed="upstreamResumed",B.SubscriptionPermissionChanged="subscriptionPermissionChanged",B.SubscriptionStatusChanged="subscriptionStatusChanged",B.SubscriptionFailed="subscriptionFailed",B.TrackProcessorUpdate="trackProcessorUpdate",B.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",B.TranscriptionReceived="transcriptionReceived",B.TimeSyncUpdate="timeSyncUpdate",B.PreConnectBufferFlushed="preConnectBufferFlushed"})(TrackEvent||(TrackEvent={}));function cloneDeep(B){return typeof B>"u"?B:typeof structuredClone=="function"?structuredClone(B):JSON.parse(JSON.stringify(B))}const commonVersionIdentifier=/version\/(\d+(\.?_?\d+)+)/i;let browserDetails;function getBrowser(B){let F=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const U=navigator.userAgent.toLowerCase();if(browserDetails===void 0||F){const q=browsersList.find(V=>{let{test:j}=V;return j.test(U)});browserDetails=q==null?void 0:q.describe(U)}return browserDetails}const browsersList=[{test:/firefox|iceweasel|fxios/i,describe(B){return{name:"Firefox",version:getMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,B),os:B.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:getOSVersion(B)}}},{test:/chrom|crios|crmo/i,describe(B){return{name:"Chrome",version:getMatch(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,B),os:B.toLowerCase().includes("crios")?"iOS":void 0,osVersion:getOSVersion(B)}}},{test:/safari|applewebkit/i,describe(B){return{name:"Safari",version:getMatch(commonVersionIdentifier,B),os:B.includes("mobile/")?"iOS":"macOS",osVersion:getOSVersion(B)}}}];function getMatch(B,F){let U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const q=F.match(B);return q&&q.length>=U&&q[U]||""}function getOSVersion(B){return B.includes("mac os")?getMatch(/\(.+?(\d+_\d+(:?_\d+)?)/,B,1).replace(/_/g,"."):void 0}var version$1="2.13.3";const version=version$1,protocolVersion=16;class CriticalTimers{}CriticalTimers.setTimeout=function(){return setTimeout(...arguments)},CriticalTimers.setInterval=function(){return setInterval(...arguments)},CriticalTimers.clearTimeout=function(){return clearTimeout(...arguments)},CriticalTimers.clearInterval=function(){return clearInterval(...arguments)};const BACKGROUND_REACTION_DELAY=5e3,recycledElements=[];var VideoQuality;(function(B){B[B.LOW=0]="LOW",B[B.MEDIUM=1]="MEDIUM",B[B.HIGH=2]="HIGH"})(VideoQuality||(VideoQuality={}));class Track extends eventsExports.EventEmitter{constructor(F,U){let q=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var V;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=Track.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=livekitLogger,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),BACKGROUND_REACTION_DELAY):this.handleAppVisibilityChanged()},this.log=getLogger((V=q.loggerName)!==null&&V!==void 0?V:LoggerNames.Track),this.loggerContextCb=q.loggerContextCb,this.setMaxListeners(100),this.kind=U,this._mediaStreamTrack=F,this._mediaStreamID=F.id,this.source=Track.Source.Unknown}get logContext(){var F;return Object.assign(Object.assign({},(F=this.loggerContextCb)===null||F===void 0?void 0:F.call(this)),getLogContextFromTrack(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(F){let U="audio";this.kind===Track.Kind.Video&&(U="video"),this.attachedElements.length===0&&this.kind===Track.Kind.Video&&this.addAppVisibilityListener(),F||(U==="audio"&&(recycledElements.forEach(j=>{j.parentElement===null&&!F&&(F=j)}),F&&recycledElements.splice(recycledElements.indexOf(F),1)),F||(F=document.createElement(U))),this.attachedElements.includes(F)||this.attachedElements.push(F),attachToElement(this.mediaStreamTrack,F);const q=F.srcObject.getTracks(),V=q.some(j=>j.kind==="audio");return F.play().then(()=>{this.emit(V?TrackEvent.AudioPlaybackStarted:TrackEvent.VideoPlaybackStarted)}).catch(j=>{j.name==="NotAllowedError"?this.emit(V?TrackEvent.AudioPlaybackFailed:TrackEvent.VideoPlaybackFailed,j):j.name==="AbortError"?livekitLogger.debug("".concat(V?"audio":"video"," playback aborted, likely due to new play request")):livekitLogger.warn("could not playback ".concat(V?"audio":"video"),j),V&&F&&q.some($=>$.kind==="video")&&j.name==="NotAllowedError"&&(F.muted=!0,F.play().catch(()=>{}))}),this.emit(TrackEvent.ElementAttached,F),F}detach(F){try{if(F){detachTrack(this.mediaStreamTrack,F);const q=this.attachedElements.indexOf(F);return q>=0&&(this.attachedElements.splice(q,1),this.recycleElement(F),this.emit(TrackEvent.ElementDetached,F)),F}const U=[];return this.attachedElements.forEach(q=>{detachTrack(this.mediaStreamTrack,q),U.push(q),this.recycleElement(q),this.emit(TrackEvent.ElementDetached,q)}),this.attachedElements=[],U}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(F){F.loggerName&&(this.log=getLogger(F.loggerName)),F.loggerContextCb&&(this.loggerContextCb=F.loggerContextCb)}recycleElement(F){if(F instanceof HTMLAudioElement){let U=!0;F.pause(),recycledElements.forEach(q=>{q.parentElement||(U=!1)}),U&&recycledElements.push(F)}}handleAppVisibilityChanged(){return __awaiter$1(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===Track.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(F=>F.play().catch(()=>{})),0)})}addAppVisibilityListener(){isWeb()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){isWeb()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function attachToElement(B,F){let U;F.srcObject instanceof MediaStream?U=F.srcObject:U=new MediaStream;let q;B.kind==="audio"?q=U.getAudioTracks():q=U.getVideoTracks(),q.includes(B)||(q.forEach(V=>{U.removeTrack(V)}),U.addTrack(B)),(!isSafari()||!(F instanceof HTMLVideoElement))&&(F.autoplay=!0),F.muted=U.getAudioTracks().length===0,F instanceof HTMLVideoElement&&(F.playsInline=!0),F.srcObject!==U&&(F.srcObject=U,(isSafari()||isFireFox())&&F instanceof HTMLVideoElement&&setTimeout(()=>{F.srcObject=U,F.play().catch(()=>{})},0))}function detachTrack(B,F){if(F.srcObject instanceof MediaStream){const U=F.srcObject;U.removeTrack(B),U.getTracks().length>0?F.srcObject=U:F.srcObject=null}}(function(B){let F;(function(G){G.Audio="audio",G.Video="video",G.Unknown="unknown"})(F=B.Kind||(B.Kind={}));let U;(function(G){G.Camera="camera",G.Microphone="microphone",G.ScreenShare="screen_share",G.ScreenShareAudio="screen_share_audio",G.Unknown="unknown"})(U=B.Source||(B.Source={}));let q;(function(G){G.Active="active",G.Paused="paused",G.Unknown="unknown"})(q=B.StreamState||(B.StreamState={}));function V(G){switch(G){case F.Audio:return TrackType.AUDIO;case F.Video:return TrackType.VIDEO;default:return TrackType.DATA}}B.kindToProto=V;function j(G){switch(G){case TrackType.AUDIO:return F.Audio;case TrackType.VIDEO:return F.Video;default:return F.Unknown}}B.kindFromProto=j;function $(G){switch(G){case U.Camera:return TrackSource.CAMERA;case U.Microphone:return TrackSource.MICROPHONE;case U.ScreenShare:return TrackSource.SCREEN_SHARE;case U.ScreenShareAudio:return TrackSource.SCREEN_SHARE_AUDIO;default:return TrackSource.UNKNOWN}}B.sourceToProto=$;function W(G){switch(G){case TrackSource.CAMERA:return U.Camera;case TrackSource.MICROPHONE:return U.Microphone;case TrackSource.SCREEN_SHARE:return U.ScreenShare;case TrackSource.SCREEN_SHARE_AUDIO:return U.ScreenShareAudio;default:return U.Unknown}}B.sourceFromProto=W;function K(G){switch(G){case StreamState.ACTIVE:return q.Active;case StreamState.PAUSED:return q.Paused;default:return q.Unknown}}B.streamStateFromProto=K})(Track||(Track={}));class VideoPreset{constructor(F,U,q,V,j){if(typeof F=="object")this.width=F.width,this.height=F.height,this.aspectRatio=F.aspectRatio,this.encoding={maxBitrate:F.maxBitrate,maxFramerate:F.maxFramerate,priority:F.priority};else if(U!==void 0&&q!==void 0)this.width=F,this.height=U,this.aspectRatio=F/U,this.encoding={maxBitrate:q,maxFramerate:V,priority:j};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const backupCodecs=["vp8","h264"],videoCodecs=["vp8","h264","vp9","av1"];function isBackupCodec(B){return!!backupCodecs.find(F=>F===B)}var BackupCodecPolicy;(function(B){B[B.PREFER_REGRESSION=0]="PREFER_REGRESSION",B[B.SIMULCAST=1]="SIMULCAST",B[B.REGRESSION=2]="REGRESSION"})(BackupCodecPolicy||(BackupCodecPolicy={}));var AudioPresets;(function(B){B.telephone={maxBitrate:12e3},B.speech={maxBitrate:24e3},B.music={maxBitrate:48e3},B.musicStereo={maxBitrate:64e3},B.musicHighQuality={maxBitrate:96e3},B.musicHighQualityStereo={maxBitrate:128e3}})(AudioPresets||(AudioPresets={}));const VideoPresets={h90:new VideoPreset(160,90,9e4,20),h180:new VideoPreset(320,180,16e4,20),h216:new VideoPreset(384,216,18e4,20),h360:new VideoPreset(640,360,45e4,20),h540:new VideoPreset(960,540,8e5,25),h720:new VideoPreset(1280,720,17e5,30),h1080:new VideoPreset(1920,1080,3e6,30),h1440:new VideoPreset(2560,1440,5e6,30),h2160:new VideoPreset(3840,2160,8e6,30)},VideoPresets43={h120:new VideoPreset(160,120,7e4,20),h180:new VideoPreset(240,180,125e3,20),h240:new VideoPreset(320,240,14e4,20),h360:new VideoPreset(480,360,33e4,20),h480:new VideoPreset(640,480,5e5,20),h540:new VideoPreset(720,540,6e5,25),h720:new VideoPreset(960,720,13e5,30),h1080:new VideoPreset(1440,1080,23e5,30),h1440:new VideoPreset(1920,1440,38e5,30)},ScreenSharePresets={h360fps3:new VideoPreset(640,360,2e5,3,"medium"),h360fps15:new VideoPreset(640,360,4e5,15,"medium"),h720fps5:new VideoPreset(1280,720,8e5,5,"medium"),h720fps15:new VideoPreset(1280,720,15e5,15,"medium"),h720fps30:new VideoPreset(1280,720,2e6,30,"medium"),h1080fps15:new VideoPreset(1920,1080,25e5,15,"medium"),h1080fps30:new VideoPreset(1920,1080,5e6,30,"medium"),original:new VideoPreset(0,0,7e6,30,"medium")},separator="|",ddExtensionURI="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function unpackStreamId(B){const F=B.split(separator);return F.length>1?[F[0],B.substr(F[0].length+1)]:[B,""]}function sleep$1(B){return __awaiter$1(this,void 0,void 0,function*(){return new Promise(F=>CriticalTimers.setTimeout(F,B))})}function supportsTransceiver(){return"addTransceiver"in RTCPeerConnection.prototype}function supportsAddTrack(){return"addTrack"in RTCPeerConnection.prototype}function supportsAV1(){if(!("getCapabilities"in RTCRtpSender)||isSafari())return!1;const B=RTCRtpSender.getCapabilities("video");let F=!1;if(B){for(const U of B.codecs)if(U.mimeType==="video/AV1"){F=!0;break}}return F}function supportsVP9(){if(!("getCapabilities"in RTCRtpSender)||isFireFox())return!1;if(isSafari()){const U=getBrowser();if(U!=null&&U.version&&compareVersions(U.version,"16")<0)return!1}const B=RTCRtpSender.getCapabilities("video");let F=!1;if(B){for(const U of B.codecs)if(U.mimeType==="video/VP9"){F=!0;break}}return F}function isSVCCodec(B){return B==="av1"||B==="vp9"}function supportsSetSinkId(B){return document?(B||(B=document.createElement("audio")),"setSinkId"in B):!1}function isBrowserSupported(){return typeof RTCPeerConnection>"u"?!1:supportsTransceiver()||supportsAddTrack()}function isFireFox(){var B;return((B=getBrowser())===null||B===void 0?void 0:B.name)==="Firefox"}function isSafari(){var B;return((B=getBrowser())===null||B===void 0?void 0:B.name)==="Safari"}function isSafariBased(){const B=getBrowser();return(B==null?void 0:B.name)==="Safari"||(B==null?void 0:B.os)==="iOS"}function isSafari17(){const B=getBrowser();return(B==null?void 0:B.name)==="Safari"&&B.version.startsWith("17.")}function isSafariSvcApi(B){return B||(B=getBrowser()),(B==null?void 0:B.name)==="Safari"&&compareVersions(B.version,"18.3")>0}function isMobile(){var B,F;return isWeb()?(F=(B=navigator.userAgentData)===null||B===void 0?void 0:B.mobile)!==null&&F!==void 0?F:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function isE2EESimulcastSupported(){const B=getBrowser(),F="17.2";if(B)return B.name!=="Safari"&&B.os!=="iOS"||B.os==="iOS"&&B.osVersion&&compareVersions(F,B.osVersion)>=0?!0:B.name==="Safari"&&compareVersions(F,B.version)>=0}function isWeb(){return typeof document<"u"}function isReactNative(){return navigator.product=="ReactNative"}function isCloud(B){return B.hostname.endsWith(".livekit.cloud")||B.hostname.endsWith(".livekit.run")}function getLKReactNativeInfo(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function getReactNativeOs(){if(!isReactNative())return;let B=getLKReactNativeInfo();if(B)return B.platform}function getDevicePixelRatio(){if(isWeb())return window.devicePixelRatio;if(isReactNative()){let B=getLKReactNativeInfo();if(B)return B.devicePixelRatio}return 1}function compareVersions(B,F){const U=B.split("."),q=F.split("."),V=Math.min(U.length,q.length);for(let j=0;j<V;++j){const $=parseInt(U[j],10),W=parseInt(q[j],10);if($>W)return 1;if($<W)return-1;if(j===V-1&&$===W)return 0}return B===""&&F!==""?-1:F===""?1:U.length==q.length?0:U.length<q.length?-1:1}function roDispatchCallback(B){for(const F of B)F.target.handleResize(F)}function ioDispatchCallback(B){for(const F of B)F.target.handleVisibilityChanged(F)}let resizeObserver=null;const getResizeObserver=()=>(resizeObserver||(resizeObserver=new ResizeObserver(roDispatchCallback)),resizeObserver);let intersectionObserver=null;const getIntersectionObserver=()=>(intersectionObserver||(intersectionObserver=new IntersectionObserver(ioDispatchCallback,{root:null,rootMargin:"0px"})),intersectionObserver);function getClientInfo(){var B;const F=new ClientInfo({sdk:ClientInfo_SDK.JS,protocol:protocolVersion,version});return isReactNative()&&(F.os=(B=getReactNativeOs())!==null&&B!==void 0?B:""),F}function createDummyVideoStreamTrack(){let B=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,F=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,q=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const V=document.createElement("canvas");V.width=B,V.height=F;const j=V.getContext("2d");j==null||j.fillRect(0,0,V.width,V.height),q&&j&&(j.beginPath(),j.arc(B/2,F/2,50,0,Math.PI*2,!0),j.closePath(),j.fillStyle="grey",j.fill());const $=V.captureStream(),[W]=$.getTracks();if(!W)throw Error("Could not get empty media stream video track");return W.enabled=U,W}let emptyAudioStreamTrack;function getEmptyAudioStreamTrack(){if(!emptyAudioStreamTrack){const B=new AudioContext,F=B.createOscillator(),U=B.createGain();U.gain.setValueAtTime(0,0);const q=B.createMediaStreamDestination();if(F.connect(U),U.connect(q),F.start(),[emptyAudioStreamTrack]=q.stream.getAudioTracks(),!emptyAudioStreamTrack)throw Error("Could not get empty media stream audio track");emptyAudioStreamTrack.enabled=!1}return emptyAudioStreamTrack.clone()}class Future{constructor(F,U){this.onFinally=U,this.promise=new Promise((q,V)=>__awaiter$1(this,void 0,void 0,function*(){this.resolve=q,this.reject=V,F&&(yield F(q,V))})).finally(()=>{var q;return(q=this.onFinally)===null||q===void 0?void 0:q.call(this)})}}function isVideoCodec(B){return videoCodecs.includes(B)}function unwrapConstraint(B){if(typeof B=="string"||typeof B=="number")return B;if(Array.isArray(B))return B[0];if(B.exact)return Array.isArray(B.exact)?B.exact[0]:B.exact;if(B.ideal)return Array.isArray(B.ideal)?B.ideal[0]:B.ideal;throw Error("could not unwrap constraint")}function toWebsocketUrl(B){return B.startsWith("http")?B.replace(/^(http)/,"ws"):B}function toHttpUrl(B){return B.startsWith("ws")?B.replace(/^(ws)/,"http"):B}function extractTranscriptionSegments(B,F){return B.segments.map(U=>{let{id:q,text:V,language:j,startTime:$,endTime:W,final:K}=U;var G;const Q=(G=F.get(q))!==null&&G!==void 0?G:Date.now(),z=Date.now();return K?F.delete(q):F.set(q,Q),{id:q,text:V,startTime:Number.parseInt($.toString()),endTime:Number.parseInt(W.toString()),final:K,language:j,firstReceivedTime:Q,lastReceivedTime:z}})}function extractChatMessage(B){const{id:F,timestamp:U,message:q,editTimestamp:V}=B;return{id:F,timestamp:Number.parseInt(U.toString()),editTimestamp:V?Number.parseInt(V.toString()):void 0,message:q}}function getDisconnectReasonFromConnectionError(B){switch(B.reason){case ConnectionErrorReason.LeaveRequest:return B.context;case ConnectionErrorReason.Cancelled:return DisconnectReason.CLIENT_INITIATED;case ConnectionErrorReason.NotAllowed:return DisconnectReason.USER_REJECTED;case ConnectionErrorReason.ServerUnreachable:return DisconnectReason.JOIN_FAILURE;default:return DisconnectReason.UNKNOWN_REASON}}function bigIntToNumber(B){return B!==void 0?Number(B):void 0}function numberToBigInt(B){return B!==void 0?BigInt(B):void 0}function isLocalTrack(B){return!!B&&!(B instanceof MediaStreamTrack)&&B.isLocal}function isAudioTrack(B){return!!B&&B.kind==Track.Kind.Audio}function isVideoTrack(B){return!!B&&B.kind==Track.Kind.Video}function isLocalVideoTrack(B){return isLocalTrack(B)&&isVideoTrack(B)}function isLocalAudioTrack(B){return isLocalTrack(B)&&isAudioTrack(B)}function isRemoteTrack(B){return!!B&&!B.isLocal}function isRemotePub(B){return!!B&&!B.isLocal}function isRemoteVideoTrack(B){return isRemoteTrack(B)&&isVideoTrack(B)}function isLocalParticipant(B){return B.isLocal}function splitUtf8(B,F){const U=[];let q=new TextEncoder().encode(B);for(;q.length>F;){let V=F;for(;V>0;){const j=q[V];if(j!==void 0&&(j&192)!==128)break;V--}U.push(q.slice(0,V)),q=q.slice(V)}return q.length>0&&U.push(q),U}function mergeDefaultOptions(B,F,U){var q,V,j,$;const{optionsWithoutProcessor:W,audioProcessor:K,videoProcessor:G}=extractProcessorsFromOptions(B??{}),Q=F==null?void 0:F.processor,z=U==null?void 0:U.processor,H=W??{};return H.audio===!0&&(H.audio={}),H.video===!0&&(H.video={}),H.audio&&(mergeObjectWithoutOverwriting(H.audio,F),(q=(j=H.audio).deviceId)!==null&&q!==void 0||(j.deviceId={ideal:"default"}),(K||Q)&&(H.audio.processor=K??Q)),H.video&&(mergeObjectWithoutOverwriting(H.video,U),(V=($=H.video).deviceId)!==null&&V!==void 0||($.deviceId={ideal:"default"}),(G||z)&&(H.video.processor=G??z)),H}function mergeObjectWithoutOverwriting(B,F){return Object.keys(F).forEach(U=>{B[U]===void 0&&(B[U]=F[U])}),B}function constraintsForOptions(B){var F,U,q,V;const j={};if(B.video)if(typeof B.video=="object"){const $={},W=$,K=B.video;Object.keys(K).forEach(G=>{switch(G){case"resolution":mergeObjectWithoutOverwriting(W,K.resolution);break;default:W[G]=K[G]}}),j.video=$,(F=(q=j.video).deviceId)!==null&&F!==void 0||(q.deviceId={ideal:"default"})}else j.video=B.video?{deviceId:{ideal:"default"}}:!1;else j.video=!1;return B.audio?typeof B.audio=="object"?(j.audio=B.audio,(U=(V=j.audio).deviceId)!==null&&U!==void 0||(V.deviceId={ideal:"default"})):j.audio={deviceId:{ideal:"default"}}:j.audio=!1,j}function detectSilence(B){return __awaiter$1(this,arguments,void 0,function(F){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return function*(){const q=getNewAudioContext();if(q){const V=q.createAnalyser();V.fftSize=2048;const j=V.frequencyBinCount,$=new Uint8Array(j);q.createMediaStreamSource(new MediaStream([F.mediaStreamTrack])).connect(V),yield sleep$1(U),V.getByteTimeDomainData($);const K=$.some(G=>G!==128&&G!==0);return q.close(),!K}return!1}()})}function getNewAudioContext(){var B;const F=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(F){const U=new F({latencyHint:"interactive"});if(U.state==="suspended"&&typeof window<"u"&&(!((B=window.document)===null||B===void 0)&&B.body)){const q=()=>__awaiter$1(this,void 0,void 0,function*(){var V;try{U.state==="suspended"&&(yield U.resume())}catch(j){console.warn("Error trying to auto-resume audio context",j)}(V=window.document.body)===null||V===void 0||V.removeEventListener("click",q)});window.document.body.addEventListener("click",q)}return U}}function kindToSource(B){return B==="audioinput"?Track.Source.Microphone:B==="videoinput"?Track.Source.Camera:Track.Source.Unknown}function sourceToKind(B){return B===Track.Source.Microphone?"audioinput":B===Track.Source.Camera?"videoinput":void 0}function screenCaptureToDisplayMediaStreamOptions(B){var F,U;let q=(F=B.video)!==null&&F!==void 0?F:!0;return B.resolution&&B.resolution.width>0&&B.resolution.height>0&&(q=typeof q=="boolean"?{}:q,isSafari()?q=Object.assign(Object.assign({},q),{width:{max:B.resolution.width},height:{max:B.resolution.height},frameRate:B.resolution.frameRate}):q=Object.assign(Object.assign({},q),{width:{ideal:B.resolution.width},height:{ideal:B.resolution.height},frameRate:B.resolution.frameRate})),{audio:(U=B.audio)!==null&&U!==void 0?U:!1,video:q,controller:B.controller,selfBrowserSurface:B.selfBrowserSurface,surfaceSwitching:B.surfaceSwitching,systemAudio:B.systemAudio,preferCurrentTab:B.preferCurrentTab}}function mimeTypeToVideoCodecString(B){return B.split("/")[1].toLowerCase()}function getTrackPublicationInfo(B){const F=[];return B.forEach(U=>{U.track!==void 0&&F.push(new TrackPublishedResponse({cid:U.track.mediaStreamID,track:U.trackInfo}))}),F}function getLogContextFromTrack(B){return"mediaStreamTrack"in B?{trackID:B.sid,source:B.source,muted:B.isMuted,enabled:B.mediaStreamTrack.enabled,kind:B.kind,streamID:B.mediaStreamID,streamTrackID:B.mediaStreamTrack.id}:{trackID:B.trackSid,enabled:B.isEnabled,muted:B.isMuted,trackInfo:Object.assign({mimeType:B.mimeType,name:B.trackName,encrypted:B.isEncrypted,kind:B.kind,source:B.source},B.track?getLogContextFromTrack(B.track):{})}}function supportsSynchronizationSources(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function diffAttributes(B,F){var U;B===void 0&&(B={}),F===void 0&&(F={});const q=[...Object.keys(F),...Object.keys(B)],V={};for(const j of q)B[j]!==F[j]&&(V[j]=(U=F[j])!==null&&U!==void 0?U:"");return V}function extractProcessorsFromOptions(B){const F=Object.assign({},B);let U,q;return typeof F.audio=="object"&&F.audio.processor&&(U=F.audio.processor,F.audio=Object.assign(Object.assign({},F.audio),{processor:void 0})),typeof F.video=="object"&&F.video.processor&&(q=F.video.processor,F.video=Object.assign(Object.assign({},F.video),{processor:void 0})),{audioProcessor:U,videoProcessor:q,optionsWithoutProcessor:cloneDeep(F)}}function getTrackSourceFromProto(B){switch(B){case TrackSource.CAMERA:return Track.Source.Camera;case TrackSource.MICROPHONE:return Track.Source.Microphone;case TrackSource.SCREEN_SHARE:return Track.Source.ScreenShare;case TrackSource.SCREEN_SHARE_AUDIO:return Track.Source.ScreenShareAudio;default:return Track.Source.Unknown}}class E2EEManager extends eventsExports.EventEmitter{constructor(F){super(),this.onWorkerMessage=U=>{var q,V;const{kind:j,data:$}=U.data;switch(j){case"error":livekitLogger.error($.error.message),this.emit(EncryptionEvent.EncryptionError,$.error);break;case"initAck":$.enabled&&this.keyProvider.getKeys().forEach(W=>{this.postKey(W)});break;case"enable":if($.enabled&&this.keyProvider.getKeys().forEach(W=>{this.postKey(W)}),this.encryptionEnabled!==$.enabled&&$.participantIdentity===((q=this.room)===null||q===void 0?void 0:q.localParticipant.identity))this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,$.enabled,this.room.localParticipant),this.encryptionEnabled=$.enabled;else if($.participantIdentity){const W=(V=this.room)===null||V===void 0?void 0:V.getParticipantByIdentity($.participantIdentity);if(!W)throw TypeError("couldn't set encryption status, participant not found".concat($.participantIdentity));this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,$.enabled,W)}break;case"ratchetKey":this.keyProvider.emit(KeyProviderEvent.KeyRatcheted,$.ratchetResult,$.participantIdentity,$.keyIndex);break}},this.onWorkerError=U=>{livekitLogger.error("e2ee worker encountered an error:",{error:U.error}),this.emit(EncryptionEvent.EncryptionError,U.error)},this.keyProvider=F.keyProvider,this.worker=F.worker,this.encryptionEnabled=!1}setup(F){if(!isE2EESupported())throw new DeviceUnsupportedError("tried to setup end-to-end encryption on an unsupported browser");if(livekitLogger.info("setting up e2ee"),F!==this.room){this.room=F,this.setupEventListeners(F,this.keyProvider);const U={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:workerLogger.getLevel()}};this.worker&&(livekitLogger.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(U))}}setParticipantCryptorEnabled(F,U){livekitLogger.debug("set e2ee to ".concat(F," for participant ").concat(U)),this.postEnable(F,U)}setSifTrailer(F){!F||F.length===0?livekitLogger.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(F)}setupEngine(F){F.on(EngineEvent.RTPVideoMapUpdate,U=>{this.postRTPMap(U)})}setupEventListeners(F,U){F.on(RoomEvent.TrackPublished,(q,V)=>this.setParticipantCryptorEnabled(q.trackInfo.encryption!==Encryption_Type.NONE,V.identity)),F.on(RoomEvent.ConnectionStateChanged,q=>{q===ConnectionState.Connected&&F.remoteParticipants.forEach(V=>{V.trackPublications.forEach(j=>{this.setParticipantCryptorEnabled(j.trackInfo.encryption!==Encryption_Type.NONE,V.identity)})})}).on(RoomEvent.TrackUnsubscribed,(q,V,j)=>{var $;const W={kind:"removeTransform",data:{participantIdentity:j.identity,trackId:q.mediaStreamID}};($=this.worker)===null||$===void 0||$.postMessage(W)}).on(RoomEvent.TrackSubscribed,(q,V,j)=>{this.setupE2EEReceiver(q,j.identity,V.trackInfo)}).on(RoomEvent.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");U.getKeys().forEach(q=>{this.postKey(q)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),F.localParticipant.on(ParticipantEvent.LocalTrackPublished,q=>__awaiter$1(this,void 0,void 0,function*(){this.setupE2EESender(q.track,q.track.sender)})),U.on(KeyProviderEvent.SetKey,q=>this.postKey(q)).on(KeyProviderEvent.RatchetRequest,(q,V)=>this.postRatchetRequest(q,V))}postRatchetRequest(F,U){if(!this.worker)throw Error("could not ratchet key, worker is missing");const q={kind:"ratchetRequest",data:{participantIdentity:F,keyIndex:U}};this.worker.postMessage(q)}postKey(F){let{key:U,participantIdentity:q,keyIndex:V}=F;var j;if(!this.worker)throw Error("could not set key, worker is missing");const $={kind:"setKey",data:{participantIdentity:q,isPublisher:q===((j=this.room)===null||j===void 0?void 0:j.localParticipant.identity),key:U,keyIndex:V}};this.worker.postMessage($)}postEnable(F,U){if(this.worker){const q={kind:"enable",data:{enabled:F,participantIdentity:U}};this.worker.postMessage(q)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(F){var U;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((U=this.room)===null||U===void 0)&&U.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const q={kind:"setRTPMap",data:{map:F,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(q)}postSifTrailer(F){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const U={kind:"setSifTrailer",data:{trailer:F}};this.worker.postMessage(U)}setupE2EEReceiver(F,U,q){if(F.receiver){if(!(q!=null&&q.mimeType)||q.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(F.receiver,F.mediaStreamID,U,F.kind==="video"?mimeTypeToVideoCodecString(q.mimeType):void 0)}}setupE2EESender(F,U){if(!isLocalTrack(F)||!U){U||livekitLogger.warn("early return because sender is not ready");return}this.handleSender(U,F.mediaStreamID,void 0)}handleReceiver(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){if(this.worker){if(isScriptTransformSupported()){const j={kind:"decode",participantIdentity:q,trackId:U,codec:V};F.transform=new RTCRtpScriptTransform(this.worker,j)}else{if(E2EE_FLAG in F&&V){const K={kind:"updateCodec",data:{trackId:U,codec:V,participantIdentity:q}};this.worker.postMessage(K);return}let j=F.writableStream,$=F.readableStream;if(!j||!$){const K=F.createEncodedStreams();F.writableStream=K.writable,j=K.writable,F.readableStream=K.readable,$=K.readable}const W={kind:"decode",data:{readableStream:$,writableStream:j,trackId:U,codec:V,participantIdentity:q}};this.worker.postMessage(W,[$,j])}F[E2EE_FLAG]=!0}})}handleSender(F,U,q){var V;if(!(E2EE_FLAG in F||!this.worker)){if(!(!((V=this.room)===null||V===void 0)&&V.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(isScriptTransformSupported()){livekitLogger.info("initialize script transform");const j={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:U,codec:q};F.transform=new RTCRtpScriptTransform(this.worker,j)}else{livekitLogger.info("initialize encoded streams");const j=F.createEncodedStreams(),$={kind:"encode",data:{readableStream:j.readable,writableStream:j.writable,codec:q,trackId:U,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage($,[j.readable,j.writable])}F[E2EE_FLAG]=!0}}}const defaultId="default";class DeviceManager{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new DeviceManager),this.instance}get previousDevices(){return this._previousDevices}getDevices(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var j;if(((j=DeviceManager.userMediaPromiseMap)===null||j===void 0?void 0:j.size)>0){livekitLogger.debug("awaiting getUserMedia promise");try{U?yield DeviceManager.userMediaPromiseMap.get(U):yield Promise.all(DeviceManager.userMediaPromiseMap.values())}catch{livekitLogger.warn("error waiting for media permissons")}}let $=yield navigator.mediaDevices.enumerateDevices();if(V&&!(isSafari()&&q.hasDeviceInUse(U))&&($.filter(K=>K.kind===U).length===0||$.some(K=>{const G=K.label==="",Q=U?K.kind===U:!0;return G&&Q}))){const K={video:U!=="audioinput"&&U!=="audiooutput",audio:U!=="videoinput"&&{deviceId:{ideal:"default"}}},G=yield navigator.mediaDevices.getUserMedia(K);$=yield navigator.mediaDevices.enumerateDevices(),G.getTracks().forEach(Q=>{Q.stop()})}return q._previousDevices=$,U&&($=$.filter(W=>W.kind===U)),$}()})}normalizeDeviceId(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){if(U!==defaultId)return U;const V=yield this.getDevices(F),j=V.find(W=>W.deviceId===defaultId);if(!j){livekitLogger.warn("could not reliably determine default device");return}const $=V.find(W=>W.deviceId!==defaultId&&W.groupId===(q??j.groupId));if(!$){livekitLogger.warn("could not reliably determine default device");return}return $==null?void 0:$.deviceId})}hasDeviceInUse(F){return F?DeviceManager.userMediaPromiseMap.has(F):DeviceManager.userMediaPromiseMap.size>0}}DeviceManager.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],DeviceManager.userMediaPromiseMap=new Map;var QueueTaskStatus;(function(B){B[B.WAITING=0]="WAITING",B[B.RUNNING=1]="RUNNING",B[B.COMPLETED=2]="COMPLETED"})(QueueTaskStatus||(QueueTaskStatus={}));class AsyncQueue{constructor(){this.pendingTasks=new Map,this.taskMutex=new _$1,this.nextTaskIndex=0}run(F){return __awaiter$1(this,void 0,void 0,function*(){const U={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:QueueTaskStatus.WAITING};this.pendingTasks.set(U.id,U);const q=yield this.taskMutex.lock();try{return U.executedAt=Date.now(),U.status=QueueTaskStatus.RUNNING,yield F()}finally{U.status=QueueTaskStatus.COMPLETED,this.pendingTasks.delete(U.id),q()}})}flush(){return __awaiter$1(this,void 0,void 0,function*(){return this.run(()=>__awaiter$1(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}function createRtcUrl(B,F){const U=new URL(toWebsocketUrl(B));return F.forEach((q,V)=>{U.searchParams.set(V,q)}),appendUrlPath(U,"rtc")}function createValidateUrl(B){const F=new URL(toHttpUrl(B));return appendUrlPath(F,"validate")}function ensureTrailingSlash(B){return B.endsWith("/")?B:"".concat(B,"/")}function appendUrlPath(B,F){return B.pathname="".concat(ensureTrailingSlash(B.pathname)).concat(F),B.toString()}const passThroughQueueSignals=["syncState","trickle","offer","answer","simulate","leave"];function canPassThroughQueue(B){const F=passThroughQueueSignals.indexOf(B.case)>=0;return livekitLogger.trace("request allowed to bypass queue:",{canPass:F,req:B}),F}var SignalConnectionState;(function(B){B[B.CONNECTING=0]="CONNECTING",B[B.CONNECTED=1]="CONNECTED",B[B.RECONNECTING=2]="RECONNECTING",B[B.DISCONNECTING=3]="DISCONNECTING",B[B.DISCONNECTED=4]="DISCONNECTED"})(SignalConnectionState||(SignalConnectionState={}));class SignalClient{get currentState(){return this.state}get isDisconnected(){return this.state===SignalConnectionState.DISCONNECTING||this.state===SignalConnectionState.DISCONNECTED}get isEstablishingConnection(){return this.state===SignalConnectionState.CONNECTING||this.state===SignalConnectionState.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var q;this.rtt=0,this.state=SignalConnectionState.DISCONNECTED,this.log=livekitLogger,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=getLogger((q=U.loggerName)!==null&&q!==void 0?q:LoggerNames.Signal),this.loggerContextCb=U.loggerContextCb,this.useJSON=F,this.requestQueue=new AsyncQueue,this.queuedRequests=[],this.closingLock=new _$1,this.connectionLock=new _$1,this.state=SignalConnectionState.DISCONNECTED}get logContext(){var F,U;return(U=(F=this.loggerContextCb)===null||F===void 0?void 0:F.call(this))!==null&&U!==void 0?U:{}}join(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){return this.state=SignalConnectionState.CONNECTING,this.options=q,yield this.connect(F,U,q,V)})}reconnect(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=SignalConnectionState.RECONNECTING,this.clearPingInterval(),yield this.connect(F,U,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:q,reconnectReason:V}))})}connect(F,U,q,V){this.connectOptions=q;const j=getClientInfo(),$=createConnectionParams(U,j,q),W=createRtcUrl(F,$),K=createValidateUrl(W);return new Promise((G,Q)=>__awaiter$1(this,void 0,void 0,function*(){const z=yield this.connectionLock.lock();try{const H=()=>__awaiter$1(this,void 0,void 0,function*(){this.close(),clearTimeout(Y),Q(new ConnectionError("room connection has been cancelled (signal)",ConnectionErrorReason.Cancelled))}),Y=setTimeout(()=>{this.close(),Q(new ConnectionError("room connection has timed out (signal)",ConnectionErrorReason.ServerUnreachable))},q.websocketTimeout);V!=null&&V.aborted&&H(),V==null||V.addEventListener("abort",H);const X=new URL(W);X.searchParams.has("access_token")&&X.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(X),Object.assign({reconnect:q.reconnect,reconnectReason:q.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(W),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(Y)},this.ws.onerror=Z=>__awaiter$1(this,void 0,void 0,function*(){if(this.state!==SignalConnectionState.CONNECTED){this.state=SignalConnectionState.DISCONNECTED,clearTimeout(Y);try{const ie=yield fetch(K);if(ie.status.toFixed(0).startsWith("4")){const ee=yield ie.text();Q(new ConnectionError(ee,ConnectionErrorReason.NotAllowed,ie.status))}else Q(new ConnectionError("Encountered unknown websocket error during connection: ".concat(Z.toString()),ConnectionErrorReason.InternalError,ie.status))}catch(ie){Q(new ConnectionError(ie instanceof Error?ie.message:"server was not reachable",ConnectionErrorReason.ServerUnreachable))}return}this.handleWSError(Z)}),this.ws.onmessage=Z=>__awaiter$1(this,void 0,void 0,function*(){var ie,ee,te;let re;if(typeof Z.data=="string"){const ne=JSON.parse(Z.data);re=SignalResponse.fromJson(ne,{ignoreUnknownFields:!0})}else if(Z.data instanceof ArrayBuffer)re=SignalResponse.fromBinary(new Uint8Array(Z.data));else{this.log.error("could not decode websocket message: ".concat(typeof Z.data),this.logContext);return}if(this.state!==SignalConnectionState.CONNECTED){let ne=!1;if(((ie=re.message)===null||ie===void 0?void 0:ie.case)==="join"?(this.state=SignalConnectionState.CONNECTED,V==null||V.removeEventListener("abort",H),this.pingTimeoutDuration=re.message.value.pingTimeout,this.pingIntervalDuration=re.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),G(re.message.value)):this.state===SignalConnectionState.RECONNECTING&&re.message.case!=="leave"?(this.state=SignalConnectionState.CONNECTED,V==null||V.removeEventListener("abort",H),this.startPingInterval(),((ee=re.message)===null||ee===void 0?void 0:ee.case)==="reconnect"?G(re.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),G(void 0),ne=!0)):this.isEstablishingConnection&&re.message.case==="leave"?Q(new ConnectionError("Received leave request while trying to (re)connect",ConnectionErrorReason.LeaveRequest,void 0,re.message.value.reason)):q.reconnect||Q(new ConnectionError("did not receive join response, got ".concat((te=re.message)===null||te===void 0?void 0:te.case," instead"),ConnectionErrorReason.InternalError)),!ne)return}this.signalLatency&&(yield sleep$1(this.signalLatency)),this.handleSignalResponse(re)}),this.ws.onclose=Z=>{this.isEstablishingConnection&&Q(new ConnectionError("Websocket got closed during a (re)connection attempt",ConnectionErrorReason.InternalError)),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:Z.reason,code:Z.code,wasClean:Z.wasClean,state:this.state})),this.handleOnClose(Z.reason)}}finally{z()}}))}close(){return __awaiter$1(this,arguments,void 0,function(){var F=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){const q=yield F.closingLock.lock();try{if(F.clearPingInterval(),U&&(F.state=SignalConnectionState.DISCONNECTING),F.ws){F.ws.onmessage=null,F.ws.onopen=null,F.ws.onclose=null;const V=new Promise(j=>{F.ws?F.ws.onclose=()=>{j()}:j()});F.ws.readyState<F.ws.CLOSING&&(F.ws.close(),yield Promise.race([V,sleep$1(250)])),F.ws=void 0}}finally{U&&(F.state=SignalConnectionState.DISCONNECTED),q()}}()})}sendOffer(F){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:F.sdp})),this.sendRequest({case:"offer",value:toProtoSessionDescription(F)})}sendAnswer(F){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:F.sdp})),this.sendRequest({case:"answer",value:toProtoSessionDescription(F)})}sendIceCandidate(F,U){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:F})),this.sendRequest({case:"trickle",value:new TrickleRequest({candidateInit:JSON.stringify(F),target:U})})}sendMuteTrack(F,U){return this.sendRequest({case:"mute",value:new MuteTrackRequest({sid:F,muted:U})})}sendAddTrack(F){return this.sendRequest({case:"addTrack",value:F})}sendUpdateLocalMetadata(F,U){return __awaiter$1(this,arguments,void 0,function(q,V){var j=this;let $=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return function*(){const W=j.getNextRequestId();return yield j.sendRequest({case:"updateMetadata",value:new UpdateParticipantMetadata({requestId:W,metadata:q,name:V,attributes:$})}),W}()})}sendUpdateTrackSettings(F){this.sendRequest({case:"trackSetting",value:F})}sendUpdateSubscription(F){return this.sendRequest({case:"subscription",value:F})}sendSyncState(F){return this.sendRequest({case:"syncState",value:F})}sendUpdateVideoLayers(F,U){return this.sendRequest({case:"updateLayers",value:new UpdateVideoLayers({trackSid:F,layers:U})})}sendUpdateSubscriptionPermissions(F,U){return this.sendRequest({case:"subscriptionPermission",value:new SubscriptionPermission({allParticipants:F,trackPermissions:U})})}sendSimulateScenario(F){return this.sendRequest({case:"simulate",value:F})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:protoInt64.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Ping({timestamp:protoInt64.parse(Date.now()),rtt:protoInt64.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(F,U){return this.sendRequest({case:"updateAudioTrack",value:new UpdateLocalAudioTrack({trackSid:F,features:U})})}sendLeave(){return this.sendRequest({case:"leave",value:new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.DISCONNECT})})}sendRequest(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return function*(){if(!V&&!canPassThroughQueue(U)&&q.state===SignalConnectionState.RECONNECTING){q.queuedRequests.push(()=>__awaiter$1(q,void 0,void 0,function*(){yield this.sendRequest(U,!0)}));return}if(V||(yield q.requestQueue.flush()),q.signalLatency&&(yield sleep$1(q.signalLatency)),!q.ws||q.ws.readyState!==q.ws.OPEN){q.log.error("cannot send signal request before connected, type: ".concat(U==null?void 0:U.case),q.logContext);return}const $=new SignalRequest({message:U});try{q.useJSON?q.ws.send($.toJsonString()):q.ws.send($.toBinary())}catch(W){q.log.error("error sending signal message",Object.assign(Object.assign({},q.logContext),{error:W}))}}()})}handleSignalResponse(F){var U,q;const V=F.message;if(V==null){this.log.debug("received unsupported message",this.logContext);return}let j=!1;if(V.case==="answer"){const $=fromProtoSessionDescription(V.value);this.onAnswer&&this.onAnswer($)}else if(V.case==="offer"){const $=fromProtoSessionDescription(V.value);this.onOffer&&this.onOffer($)}else if(V.case==="trickle"){const $=JSON.parse(V.value.candidateInit);this.onTrickle&&this.onTrickle($,V.value.target)}else V.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((U=V.value.participants)!==null&&U!==void 0?U:[]):V.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(V.value):V.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((q=V.value.speakers)!==null&&q!==void 0?q:[]):V.case==="leave"?this.onLeave&&this.onLeave(V.value):V.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(V.value.sid,V.value.muted):V.case==="roomUpdate"?this.onRoomUpdate&&V.value.room&&this.onRoomUpdate(V.value.room):V.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(V.value):V.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(V.value):V.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(V.value):V.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(V.value):V.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(V.value):V.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(V.value):V.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(V.value):V.case==="pong"||(V.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(V.value.lastPingTimestamp.toString()),this.resetPingTimeout(),j=!0):V.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(V.value):V.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(V.value.trackSid):V.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(V.value.token),this.onRoomMoved&&this.onRoomMoved(V.value)):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:V.case})));j||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const F=this.queuedRequests.shift();F&&this.requestQueue.run(F)}}handleOnClose(F){return __awaiter$1(this,void 0,void 0,function*(){if(this.state===SignalConnectionState.DISCONNECTED)return;const U=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat(F),Object.assign(Object.assign({},this.logContext),{reason:F})),U&&U(F)})}handleWSError(F){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:F}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=CriticalTimers.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&CriticalTimers.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=CriticalTimers.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&CriticalTimers.clearInterval(this.pingInterval)}}function fromProtoSessionDescription(B){const F={type:"offer",sdp:B.sdp};switch(B.type){case"answer":case"offer":case"pranswer":case"rollback":F.type=B.type;break}return F}function toProtoSessionDescription(B){return new SessionDescription({sdp:B.sdp,type:B.type})}function createConnectionParams(B,F,U){var q;const V=new URLSearchParams;return V.set("access_token",B),U.reconnect&&(V.set("reconnect","1"),U.sid&&V.set("sid",U.sid)),V.set("auto_subscribe",U.autoSubscribe?"1":"0"),V.set("sdk",isReactNative()?"reactnative":"js"),V.set("version",F.version),V.set("protocol",F.protocol.toString()),F.deviceModel&&V.set("device_model",F.deviceModel),F.os&&V.set("os",F.os),F.osVersion&&V.set("os_version",F.osVersion),F.browser&&V.set("browser",F.browser),F.browserVersion&&V.set("browser_version",F.browserVersion),U.adaptiveStream&&V.set("adaptive_stream","1"),U.reconnectReason&&V.set("reconnect_reason",U.reconnectReason.toString()),!((q=navigator.connection)===null||q===void 0)&&q.type&&V.set("network",navigator.connection.type),V}var lib={},parser={},grammar={exports:{}},hasRequiredGrammar;function requireGrammar(){if(hasRequiredGrammar)return grammar.exports;hasRequiredGrammar=1;var B=grammar.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(F){return F.encoding?"rtpmap:%d %s/%s/%s":F.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(F){return F.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(F){return F.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(F){return"extmap:%d"+(F.direction?"/%s":"%v")+(F["encrypt-uri"]?" %s":"%v")+" %s"+(F.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(F){return F.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(F){var U="candidate:%s %d %s %d %s %d typ %s";return U+=F.raddr!=null?" raddr %s rport %d":"%v%v",U+=F.tcptype!=null?" tcptype %s":"%v",F.generation!=null&&(U+=" generation %d"),U+=F["network-id"]!=null?" network-id %d":"%v",U+=F["network-cost"]!=null?" network-cost %d":"%v",U}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(F){var U="ssrc:%d";return F.attribute!=null&&(U+=" %s",F.value!=null&&(U+=":%s")),U}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(F){return F.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(F){return F.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(F){return"imageattr:%s %s %s"+(F.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(F){return"simulcast:%s %s"+(F.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(F){return"ts-refclk:%s"+(F.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(F){var U="mediaclk:";return U+=F.id!=null?"id=%s %s":"%v%s",U+=F.mediaClockValue!=null?"=%s":"",U+=F.rateNumerator!=null?" rate=%s":"",U+=F.rateDenominator!=null?"/%s":"",U}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(B).forEach(function(F){var U=B[F];U.forEach(function(q){q.reg||(q.reg=/(.*)/),q.format||(q.format="%s")})}),grammar.exports}var hasRequiredParser;function requireParser(){return hasRequiredParser||(hasRequiredParser=1,function(B){var F=function(W){return String(Number(W))===W?Number(W):W},U=function(W,K,G,Q){if(Q&&!G)K[Q]=F(W[1]);else for(var z=0;z<G.length;z+=1)W[z+1]!=null&&(K[G[z]]=F(W[z+1]))},q=function(W,K,G){var Q=W.name&&W.names;W.push&&!K[W.push]?K[W.push]=[]:Q&&!K[W.name]&&(K[W.name]={});var z=W.push?{}:Q?K[W.name]:K;U(G.match(W.reg),z,W.names,W.name),W.push&&K[W.push].push(z)},V=requireGrammar(),j=RegExp.prototype.test.bind(/^([a-z])=(.*)/);B.parse=function(W){var K={},G=[],Q=K;return W.split(/(\r\n|\r|\n)/).filter(j).forEach(function(z){var H=z[0],Y=z.slice(2);H==="m"&&(G.push({rtp:[],fmtp:[]}),Q=G[G.length-1]);for(var X=0;X<(V[H]||[]).length;X+=1){var Z=V[H][X];if(Z.reg.test(Y))return q(Z,Q,Y)}}),K.media=G,K};var $=function(W,K){var G=K.split(/=(.+)/,2);return G.length===2?W[G[0]]=F(G[1]):G.length===1&&K.length>1&&(W[G[0]]=void 0),W};B.parseParams=function(W){return W.split(/;\s?/).reduce($,{})},B.parseFmtpConfig=B.parseParams,B.parsePayloads=function(W){return W.toString().split(" ").map(Number)},B.parseRemoteCandidates=function(W){for(var K=[],G=W.split(" ").map(F),Q=0;Q<G.length;Q+=3)K.push({component:G[Q],ip:G[Q+1],port:G[Q+2]});return K},B.parseImageAttributes=function(W){return W.split(" ").map(function(K){return K.substring(1,K.length-1).split(",").reduce($,{})})},B.parseSimulcastStreamList=function(W){return W.split(";").map(function(K){return K.split(",").map(function(G){var Q,z=!1;return G[0]!=="~"?Q=F(G):(Q=F(G.substring(1,G.length)),z=!0),{scid:Q,paused:z}})})}}(parser)),parser}var writer$1,hasRequiredWriter$1;function requireWriter$1(){if(hasRequiredWriter$1)return writer$1;hasRequiredWriter$1=1;var B=requireGrammar(),F=/%[sdv%]/g,U=function($){var W=1,K=arguments,G=K.length;return $.replace(F,function(Q){if(W>=G)return Q;var z=K[W];switch(W+=1,Q){case"%%":return"%";case"%s":return String(z);case"%d":return Number(z);case"%v":return""}})},q=function($,W,K){var G=W.format instanceof Function?W.format(W.push?K:K[W.name]):W.format,Q=[$+"="+G];if(W.names)for(var z=0;z<W.names.length;z+=1){var H=W.names[z];W.name?Q.push(K[W.name][H]):Q.push(K[W.names[z]])}else Q.push(K[W.name]);return U.apply(null,Q)},V=["v","o","s","i","u","e","p","c","b","t","r","z","a"],j=["i","c","b","a"];return writer$1=function($,W){W=W||{},$.version==null&&($.version=0),$.name==null&&($.name=" "),$.media.forEach(function(z){z.payloads==null&&(z.payloads="")});var K=W.outerOrder||V,G=W.innerOrder||j,Q=[];return K.forEach(function(z){B[z].forEach(function(H){H.name in $&&$[H.name]!=null?Q.push(q(z,H,$)):H.push in $&&$[H.push]!=null&&$[H.push].forEach(function(Y){Q.push(q(z,H,Y))})})}),$.media.forEach(function(z){Q.push(q("m",B.m[0],z)),G.forEach(function(H){B[H].forEach(function(Y){Y.name in z&&z[Y.name]!=null?Q.push(q(H,Y,z)):Y.push in z&&z[Y.push]!=null&&z[Y.push].forEach(function(X){Q.push(q(H,Y,X))})})})}),Q.join(`\r
`)+`\r
`},writer$1}var hasRequiredLib;function requireLib(){if(hasRequiredLib)return lib;hasRequiredLib=1;var B=requireParser(),F=requireWriter$1(),U=requireGrammar();return lib.grammar=U,lib.write=F,lib.parse=B.parse,lib.parseParams=B.parseParams,lib.parseFmtpConfig=B.parseFmtpConfig,lib.parsePayloads=B.parsePayloads,lib.parseRemoteCandidates=B.parseRemoteCandidates,lib.parseImageAttributes=B.parseImageAttributes,lib.parseSimulcastStreamList=B.parseSimulcastStreamList,lib}var libExports=requireLib();function r$1(B,F,U){var q,V,j;F===void 0&&(F=50),U===void 0&&(U={});var $=(q=U.isImmediate)!=null&&q,W=(V=U.callback)!=null&&V,K=U.maxWait,G=Date.now(),Q=[];function z(){if(K!==void 0){var Y=Date.now()-G;if(Y+F>=K)return K-Y}return F}var H=function(){var Y=[].slice.call(arguments),X=this;return new Promise(function(Z,ie){var ee=$&&j===void 0;if(j!==void 0&&clearTimeout(j),j=setTimeout(function(){if(j=void 0,G=Date.now(),!$){var re=B.apply(X,Y);W&&W(re),Q.forEach(function(ne){return(0,ne.resolve)(re)}),Q=[]}},z()),ee){var te=B.apply(X,Y);return W&&W(te),Z(te)}Q.push({resolve:Z,reject:ie})})};return H.cancel=function(Y){j!==void 0&&clearTimeout(j),Q.forEach(function(X){return(0,X.reject)(Y)}),Q=[]},H}const startBitrateForSVC=.7,debounceInterval=20,PCEvents={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class PCTransport extends eventsExports.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(F){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var q;super(),this.log=livekitLogger,this.ddExtID=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=r$1(V=>__awaiter$1(this,void 0,void 0,function*(){this.emit(PCEvents.NegotiationStarted);try{yield this.createAndSendOffer()}catch(j){if(V)V(j);else throw j}}),debounceInterval),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=getLogger((q=U.loggerName)!==null&&q!==void 0?q:LoggerNames.PCTransport),this.loggerOptions=U,this.config=F,this._pc=this.createPC()}createPC(){const F=new RTCPeerConnection(this.config);return F.onicecandidate=U=>{var q;U.candidate&&((q=this.onIceCandidate)===null||q===void 0||q.call(this,U.candidate))},F.onicecandidateerror=U=>{var q;(q=this.onIceCandidateError)===null||q===void 0||q.call(this,U)},F.oniceconnectionstatechange=()=>{var U;(U=this.onIceConnectionStateChange)===null||U===void 0||U.call(this,F.iceConnectionState)},F.onsignalingstatechange=()=>{var U;(U=this.onSignalingStatechange)===null||U===void 0||U.call(this,F.signalingState)},F.onconnectionstatechange=()=>{var U;(U=this.onConnectionStateChange)===null||U===void 0||U.call(this,F.connectionState)},F.ondatachannel=U=>{var q;(q=this.onDataChannel)===null||q===void 0||q.call(this,U)},F.ontrack=U=>{var q;(q=this.onTrack)===null||q===void 0||q.call(this,U)},F}get logContext(){var F,U;return Object.assign({},(U=(F=this.loggerOptions).loggerContextCb)===null||U===void 0?void 0:U.call(F))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(F){return __awaiter$1(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(F);this.pendingCandidates.push(F)})}setRemoteDescription(F){return __awaiter$1(this,void 0,void 0,function*(){var U;let q;if(F.type==="offer"){let{stereoMids:V,nackMids:j}=extractStereoAndNackAudioFromOffer(F);this.remoteStereoMids=V,this.remoteNackMids=j}else if(F.type==="answer"){const V=libExports.parse((U=F.sdp)!==null&&U!==void 0?U:"");V.media.forEach(j=>{j.type==="audio"&&this.trackBitrates.some($=>{if(!$.transceiver||j.mid!=$.transceiver.mid)return!1;let W=0;if(j.rtp.some(G=>G.codec.toUpperCase()===$.codec.toUpperCase()?(W=G.payload,!0):!1),W===0)return!0;let K=!1;for(const G of j.fmtp)if(G.payload===W){G.config=G.config.split(";").filter(Q=>!Q.includes("maxaveragebitrate")).join(";"),$.maxbr>0&&(G.config+=";maxaveragebitrate=".concat($.maxbr*1e3)),K=!0;break}return K||$.maxbr>0&&j.fmtp.push({payload:W,config:"maxaveragebitrate=".concat($.maxbr*1e3)}),!0})}),q=libExports.write(V)}yield this.setMungedSDP(F,q,!0),this.pendingCandidates.forEach(V=>{this.pc.addIceCandidate(V)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):F.type==="answer"&&(this.emit(PCEvents.NegotiationComplete),F.sdp&&libExports.parse(F.sdp).media.forEach(j=>{j.type==="video"&&this.emit(PCEvents.RTPVideoPayloadTypes,j.rtp)}))})}createAndSendOffer(F){return __awaiter$1(this,void 0,void 0,function*(){var U;if(this.onOffer===void 0)return;if(F!=null&&F.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const j=this._pc.remoteDescription;if(F!=null&&F.iceRestart&&j)yield this._pc.setRemoteDescription(j);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const q=yield this.pc.createOffer(F);this.log.debug("original offer",Object.assign({sdp:q.sdp},this.logContext));const V=libExports.parse((U=q.sdp)!==null&&U!==void 0?U:"");V.media.forEach(j=>{ensureIPAddrMatchVersion(j),j.type==="audio"?ensureAudioNackAndStereo(j,[],[]):j.type==="video"&&this.trackBitrates.some($=>{if(!j.msid||!$.cid||!j.msid.includes($.cid))return!1;let W=0;if(j.rtp.some(G=>G.codec.toUpperCase()===$.codec.toUpperCase()?(W=G.payload,!0):!1),W===0||(isSVCCodec($.codec)&&this.ensureVideoDDExtensionForSVC(j,V),$.codec!=="av1"))return!0;const K=Math.round($.maxbr*startBitrateForSVC);for(const G of j.fmtp)if(G.payload===W){G.config.includes("x-google-start-bitrate")||(G.config+=";x-google-start-bitrate=".concat(K));break}return!0})}),yield this.setMungedSDP(q,libExports.write(V)),this.onOffer(q)})}createAndSetAnswer(){return __awaiter$1(this,void 0,void 0,function*(){var F;const U=yield this.pc.createAnswer(),q=libExports.parse((F=U.sdp)!==null&&F!==void 0?F:"");return q.media.forEach(V=>{ensureIPAddrMatchVersion(V),V.type==="audio"&&ensureAudioNackAndStereo(V,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(U,libExports.write(q)),U})}createDataChannel(F,U){return this.pc.createDataChannel(F,U)}addTransceiver(F,U){return this.pc.addTransceiver(F,U)}addTrack(F){if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot add track");return this._pc.addTrack(F)}setTrackCodecBitrate(F){this.trackBitrates.push(F)}setConfiguration(F){var U;if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot configure");return(U=this._pc)===null||U===void 0?void 0:U.setConfiguration(F)}canRemoveTrack(){var F;return!!(!((F=this._pc)===null||F===void 0)&&F.removeTrack)}removeTrack(F){var U;return(U=this._pc)===null||U===void 0?void 0:U.removeTrack(F)}getConnectionState(){var F,U;return(U=(F=this._pc)===null||F===void 0?void 0:F.connectionState)!==null&&U!==void 0?U:"closed"}getICEConnectionState(){var F,U;return(U=(F=this._pc)===null||F===void 0?void 0:F.iceConnectionState)!==null&&U!==void 0?U:"closed"}getSignallingState(){var F,U;return(U=(F=this._pc)===null||F===void 0?void 0:F.signalingState)!==null&&U!==void 0?U:"closed"}getTransceivers(){var F,U;return(U=(F=this._pc)===null||F===void 0?void 0:F.getTransceivers())!==null&&U!==void 0?U:[]}getSenders(){var F,U;return(U=(F=this._pc)===null||F===void 0?void 0:F.getSenders())!==null&&U!==void 0?U:[]}getLocalDescription(){var F;return(F=this._pc)===null||F===void 0?void 0:F.localDescription}getRemoteDescription(){var F;return(F=this.pc)===null||F===void 0?void 0:F.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return __awaiter$1(this,void 0,void 0,function*(){var F;if(!this._pc)return;let U="";const q=new Map,V=new Map;if((yield this._pc.getStats()).forEach(W=>{switch(W.type){case"transport":U=W.selectedCandidatePairId;break;case"candidate-pair":U===""&&W.selected&&(U=W.id),q.set(W.id,W);break;case"remote-candidate":V.set(W.id,"".concat(W.address,":").concat(W.port));break}}),U==="")return;const $=(F=q.get(U))===null||F===void 0?void 0:F.remoteCandidateId;if($!==void 0)return V.get($)})}setMungedSDP(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){if(U){const V=F.sdp;F.sdp=U;try{this.log.debug("setting munged ".concat(q?"remote":"local"," description"),this.logContext),q?yield this.pc.setRemoteDescription(F):yield this.pc.setLocalDescription(F);return}catch(j){this.log.warn("not able to set ".concat(F.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:j,sdp:U})),F.sdp=V}}try{q?yield this.pc.setRemoteDescription(F):yield this.pc.setLocalDescription(F)}catch(V){let j="unknown error";V instanceof Error?j=V.message:typeof V=="string"&&(j=V);const $={error:j,sdp:F.sdp};throw!q&&this.pc.remoteDescription&&($.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(F.type),Object.assign(Object.assign({},this.logContext),{fields:$})),new NegotiationError(j)}})}ensureVideoDDExtensionForSVC(F,U){var q,V;if(!((q=F.ext)===null||q===void 0?void 0:q.some($=>$.uri===ddExtensionURI))){if(this.ddExtID===0){let $=0;U.media.forEach(W=>{var K;W.type==="video"&&((K=W.ext)===null||K===void 0||K.forEach(G=>{G.value>$&&($=G.value)}))}),this.ddExtID=$+1}(V=F.ext)===null||V===void 0||V.push({value:this.ddExtID,uri:ddExtensionURI})}}}function ensureAudioNackAndStereo(B,F,U){let q=0;B.rtp.some(V=>V.codec==="opus"?(q=V.payload,!0):!1),q>0&&(B.rtcpFb||(B.rtcpFb=[]),U.includes(B.mid)&&!B.rtcpFb.some(V=>V.payload===q&&V.type==="nack")&&B.rtcpFb.push({payload:q,type:"nack"}),F.includes(B.mid)&&B.fmtp.some(V=>V.payload===q?(V.config.includes("stereo=1")||(V.config+=";stereo=1"),!0):!1))}function extractStereoAndNackAudioFromOffer(B){var F;const U=[],q=[],V=libExports.parse((F=B.sdp)!==null&&F!==void 0?F:"");let j=0;return V.media.forEach($=>{var W;$.type==="audio"&&($.rtp.some(K=>K.codec==="opus"?(j=K.payload,!0):!1),!((W=$.rtcpFb)===null||W===void 0)&&W.some(K=>K.payload===j&&K.type==="nack")&&q.push($.mid),$.fmtp.some(K=>K.payload===j?(K.config.includes("sprop-stereo=1")&&U.push($.mid),!0):!1))}),{stereoMids:U,nackMids:q}}function ensureIPAddrMatchVersion(B){if(B.connection){const F=B.connection.ip.indexOf(":")>=0;(B.connection.version===4&&F||B.connection.version===6&&!F)&&(B.connection.ip="0.0.0.0",B.connection.version=4)}}const defaultVideoCodec="vp8",publishDefaults={audioPreset:AudioPresets.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ScreenSharePresets.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:defaultVideoCodec,backupCodec:!0,preConnectBuffer:!1},audioDefaults={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},videoDefaults={deviceId:{ideal:"default"},resolution:VideoPresets.h720.resolution},roomOptionDefaults={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new DefaultReconnectPolicy,disconnectOnPageLeave:!0,webAudioMix:!1},roomConnectOptionDefaults={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var PCTransportState;(function(B){B[B.NEW=0]="NEW",B[B.CONNECTING=1]="CONNECTING",B[B.CONNECTED=2]="CONNECTED",B[B.FAILED=3]="FAILED",B[B.CLOSING=4]="CLOSING",B[B.CLOSED=5]="CLOSED"})(PCTransportState||(PCTransportState={}));class PCTransportManager{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(F,U,q){var V;this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.log=livekitLogger,this.updateState=()=>{var j;const $=this.state,W=this.requiredTransports.map(K=>K.getConnectionState());W.every(K=>K==="connected")?this.state=PCTransportState.CONNECTED:W.some(K=>K==="failed")?this.state=PCTransportState.FAILED:W.some(K=>K==="connecting")?this.state=PCTransportState.CONNECTING:W.every(K=>K==="closed")?this.state=PCTransportState.CLOSED:W.some(K=>K==="closed")?this.state=PCTransportState.CLOSING:W.every(K=>K==="new")&&(this.state=PCTransportState.NEW),$!==this.state&&(this.log.debug("pc state change: from ".concat(PCTransportState[$]," to ").concat(PCTransportState[this.state]),this.logContext),(j=this.onStateChange)===null||j===void 0||j.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=getLogger((V=q.loggerName)!==null&&V!==void 0?V:LoggerNames.PCManager),this.loggerOptions=q,this.isPublisherConnectionRequired=!U,this.isSubscriberConnectionRequired=U,this.publisher=new PCTransport(F,q),this.subscriber=new PCTransport(F,q),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=j=>{var $;($=this.onIceCandidate)===null||$===void 0||$.call(this,j,SignalTarget.PUBLISHER)},this.subscriber.onIceCandidate=j=>{var $;($=this.onIceCandidate)===null||$===void 0||$.call(this,j,SignalTarget.SUBSCRIBER)},this.subscriber.onDataChannel=j=>{var $;($=this.onDataChannel)===null||$===void 0||$.call(this,j)},this.subscriber.onTrack=j=>{var $;($=this.onTrack)===null||$===void 0||$.call(this,j)},this.publisher.onOffer=j=>{var $;($=this.onPublisherOffer)===null||$===void 0||$.call(this,j)},this.state=PCTransportState.NEW,this.connectionLock=new _$1,this.remoteOfferLock=new _$1}get logContext(){var F,U;return Object.assign({},(U=(F=this.loggerOptions).loggerContextCb)===null||U===void 0?void 0:U.call(F))}requirePublisher(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=F,this.updateState()}requireSubscriber(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=F,this.updateState()}createAndSendPublisherOffer(F){return this.publisher.createAndSendOffer(F)}setPublisherAnswer(F){return this.publisher.setRemoteDescription(F)}removeTrack(F){return this.publisher.removeTrack(F)}close(){return __awaiter$1(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const F=this.publisher;for(const U of F.getSenders())try{F.canRemoveTrack()&&F.removeTrack(U)}catch(q){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:q}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return __awaiter$1(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(F,U){return __awaiter$1(this,void 0,void 0,function*(){U===SignalTarget.PUBLISHER?yield this.publisher.addIceCandidate(F):yield this.subscriber.addIceCandidate(F)})}createSubscriberAnswerFromOffer(F){return __awaiter$1(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:F.type,sdp:F.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const U=yield this.remoteOfferLock.lock();try{return yield this.subscriber.setRemoteDescription(F),yield this.subscriber.createAndSetAnswer()}finally{U()}})}updateConfiguration(F,U){this.publisher.setConfiguration(F),this.subscriber.setConfiguration(F),U&&this.triggerIceRestart()}ensurePCTransportConnection(F,U){return __awaiter$1(this,void 0,void 0,function*(){var q;const V=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((q=this.requiredTransports)===null||q===void 0?void 0:q.map(j=>this.ensureTransportConnected(j,F,U)))}finally{V()}})}negotiate(F){return __awaiter$1(this,void 0,void 0,function*(){return new Promise((U,q)=>__awaiter$1(this,void 0,void 0,function*(){const V=setTimeout(()=>{q("negotiation timed out")},this.peerConnectionTimeout),j=()=>{clearTimeout(V),q("negotiation aborted")};F.signal.addEventListener("abort",j),this.publisher.once(PCEvents.NegotiationStarted,()=>{F.signal.aborted||this.publisher.once(PCEvents.NegotiationComplete,()=>{clearTimeout(V),U()})}),yield this.publisher.negotiate($=>{clearTimeout(V),q($)})}))})}addPublisherTransceiver(F,U){return this.publisher.addTransceiver(F,U)}addPublisherTrack(F){return this.publisher.addTrack(F)}createPublisherDataChannel(F,U){return this.publisher.createDataChannel(F,U)}getConnectedAddress(F){return F===SignalTarget.PUBLISHER?this.publisher.getConnectedAddress():F===SignalTarget.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const F=[];return this.isPublisherConnectionRequired&&F.push(this.publisher),this.isSubscriberConnectionRequired&&F.push(this.subscriber),F}ensureTransportConnected(F,U){return __awaiter$1(this,arguments,void 0,function(q,V){var j=this;let $=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return function*(){if(q.getConnectionState()!=="connected")return new Promise((K,G)=>__awaiter$1(j,void 0,void 0,function*(){const Q=()=>{this.log.warn("abort transport connection",this.logContext),CriticalTimers.clearTimeout(z),G(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled))};V!=null&&V.signal.aborted&&Q(),V==null||V.signal.addEventListener("abort",Q);const z=CriticalTimers.setTimeout(()=>{V==null||V.signal.removeEventListener("abort",Q),G(new ConnectionError("could not establish pc connection",ConnectionErrorReason.InternalError))},$);for(;this.state!==PCTransportState.CONNECTED;)if(yield sleep$1(50),V!=null&&V.signal.aborted){G(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled));return}CriticalTimers.clearTimeout(z),V==null||V.signal.removeEventListener("abort",Q),K()}))}()})}}class RpcError extends Error{constructor(F,U,q){super(U),this.code=F,this.message=truncateBytes(U,RpcError.MAX_MESSAGE_BYTES),this.data=q?truncateBytes(q,RpcError.MAX_DATA_BYTES):void 0}static fromProto(F){return new RpcError(F.code,F.message,F.data)}toProto(){return new RpcError$1({code:this.code,message:this.message,data:this.data})}static builtIn(F,U){return new RpcError(RpcError.ErrorCode[F],RpcError.ErrorMessage[F],U)}}RpcError.MAX_MESSAGE_BYTES=256,RpcError.MAX_DATA_BYTES=15360,RpcError.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},RpcError.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const MAX_PAYLOAD_BYTES=15360;function byteLength(B){return new TextEncoder().encode(B).length}function truncateBytes(B,F){if(byteLength(B)<=F)return B;let U=0,q=B.length;const V=new TextEncoder;for(;U<q;){const j=Math.floor((U+q+1)/2);V.encode(B.slice(0,j)).length<=F?U=j:q=j-1}return B.slice(0,U)}const monitorFrequency=2e3;function computeBitrate(B,F){if(!F)return 0;let U,q;return"bytesReceived"in B?(U=B.bytesReceived,q=F.bytesReceived):"bytesSent"in B&&(U=B.bytesSent,q=F.bytesSent),U===void 0||q===void 0||B.timestamp===void 0||F.timestamp===void 0?0:(U-q)*8*1e3/(B.timestamp-F.timestamp)}const isMediaRecorderAvailable=typeof MediaRecorder<"u";class FallbackRecorder{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const RecorderBase=isMediaRecorderAvailable?MediaRecorder:FallbackRecorder;class LocalTrackRecorder extends RecorderBase{constructor(F,U){if(!isMediaRecorderAvailable)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([F.mediaStreamTrack]),U);let q,V;const j=()=>V===void 0,$=()=>{this.removeEventListener("dataavailable",q),this.removeEventListener("stop",$),this.removeEventListener("error",W),V==null||V.close(),V=void 0},W=K=>{V==null||V.error(K),this.removeEventListener("dataavailable",q),this.removeEventListener("stop",$),this.removeEventListener("error",W),V=void 0};this.byteStream=new ReadableStream({start:K=>{V=K,q=G=>__awaiter$1(this,void 0,void 0,function*(){const Q=yield G.data.arrayBuffer();j()||K.enqueue(new Uint8Array(Q))}),this.addEventListener("dataavailable",q)},cancel:()=>{$()}}),this.addEventListener("stop",$),this.addEventListener("error",W)}}function isRecordingSupported(){return isMediaRecorderAvailable}const DEFAULT_DIMENSIONS_TIMEOUT=1e3,PRE_CONNECT_BUFFER_TIMEOUT=1e4;class LocalTrack extends Track{get sender(){return this._sender}set sender(F){this._sender=F}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(F,U,q){let V=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,j=arguments.length>4?arguments[4]:void 0;super(F,U,j),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=r$1(()=>__awaiter$1(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>__awaiter$1(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(TrackEvent.Ended,this)},this.reacquireTrack=!1,this.providedByUser=V,this.muteLock=new _$1,this.pauseUpstreamLock=new _$1,this.processorLock=new _$1,this.restartLock=new _$1,this.setMediaStreamTrack(F,!0),this._constraints=F.getConstraints(),q&&(this._constraints=q)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Track.Kind.Video)return;const{width:F,height:U}=this._mediaStreamTrack.getSettings();if(F&&U)return{width:F,height:U}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var F,U;return(U=(F=this.processor)===null||F===void 0?void 0:F.processedTrack)!==null&&U!==void 0?U:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(F,U){return __awaiter$1(this,void 0,void 0,function*(){var q;if(F===this._mediaStreamTrack&&!U)return;this._mediaStreamTrack&&(this.attachedElements.forEach(j=>{detachTrack(this._mediaStreamTrack,j)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([F]),F&&(F.addEventListener("ended",this.handleEnded),F.addEventListener("mute",this.handleTrackMuteEvent),F.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=F.getConstraints());let V;if(this.processor&&F){const j=yield this.processorLock.lock();try{if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(attachToElement(F,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:F,kind:this.kind,element:this.processorElement}),V=this.processor.processedTrack}finally{j()}}this.sender&&((q=this.sender.transport)===null||q===void 0?void 0:q.state)!=="closed"&&(yield this.sender.replaceTrack(V??F)),!this.providedByUser&&this._mediaStreamTrack!==F&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=F,F&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(j=>{attachToElement(V??F,j)}))})}waitForDimensions(){return __awaiter$1(this,arguments,void 0,function(){var F=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:DEFAULT_DIMENSIONS_TIMEOUT;return function*(){var q;if(F.kind===Track.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((q=getBrowser())===null||q===void 0?void 0:q.os)==="iOS"&&(yield sleep$1(10));const V=Date.now();for(;Date.now()-V<U;){const j=F.dimensions;if(j)return j;yield sleep$1(50)}throw new TrackInvalidError("unable to get track dimensions after timeout")}()})}setDeviceId(F){return __awaiter$1(this,void 0,void 0,function*(){return this._constraints.deviceId===F&&this._mediaStreamTrack.getSettings().deviceId===unwrapConstraint(F)||(this._constraints.deviceId=F,this.isMuted)?!0:(yield this.restartTrack(),unwrapConstraint(F)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return __awaiter$1(this,arguments,void 0,function(){var F=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){if(F.source===Track.Source.ScreenShare)return;const{deviceId:q,groupId:V}=F._mediaStreamTrack.getSettings(),j=F.kind===Track.Kind.Audio?"audioinput":"videoinput";return U?DeviceManager.getInstance().normalizeDeviceId(j,q,V):q}()})}mute(){return __awaiter$1(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return __awaiter$1(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(F,U){return __awaiter$1(this,void 0,void 0,function*(){if(!this.sender)throw new TrackInvalidError("unable to replace an unpublished track");let q,V;return typeof U=="boolean"?q=U:U!==void 0&&(q=U.userProvidedTrack,V=U.stopProcessor),this.providedByUser=q??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(F),V&&this.processor&&(yield this.stopProcessor()),this})}restart(F){return __awaiter$1(this,void 0,void 0,function*(){this.manuallyStopped=!1;const U=yield this.restartLock.lock();try{F||(F=this._constraints);const{deviceId:q,facingMode:V}=F,j=__rest(F,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:F}));const $={audio:!1,video:!1};this.kind===Track.Kind.Video?$.video=q||V?{deviceId:q,facingMode:V}:!0:$.audio=q?{deviceId:q}:!0,this.attachedElements.forEach(G=>{detachTrack(this.mediaStreamTrack,G)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const K=(yield navigator.mediaDevices.getUserMedia($)).getTracks()[0];return yield K.applyConstraints(j),K.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(K),this._constraints=F,this.emit(TrackEvent.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{U()}})}setTrackMuted(F){this.log.debug("setting ".concat(this.kind," track ").concat(F?"muted":"unmuted"),this.logContext),!(this.isMuted===F&&this._mediaStreamTrack.enabled!==F)&&(this.isMuted=F,this._mediaStreamTrack.enabled=!F,this.emit(F?TrackEvent.Muted:TrackEvent.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const F=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield F.handleAppVisibilityChanged.call(this),isMobile()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var F;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(F=this.processor)===null||F===void 0||F.destroy(),this.processor=void 0}pauseUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var F;const U=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(TrackEvent.UpstreamPaused,this);const q=getBrowser();if((q==null?void 0:q.name)==="Safari"&&compareVersions(q.version,"12.0")<0)throw new DeviceUnsupportedError("pauseUpstream is not supported on Safari < 12.");((F=this.sender.transport)===null||F===void 0?void 0:F.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{U()}})}resumeUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var F;const U=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(TrackEvent.UpstreamResumed,this),((F=this.sender.transport)===null||F===void 0?void 0:F.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{U()}})}getRTCStatsReport(){return __awaiter$1(this,void 0,void 0,function*(){var F;return!((F=this.sender)===null||F===void 0)&&F.getStats?yield this.sender.getStats():void 0})}setProcessor(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var j;const $=yield q.processorLock.lock();try{q.log.debug("setting up processor",q.logContext);const W=document.createElement(q.kind),K={kind:q.kind,track:q._mediaStreamTrack,element:W,audioContext:q.audioContext};if(yield U.init(K),q.log.debug("processor initialized",q.logContext),q.processor&&(yield q.stopProcessor()),q.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(attachToElement(q._mediaStreamTrack,W),W.muted=!0,W.play().catch(G=>q.log.error("failed to play processor element",Object.assign(Object.assign({},q.logContext),{error:G}))),q.processor=U,q.processorElement=W,q.processor.processedTrack){for(const G of q.attachedElements)G!==q.processorElement&&V&&(detachTrack(q._mediaStreamTrack,G),attachToElement(q.processor.processedTrack,G));yield(j=q.sender)===null||j===void 0?void 0:j.replaceTrack(q.processor.processedTrack)}q.emit(TrackEvent.TrackProcessorUpdate,q.processor)}finally{$()}}()})}getProcessor(){return this.processor}stopProcessor(){return __awaiter$1(this,arguments,void 0,function(){var F=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var q,V;F.processor&&(F.log.debug("stopping processor",F.logContext),(q=F.processor.processedTrack)===null||q===void 0||q.stop(),yield F.processor.destroy(),F.processor=void 0,U||((V=F.processorElement)===null||V===void 0||V.remove(),F.processorElement=void 0),yield F._mediaStreamTrack.applyConstraints(F._constraints),yield F.setMediaStreamTrack(F._mediaStreamTrack,!0),F.emit(TrackEvent.TrackProcessorUpdate))}()})}startPreConnectBuffer(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!isRecordingSupported()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(!this.localTrackRecorder)this.localTrackRecorder=new LocalTrackRecorder(this,{mimeType:"audio/webm;codecs=opus"});else{this.log.warn("preconnect buffer already started");return}this.localTrackRecorder.start(F),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},PRE_CONNECT_BUFFER_TIMEOUT)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var F;return(F=this.localTrackRecorder)===null||F===void 0?void 0:F.byteStream}}class LocalAudioTrack extends LocalTrack{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(F,U){let q=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,V=arguments.length>3?arguments[3]:void 0,j=arguments.length>4?arguments[4]:void 0;super(F,Track.Kind.Audio,U,q,j),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let $;try{$=yield this.getSenderStats()}catch(W){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:W}));return}$&&this.prevStats&&(this._currentBitrate=computeBitrate($,this.prevStats)),this.prevStats=$}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=V,this.checkForSilence()}mute(){const F=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$1(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield F.mute.call(this),this)}finally{U()}})}unmute(){const F=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$1(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const q=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==unwrapConstraint(this._constraints.deviceId);return this.source===Track.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||q)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield F.unmute.call(this),this}finally{U()}})}restartTrack(F){return __awaiter$1(this,void 0,void 0,function*(){let U;if(F){const q=constraintsForOptions({audio:F});typeof q.audio!="boolean"&&(U=q.audio)}yield this.restart(U)})}restart(F){const U=Object.create(null,{restart:{get:()=>super.restart}});return __awaiter$1(this,void 0,void 0,function*(){const q=yield U.restart.call(this,F);return this.checkForSilence(),q})}startMonitor(){isWeb()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency)))}setProcessor(F){return __awaiter$1(this,void 0,void 0,function*(){var U;const q=yield this.processorLock.lock();try{if(!isReactNative()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.stopProcessor());const V={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(F.name),this.logContext),yield F.init(V),this.processor=F,this.processor.processedTrack&&(yield(U=this.sender)===null||U===void 0?void 0:U.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(TrackEvent.TrackProcessorUpdate,this.processor)}finally{q()}})}setAudioContext(F){this.audioContext=F}getSenderStats(){return __awaiter$1(this,void 0,void 0,function*(){var F;if(!(!((F=this.sender)===null||F===void 0)&&F.getStats))return;const U=yield this.sender.getStats();let q;return U.forEach(V=>{V.type==="outbound-rtp"&&(q={type:"audio",streamId:V.id,packetsSent:V.packetsSent,packetsLost:V.packetsLost,bytesSent:V.bytesSent,timestamp:V.timestamp,roundTripTime:V.roundTripTime,jitter:V.jitter})}),q})}checkForSilence(){return __awaiter$1(this,void 0,void 0,function*(){const F=yield detectSilence(this);return F&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(TrackEvent.AudioSilenceDetected)),F})}}function mediaTrackToLocalTrack(B,F,U){switch(B.kind){case"audio":return new LocalAudioTrack(B,F,!1,void 0,U);case"video":return new LocalVideoTrack(B,F,!1,U);default:throw new TrackInvalidError("unsupported track type: ".concat(B.kind))}}const presets169=Object.values(VideoPresets),presets43=Object.values(VideoPresets43),presetsScreenShare=Object.values(ScreenSharePresets),defaultSimulcastPresets169=[VideoPresets.h180,VideoPresets.h360],defaultSimulcastPresets43=[VideoPresets43.h180,VideoPresets43.h360],computeDefaultScreenShareSimulcastPresets=B=>[{scaleResolutionDownBy:2,fps:B.encoding.maxFramerate}].map(U=>{var q,V;return new VideoPreset(Math.floor(B.width/U.scaleResolutionDownBy),Math.floor(B.height/U.scaleResolutionDownBy),Math.max(15e4,Math.floor(B.encoding.maxBitrate/(Math.pow(U.scaleResolutionDownBy,2)*(((q=B.encoding.maxFramerate)!==null&&q!==void 0?q:30)/((V=U.fps)!==null&&V!==void 0?V:30))))),U.fps,B.encoding.priority)}),videoRids=["q","h","f"];function computeVideoEncodings(B,F,U,q){var V,j;let $=q==null?void 0:q.videoEncoding;B&&($=q==null?void 0:q.screenShareEncoding);const W=q==null?void 0:q.simulcast,K=q==null?void 0:q.scalabilityMode,G=q==null?void 0:q.videoCodec;if(!$&&!W&&!K||!F||!U)return[{}];$||($=determineAppropriateEncoding(B,F,U,G),livekitLogger.debug("using video encoding",$));const Q=$.maxFramerate,z=new VideoPreset(F,U,$.maxBitrate,$.maxFramerate,$.priority);if(K&&isSVCCodec(G)){const X=new ScalabilityMode(K),Z=[];if(X.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(K));const ie=getBrowser();if(isSafari()||isReactNative()||(ie==null?void 0:ie.name)==="Chrome"&&compareVersions(ie==null?void 0:ie.version,"113")<0){const ee=X.suffix=="h"?2:3,te=isSafariSvcApi(ie);for(let re=0;re<X.spatial;re+=1)Z.push({rid:videoRids[2-re],maxBitrate:$.maxBitrate/Math.pow(ee,re),maxFramerate:z.encoding.maxFramerate,scaleResolutionDownBy:te?Math.pow(2,re):void 0});Z[0].scalabilityMode=K}else Z.push({maxBitrate:$.maxBitrate,maxFramerate:z.encoding.maxFramerate,scalabilityMode:K});return z.encoding.priority&&(Z[0].priority=z.encoding.priority,Z[0].networkPriority=z.encoding.priority),livekitLogger.debug("using svc encoding",{encodings:Z}),Z}if(!W)return[$];let H=[];B?H=(V=sortPresets(q==null?void 0:q.screenShareSimulcastLayers))!==null&&V!==void 0?V:defaultSimulcastLayers(B,z):H=(j=sortPresets(q==null?void 0:q.videoSimulcastLayers))!==null&&j!==void 0?j:defaultSimulcastLayers(B,z);let Y;if(H.length>0){const X=H[0];H.length>1&&([,Y]=H);const Z=Math.max(F,U);if(Z>=960&&Y)return encodingsFromPresets(F,U,[X,Y,z],Q);if(Z>=480)return encodingsFromPresets(F,U,[X,z],Q)}return encodingsFromPresets(F,U,[z])}function computeTrackBackupEncodings(B,F,U){var q,V,j,$;if(!U.backupCodec||U.backupCodec===!0||U.backupCodec.codec===U.videoCodec)return;F!==U.backupCodec.codec&&livekitLogger.warn("requested a different codec than specified as backup",{serverRequested:F,backup:U.backupCodec.codec}),U.videoCodec=F,U.videoEncoding=U.backupCodec.encoding;const W=B.mediaStreamTrack.getSettings(),K=(q=W.width)!==null&&q!==void 0?q:(V=B.dimensions)===null||V===void 0?void 0:V.width,G=(j=W.height)!==null&&j!==void 0?j:($=B.dimensions)===null||$===void 0?void 0:$.height;return B.source===Track.Source.ScreenShare&&U.simulcast&&(U.simulcast=!1),computeVideoEncodings(B.source===Track.Source.ScreenShare,K,G,U)}function determineAppropriateEncoding(B,F,U,q){const V=presetsForResolution(B,F,U);let{encoding:j}=V[0];const $=Math.max(F,U);for(let W=0;W<V.length;W+=1){const K=V[W];if(j=K.encoding,K.width>=$)break}if(q)switch(q){case"av1":j=Object.assign({},j),j.maxBitrate=j.maxBitrate*.7;break;case"vp9":j=Object.assign({},j),j.maxBitrate=j.maxBitrate*.85;break}return j}function presetsForResolution(B,F,U){if(B)return presetsScreenShare;const q=F>U?F/U:U/F;return Math.abs(q-16/9)<Math.abs(q-4/3)?presets169:presets43}function defaultSimulcastLayers(B,F){if(B)return computeDefaultScreenShareSimulcastPresets(F);const{width:U,height:q}=F,V=U>q?U/q:q/U;return Math.abs(V-16/9)<Math.abs(V-4/3)?defaultSimulcastPresets169:defaultSimulcastPresets43}function encodingsFromPresets(B,F,U,q){const V=[];if(U.forEach((j,$)=>{if($>=videoRids.length)return;const W=Math.min(B,F),G={rid:videoRids[$],scaleResolutionDownBy:Math.max(1,W/Math.min(j.width,j.height)),maxBitrate:j.encoding.maxBitrate},Q=q&&j.encoding.maxFramerate?Math.min(q,j.encoding.maxFramerate):j.encoding.maxFramerate;Q&&(G.maxFramerate=Q);const z=isFireFox()||$===0;j.encoding.priority&&z&&(G.priority=j.encoding.priority,G.networkPriority=j.encoding.priority),V.push(G)}),isReactNative()&&getReactNativeOs()==="ios"){let j;V.forEach(W=>{j?W.maxFramerate&&W.maxFramerate>j&&(j=W.maxFramerate):j=W.maxFramerate});let $=!0;V.forEach(W=>{var K;W.maxFramerate!=j&&($&&($=!1,livekitLogger.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),livekitLogger.info('Setting framerate of encoding "'.concat((K=W.rid)!==null&&K!==void 0?K:"",'" to ').concat(j)),W.maxFramerate=j)})}return V}function sortPresets(B){if(B)return B.sort((F,U)=>{const{encoding:q}=F,{encoding:V}=U;return q.maxBitrate>V.maxBitrate?1:q.maxBitrate<V.maxBitrate?-1:q.maxBitrate===V.maxBitrate&&q.maxFramerate&&V.maxFramerate?q.maxFramerate>V.maxFramerate?1:-1:0})}class ScalabilityMode{constructor(F){const U=F.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!U)throw new Error("invalid scalability mode");if(this.spatial=parseInt(U[1]),this.temporal=parseInt(U[2]),U.length>3)switch(U[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=U[3]}}toString(){var F;return"L".concat(this.spatial,"T").concat(this.temporal).concat((F=this.suffix)!==null&&F!==void 0?F:"")}}function getDefaultDegradationPreference(B){return B.source===Track.Source.ScreenShare||B.constraints.height&&unwrapConstraint(B.constraints.height)>=1080?"maintain-resolution":"balanced"}const refreshSubscribedCodecAfterNewCodec=5e3;class LocalVideoTrack extends LocalTrack{get sender(){return this._sender}set sender(F){this._sender=F,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(F,U){let q=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,V=arguments.length>3?arguments[3]:void 0;super(F,Track.Kind.Video,U,q,V),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.monitorSender=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let j;try{j=yield this.getSenderStats()}catch(W){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:W}));return}const $=new Map(j.map(W=>[W.rid,W]));if(this.prevStats){let W=0;$.forEach((K,G)=>{var Q;const z=(Q=this.prevStats)===null||Q===void 0?void 0:Q.get(G);W+=computeBitrate(K,z)}),this._currentBitrate=W}this.prevStats=$}),this.senderLock=new _$1}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(F){var U;if(this.signalClient=F,!isWeb())return;const q=(U=this.sender)===null||U===void 0?void 0:U.getParameters();q&&(this.encodings=q.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(F=>{F.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const F=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return __awaiter$1(this,void 0,void 0,function*(){var U,q,V,j,$;yield F.pauseUpstream.call(this);try{for(var W=!0,K=__asyncValues(this.simulcastCodecs.values()),G;G=yield K.next(),U=G.done,!U;W=!0)j=G.value,W=!1,yield($=j.sender)===null||$===void 0?void 0:$.replaceTrack(null)}catch(Q){q={error:Q}}finally{try{!W&&!U&&(V=K.return)&&(yield V.call(K))}finally{if(q)throw q.error}}})}resumeUpstream(){const F=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return __awaiter$1(this,void 0,void 0,function*(){var U,q,V,j,$;yield F.resumeUpstream.call(this);try{for(var W=!0,K=__asyncValues(this.simulcastCodecs.values()),G;G=yield K.next(),U=G.done,!U;W=!0){j=G.value,W=!1;const Q=j;yield($=Q.sender)===null||$===void 0?void 0:$.replaceTrack(Q.mediaStreamTrack)}}catch(Q){q={error:Q}}finally{try{!W&&!U&&(V=K.return)&&(yield V.call(K))}finally{if(q)throw q.error}}})}mute(){const F=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$1(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield F.mute.call(this),this)}finally{U()}})}unmute(){const F=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$1(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield F.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{U()}})}setTrackMuted(F){super.setTrackMuted(F);for(const U of this.simulcastCodecs.values())U.mediaStreamTrack.enabled=!F}getSenderStats(){return __awaiter$1(this,void 0,void 0,function*(){var F;if(!(!((F=this.sender)===null||F===void 0)&&F.getStats))return[];const U=[],q=yield this.sender.getStats();return q.forEach(V=>{var j;if(V.type==="outbound-rtp"){const $={type:"video",streamId:V.id,frameHeight:V.frameHeight,frameWidth:V.frameWidth,framesPerSecond:V.framesPerSecond,framesSent:V.framesSent,firCount:V.firCount,pliCount:V.pliCount,nackCount:V.nackCount,packetsSent:V.packetsSent,bytesSent:V.bytesSent,qualityLimitationReason:V.qualityLimitationReason,qualityLimitationDurations:V.qualityLimitationDurations,qualityLimitationResolutionChanges:V.qualityLimitationResolutionChanges,rid:(j=V.rid)!==null&&j!==void 0?j:V.id,retransmittedPacketsSent:V.retransmittedPacketsSent,targetBitrate:V.targetBitrate,timestamp:V.timestamp},W=q.get(V.remoteId);W&&($.jitter=W.jitter,$.packetsLost=W.packetsLost,$.roundTripTime=W.roundTripTime),U.push($)}}),U.sort((V,j)=>{var $,W;return(($=j.frameWidth)!==null&&$!==void 0?$:0)-((W=V.frameWidth)!==null&&W!==void 0?W:0)}),U})}setPublishingQuality(F){const U=[];for(let q=VideoQuality.LOW;q<=VideoQuality.HIGH;q+=1)U.push(new SubscribedQuality({quality:q,enabled:q<=F}));this.log.debug("setting publishing quality. max quality ".concat(F),this.logContext),this.setPublishingLayers(isSVCCodec(this.codec),U)}restartTrack(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q,V,j,$;let W;if(F){const z=constraintsForOptions({video:F});typeof z.video!="boolean"&&(W=z.video)}yield this.restart(W);try{for(var K=!0,G=__asyncValues(this.simulcastCodecs.values()),Q;Q=yield G.next(),U=Q.done,!U;K=!0){j=Q.value,K=!1;const z=j;z.sender&&(($=z.sender.transport)===null||$===void 0?void 0:$.state)!=="closed"&&(z.mediaStreamTrack=this.mediaStreamTrack.clone(),yield z.sender.replaceTrack(z.mediaStreamTrack))}}catch(z){q={error:z}}finally{try{!K&&!U&&(V=G.return)&&(yield V.call(G))}finally{if(q)throw q.error}}})}setProcessor(F){const U=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return __awaiter$1(this,arguments,void 0,function(q){var V=this;let j=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var $,W,K,G,Q,z;if(yield U.setProcessor.call(V,q,j),!((Q=V.processor)===null||Q===void 0)&&Q.processedTrack)try{for(var H=!0,Y=__asyncValues(V.simulcastCodecs.values()),X;X=yield Y.next(),$=X.done,!$;H=!0)G=X.value,H=!1,yield(z=G.sender)===null||z===void 0?void 0:z.replaceTrack(V.processor.processedTrack)}catch(Z){W={error:Z}}finally{try{!H&&!$&&(K=Y.return)&&(yield K.call(Y))}finally{if(W)throw W.error}}}()})}setDegradationPreference(F){return __awaiter$1(this,void 0,void 0,function*(){if(this.degradationPreference=F,this.sender)try{this.log.debug("setting degradationPreference to ".concat(F),this.logContext);const U=this.sender.getParameters();U.degradationPreference=F,this.sender.setParameters(U)}catch(U){this.log.warn("failed to set degradationPreference",Object.assign({error:U},this.logContext))}})}addSimulcastTrack(F,U){if(this.simulcastCodecs.has(F)){this.log.error("".concat(F," already added, skipping adding simulcast codec"),this.logContext);return}const q={codec:F,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:U};return this.simulcastCodecs.set(F,q),q}setSimulcastTrackSender(F,U){const q=this.simulcastCodecs.get(F);q&&(q.sender=U,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},refreshSubscribedCodecAfterNewCodec))}setPublishingCodecs(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q,V,j,$,W,K;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:F,currentCodec:this.codec})),!this.codec&&F.length>0)return yield this.setPublishingLayers(isSVCCodec(F[0].codec),F[0].qualities),[];this.subscribedCodecs=F;const G=[];try{for(U=!0,q=__asyncValues(F);V=yield q.next(),j=V.done,!j;U=!0){K=V.value,U=!1;const Q=K;if(!this.codec||this.codec===Q.codec)yield this.setPublishingLayers(isSVCCodec(Q.codec),Q.qualities);else{const z=this.simulcastCodecs.get(Q.codec);if(this.log.debug("try setPublishingCodec for ".concat(Q.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:z})),!z||!z.sender){for(const H of Q.qualities)if(H.enabled){G.push(Q.codec);break}}else z.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(Q.codec),this.logContext),yield setPublishingLayersForSender(z.sender,z.encodings,Q.qualities,this.senderLock,isSVCCodec(Q.codec),this.log,this.logContext))}}}catch(Q){$={error:Q}}finally{try{!U&&!j&&(W=q.return)&&(yield W.call(q))}finally{if($)throw $.error}}return G})}setPublishingLayers(F,U){return __awaiter$1(this,void 0,void 0,function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:U})),!(!this.sender||!this.encodings)&&(yield setPublishingLayersForSender(this.sender,this.encodings,U,this.senderLock,F,this.log,this.logContext))})}handleAppVisibilityChanged(){const F=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield F.handleAppVisibilityChanged.call(this),isMobile()&&this.isInBackground&&this.source===Track.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function setPublishingLayersForSender(B,F,U,q,V,j,$){return __awaiter$1(this,void 0,void 0,function*(){const W=yield q.lock();j.debug("setPublishingLayersForSender",Object.assign(Object.assign({},$),{sender:B,qualities:U,senderEncodings:F}));try{const K=B.getParameters(),{encodings:G}=K;if(!G)return;if(G.length!==F.length){j.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},$),{encodings:G,senderEncodings:F}));return}let Q=!1;const z=getBrowser();if((z==null?void 0:z.name)==="Chrome"&&compareVersions(z==null?void 0:z.version,"133")>0&&G[0].scalabilityMode){const Y=G[0],X=new ScalabilityMode(Y.scalabilityMode);let Z=VideoQuality$1.OFF;if(U.forEach(ie=>{ie.enabled&&(Z===VideoQuality$1.OFF||ie.quality>Z)&&(Z=ie.quality)}),Z===VideoQuality$1.OFF)Y.active&&(Y.active=!1,Q=!0);else if(!Y.active||X.spatial!==Z+1){Q=!0,Y.active=!0;const ie=new ScalabilityMode(F[0].scalabilityMode);X.spatial=Z+1,X.suffix=ie.suffix,X.spatial===1&&(X.suffix=void 0),Y.scalabilityMode=X.toString(),Y.scaleResolutionDownBy=Math.pow(2,2-Z),F[0].maxBitrate&&(Y.maxBitrate=F[0].maxBitrate/(Y.scaleResolutionDownBy*Y.scaleResolutionDownBy))}}else V&&U.some(X=>X.enabled)&&U.forEach(X=>X.enabled=!0),G.forEach((Y,X)=>{var Z;let ie=(Z=Y.rid)!==null&&Z!==void 0?Z:"";ie===""&&(ie="q");const ee=videoQualityForRid(ie),te=U.find(re=>re.quality===ee);te&&Y.active!==te.enabled&&(Q=!0,Y.active=te.enabled,j.debug("setting layer ".concat(te.quality," to ").concat(Y.active?"enabled":"disabled"),$),isFireFox()&&(te.enabled?(Y.scaleResolutionDownBy=F[X].scaleResolutionDownBy,Y.maxBitrate=F[X].maxBitrate,Y.maxFrameRate=F[X].maxFrameRate):(Y.scaleResolutionDownBy=4,Y.maxBitrate=10,Y.maxFrameRate=2)))});Q&&(K.encodings=G,j.debug("setting encodings",Object.assign(Object.assign({},$),{encodings:K.encodings})),yield B.setParameters(K))}finally{W()}})}function videoQualityForRid(B){switch(B){case"f":return VideoQuality.HIGH;case"h":return VideoQuality.MEDIUM;case"q":return VideoQuality.LOW;default:return VideoQuality.HIGH}}function videoLayersFromEncodings(B,F,U,q){if(!U)return[new VideoLayer({quality:VideoQuality.HIGH,width:B,height:F,bitrate:0,ssrc:0})];if(q){const V=U[0].scalabilityMode,j=new ScalabilityMode(V),$=[],W=j.suffix=="h"?1.5:2,K=j.suffix=="h"?2:3;for(let G=0;G<j.spatial;G+=1)$.push(new VideoLayer({quality:Math.min(VideoQuality.HIGH,j.spatial-1)-G,width:Math.ceil(B/Math.pow(W,G)),height:Math.ceil(F/Math.pow(W,G)),bitrate:U[0].maxBitrate?Math.ceil(U[0].maxBitrate/Math.pow(K,G)):0,ssrc:0}));return $}return U.map(V=>{var j,$,W;const K=(j=V.scaleResolutionDownBy)!==null&&j!==void 0?j:1;let G=videoQualityForRid(($=V.rid)!==null&&$!==void 0?$:"");return new VideoLayer({quality:G,width:Math.ceil(B/K),height:Math.ceil(F/K),bitrate:(W=V.maxBitrate)!==null&&W!==void 0?W:0,ssrc:0})})}const lossyDataChannel="_lossy",reliableDataChannel="_reliable",minReconnectWait=2*1e3,leaveReconnect="leave-reconnect";var PCState;(function(B){B[B.New=0]="New",B[B.Connected=1]="Connected",B[B.Disconnected=2]="Disconnected",B[B.Reconnecting=3]="Reconnecting",B[B.Closed=4]="Closed"})(PCState||(PCState={}));class RTCEngine extends eventsExports.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(F){var U;super(),this.options=F,this.rtcConfig={},this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=PCState.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=livekitLogger,this.handleDataChannel=q=>__awaiter$1(this,[q],void 0,function(V){var j=this;let{channel:$}=V;return function*(){if($){if($.label===reliableDataChannel)j.reliableDCSub=$;else if($.label===lossyDataChannel)j.lossyDCSub=$;else return;j.log.debug("on data channel ".concat($.id,", ").concat($.label),j.logContext),$.onmessage=j.handleDataMessage}}()}),this.handleDataMessage=q=>__awaiter$1(this,void 0,void 0,function*(){var V,j;const $=yield this.dataProcessLock.lock();try{let W;if(q.data instanceof ArrayBuffer)W=q.data;else if(q.data instanceof Blob)W=yield q.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:q.data}));return}const K=DataPacket.fromBinary(new Uint8Array(W));((V=K.value)===null||V===void 0?void 0:V.case)==="speaker"?this.emit(EngineEvent.ActiveSpeakersUpdate,K.value.value.speakers):(((j=K.value)===null||j===void 0?void 0:j.case)==="user"&&applyUserDataCompat(K,K.value.value),this.emit(EngineEvent.DataPacketReceived,K))}finally{$()}}),this.handleDataError=q=>{const j=q.currentTarget.maxRetransmits===0?"lossy":"reliable";if(q instanceof ErrorEvent&&q.error){const{error:$}=q.error;this.log.error("DataChannel error on ".concat(j,": ").concat(q.message),Object.assign(Object.assign({},this.logContext),{error:$}))}else this.log.error("Unknown DataChannel error on ".concat(j),Object.assign(Object.assign({},this.logContext),{event:q}))},this.handleBufferedAmountLow=q=>{const j=q.currentTarget.maxRetransmits===0?DataPacket_Kind.LOSSY:DataPacket_Kind.RELIABLE;this.updateAndEmitDCBufferStatus(j)},this.handleDisconnect=(q,V)=>{if(this._isClosed)return;this.log.warn("".concat(q," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const j=K=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(K,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),this.close()},$=Date.now()-this.reconnectStart;let W=this.getNextRetryDelay({elapsedMs:$,retryCount:this.reconnectAttempts});if(W===null){j($);return}q===leaveReconnect&&(W=0),this.log.debug("reconnecting in ".concat(W,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=CriticalTimers.setTimeout(()=>this.attemptReconnect(V).finally(()=>this.reconnectTimeout=void 0),W)},this.waitForRestarted=()=>new Promise((q,V)=>{this.pcState===PCState.Connected&&q();const j=()=>{this.off(EngineEvent.Disconnected,$),q()},$=()=>{this.off(EngineEvent.Restarted,j),V()};this.once(EngineEvent.Restarted,j),this.once(EngineEvent.Disconnected,$)}),this.updateAndEmitDCBufferStatus=q=>{const V=this.isBufferStatusLow(q);typeof V<"u"&&V!==this.dcBufferStatus.get(q)&&(this.dcBufferStatus.set(q,V),this.emit(EngineEvent.DCBufferStatusChanged,V,q))},this.isBufferStatusLow=q=>{const V=this.dataChannelForKind(q);if(V)return V.bufferedAmount<=V.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===SignalConnectionState.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(ReconnectReason.RR_SIGNAL_DISCONNECTED))},this.log=getLogger((U=F.loggerName)!==null&&U!==void 0?U:LoggerNames.Engine),this.loggerOptions={loggerName:F.loggerName,loggerContextCb:()=>this.logContext},this.client=new SignalClient(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new _$1,this.dataProcessLock=new _$1,this.dcBufferStatus=new Map([[DataPacket_Kind.LOSSY,!0],[DataPacket_Kind.RELIABLE,!0]]),this.client.onParticipantUpdate=q=>this.emit(EngineEvent.ParticipantUpdate,q),this.client.onConnectionQuality=q=>this.emit(EngineEvent.ConnectionQualityUpdate,q),this.client.onRoomUpdate=q=>this.emit(EngineEvent.RoomUpdate,q),this.client.onSubscriptionError=q=>this.emit(EngineEvent.SubscriptionError,q),this.client.onSubscriptionPermissionUpdate=q=>this.emit(EngineEvent.SubscriptionPermissionUpdate,q),this.client.onSpeakersChanged=q=>this.emit(EngineEvent.SpeakersChanged,q),this.client.onStreamStateUpdate=q=>this.emit(EngineEvent.StreamStateChanged,q),this.client.onRequestResponse=q=>this.emit(EngineEvent.SignalRequestResponse,q)}get logContext(){var F,U,q,V,j,$;return{room:(U=(F=this.latestJoinResponse)===null||F===void 0?void 0:F.room)===null||U===void 0?void 0:U.name,roomID:(V=(q=this.latestJoinResponse)===null||q===void 0?void 0:q.room)===null||V===void 0?void 0:V.sid,participant:($=(j=this.latestJoinResponse)===null||j===void 0?void 0:j.participant)===null||$===void 0?void 0:$.identity,pID:this.participantSid}}join(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){this.url=F,this.token=U,this.signalOpts=q,this.maxJoinAttempts=q.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const j=yield this.client.join(F,U,q,V);return this._isClosed=!1,this.latestJoinResponse=j,this.subscriberPrimary=j.subscriberPrimary,this.pcManager||(yield this.configure(j)),(!this.subscriberPrimary||j.fastPublish)&&this.negotiate(),this.clientConfiguration=j.clientConfiguration,this.emit(EngineEvent.SignalConnected,j),j}catch(j){if(j instanceof ConnectionError&&j.reason===ConnectionErrorReason.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(F,U,q,V);throw j}})}close(){return __awaiter$1(this,void 0,void 0,function*(){const F=yield this.closingLock.lock();if(this.isClosed){F();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(EngineEvent.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{F()}})}cleanupPeerConnections(){return __awaiter$1(this,void 0,void 0,function*(){var F;yield(F=this.pcManager)===null||F===void 0?void 0:F.close(),this.pcManager=void 0;const U=q=>{q&&(q.close(),q.onbufferedamountlow=null,q.onclose=null,q.onclosing=null,q.onerror=null,q.onmessage=null,q.onopen=null)};U(this.lossyDC),U(this.lossyDCSub),U(this.reliableDC),U(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0})}cleanupClient(){return __awaiter$1(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(F){if(this.pendingTrackResolvers[F.cid])throw new TrackInvalidError("a track with the same ID has already been published");return new Promise((U,q)=>{const V=setTimeout(()=>{delete this.pendingTrackResolvers[F.cid],q(new ConnectionError("publication of local track timed out, no response from server",ConnectionErrorReason.Timeout))},1e4);this.pendingTrackResolvers[F.cid]={resolve:j=>{clearTimeout(V),U(j)},reject:()=>{clearTimeout(V),q(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(F)})}removeTrack(F){if(F.track&&this.pendingTrackResolvers[F.track.id]){const{reject:U}=this.pendingTrackResolvers[F.track.id];U&&U(),delete this.pendingTrackResolvers[F.track.id]}try{return this.pcManager.removeTrack(F),!0}catch(U){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:U}))}return!1}updateMuteStatus(F,U){this.client.sendMuteTrack(F,U)}get dataSubscriberReadyState(){var F;return(F=this.reliableDCSub)===null||F===void 0?void 0:F.readyState}getConnectedServerAddress(){return __awaiter$1(this,void 0,void 0,function*(){var F;return(F=this.pcManager)===null||F===void 0?void 0:F.getConnectedAddress()})}setRegionUrlProvider(F){this.regionUrlProvider=F}configure(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q;if(this.pcManager&&this.pcManager.currentState!==PCTransportState.NEW)return;this.participantSid=(U=F.participant)===null||U===void 0?void 0:U.sid;const V=this.makeRTCConfiguration(F);this.pcManager=new PCTransportManager(V,F.subscriberPrimary,this.loggerOptions),this.emit(EngineEvent.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(j,$)=>{this.client.sendIceCandidate(j,$)},this.pcManager.onPublisherOffer=j=>{this.client.sendOffer(j)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(j,$,W)=>__awaiter$1(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(j),this.logContext),["closed","disconnected","failed"].includes($)&&(this.publisherConnectionPromise=void 0),j===PCTransportState.CONNECTED){const Q=this.pcState===PCState.New;this.pcState=PCState.Connected,Q&&this.emit(EngineEvent.Connected,F)}else j===PCTransportState.FAILED&&this.pcState===PCState.Connected&&(this.pcState=PCState.Disconnected,this.handleDisconnect("peerconnection failed",W==="failed"?ReconnectReason.RR_SUBSCRIBER_FAILED:ReconnectReason.RR_PUBLISHER_FAILED));const K=this.client.isDisconnected||this.client.currentState===SignalConnectionState.RECONNECTING,G=[PCTransportState.FAILED,PCTransportState.CLOSING,PCTransportState.CLOSED].includes(j);K&&G&&!this._isClosed&&this.emit(EngineEvent.Offline)}),this.pcManager.onTrack=j=>{this.emit(EngineEvent.MediaTrackAdded,j.track,j.streams[0],j.receiver)},supportOptionalDatachannel((q=F.serverInfo)===null||q===void 0?void 0:q.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=F=>__awaiter$1(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:F.type})),yield this.pcManager.setPublisherAnswer(F))}),this.client.onTrickle=(F,U)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:F,target:U})),this.pcManager.addIceCandidate(F,U))},this.client.onOffer=F=>__awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)return;const U=yield this.pcManager.createSubscriberAnswerFromOffer(F);this.client.sendAnswer(U)}),this.client.onLocalTrackPublished=F=>{var U;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:F.cid,track:(U=F.track)===null||U===void 0?void 0:U.sid})),!this.pendingTrackResolvers[F.cid]){this.log.error("missing track resolver for ".concat(F.cid),Object.assign(Object.assign({},this.logContext),{cid:F.cid}));return}const{resolve:q}=this.pendingTrackResolvers[F.cid];delete this.pendingTrackResolvers[F.cid],q(F.track)},this.client.onLocalTrackUnpublished=F=>{this.emit(EngineEvent.LocalTrackUnpublished,F)},this.client.onLocalTrackSubscribed=F=>{this.emit(EngineEvent.LocalTrackSubscribed,F)},this.client.onTokenRefresh=F=>{this.token=F},this.client.onRemoteMuteChanged=(F,U)=>{this.emit(EngineEvent.RemoteMute,F,U)},this.client.onSubscribedQualityUpdate=F=>{this.emit(EngineEvent.SubscribedQualityUpdate,F)},this.client.onRoomMoved=F=>{var U;this.participantSid=(U=F.participant)===null||U===void 0?void 0:U.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=F.room),this.emit(EngineEvent.RoomMoved,F)},this.client.onClose=()=>{this.handleDisconnect("signal",ReconnectReason.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=F=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:F==null?void 0:F.reason})),F.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(F.regions)),F.action){case LeaveRequest_Action.DISCONNECT:this.emit(EngineEvent.Disconnected,F==null?void 0:F.reason),this.close();break;case LeaveRequest_Action.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(leaveReconnect);break;case LeaveRequest_Action.RESUME:this.handleDisconnect(leaveReconnect)}}}makeRTCConfiguration(F){var U;const q=Object.assign({},this.rtcConfig);if(!((U=this.signalOpts)===null||U===void 0)&&U.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),q.encodedInsertableStreams=!0),F.iceServers&&!q.iceServers){const V=[];F.iceServers.forEach(j=>{const $={urls:j.urls};j.username&&($.username=j.username),j.credential&&($.credential=j.credential),V.push($)}),q.iceServers=V}return F.clientConfiguration&&F.clientConfiguration.forceRelay===ClientConfigSetting.ENABLED&&(q.iceTransportPolicy="relay"),q.sdpSemantics="unified-plan",q.continualGatheringPolicy="gather_continually",q}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(lossyDataChannel,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(reliableDataChannel,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){if(supportsTransceiver())return yield this.createTransceiverRTCRtpSender(F,U,q);if(supportsAddTrack())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(F.mediaStreamTrack);throw new UnexpectedConnectionState("Required webRTC APIs not supported on this device")})}createSimulcastSender(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){if(supportsTransceiver())return this.createSimulcastTransceiverSender(F,U,q,V);if(supportsAddTrack())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(F.mediaStreamTrack);throw new UnexpectedConnectionState("Cannot stream on this device")})}createTransceiverRTCRtpSender(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const V=[];F.mediaStream&&V.push(F.mediaStream),isVideoTrack(F)&&(F.codec=U.videoCodec);const j={direction:"sendonly",streams:V};return q&&(j.sendEncodings=q),(yield this.pcManager.addPublisherTransceiver(F.mediaStreamTrack,j)).sender})}createSimulcastTransceiverSender(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const j={direction:"sendonly"};V&&(j.sendEncodings=V);const $=yield this.pcManager.addPublisherTransceiver(U.mediaStreamTrack,j);if(q.videoCodec)return F.setSimulcastTrackSender(q.videoCodec,$.sender),$.sender})}createRTCRtpSender(F){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");return this.pcManager.addPublisherTrack(F)})}attemptReconnect(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q,V;if(!this._isClosed){if(this.attemptingReconnect){livekitLogger.warn("already attempting reconnect, returning early",this.logContext);return}(((U=this.clientConfiguration)===null||U===void 0?void 0:U.resumeConnection)===ClientConfigSetting.DISABLED||((V=(q=this.pcManager)===null||q===void 0?void 0:q.currentState)!==null&&V!==void 0?V:PCTransportState.NEW)===PCTransportState.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(F),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(j){this.reconnectAttempts+=1;let $=!0;j instanceof UnexpectedConnectionState?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:j})),$=!1):j instanceof SignalReconnectError||(this.fullReconnectOnNext=!0),$?this.handleDisconnect("reconnect",ReconnectReason.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(F){try{return this.reconnectPolicy.nextRetryDelayInMs(F)}catch(U){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:U}))}return null}restartConnection(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q,V;try{if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let j;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new SignalReconnectError;j=yield this.join(F??this.url,this.token,this.signalOpts)}catch($){throw $ instanceof ConnectionError&&$.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):new SignalReconnectError}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(EngineEvent.SignalRestarted,j),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");(U=this.regionUrlProvider)===null||U===void 0||U.resetAttempts(),this.emit(EngineEvent.Restarted)}catch(j){const $=yield(q=this.regionUrlProvider)===null||q===void 0?void 0:q.getNextBestRegionUrl();if($){yield this.restartConnection($);return}else throw(V=this.regionUrlProvider)===null||V===void 0||V.resetAttempts(),j}})}resumeConnection(F){return __awaiter$1(this,void 0,void 0,function*(){var U;if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");if(!this.pcManager)throw new UnexpectedConnectionState("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Resuming);let q;try{this.setupSignalClientCallbacks(),q=yield this.client.reconnect(this.url,this.token,this.participantSid,F)}catch(V){let j="";throw V instanceof Error&&(j=V.message,this.log.error(V.message,Object.assign(Object.assign({},this.logContext),{error:V}))),V instanceof ConnectionError&&V.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):V instanceof ConnectionError&&V.reason===ConnectionErrorReason.LeaveRequest?V:new SignalReconnectError(j)}if(this.emit(EngineEvent.SignalResumed),q){const V=this.makeRTCConfiguration(q);this.pcManager.updateConfiguration(V)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");this.client.setReconnected(),((U=this.reliableDC)===null||U===void 0?void 0:U.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),this.emit(EngineEvent.Resumed)})}waitForPCInitialConnection(F,U){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(U,F)})}waitForPCReconnected(){return __awaiter$1(this,void 0,void 0,function*(){this.pcState=PCState.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield sleep$1(minReconnectWait),!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=PCState.Connected}catch(F){throw this.pcState=PCState.Disconnected,new ConnectionError("could not establish PC connection, ".concat(F.message),ConnectionErrorReason.InternalError)}})}publishRpcResponse(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){const j=new DataPacket({destinationIdentities:[F],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcResponse",value:new RpcResponse({requestId:U,value:V?{case:"error",value:V.toProto()}:{case:"payload",value:q??""}})}});yield this.sendDataPacket(j,DataPacket_Kind.RELIABLE)})}publishRpcAck(F,U){return __awaiter$1(this,void 0,void 0,function*(){const q=new DataPacket({destinationIdentities:[F],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcAck",value:new RpcAck({requestId:U})}});yield this.sendDataPacket(q,DataPacket_Kind.RELIABLE)})}sendDataPacket(F,U){return __awaiter$1(this,void 0,void 0,function*(){const q=F.toBinary();yield this.ensurePublisherConnected(U);const V=this.dataChannelForKind(U);V&&V.send(q),this.updateAndEmitDCBufferStatus(U)})}waitForBufferStatusLow(F){return new Promise((U,q)=>__awaiter$1(this,void 0,void 0,function*(){if(this.isBufferStatusLow(F))U();else{const V=()=>q("Engine closed");for(this.once(EngineEvent.Closing,V);!this.dcBufferStatus.get(F);)yield sleep$1(10);this.off(EngineEvent.Closing,V),U()}}))}ensureDataTransportConnected(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return function*(){var j;if(!q.pcManager)throw new UnexpectedConnectionState("PC manager is closed");const $=V?q.pcManager.subscriber:q.pcManager.publisher,W=V?"Subscriber":"Publisher";if(!$)throw new ConnectionError("".concat(W," connection not set"),ConnectionErrorReason.InternalError);let K=!1;!V&&!q.dataChannelForKind(U,V)&&(q.createDataChannels(),K=!0),!K&&!V&&!q.pcManager.publisher.isICEConnected&&q.pcManager.publisher.getICEConnectionState()!=="checking"&&(K=!0),K&&q.negotiate();const G=q.dataChannelForKind(U,V);if((G==null?void 0:G.readyState)==="open")return;const Q=new Date().getTime()+q.peerConnectionTimeout;for(;new Date().getTime()<Q;){if($.isICEConnected&&((j=q.dataChannelForKind(U,V))===null||j===void 0?void 0:j.readyState)==="open")return;yield sleep$1(50)}throw new ConnectionError("could not establish ".concat(W," connection, state: ").concat($.getICEConnectionState()),ConnectionErrorReason.InternalError)}()})}ensurePublisherConnected(F){return __awaiter$1(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(F,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==PCTransportState.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return __awaiter$1(this,void 0,void 0,function*(){return new Promise((F,U)=>__awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager){U(new NegotiationError("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const q=new AbortController,V=()=>{q.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),F()};this.isClosed&&U("cannot negotiate on closed engine"),this.on(EngineEvent.Closing,V),this.pcManager.publisher.once(PCEvents.RTPVideoPayloadTypes,j=>{const $=new Map;j.forEach(W=>{const K=W.codec.toLowerCase();isVideoCodec(K)&&$.set(W.payload,K)}),this.emit(EngineEvent.RTPVideoMapUpdate,$)});try{yield this.pcManager.negotiate(q),F()}catch(j){j instanceof NegotiationError&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",ReconnectReason.RR_UNKNOWN),U(j)}finally{this.off(EngineEvent.Closing,V)}}))})}dataChannelForKind(F,U){if(U){if(F===DataPacket_Kind.LOSSY)return this.lossyDCSub;if(F===DataPacket_Kind.RELIABLE)return this.reliableDCSub}else{if(F===DataPacket_Kind.LOSSY)return this.lossyDC;if(F===DataPacket_Kind.RELIABLE)return this.reliableDC}}sendSyncState(F,U){var q,V;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const j=this.pcManager.subscriber.getLocalDescription(),$=this.pcManager.subscriber.getRemoteDescription(),W=(V=(q=this.signalOpts)===null||q===void 0?void 0:q.autoSubscribe)!==null&&V!==void 0?V:!0,K=new Array,G=new Array;F.forEach(Q=>{Q.isDesired!==W&&K.push(Q.trackSid),Q.isEnabled||G.push(Q.trackSid)}),this.client.sendSyncState(new SyncState({answer:j?toProtoSessionDescription({sdp:j.sdp,type:j.type}):void 0,offer:$?toProtoSessionDescription({sdp:$.sdp,type:$.type}):void 0,subscription:new UpdateSubscription({trackSids:K,subscribe:!W,participantTracks:[]}),publishTracks:getTrackPublicationInfo(U),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:G}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const F=[],U=(q,V)=>{(q==null?void 0:q.id)!==void 0&&q.id!==null&&F.push(new DataChannelInfo({label:q.label,id:q.id,target:V}))};return U(this.dataChannelForKind(DataPacket_Kind.LOSSY),SignalTarget.PUBLISHER),U(this.dataChannelForKind(DataPacket_Kind.RELIABLE),SignalTarget.PUBLISHER),U(this.dataChannelForKind(DataPacket_Kind.LOSSY,!0),SignalTarget.SUBSCRIBER),U(this.dataChannelForKind(DataPacket_Kind.RELIABLE,!0),SignalTarget.SUBSCRIBER),F}clearReconnectTimeout(){this.reconnectTimeout&&CriticalTimers.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){isWeb()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){isWeb()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class SignalReconnectError extends Error{}function supportOptionalDatachannel(B){return B!==void 0&&B>13}function applyUserDataCompat(B,F){const U=B.participantIdentity?B.participantIdentity:F.participantIdentity;B.participantIdentity=U,F.participantIdentity=U;const q=B.destinationIdentities.length!==0?B.destinationIdentities:F.destinationIdentities;B.destinationIdentities=q,F.destinationIdentities=q}class RegionUrlProvider{constructor(F,U){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(F),this.token=U}updateToken(F){this.token=F}isCloud(){return isCloud(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(F){return __awaiter$1(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(F));const U=this.regionSettings.regions.filter(q=>!this.attemptedRegions.find(V=>V.url===q.url));if(U.length>0){const q=U[0];return this.attemptedRegions.push(q),livekitLogger.debug("next region: ".concat(q.region)),q.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(F){return __awaiter$1(this,void 0,void 0,function*(){const U=yield fetch("".concat(getCloudConfigUrl(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:F});if(U.ok){const q=yield U.json();return this.lastUpdateAt=Date.now(),q}else throw new ConnectionError("Could not fetch region settings: ".concat(U.statusText),U.status===401?ConnectionErrorReason.NotAllowed:ConnectionErrorReason.InternalError,U.status)})}setServerReportedRegions(F){this.regionSettings=F,this.lastUpdateAt=Date.now()}}function getCloudConfigUrl(B){return"".concat(B.protocol.replace("ws","http"),"//").concat(B.host,"/settings")}class BaseStreamReader{get info(){return this._info}constructor(F,U,q){this.reader=U,this.totalByteSize=q,this._info=F,this.bytesReceived=0}}class ByteStreamReader extends BaseStreamReader{handleChunkReceived(F){var U;this.bytesReceived+=F.content.byteLength;const q=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(U=this.onProgress)===null||U===void 0||U.call(this,q)}[Symbol.asyncIterator](){const F=this.reader.getReader();return{next:()=>__awaiter$1(this,void 0,void 0,function*(){try{const{done:U,value:q}=yield F.read();return U?{done:!0,value:void 0}:(this.handleChunkReceived(q),{done:!1,value:q.content})}catch{return{done:!0,value:void 0}}}),return(){return __awaiter$1(this,void 0,void 0,function*(){return F.releaseLock(),{done:!0,value:void 0}})}}}readAll(){return __awaiter$1(this,void 0,void 0,function*(){var F,U,q,V;let j=new Set;try{for(var $=!0,W=__asyncValues(this),K;K=yield W.next(),F=K.done,!F;$=!0){V=K.value,$=!1;const G=V;j.add(G)}}catch(G){U={error:G}}finally{try{!$&&!F&&(q=W.return)&&(yield q.call(W))}finally{if(U)throw U.error}}return Array.from(j)})}}class TextStreamReader extends BaseStreamReader{constructor(F,U,q){super(F,U,q),this.receivedChunks=new Map}handleChunkReceived(F){var U;const q=bigIntToNumber(F.chunkIndex),V=this.receivedChunks.get(q);if(V&&V.version>F.version)return;this.receivedChunks.set(q,F),this.bytesReceived+=F.content.byteLength;const j=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(U=this.onProgress)===null||U===void 0||U.call(this,j)}[Symbol.asyncIterator](){const F=this.reader.getReader(),U=new TextDecoder;return{next:()=>__awaiter$1(this,void 0,void 0,function*(){try{const{done:q,value:V}=yield F.read();return q?{done:!0,value:void 0}:(this.handleChunkReceived(V),{done:!1,value:U.decode(V.content)})}catch{return{done:!0,value:void 0}}}),return(){return __awaiter$1(this,void 0,void 0,function*(){return F.releaseLock(),{done:!0,value:void 0}})}}}readAll(){return __awaiter$1(this,void 0,void 0,function*(){var F,U,q,V;let j="";try{for(var $=!0,W=__asyncValues(this),K;K=yield W.next(),F=K.done,!F;$=!0)V=K.value,$=!1,j+=V}catch(G){U={error:G}}finally{try{!$&&!F&&(q=W.return)&&(yield q.call(W))}finally{if(U)throw U.error}}return j})}}class BaseStreamWriter{constructor(F,U,q){this.writableStream=F,this.defaultWriter=F.getWriter(),this.onClose=q,this.info=U}write(F){return this.defaultWriter.write(F)}close(){return __awaiter$1(this,void 0,void 0,function*(){var F;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(F=this.onClose)===null||F===void 0||F.call(this)})}}class TextStreamWriter extends BaseStreamWriter{}class ByteStreamWriter extends BaseStreamWriter{}class RemoteTrack extends Track{constructor(F,U,q,V,j){super(F,q,j),this.sid=U,this.receiver=V}get isLocal(){return!1}setMuted(F){this.isMuted!==F&&(this.isMuted=F,this._mediaStreamTrack.enabled=!F,this.emit(F?TrackEvent.Muted:TrackEvent.Unmuted,this))}setMediaStream(F){this.mediaStream=F;const U=q=>{q.track===this._mediaStreamTrack&&(F.removeEventListener("removetrack",U),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(TrackEvent.Ended,this))};F.addEventListener("removetrack",U)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return __awaiter$1(this,void 0,void 0,function*(){var F;return!((F=this.receiver)===null||F===void 0)&&F.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(F){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=F:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),monitorFrequency)),supportsSynchronizationSources()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const F=()=>{var U;this.timeSyncHandle=requestAnimationFrame(()=>F());const q=(U=this.receiver)===null||U===void 0?void 0:U.getSynchronizationSources()[0];if(q){const{timestamp:V,rtpTimestamp:j}=q;j&&this.rtpTimestamp!==j&&(this.emit(TrackEvent.TimeSyncUpdate,{timestamp:V,rtpTimestamp:j}),this.rtpTimestamp=j)}};F()}}class RemoteAudioTrack extends RemoteTrack{constructor(F,U,q,V,j,$){super(F,U,Track.Kind.Audio,q,$),this.monitorReceiver=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const W=yield this.getReceiverStats();W&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(W,this.prevStats)),this.prevStats=W}),this.audioContext=V,this.webAudioPluginNodes=[],j&&(this.sinkId=j.deviceId)}setVolume(F){var U;for(const q of this.attachedElements)this.audioContext?(U=this.gainNode)===null||U===void 0||U.gain.setTargetAtTime(F,0,.1):q.volume=F;isReactNative()&&this._mediaStreamTrack._setVolume(F),this.elementVolume=F}getVolume(){if(this.elementVolume)return this.elementVolume;if(isReactNative())return 1;let F=0;return this.attachedElements.forEach(U=>{U.volume>F&&(F=U.volume)}),F}setSinkId(F){return __awaiter$1(this,void 0,void 0,function*(){this.sinkId=F,yield Promise.all(this.attachedElements.map(U=>{if(supportsSetSinkId(U))return U.setSinkId(F)}))})}attach(F){const U=this.attachedElements.length===0;return F?super.attach(F):F=super.attach(),this.sinkId&&supportsSetSinkId(F)&&F.setSinkId(this.sinkId).catch(q=>{this.log.error("Failed to set sink id on remote audio track",q,this.logContext)}),this.audioContext&&U&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,F),F.volume=0,F.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),F}detach(F){let U;return F?(U=super.detach(F),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(U=super.detach(),this.disconnectWebAudio()),U}setAudioContext(F){this.audioContext=F,F&&this.attachedElements.length>0?this.connectWebAudio(F,this.attachedElements[0]):F||this.disconnectWebAudio()}setWebAudioPlugins(F){this.webAudioPluginNodes=F,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(F,U){this.disconnectWebAudio(),this.sourceNode=F.createMediaStreamSource(U.srcObject);let q=this.sourceNode;this.webAudioPluginNodes.forEach(V=>{q.connect(V),q=V}),this.gainNode=F.createGain(),q.connect(this.gainNode),this.gainNode.connect(F.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),F.state!=="running"&&F.resume().then(()=>{F.state!=="running"&&this.emit(TrackEvent.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(V=>{this.emit(TrackEvent.AudioPlaybackFailed,V)})}disconnectWebAudio(){var F,U;(F=this.gainNode)===null||F===void 0||F.disconnect(),(U=this.sourceNode)===null||U===void 0||U.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return __awaiter$1(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const F=yield this.receiver.getStats();let U;return F.forEach(q=>{q.type==="inbound-rtp"&&(U={type:"audio",streamId:q.id,timestamp:q.timestamp,jitter:q.jitter,bytesReceived:q.bytesReceived,concealedSamples:q.concealedSamples,concealmentEvents:q.concealmentEvents,silentConcealedSamples:q.silentConcealedSamples,silentConcealmentEvents:q.silentConcealmentEvents,totalAudioEnergy:q.totalAudioEnergy,totalSamplesDuration:q.totalSamplesDuration})}),U})}}const REACTION_DELAY=100;class RemoteVideoTrack extends RemoteTrack{constructor(F,U,q,V,j){super(F,U,Track.Kind.Video,q,j),this.elementInfos=[],this.monitorReceiver=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const $=yield this.getReceiverStats();$&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate($,this.prevStats)),this.prevStats=$}),this.debouncedHandleResize=r$1(()=>{this.updateDimensions()},REACTION_DELAY),this.adaptiveStreamSettings=V}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(F){super.setMuted(F),this.attachedElements.forEach(U=>{F?detachTrack(this._mediaStreamTrack,U):attachToElement(this._mediaStreamTrack,U)})}attach(F){if(F?super.attach(F):F=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(U=>U.element===F)===void 0){const U=new HTMLElementInfo(F);this.observeElementInfo(U)}return F}observeElementInfo(F){this.adaptiveStreamSettings&&this.elementInfos.find(U=>U===F)===void 0?(F.handleResize=()=>{this.debouncedHandleResize()},F.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(F),F.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(F){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const U=this.elementInfos.filter(q=>q===F);for(const q of U)q.stopObserving();this.elementInfos=this.elementInfos.filter(q=>q!==F),this.updateVisibility(),this.debouncedHandleResize()}detach(F){let U=[];if(F)return this.stopObservingElement(F),super.detach(F);U=super.detach();for(const q of U)this.stopObservingElement(q);return U}getDecoderImplementation(){var F;return(F=this.prevStats)===null||F===void 0?void 0:F.decoderImplementation}getReceiverStats(){return __awaiter$1(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const F=yield this.receiver.getStats();let U,q="",V=new Map;return F.forEach(j=>{j.type==="inbound-rtp"?(q=j.codecId,U={type:"video",streamId:j.id,framesDecoded:j.framesDecoded,framesDropped:j.framesDropped,framesReceived:j.framesReceived,packetsReceived:j.packetsReceived,packetsLost:j.packetsLost,frameWidth:j.frameWidth,frameHeight:j.frameHeight,pliCount:j.pliCount,firCount:j.firCount,nackCount:j.nackCount,jitter:j.jitter,timestamp:j.timestamp,bytesReceived:j.bytesReceived,decoderImplementation:j.decoderImplementation}):j.type==="codec"&&V.set(j.id,j)}),U&&q!==""&&V.get(q)&&(U.mimeType=V.get(q).mimeType),U})}stopObservingElement(F){const U=this.elementInfos.filter(q=>q.element===F);for(const q of U)this.stopObservingElementInfo(q)}handleAppVisibilityChanged(){const F=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield F.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(){var F,U;const q=this.elementInfos.reduce((W,K)=>Math.max(W,K.visibilityChangedAt||0),0),V=!((U=(F=this.adaptiveStreamSettings)===null||F===void 0?void 0:F.pauseVideoInBackground)!==null&&U!==void 0)||U?this.isInBackground:!1,j=this.elementInfos.some(W=>W.pictureInPicture),$=this.elementInfos.some(W=>W.visible)&&!V||j;if(this.lastVisible!==$){if(!$&&Date.now()-q<REACTION_DELAY){CriticalTimers.setTimeout(()=>{this.updateVisibility()},REACTION_DELAY);return}this.lastVisible=$,this.emit(TrackEvent.VisibilityChanged,$,this)}}updateDimensions(){var F,U;let q=0,V=0;const j=this.getPixelDensity();for(const $ of this.elementInfos){const W=$.width()*j,K=$.height()*j;W+K>q+V&&(q=W,V=K)}((F=this.lastDimensions)===null||F===void 0?void 0:F.width)===q&&((U=this.lastDimensions)===null||U===void 0?void 0:U.height)===V||(this.lastDimensions={width:q,height:V},this.emit(TrackEvent.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var F;const U=(F=this.adaptiveStreamSettings)===null||F===void 0?void 0:F.pixelDensity;return U==="screen"?getDevicePixelRatio():U||(getDevicePixelRatio()>2?2:1)}}class HTMLElementInfo{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(F,U){this.onVisibilityChanged=q=>{var V;const{target:j,isIntersecting:$}=q;j===this.element&&(this.isIntersecting=$,this.isPiP=isElementInPiP(this.element),this.visibilityChangedAt=Date.now(),(V=this.handleVisibilityChanged)===null||V===void 0||V.call(this))},this.onEnterPiP=()=>{var q,V,j;(V=(q=window.documentPictureInPicture)===null||q===void 0?void 0:q.window)===null||V===void 0||V.addEventListener("pagehide",this.onLeavePiP),this.isPiP=isElementInPiP(this.element),(j=this.handleVisibilityChanged)===null||j===void 0||j.call(this)},this.onLeavePiP=()=>{var q;this.isPiP=isElementInPiP(this.element),(q=this.handleVisibilityChanged)===null||q===void 0||q.call(this)},this.element=F,this.isIntersecting=U??isElementInViewport(F),this.isPiP=isWeb()&&isElementInPiP(F),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var F,U,q;this.isIntersecting=isElementInViewport(this.element),this.isPiP=isElementInPiP(this.element),this.element.handleResize=()=>{var V;(V=this.handleResize)===null||V===void 0||V.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,getIntersectionObserver().observe(this.element),getResizeObserver().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(F=window.documentPictureInPicture)===null||F===void 0||F.addEventListener("enter",this.onEnterPiP),(q=(U=window.documentPictureInPicture)===null||U===void 0?void 0:U.window)===null||q===void 0||q.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var F,U,q,V,j;(F=getIntersectionObserver())===null||F===void 0||F.unobserve(this.element),(U=getResizeObserver())===null||U===void 0||U.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(q=window.documentPictureInPicture)===null||q===void 0||q.removeEventListener("enter",this.onEnterPiP),(j=(V=window.documentPictureInPicture)===null||V===void 0?void 0:V.window)===null||j===void 0||j.removeEventListener("pagehide",this.onLeavePiP)}}function isElementInPiP(B){var F,U;return document.pictureInPictureElement===B?!0:!((F=window.documentPictureInPicture)===null||F===void 0)&&F.window?isElementInViewport(B,(U=window.documentPictureInPicture)===null||U===void 0?void 0:U.window):!1}function isElementInViewport(B,F){const U=F||window;let q=B.offsetTop,V=B.offsetLeft;const j=B.offsetWidth,$=B.offsetHeight,{hidden:W}=B,{display:K}=getComputedStyle(B);for(;B.offsetParent;)B=B.offsetParent,q+=B.offsetTop,V+=B.offsetLeft;return q<U.pageYOffset+U.innerHeight&&V<U.pageXOffset+U.innerWidth&&q+$>U.pageYOffset&&V+j>U.pageXOffset&&!W&&K!=="none"}class TrackPublication extends eventsExports.EventEmitter{constructor(F,U,q,V){var j;super(),this.metadataMuted=!1,this.encryption=Encryption_Type.NONE,this.log=livekitLogger,this.handleMuted=()=>{this.emit(TrackEvent.Muted)},this.handleUnmuted=()=>{this.emit(TrackEvent.Unmuted)},this.log=getLogger((j=V==null?void 0:V.loggerName)!==null&&j!==void 0?j:LoggerNames.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=F,this.trackSid=U,this.trackName=q,this.source=Track.Source.Unknown}setTrack(F){this.track&&(this.track.off(TrackEvent.Muted,this.handleMuted),this.track.off(TrackEvent.Unmuted,this.handleUnmuted)),this.track=F,F&&(F.on(TrackEvent.Muted,this.handleMuted),F.on(TrackEvent.Unmuted,this.handleUnmuted))}get logContext(){var F;return Object.assign(Object.assign({},(F=this.loggerContextCb)===null||F===void 0?void 0:F.call(this)),getLogContextFromTrack(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==Encryption_Type.NONE}get audioTrack(){if(isAudioTrack(this.track))return this.track}get videoTrack(){if(isVideoTrack(this.track))return this.track}updateInfo(F){this.trackSid=F.sid,this.trackName=F.name,this.source=Track.sourceFromProto(F.source),this.mimeType=F.mimeType,this.kind===Track.Kind.Video&&F.width>0&&(this.dimensions={width:F.width,height:F.height},this.simulcasted=F.simulcast),this.encryption=F.encryption,this.trackInfo=F,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:F}))}}(function(B){(function(F){F.Desired="desired",F.Subscribed="subscribed",F.Unsubscribed="unsubscribed"})(B.SubscriptionStatus||(B.SubscriptionStatus={})),function(F){F.Allowed="allowed",F.NotAllowed="not_allowed"}(B.PermissionStatus||(B.PermissionStatus={}))})(TrackPublication||(TrackPublication={}));class LocalTrackPublication extends TrackPublication{get isUpstreamPaused(){var F;return(F=this.track)===null||F===void 0?void 0:F.isUpstreamPaused}constructor(F,U,q,V){super(F,U.sid,U.name,V),this.track=void 0,this.handleTrackEnded=()=>{this.emit(TrackEvent.Ended)},this.updateInfo(U),this.setTrack(q)}setTrack(F){this.track&&this.track.off(TrackEvent.Ended,this.handleTrackEnded),super.setTrack(F),F&&F.on(TrackEvent.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return __awaiter$1(this,void 0,void 0,function*(){var F;return(F=this.track)===null||F===void 0?void 0:F.mute()})}unmute(){return __awaiter$1(this,void 0,void 0,function*(){var F;return(F=this.track)===null||F===void 0?void 0:F.unmute()})}pauseUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var F;yield(F=this.track)===null||F===void 0?void 0:F.pauseUpstream()})}resumeUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var F;yield(F=this.track)===null||F===void 0?void 0:F.resumeUpstream()})}getTrackFeatures(){var F;if(isAudioTrack(this.track)){const U=this.track.getSourceTrackSettings(),q=new Set;return U.autoGainControl&&q.add(AudioTrackFeature.TF_AUTO_GAIN_CONTROL),U.echoCancellation&&q.add(AudioTrackFeature.TF_ECHO_CANCELLATION),U.noiseSuppression&&q.add(AudioTrackFeature.TF_NOISE_SUPPRESSION),U.channelCount&&U.channelCount>1&&q.add(AudioTrackFeature.TF_STEREO),!((F=this.options)===null||F===void 0)&&F.dtx||q.add(AudioTrackFeature.TF_NO_DTX),this.track.enhancedNoiseCancellation&&q.add(AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION),Array.from(q.values())}else return[]}}function createLocalTracks(B,F){return __awaiter$1(this,void 0,void 0,function*(){B??(B={});let U=!1;const{audioProcessor:q,videoProcessor:V,optionsWithoutProcessor:j}=extractProcessorsFromOptions(B);let $=j.audio,W=j.video;if(q&&typeof j.audio=="object"&&(j.audio.processor=q),V&&typeof j.video=="object"&&(j.video.processor=V),B.audio&&typeof j.audio=="object"&&typeof j.audio.deviceId=="string"){const z=j.audio.deviceId;j.audio.deviceId={exact:z},U=!0,$=Object.assign(Object.assign({},j.audio),{deviceId:{ideal:z}})}if(j.video&&typeof j.video=="object"&&typeof j.video.deviceId=="string"){const z=j.video.deviceId;j.video.deviceId={exact:z},U=!0,W=Object.assign(Object.assign({},j.video),{deviceId:{ideal:z}})}(j.audio===!0||typeof j.audio=="object"&&!j.audio.deviceId)&&(j.audio={deviceId:"default"}),j.video===!0?j.video={deviceId:"default"}:typeof j.video=="object"&&!j.video.deviceId&&(j.video.deviceId="default");const K=mergeDefaultOptions(j,audioDefaults,videoDefaults),G=constraintsForOptions(K),Q=navigator.mediaDevices.getUserMedia(G);j.audio&&(DeviceManager.userMediaPromiseMap.set("audioinput",Q),Q.catch(()=>DeviceManager.userMediaPromiseMap.delete("audioinput"))),j.video&&(DeviceManager.userMediaPromiseMap.set("videoinput",Q),Q.catch(()=>DeviceManager.userMediaPromiseMap.delete("videoinput")));try{const z=yield Q;return yield Promise.all(z.getTracks().map(H=>__awaiter$1(this,void 0,void 0,function*(){const Y=H.kind==="audio";let X=Y?K.audio:K.video;(typeof X=="boolean"||!X)&&(X={});let Z;const ie=Y?G.audio:G.video;typeof ie!="boolean"&&(Z=ie);const ee=H.getSettings().deviceId;Z!=null&&Z.deviceId&&unwrapConstraint(Z.deviceId)!==ee?Z.deviceId=ee:Z||(Z={deviceId:ee});const te=mediaTrackToLocalTrack(H,Z,F);return te.kind===Track.Kind.Video?te.source=Track.Source.Camera:te.kind===Track.Kind.Audio&&(te.source=Track.Source.Microphone),te.mediaStream=z,isAudioTrack(te)&&q?yield te.setProcessor(q):isVideoTrack(te)&&V&&(yield te.setProcessor(V)),te})))}catch(z){if(!U)throw z;return createLocalTracks(Object.assign(Object.assign({},B),{audio:$,video:W}),F)}})}function createLocalVideoTrack(B){return __awaiter$1(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:!1,video:!0}))[0]})}function createLocalAudioTrack(B){return __awaiter$1(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:B??!0,video:!1}))[0]})}var ConnectionQuality$2;(function(B){B.Excellent="excellent",B.Good="good",B.Poor="poor",B.Lost="lost",B.Unknown="unknown"})(ConnectionQuality$2||(ConnectionQuality$2={}));function qualityFromProto(B){switch(B){case ConnectionQuality$1.EXCELLENT:return ConnectionQuality$2.Excellent;case ConnectionQuality$1.GOOD:return ConnectionQuality$2.Good;case ConnectionQuality$1.POOR:return ConnectionQuality$2.Poor;case ConnectionQuality$1.LOST:return ConnectionQuality$2.Lost;default:return ConnectionQuality$2.Unknown}}class Participant extends eventsExports.EventEmitter{get logContext(){var F,U;return Object.assign({},(U=(F=this.loggerOptions)===null||F===void 0?void 0:F.loggerContextCb)===null||U===void 0?void 0:U.call(F))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(F=>F.isEncrypted)}get isAgent(){var F;return((F=this.permissions)===null||F===void 0?void 0:F.agent)||this.kind===ParticipantInfo_Kind.AGENT}get isActive(){var F;return((F=this.participantInfo)===null||F===void 0?void 0:F.state)===ParticipantInfo_State.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(F,U,q,V,j,$){let W=arguments.length>6&&arguments[6]!==void 0?arguments[6]:ParticipantInfo_Kind.STANDARD;var K;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=ConnectionQuality$2.Unknown,this.log=livekitLogger,this.log=getLogger((K=$==null?void 0:$.loggerName)!==null&&K!==void 0?K:LoggerNames.Participant),this.loggerOptions=$,this.setMaxListeners(100),this.sid=F,this.identity=U,this.name=q,this.metadata=V,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=W,this._attributes=j??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(F){for(const[,U]of this.trackPublications)if(U.source===F)return U}getTrackPublicationByName(F){for(const[,U]of this.trackPublications)if(U.trackName===F)return U}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new Future,this.once(ParticipantEvent.Active,()=>{var F,U;(U=(F=this.activeFuture)===null||F===void 0?void 0:F.resolve)===null||U===void 0||U.call(F),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var F;const U=this.getTrackPublication(Track.Source.Camera);return!(!((F=U==null?void 0:U.isMuted)!==null&&F!==void 0)||F)}get isMicrophoneEnabled(){var F;const U=this.getTrackPublication(Track.Source.Microphone);return!(!((F=U==null?void 0:U.isMuted)!==null&&F!==void 0)||F)}get isScreenShareEnabled(){return!!this.getTrackPublication(Track.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(F){var U;return this.participantInfo&&this.participantInfo.sid===F.sid&&this.participantInfo.version>F.version?!1:(this.identity=F.identity,this.sid=F.sid,this._setName(F.name),this._setMetadata(F.metadata),this._setAttributes(F.attributes),F.state===ParticipantInfo_State.ACTIVE&&((U=this.participantInfo)===null||U===void 0?void 0:U.state)!==ParticipantInfo_State.ACTIVE&&this.emit(ParticipantEvent.Active),F.permission&&this.setPermissions(F.permission),this.participantInfo=F,!0)}_setMetadata(F){const U=this.metadata!==F,q=this.metadata;this.metadata=F,U&&this.emit(ParticipantEvent.ParticipantMetadataChanged,q)}_setName(F){const U=this.name!==F;this.name=F,U&&this.emit(ParticipantEvent.ParticipantNameChanged,F)}_setAttributes(F){const U=diffAttributes(this.attributes,F);this._attributes=F,Object.keys(U).length>0&&this.emit(ParticipantEvent.AttributesChanged,U)}setPermissions(F){var U,q,V,j,$,W;const K=this.permissions,G=F.canPublish!==((U=this.permissions)===null||U===void 0?void 0:U.canPublish)||F.canSubscribe!==((q=this.permissions)===null||q===void 0?void 0:q.canSubscribe)||F.canPublishData!==((V=this.permissions)===null||V===void 0?void 0:V.canPublishData)||F.hidden!==((j=this.permissions)===null||j===void 0?void 0:j.hidden)||F.recorder!==(($=this.permissions)===null||$===void 0?void 0:$.recorder)||F.canPublishSources.length!==this.permissions.canPublishSources.length||F.canPublishSources.some((Q,z)=>{var H;return Q!==((H=this.permissions)===null||H===void 0?void 0:H.canPublishSources[z])})||F.canSubscribeMetrics!==((W=this.permissions)===null||W===void 0?void 0:W.canSubscribeMetrics);return this.permissions=F,G&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,K),G}setIsSpeaking(F){F!==this.isSpeaking&&(this.isSpeaking=F,F&&(this.lastSpokeAt=new Date),this.emit(ParticipantEvent.IsSpeakingChanged,F))}setConnectionQuality(F){const U=this._connectionQuality;this._connectionQuality=qualityFromProto(F),U!==this._connectionQuality&&this.emit(ParticipantEvent.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var F,U;this.activeFuture&&((U=(F=this.activeFuture).reject)===null||U===void 0||U.call(F,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(F){this.audioContext=F,this.audioTrackPublications.forEach(U=>isAudioTrack(U.track)&&U.track.setAudioContext(F))}addTrackPublication(F){F.on(TrackEvent.Muted,()=>{this.emit(ParticipantEvent.TrackMuted,F)}),F.on(TrackEvent.Unmuted,()=>{this.emit(ParticipantEvent.TrackUnmuted,F)});const U=F;switch(U.track&&(U.track.sid=F.trackSid),this.trackPublications.set(F.trackSid,F),F.kind){case Track.Kind.Audio:this.audioTrackPublications.set(F.trackSid,F);break;case Track.Kind.Video:this.videoTrackPublications.set(F.trackSid,F);break}}}function trackPermissionToProto(B){var F,U,q;if(!B.participantSid&&!B.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new TrackPermission({participantIdentity:(F=B.participantIdentity)!==null&&F!==void 0?F:"",participantSid:(U=B.participantSid)!==null&&U!==void 0?U:"",allTracks:(q=B.allowAll)!==null&&q!==void 0?q:!1,trackSids:B.allowedTrackSids||[]})}const STREAM_CHUNK_SIZE=15e3;class LocalParticipant extends Participant{constructor(F,U,q,V,j){super(F,U,void 0,void 0,void 0,{loggerName:V.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=Encryption_Type.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Future)},this.handleReconnected=()=>{var $,W;(W=($=this.reconnectFuture)===null||$===void 0?void 0:$.resolve)===null||W===void 0||W.call($),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var $,W,K,G,Q,z;this.reconnectFuture&&(this.reconnectFuture.promise.catch(H=>this.log.warn(H.message,this.logContext)),(W=($=this.reconnectFuture)===null||$===void 0?void 0:$.reject)===null||W===void 0||W.call($,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0),this.signalConnectedFuture&&((G=(K=this.signalConnectedFuture).reject)===null||G===void 0||G.call(K,"Got disconnected without signal connected"),this.signalConnectedFuture=void 0),(z=(Q=this.activeAgentFuture)===null||Q===void 0?void 0:Q.reject)===null||z===void 0||z.call(Q,"Got disconnected without active agent present"),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=$=>{var W,K;$.participant&&this.updateInfo($.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Future),(K=(W=this.signalConnectedFuture).resolve)===null||K===void 0||K.call(W)},this.handleSignalRequestResponse=$=>{const{requestId:W,reason:K,message:G}=$,Q=this.pendingSignalRequests.get(W);Q&&(K!==RequestResponse_Reason.OK&&Q.reject(new SignalRequestError(G,K)),this.pendingSignalRequests.delete(W))},this.handleDataPacket=$=>{switch($.value.case){case"rpcResponse":let W=$.value.value,K=null,G=null;W.value.case==="payload"?K=W.value.value:W.value.case==="error"&&(G=RpcError.fromProto(W.value.value)),this.handleIncomingRpcResponse(W.requestId,K,G);break;case"rpcAck":let Q=$.value.value;this.handleIncomingRpcAck(Q.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map($=>trackPermissionToProto($)))},this.onTrackUnmuted=$=>{this.onTrackMuted($,$.isUpstreamPaused)},this.onTrackMuted=($,W)=>{if(W===void 0&&(W=!0),!$.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)));return}this.engine.updateMuteStatus($.sid,W)},this.onTrackUpstreamPaused=$=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),this.onTrackMuted($,!0)},this.onTrackUpstreamResumed=$=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),this.onTrackMuted($,$.isMuted)},this.onTrackFeatureUpdate=$=>{const W=this.audioTrackPublications.get($.sid);if(!W){this.log.warn("Could not update local audio track settings, missing publication for track ".concat($.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(W.trackSid,W.getTrackFeatures())},this.handleSubscribedQualityUpdate=$=>__awaiter$1(this,void 0,void 0,function*(){var W,K,G,Q,z;if(!(!((z=this.roomOptions)===null||z===void 0)&&z.dynacast))return;const H=this.videoTrackPublications.get($.trackSid);if(!H){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:$.trackSid}));return}if(!H.videoTrack)return;const Y=yield H.videoTrack.setPublishingCodecs($.subscribedCodecs);try{for(var X=!0,Z=__asyncValues(Y),ie;ie=yield Z.next(),W=ie.done,!W;X=!0){Q=ie.value,X=!1;const ee=Q;isBackupCodec(ee)&&(this.log.debug("publish ".concat(ee," for ").concat(H.videoTrack.sid),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(H))),yield this.publishAdditionalCodecForTrack(H.videoTrack,ee,H.options))}}catch(ee){K={error:ee}}finally{try{!X&&!W&&(G=Z.return)&&(yield G.call(Z))}finally{if(K)throw K.error}}}),this.handleLocalTrackUnpublished=$=>{const W=this.trackPublications.get($.trackSid);if(!W){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:$.trackSid}));return}this.unpublishTrack(W.track)},this.handleTrackEnded=$=>__awaiter$1(this,void 0,void 0,function*(){if($.source===Track.Source.ScreenShare||$.source===Track.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),this.unpublishTrack($);else if($.isUserProvided)yield $.mute();else if(isLocalAudioTrack($)||isLocalVideoTrack($))try{if(isWeb())try{const W=yield navigator==null?void 0:navigator.permissions.query({name:$.source===Track.Source.Camera?"camera":"microphone"});if(W&&W.state==="denied")throw this.log.warn("user has revoked access to ".concat($.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),W.onchange=()=>{W.state!=="denied"&&($.isMuted||$.restartTrack(),W.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}$.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),isLocalAudioTrack($)?yield $.restartTrack({deviceId:"default"}):yield $.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),yield $.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=q,this.roomOptions=V,this.setupEngine(q),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=j}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Encryption_Type.NONE}getTrackPublication(F){const U=super.getTrackPublication(F);if(U)return U}getTrackPublicationByName(F){const U=super.getTrackPublicationByName(F);if(U)return U}setupEngine(F){this.engine=F,this.engine.on(EngineEvent.RemoteMute,(U,q)=>{const V=this.trackPublications.get(U);!V||!V.track||(q?V.mute():V.unmute())}),this.engine.on(EngineEvent.Connected,this.handleReconnected).on(EngineEvent.SignalConnected,this.handleSignalConnected).on(EngineEvent.SignalRestarted,this.handleReconnected).on(EngineEvent.SignalResumed,this.handleReconnected).on(EngineEvent.Restarting,this.handleReconnecting).on(EngineEvent.Resuming,this.handleReconnecting).on(EngineEvent.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(EngineEvent.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(EngineEvent.Disconnected,this.handleDisconnected).on(EngineEvent.SignalRequestResponse,this.handleSignalRequestResponse).on(EngineEvent.DataPacketReceived,this.handleDataPacket)}setMetadata(F){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:F})})}setName(F){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:F})})}setAttributes(F){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:F})})}requestMetadataUpdate(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let{metadata:V,name:j,attributes:$}=U;return function*(){return new Promise((W,K)=>__awaiter$1(q,void 0,void 0,function*(){var G,Q;try{let z=!1;const H=yield this.engine.client.sendUpdateLocalMetadata((G=V??this.metadata)!==null&&G!==void 0?G:"",(Q=j??this.name)!==null&&Q!==void 0?Q:"",$),Y=performance.now();for(this.pendingSignalRequests.set(H,{resolve:W,reject:X=>{K(X),z=!0},values:{name:j,metadata:V,attributes:$}});performance.now()-Y<5e3&&!z;){if((!j||this.name===j)&&(!V||this.metadata===V)&&(!$||Object.entries($).every(X=>{let[Z,ie]=X;return this.attributes[Z]===ie||ie===""&&!this.attributes[Z]}))){this.pendingSignalRequests.delete(H),W();return}yield sleep$1(50)}K(new SignalRequestError("Request to update local metadata timed out","TimeoutError"))}catch(z){z instanceof Error&&K(z)}}))}()})}setCameraEnabled(F,U,q){return this.setTrackEnabled(Track.Source.Camera,F,U,q)}setMicrophoneEnabled(F,U,q){return this.setTrackEnabled(Track.Source.Microphone,F,U,q)}setScreenShareEnabled(F,U,q){return this.setTrackEnabled(Track.Source.ScreenShare,F,U,q)}setPermissions(F){const U=this.permissions,q=super.setPermissions(F);return q&&U&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,U),q}setE2EEEnabled(F){return __awaiter$1(this,void 0,void 0,function*(){this.encryptionType=F?Encryption_Type.GCM:Encryption_Type.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(F,U,q,V){return __awaiter$1(this,void 0,void 0,function*(){var j,$;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:F,enabled:U})),this.republishPromise&&(yield this.republishPromise);let W=this.getTrackPublication(F);if(U)if(W)yield W.unmute();else{let K;if(this.pendingPublishing.has(F)){const G=yield this.waitForPendingPublicationOfSource(F);return G||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:F})),yield G==null?void 0:G.unmute(),G}this.pendingPublishing.add(F);try{switch(F){case Track.Source.Camera:K=yield this.createTracks({video:(j=q)!==null&&j!==void 0?j:!0});break;case Track.Source.Microphone:K=yield this.createTracks({audio:($=q)!==null&&$!==void 0?$:!0});break;case Track.Source.ScreenShare:K=yield this.createScreenTracks(Object.assign({},q));break;default:throw new TrackInvalidError(F)}}catch(G){throw K==null||K.forEach(Q=>{Q.stop()}),G instanceof Error&&this.emit(ParticipantEvent.MediaDevicesError,G,sourceToKind(F)),this.pendingPublishing.delete(F),G}for(const G of K)F===Track.Source.Microphone&&isAudioTrack(G)&&(V!=null&&V.preConnectBuffer)&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),G.startPreConnectBuffer());try{const G=[];for(const z of K)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(z))),G.push(this.publishTrack(z,V));[W]=yield Promise.all(G)}catch(G){throw K==null||K.forEach(Q=>{Q.stop()}),G}finally{this.pendingPublishing.delete(F)}}else if(!(W!=null&&W.track)&&this.pendingPublishing.has(F)&&(W=yield this.waitForPendingPublicationOfSource(F),W||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:F}))),W&&W.track)if(F===Track.Source.ScreenShare){W=yield this.unpublishTrack(W.track);const K=this.getTrackPublication(Track.Source.ScreenShareAudio);K&&K.track&&this.unpublishTrack(K.track)}else yield W.mute();return W})}enableCameraAndMicrophone(){return __awaiter$1(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(Track.Source.Camera)||this.pendingPublishing.has(Track.Source.Microphone))){this.pendingPublishing.add(Track.Source.Camera),this.pendingPublishing.add(Track.Source.Microphone);try{const F=yield this.createTracks({audio:!0,video:!0});yield Promise.all(F.map(U=>this.publishTrack(U)))}finally{this.pendingPublishing.delete(Track.Source.Camera),this.pendingPublishing.delete(Track.Source.Microphone)}}})}createTracks(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q;F??(F={});const V=mergeDefaultOptions(F,(U=this.roomOptions)===null||U===void 0?void 0:U.audioCaptureDefaults,(q=this.roomOptions)===null||q===void 0?void 0:q.videoCaptureDefaults);try{return(yield createLocalTracks(V,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(W=>(isAudioTrack(W)&&(this.microphoneError=void 0,W.setAudioContext(this.audioContext),W.source=Track.Source.Microphone,this.emit(ParticipantEvent.AudioStreamAcquired)),isVideoTrack(W)&&(this.cameraError=void 0,W.source=Track.Source.Camera),W))}catch(j){throw j instanceof Error&&(F.audio&&(this.microphoneError=j),F.video&&(this.cameraError=j)),j}})}createScreenTracks(F){return __awaiter$1(this,void 0,void 0,function*(){if(F===void 0&&(F={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError("getDisplayMedia not supported");F.resolution===void 0&&!isSafari17()&&(F.resolution=ScreenSharePresets.h1080fps30.resolution);const U=screenCaptureToDisplayMediaStreamOptions(F),q=yield navigator.mediaDevices.getDisplayMedia(U),V=q.getVideoTracks();if(V.length===0)throw new TrackInvalidError("no video track found");const j=new LocalVideoTrack(V[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});j.source=Track.Source.ScreenShare,F.contentHint&&(j.mediaStreamTrack.contentHint=F.contentHint);const $=[j];if(q.getAudioTracks().length>0){this.emit(ParticipantEvent.AudioStreamAcquired);const W=new LocalAudioTrack(q.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});W.source=Track.Source.ScreenShareAudio,$.push(W)}return $})}publishTrack(F,U){return __awaiter$1(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(F,U)})}publishOrRepublishTrack(F,U){return __awaiter$1(this,arguments,void 0,function(q,V){var j=this;let $=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var W,K,G,Q;isLocalAudioTrack(q)&&q.setAudioContext(j.audioContext),yield(W=j.reconnectFuture)===null||W===void 0?void 0:W.promise,j.republishPromise&&!$&&(yield j.republishPromise),isLocalTrack(q)&&j.pendingPublishPromises.has(q)&&(yield j.pendingPublishPromises.get(q));let z;if(q instanceof MediaStreamTrack)z=q.getConstraints();else{z=q.constraints;let ee;switch(q.source){case Track.Source.Microphone:ee="audioinput";break;case Track.Source.Camera:ee="videoinput"}ee&&j.activeDeviceMap.has(ee)&&(z=Object.assign(Object.assign({},z),{deviceId:j.activeDeviceMap.get(ee)}))}if(q instanceof MediaStreamTrack)switch(q.kind){case"audio":q=new LocalAudioTrack(q,z,!0,j.audioContext,{loggerName:j.roomOptions.loggerName,loggerContextCb:()=>j.logContext});break;case"video":q=new LocalVideoTrack(q,z,!0,{loggerName:j.roomOptions.loggerName,loggerContextCb:()=>j.logContext});break;default:throw new TrackInvalidError("unsupported MediaStreamTrack kind ".concat(q.kind))}else q.updateLoggerOptions({loggerName:j.roomOptions.loggerName,loggerContextCb:()=>j.logContext});let H;if(j.trackPublications.forEach(ee=>{ee.track&&ee.track===q&&(H=ee)}),H)return j.log.warn("track has already been published, skipping",Object.assign(Object.assign({},j.logContext),getLogContextFromTrack(H))),H;const Y="channelCount"in q.mediaStreamTrack.getSettings()&&q.mediaStreamTrack.getSettings().channelCount===2||q.mediaStreamTrack.getConstraints().channelCount===2,X=(K=V==null?void 0:V.forceStereo)!==null&&K!==void 0?K:Y;X&&(V||(V={}),V.dtx===void 0&&j.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},j.logContext),getLogContextFromTrack(q))),V.red===void 0&&j.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(G=V.dtx)!==null&&G!==void 0||(V.dtx=!1),(Q=V.red)!==null&&Q!==void 0||(V.red=!1));const Z=Object.assign(Object.assign({},j.roomOptions.publishDefaults),V);!isE2EESimulcastSupported()&&j.roomOptions.e2ee&&(j.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},j.logContext)),Z.simulcast=!1),Z.source&&(q.source=Z.source);const ie=new Promise((ee,te)=>__awaiter$1(j,void 0,void 0,function*(){try{if(this.engine.client.currentState!==SignalConnectionState.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:getLogContextFromTrack(q)}));const re=setTimeout(()=>{te(new PublishTrackError("publishing rejected as engine not connected within timeout",408))},15e3);yield this.waitUntilEngineConnected(),clearTimeout(re);const ne=yield this.publish(q,Z,X);ee(ne)}else try{const re=yield this.publish(q,Z,X);ee(re)}catch(re){te(re)}}catch(re){te(re)}}));j.pendingPublishPromises.set(q,ie);try{return yield ie}catch(ee){throw ee}finally{j.pendingPublishPromises.delete(q)}}()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Future),this.signalConnectedFuture.promise}hasPermissionsToPublish(F){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))),!1;const{canPublish:U,canPublishSources:q}=this.permissions;return U&&(q.length===0||q.map(V=>getTrackSourceFromProto(V)).includes(F.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))),!1)}publish(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){var V,j,$,W,K,G,Q,z,H,Y;if(!this.hasPermissionsToPublish(F))throw new PublishTrackError("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(le=>isLocalTrack(F)&&le.source===F.source)&&F.source!==Track.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(F.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))),U.stopMicTrackOnMute&&isAudioTrack(F)&&(F.stopOnMute=!0),F.source===Track.Source.ScreenShare&&isFireFox()&&(U.simulcast=!1),U.videoCodec==="av1"&&!supportsAV1()&&(U.videoCodec=void 0),U.videoCodec==="vp9"&&!supportsVP9()&&(U.videoCodec=void 0),U.videoCodec===void 0&&(U.videoCodec=defaultVideoCodec),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(le=>U.videoCodec===mimeTypeToVideoCodecString(le.mime))||(U.videoCodec=mimeTypeToVideoCodecString(this.enabledPublishVideoCodecs[0].mime)));const Z=U.videoCodec;F.on(TrackEvent.Muted,this.onTrackMuted),F.on(TrackEvent.Unmuted,this.onTrackUnmuted),F.on(TrackEvent.Ended,this.handleTrackEnded),F.on(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),F.on(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),F.on(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const ie=[],ee=!(!((V=U.dtx)!==null&&V!==void 0)||V),te=F.getSourceTrackSettings();te.autoGainControl&&ie.push(AudioTrackFeature.TF_AUTO_GAIN_CONTROL),te.echoCancellation&&ie.push(AudioTrackFeature.TF_ECHO_CANCELLATION),te.noiseSuppression&&ie.push(AudioTrackFeature.TF_NOISE_SUPPRESSION),te.channelCount&&te.channelCount>1&&ie.push(AudioTrackFeature.TF_STEREO),ee&&ie.push(AudioTrackFeature.TF_NO_DTX),isLocalAudioTrack(F)&&F.hasPreConnectBuffer&&ie.push(AudioTrackFeature.TF_PRECONNECT_BUFFER);const re=new AddTrackRequest({cid:F.mediaStreamTrack.id,name:U.name,type:Track.kindToProto(F.kind),muted:F.isMuted,source:Track.sourceToProto(F.source),disableDtx:ee,encryption:this.encryptionType,stereo:q,disableRed:this.isE2EEEnabled||!(!((j=U.red)!==null&&j!==void 0)||j),stream:U==null?void 0:U.stream,backupCodecPolicy:U==null?void 0:U.backupCodecPolicy,audioFeatures:ie});let ne;if(F.kind===Track.Kind.Video){let le={width:0,height:0};try{le=yield F.waitForDimensions()}catch{const ae=(W=($=this.roomOptions.videoCaptureDefaults)===null||$===void 0?void 0:$.resolution)!==null&&W!==void 0?W:VideoPresets.h720.resolution;le={width:ae.width,height:ae.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)),{dims:le}))}re.width=le.width,re.height=le.height,isLocalVideoTrack(F)&&(isSVCCodec(Z)&&(F.source===Track.Source.ScreenShare&&(U.scalabilityMode="L1T3","contentHint"in F.mediaStreamTrack&&(F.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))))),U.scalabilityMode=(K=U.scalabilityMode)!==null&&K!==void 0?K:"L3T3_KEY"),re.simulcastCodecs=[new SimulcastCodec({codec:Z,cid:F.mediaStreamTrack.id})],U.backupCodec===!0&&(U.backupCodec={codec:defaultVideoCodec}),U.backupCodec&&Z!==U.backupCodec.codec&&re.encryption===Encryption_Type.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),re.simulcastCodecs.push(new SimulcastCodec({codec:U.backupCodec.codec,cid:""})))),ne=computeVideoEncodings(F.source===Track.Source.ScreenShare,re.width,re.height,U),re.layers=videoLayersFromEncodings(re.width,re.height,ne,isSVCCodec(U.videoCodec))}else F.kind===Track.Kind.Audio&&(ne=[{maxBitrate:(G=U.audioPreset)===null||G===void 0?void 0:G.maxBitrate,priority:(z=(Q=U.audioPreset)===null||Q===void 0?void 0:Q.priority)!==null&&z!==void 0?z:"high",networkPriority:(Y=(H=U.audioPreset)===null||H===void 0?void 0:H.priority)!==null&&Y!==void 0?Y:"high"}]);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const se=()=>__awaiter$1(this,void 0,void 0,function*(){var le,he,ae;if(!this.engine.pcManager)throw new UnexpectedConnectionState("pcManager is not ready");if(F.sender=yield this.engine.createSender(F,U,ne),isLocalVideoTrack(F)&&((le=U.degradationPreference)!==null&&le!==void 0||(U.degradationPreference=getDefaultDegradationPreference(F)),F.setDegradationPreference(U.degradationPreference)),ne)if(isFireFox()&&F.kind===Track.Kind.Audio){let ye;for(const Ce of this.engine.pcManager.publisher.getTransceivers())if(Ce.sender===F.sender){ye=Ce;break}ye&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:ye,codec:"opus",maxbr:!((he=ne[0])===null||he===void 0)&&he.maxBitrate?ne[0].maxBitrate/1e3:0})}else F.codec&&isSVCCodec(F.codec)&&(!((ae=ne[0])===null||ae===void 0)&&ae.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:re.cid,codec:F.codec,maxbr:ne[0].maxBitrate/1e3});yield this.engine.negotiate()});let oe;const fe=new Promise((le,he)=>__awaiter$1(this,void 0,void 0,function*(){var ae;try{oe=yield this.engine.addTrack(re),le(oe)}catch(ye){F.sender&&(!((ae=this.engine.pcManager)===null||ae===void 0)&&ae.publisher)&&(this.engine.pcManager.publisher.removeTrack(F.sender),yield this.engine.negotiate().catch(Ce=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)),{error:Ce}))})),he(ye)}}));if(this.enabledPublishVideoCodecs.length>0)oe=(yield Promise.all([fe,se()]))[0];else{oe=yield fe;let le;if(oe.codecs.forEach(he=>{le===void 0&&(le=he.mimeType)}),le&&F.kind===Track.Kind.Video){const he=mimeTypeToVideoCodecString(le);he!==Z&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)),{codec:he})),U.videoCodec=he,ne=computeVideoEncodings(F.source===Track.Source.ScreenShare,re.width,re.height,U))}yield se()}const pe=new LocalTrackPublication(F.kind,oe,F,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(pe.options=U,F.sid=oe.sid,this.log.debug("publishing ".concat(F.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:ne,trackInfo:oe})),isLocalVideoTrack(F)?F.startMonitor(this.engine.client):isLocalAudioTrack(F)&&F.startMonitor(),this.addTrackPublication(pe),this.emit(ParticipantEvent.LocalTrackPublished,pe),isLocalAudioTrack(F)&&oe.audioFeatures.includes(AudioTrackFeature.TF_PRECONNECT_BUFFER)){const le=F.getPreConnectBuffer();this.on(ParticipantEvent.LocalTrackSubscribed,he=>{if(he.trackSid===oe.sid){if(!F.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))),F.stopPreConnectBuffer()}}),le&&new Promise((ae,ye)=>__awaiter$1(this,void 0,void 0,function*(){var Ce,me,ke,Ee,_e,Oe;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)));const Fe=setTimeout(()=>{ye(new Error("agent not active within 10 seconds"))},1e4),Be=yield this.waitUntilActiveAgentPresent();clearTimeout(Fe),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)));const Ye=yield this.streamBytes({name:"preconnect-buffer",mimeType:"audio/opus",topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[Be.identity],attributes:{trackId:pe.trackSid,sampleRate:String((_e=te.sampleRate)!==null&&_e!==void 0?_e:"48000"),channels:String((Oe=te.channelCount)!==null&&Oe!==void 0?Oe:"1")}});try{for(var Le=!0,we=__asyncValues(le),Ae;Ae=yield we.next(),Ce=Ae.done,!Ce;Le=!0){Ee=Ae.value,Le=!1;const pt=Ee;yield Ye.write(pt)}}catch(pt){me={error:pt}}finally{try{!Le&&!Ce&&(ke=we.return)&&(yield ke.call(we))}finally{if(me)throw me.error}}yield Ye.close(),ae()}catch(Fe){ye(Fe)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)))}).catch(ae=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)),{error:ae}))})}return pe})}get isLocal(){return!0}publishAdditionalCodecForTrack(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){var V;if(this.encryptionType!==Encryption_Type.NONE)return;let j;if(this.trackPublications.forEach(Y=>{Y.track&&Y.track===F&&(j=Y)}),!j)throw new TrackInvalidError("track is not published");if(!isLocalVideoTrack(F))throw new TrackInvalidError("track is not a video track");const $=Object.assign(Object.assign({},(V=this.roomOptions)===null||V===void 0?void 0:V.publishDefaults),q),W=computeTrackBackupEncodings(F,U,$);if(!W){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F)));return}const K=F.addSimulcastTrack(U,W);if(!K)return;const G=new AddTrackRequest({cid:K.mediaStreamTrack.id,type:Track.kindToProto(F.kind),muted:F.isMuted,source:Track.sourceToProto(F.source),sid:F.sid,simulcastCodecs:[{codec:$.videoCodec,cid:K.mediaStreamTrack.id}]});if(G.layers=videoLayersFromEncodings(G.width,G.height,W),!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const Q=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(F,K,$,W),yield this.engine.negotiate()}),H=(yield Promise.all([this.engine.addTrack(G),Q()]))[0];this.log.debug("published ".concat(U," for track ").concat(F.sid),Object.assign(Object.assign({},this.logContext),{encodings:W,trackInfo:H}))})}unpublishTrack(F,U){return __awaiter$1(this,void 0,void 0,function*(){var q,V;if(isLocalTrack(F)){const G=this.pendingPublishPromises.get(F);G&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))),yield G)}const j=this.getPublicationForTrack(F),$=j?getLogContextFromTrack(j):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),$)),!j||!j.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),$));return}F=j.track,F.off(TrackEvent.Muted,this.onTrackMuted),F.off(TrackEvent.Unmuted,this.onTrackUnmuted),F.off(TrackEvent.Ended,this.handleTrackEnded),F.off(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),F.off(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),F.off(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),U===void 0&&(U=(V=(q=this.roomOptions)===null||q===void 0?void 0:q.stopLocalTrackOnUnpublish)!==null&&V!==void 0?V:!0),U?F.stop():F.stopMonitor();let W=!1;const K=F.sender;if(F.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<PCTransportState.FAILED&&K)try{for(const G of this.engine.pcManager.publisher.getTransceivers())G.sender===K&&(G.direction="inactive",W=!0);if(this.engine.removeTrack(K)&&(W=!0),isLocalVideoTrack(F)){for(const[,G]of F.simulcastCodecs)G.sender&&(this.engine.removeTrack(G.sender)&&(W=!0),G.sender=void 0);F.simulcastCodecs.clear()}}catch(G){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),$),{error:G}))}switch(this.trackPublications.delete(j.trackSid),j.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(j.trackSid);break;case Track.Kind.Video:this.videoTrackPublications.delete(j.trackSid);break}return this.emit(ParticipantEvent.LocalTrackUnpublished,j),j.setTrack(void 0),W&&(yield this.engine.negotiate()),j})}unpublishTracks(F){return __awaiter$1(this,void 0,void 0,function*(){return(yield Promise.all(F.map(q=>this.unpublishTrack(q)))).filter(q=>!!q)})}republishAllTracks(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){q.republishPromise&&(yield q.republishPromise),q.republishPromise=new Promise((j,$)=>__awaiter$1(q,void 0,void 0,function*(){try{const W=[];this.trackPublications.forEach(K=>{K.track&&(U&&(K.options=Object.assign(Object.assign({},K.options),U)),W.push(K))}),yield Promise.all(W.map(K=>__awaiter$1(this,void 0,void 0,function*(){const G=K.track;yield this.unpublishTrack(G,!1),V&&!G.isMuted&&G.source!==Track.Source.ScreenShare&&G.source!==Track.Source.ScreenShareAudio&&(isLocalAudioTrack(G)||isLocalVideoTrack(G))&&!G.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:K.trackSid})),yield G.restartTrack()),yield this.publishOrRepublishTrack(G,K.options,!0)}))),j()}catch(W){$(W)}finally{this.republishPromise=void 0}})),yield q.republishPromise}()})}publishData(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function*(){const j=V.reliable?DataPacket_Kind.RELIABLE:DataPacket_Kind.LOSSY,$=V.destinationIdentities,W=V.topic,K=new DataPacket({kind:j,value:{case:"user",value:new UserPacket({participantIdentity:q.identity,payload:U,destinationIdentities:$,topic:W})}});yield q.engine.sendDataPacket(K,j)}()})}publishDtmf(F,U){return __awaiter$1(this,void 0,void 0,function*(){const q=new DataPacket({kind:DataPacket_Kind.RELIABLE,value:{case:"sipDtmf",value:new SipDTMF({code:F,digit:U})}});yield this.engine.sendDataPacket(q,DataPacket_Kind.RELIABLE)})}sendChatMessage(F,U){return __awaiter$1(this,void 0,void 0,function*(){const q={id:crypto.randomUUID(),message:F,timestamp:Date.now(),attachedFiles:U==null?void 0:U.attachments},V=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},q),{timestamp:protoInt64.parse(q.timestamp)}))}});return yield this.engine.sendDataPacket(V,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,q),q})}editChatMessage(F,U){return __awaiter$1(this,void 0,void 0,function*(){const q=Object.assign(Object.assign({},U),{message:F,editTimestamp:Date.now()}),V=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},q),{timestamp:protoInt64.parse(q.timestamp),editTimestamp:protoInt64.parse(q.editTimestamp)}))}});return yield this.engine.sendDataPacket(V,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,q),q})}sendText(F,U){return __awaiter$1(this,void 0,void 0,function*(){var q;const V=crypto.randomUUID(),$=new TextEncoder().encode(F).byteLength,W=(q=U==null?void 0:U.attachments)===null||q===void 0?void 0:q.map(()=>crypto.randomUUID()),K=new Array(W?W.length+1:1).fill(0),G=(z,H)=>{var Y;K[H]=z;const X=K.reduce((Z,ie)=>Z+ie,0);(Y=U==null?void 0:U.onProgress)===null||Y===void 0||Y.call(U,X)},Q=yield this.streamText({streamId:V,totalSize:$,destinationIdentities:U==null?void 0:U.destinationIdentities,topic:U==null?void 0:U.topic,attachedStreamIds:W,attributes:U==null?void 0:U.attributes});return yield Q.write(F),G(1,0),yield Q.close(),U!=null&&U.attachments&&W&&(yield Promise.all(U.attachments.map((z,H)=>__awaiter$1(this,void 0,void 0,function*(){return this._sendFile(W[H],z,{topic:U.topic,mimeType:z.type,onProgress:Y=>{G(Y,H+1)}})})))),Q.info})}streamText(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q;const V=(U=F==null?void 0:F.streamId)!==null&&U!==void 0?U:crypto.randomUUID(),j={id:V,mimeType:"text/plain",timestamp:Date.now(),topic:(q=F==null?void 0:F.topic)!==null&&q!==void 0?q:"",size:F==null?void 0:F.totalSize,attributes:F==null?void 0:F.attributes},$=new DataStream_Header({streamId:V,mimeType:j.mimeType,topic:j.topic,timestamp:numberToBigInt(j.timestamp),totalLength:numberToBigInt(F==null?void 0:F.totalSize),attributes:j.attributes,contentHeader:{case:"textHeader",value:new DataStream_TextHeader({version:F==null?void 0:F.version,attachedStreamIds:F==null?void 0:F.attachedStreamIds,replyToStreamId:F==null?void 0:F.replyToStreamId,operationType:(F==null?void 0:F.type)==="update"?DataStream_OperationType.UPDATE:DataStream_OperationType.CREATE})}}),W=F==null?void 0:F.destinationIdentities,K=new DataPacket({destinationIdentities:W,value:{case:"streamHeader",value:$}});yield this.engine.sendDataPacket(K,DataPacket_Kind.RELIABLE);let G=0;const Q=this,z=new WritableStream({write(X){return __awaiter$1(this,void 0,void 0,function*(){for(const Z of splitUtf8(X,STREAM_CHUNK_SIZE)){yield Q.engine.waitForBufferStatusLow(DataPacket_Kind.RELIABLE);const ie=new DataStream_Chunk({content:Z,streamId:V,chunkIndex:numberToBigInt(G)}),ee=new DataPacket({destinationIdentities:W,value:{case:"streamChunk",value:ie}});yield Q.engine.sendDataPacket(ee,DataPacket_Kind.RELIABLE),G+=1}})},close(){return __awaiter$1(this,void 0,void 0,function*(){const X=new DataStream_Trailer({streamId:V}),Z=new DataPacket({destinationIdentities:W,value:{case:"streamTrailer",value:X}});yield Q.engine.sendDataPacket(Z,DataPacket_Kind.RELIABLE)})},abort(X){console.log("Sink error:",X)}});let H=()=>__awaiter$1(this,void 0,void 0,function*(){yield Y.close()});Q.engine.once(EngineEvent.Closing,H);const Y=new TextStreamWriter(z,j,()=>this.engine.off(EngineEvent.Closing,H));return Y})}sendFile(F,U){return __awaiter$1(this,void 0,void 0,function*(){const q=crypto.randomUUID();return yield this._sendFile(q,F,U),{id:q}})}_sendFile(F,U,q){return __awaiter$1(this,void 0,void 0,function*(){var V;const j=yield this.streamBytes({streamId:F,totalSize:U.size,name:U.name,mimeType:(V=q==null?void 0:q.mimeType)!==null&&V!==void 0?V:U.type,topic:q==null?void 0:q.topic,destinationIdentities:q==null?void 0:q.destinationIdentities}),$=U.stream().getReader();for(;;){const{done:W,value:K}=yield $.read();if(W)break;yield j.write(K)}return yield j.close(),j.info})}streamBytes(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q,V,j,$;const W=(U=F==null?void 0:F.streamId)!==null&&U!==void 0?U:crypto.randomUUID(),K=F==null?void 0:F.destinationIdentities,G={id:W,mimeType:(q=F==null?void 0:F.mimeType)!==null&&q!==void 0?q:"application/octet-stream",topic:(V=F==null?void 0:F.topic)!==null&&V!==void 0?V:"",timestamp:Date.now(),attributes:F==null?void 0:F.attributes,size:F==null?void 0:F.totalSize,name:(j=F==null?void 0:F.name)!==null&&j!==void 0?j:"unknown"},Q=new DataStream_Header({totalLength:numberToBigInt(($=G.size)!==null&&$!==void 0?$:0),mimeType:G.mimeType,streamId:W,topic:G.topic,timestamp:numberToBigInt(Date.now()),attributes:G.attributes,contentHeader:{case:"byteHeader",value:new DataStream_ByteHeader({name:G.name})}}),z=new DataPacket({destinationIdentities:K,value:{case:"streamHeader",value:Q}});yield this.engine.sendDataPacket(z,DataPacket_Kind.RELIABLE);let H=0;const Y=new _$1,X=this.engine,Z=this.log,ie=new WritableStream({write(te){return __awaiter$1(this,void 0,void 0,function*(){const re=yield Y.lock();let ne=0;try{for(;ne<te.byteLength;){const se=te.slice(ne,ne+STREAM_CHUNK_SIZE);yield X.waitForBufferStatusLow(DataPacket_Kind.RELIABLE);const oe=new DataPacket({destinationIdentities:K,value:{case:"streamChunk",value:new DataStream_Chunk({content:se,streamId:W,chunkIndex:numberToBigInt(H)})}});yield X.sendDataPacket(oe,DataPacket_Kind.RELIABLE),H+=1,ne+=se.byteLength}}finally{re()}})},close(){return __awaiter$1(this,void 0,void 0,function*(){const te=new DataStream_Trailer({streamId:W}),re=new DataPacket({destinationIdentities:K,value:{case:"streamTrailer",value:te}});yield X.sendDataPacket(re,DataPacket_Kind.RELIABLE)})},abort(te){Z.error("Sink error:",te)}});return new ByteStreamWriter(ie,G)})}performRpc(F){return __awaiter$1(this,arguments,void 0,function(U){var q=this;let{destinationIdentity:V,method:j,payload:$,responseTimeout:W=1e4}=U;return function*(){return new Promise((G,Q)=>__awaiter$1(q,void 0,void 0,function*(){var z,H,Y,X;if(byteLength($)>MAX_PAYLOAD_BYTES){Q(RpcError.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((H=(z=this.engine.latestJoinResponse)===null||z===void 0?void 0:z.serverInfo)===null||H===void 0)&&H.version&&compareVersions((X=(Y=this.engine.latestJoinResponse)===null||Y===void 0?void 0:Y.serverInfo)===null||X===void 0?void 0:X.version,"1.8.0")<0){Q(RpcError.builtIn("UNSUPPORTED_SERVER"));return}const Z=crypto.randomUUID();yield this.publishRpcRequest(V,Z,j,$,W-2e3);const ie=setTimeout(()=>{this.pendingAcks.delete(Z),Q(RpcError.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(Z),clearTimeout(ee)},2e3);this.pendingAcks.set(Z,{resolve:()=>{clearTimeout(ie)},participantIdentity:V});const ee=setTimeout(()=>{this.pendingResponses.delete(Z),Q(RpcError.builtIn("RESPONSE_TIMEOUT"))},W);this.pendingResponses.set(Z,{resolve:(te,re)=>{clearTimeout(ee),this.pendingAcks.has(Z)&&(console.warn("RPC response received before ack",Z),this.pendingAcks.delete(Z),clearTimeout(ie)),re?Q(re):G(te??"")},participantIdentity:V})}))}()})}registerRpcMethod(F,U){this.rpcHandlers.has(F)&&this.log.warn("you're overriding the RPC handler for method ".concat(F,", in the future this will throw an error")),this.rpcHandlers.set(F,U)}unregisterRpcMethod(F){this.rpcHandlers.delete(F)}setTrackSubscriptionPermissions(F){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=U,this.allParticipantsAllowedToSubscribe=F,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(F){const U=this.pendingAcks.get(F);U?(U.resolve(),this.pendingAcks.delete(F)):console.error("Ack received for unexpected RPC request",F)}handleIncomingRpcResponse(F,U,q){const V=this.pendingResponses.get(F);V?(V.resolve(U,q),this.pendingResponses.delete(F)):console.error("Response received for unexpected RPC request",F)}publishRpcRequest(F,U,q,V,j){return __awaiter$1(this,void 0,void 0,function*(){const $=new DataPacket({destinationIdentities:[F],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcRequest",value:new RpcRequest({id:U,method:q,payload:V,responseTimeoutMs:j,version:1})}});yield this.engine.sendDataPacket($,DataPacket_Kind.RELIABLE)})}handleParticipantDisconnected(F){for(const[U,{participantIdentity:q}]of this.pendingAcks)q===F&&this.pendingAcks.delete(U);for(const[U,{participantIdentity:q,resolve:V}]of this.pendingResponses)q===F&&(V(null,RpcError.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(U))}setEnabledPublishCodecs(F){this.enabledPublishVideoCodecs=F.filter(U=>U.mime.split("/")[0].toLowerCase()==="video")}updateInfo(F){return super.updateInfo(F)?(F.tracks.forEach(U=>{var q,V;const j=this.trackPublications.get(U.sid);if(j){const $=j.isMuted||((V=(q=j.track)===null||q===void 0?void 0:q.isUpstreamPaused)!==null&&V!==void 0?V:!1);$!==U.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(j)),{mutedOnServer:$})),this.engine.client.sendMuteTrack(U.sid,$))}}),!0):!1}setActiveAgent(F){var U,q,V,j;this.firstActiveAgent=F,F&&!this.firstActiveAgent&&(this.firstActiveAgent=F),F?(q=(U=this.activeAgentFuture)===null||U===void 0?void 0:U.resolve)===null||q===void 0||q.call(U,F):(j=(V=this.activeAgentFuture)===null||V===void 0?void 0:V.reject)===null||j===void 0||j.call(V,"Agent disconnected"),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Future),this.activeAgentFuture.promise)}getPublicationForTrack(F){let U;return this.trackPublications.forEach(q=>{const V=q.track;V&&(F instanceof MediaStreamTrack?(isLocalAudioTrack(V)||isLocalVideoTrack(V))&&V.mediaStreamTrack===F&&(U=q):F===V&&(U=q))}),U}waitForPendingPublicationOfSource(F){return __awaiter$1(this,void 0,void 0,function*(){const q=Date.now();for(;Date.now()<q+1e4;){const V=Array.from(this.pendingPublishPromises.entries()).find(j=>{let[$]=j;return $.source===F});if(V)return V[1];yield sleep$1(20)}})}}class RemoteTrackPublication extends TrackPublication{constructor(F,U,q,V){super(F,U.sid,U.name,V),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=VideoQuality.HIGH,this.handleEnded=j=>{this.setTrack(void 0),this.emit(TrackEvent.Ended,j)},this.handleVisibilityChange=j=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(j),this.logContext),this.disabled=!j,this.emitTrackUpdate()},this.handleVideoDimensionsChange=j=>{this.log.debug("adaptivestream video dimensions ".concat(j.width,"x").concat(j.height),this.logContext),this.videoDimensions=j,this.emitTrackUpdate()},this.subscribed=q,this.updateInfo(U)}setSubscribed(F){const U=this.subscriptionStatus,q=this.permissionStatus;this.subscribed=F,F&&(this.allowed=!0);const V=new UpdateSubscription({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new ParticipantTracks({participantSid:"",trackSids:[this.trackSid]})]});this.emit(TrackEvent.UpdateSubscription,V),this.emitSubscriptionUpdateIfChanged(U),this.emitPermissionUpdateIfChanged(q)}get subscriptionStatus(){return this.subscribed===!1?TrackPublication.SubscriptionStatus.Unsubscribed:super.isSubscribed?TrackPublication.SubscriptionStatus.Subscribed:TrackPublication.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?TrackPublication.PermissionStatus.Allowed:TrackPublication.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return!this.disabled}get isLocal(){return!1}setEnabled(F){!this.isManualOperationAllowed()||this.disabled===!F||(this.disabled=!F,this.emitTrackUpdate())}setVideoQuality(F){!this.isManualOperationAllowed()||this.currentVideoQuality===F||(this.currentVideoQuality=F,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(F){var U,q;this.isManualOperationAllowed()&&(((U=this.videoDimensions)===null||U===void 0?void 0:U.width)===F.width&&((q=this.videoDimensions)===null||q===void 0?void 0:q.height)===F.height||(isRemoteVideoTrack(this.track)&&(this.videoDimensions=F),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(F){this.isManualOperationAllowed()&&isRemoteVideoTrack(this.track)&&this.fps!==F&&(this.fps=F,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack(F){const U=this.subscriptionStatus,q=this.permissionStatus,V=this.track;V!==F&&(V&&(V.off(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),V.off(TrackEvent.VisibilityChanged,this.handleVisibilityChange),V.off(TrackEvent.Ended,this.handleEnded),V.detach(),V.stopMonitor(),this.emit(TrackEvent.Unsubscribed,V)),super.setTrack(F),F&&(F.sid=this.trackSid,F.on(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),F.on(TrackEvent.VisibilityChanged,this.handleVisibilityChange),F.on(TrackEvent.Ended,this.handleEnded),this.emit(TrackEvent.Subscribed,F)),this.emitPermissionUpdateIfChanged(q),this.emitSubscriptionUpdateIfChanged(U))}setAllowed(F){const U=this.subscriptionStatus,q=this.permissionStatus;this.allowed=F,this.emitPermissionUpdateIfChanged(q),this.emitSubscriptionUpdateIfChanged(U)}setSubscriptionError(F){this.emit(TrackEvent.SubscriptionFailed,F)}updateInfo(F){super.updateInfo(F);const U=this.metadataMuted;this.metadataMuted=F.muted,this.track?this.track.setMuted(F.muted):U!==F.muted&&this.emit(F.muted?TrackEvent.Muted:TrackEvent.Unmuted)}emitSubscriptionUpdateIfChanged(F){const U=this.subscriptionStatus;F!==U&&this.emit(TrackEvent.SubscriptionStatusChanged,U,F)}emitPermissionUpdateIfChanged(F){this.permissionStatus!==F&&this.emit(TrackEvent.SubscriptionPermissionChanged,this.permissionStatus,F)}isManualOperationAllowed(){return this.kind===Track.Kind.Video&&this.isAdaptiveStream?(this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext),!1):this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return isRemoteVideoTrack(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const F=new UpdateTrackSettings({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?(F.width=Math.ceil(this.videoDimensions.width),F.height=Math.ceil(this.videoDimensions.height)):this.currentVideoQuality!==void 0?F.quality=this.currentVideoQuality:F.quality=VideoQuality.HIGH,this.emit(TrackEvent.UpdateSettings,F)}}class RemoteParticipant extends Participant{static fromParticipantInfo(F,U,q){return new RemoteParticipant(F,U.sid,U.identity,U.name,U.metadata,U.attributes,q,U.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(F,U,q,V,j,$,W){let K=arguments.length>7&&arguments[7]!==void 0?arguments[7]:ParticipantInfo_Kind.STANDARD;super(U,q||"",V,j,$,W,K),this.signalClient=F,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(F){super.addTrackPublication(F),F.on(TrackEvent.UpdateSettings,U=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(F))),this.signalClient.sendUpdateTrackSettings(U)}),F.on(TrackEvent.UpdateSubscription,U=>{U.participantTracks.forEach(q=>{q.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(U)}),F.on(TrackEvent.SubscriptionPermissionChanged,U=>{this.emit(ParticipantEvent.TrackSubscriptionPermissionChanged,F,U)}),F.on(TrackEvent.SubscriptionStatusChanged,U=>{this.emit(ParticipantEvent.TrackSubscriptionStatusChanged,F,U)}),F.on(TrackEvent.Subscribed,U=>{this.emit(ParticipantEvent.TrackSubscribed,U,F)}),F.on(TrackEvent.Unsubscribed,U=>{this.emit(ParticipantEvent.TrackUnsubscribed,U,F)}),F.on(TrackEvent.SubscriptionFailed,U=>{this.emit(ParticipantEvent.TrackSubscriptionFailed,F.trackSid,U)})}getTrackPublication(F){const U=super.getTrackPublication(F);if(U)return U}getTrackPublicationByName(F){const U=super.getTrackPublicationByName(F);if(U)return U}setVolume(F){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Track.Source.Microphone;this.volumeMap.set(U,F);const q=this.getTrackPublication(U);q&&q.track&&q.track.setVolume(F)}getVolume(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Track.Source.Microphone;const U=this.getTrackPublication(F);return U&&U.track?U.track.getVolume():this.volumeMap.get(F)}addSubscribedMediaTrack(F,U,q,V,j,$){let W=this.getTrackPublicationBySid(U);if(W||U.startsWith("TR")||this.trackPublications.forEach(Q=>{!W&&F.kind===Q.kind.toString()&&(W=Q)}),!W){if($===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:U})),this.emit(ParticipantEvent.TrackSubscriptionFailed,U);return}$===void 0&&($=20),setTimeout(()=>{this.addSubscribedMediaTrack(F,U,q,V,j,$-1)},150);return}if(F.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),this.emit(ParticipantEvent.TrackSubscriptionFailed,U);return}const K=F.kind==="video";let G;return K?G=new RemoteVideoTrack(F,U,V,j):G=new RemoteAudioTrack(F,U,V,this.audioContext,this.audioOutput),G.source=W.source,G.isMuted=W.isMuted,G.setMediaStream(q),G.start(),W.setTrack(G),this.volumeMap.has(W.source)&&isRemoteTrack(G)&&isAudioTrack(G)&&G.setVolume(this.volumeMap.get(W.source)),W}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(F){return this.trackPublications.get(F)}updateInfo(F){if(!super.updateInfo(F))return!1;const U=new Map,q=new Map;return F.tracks.forEach(V=>{var j,$;let W=this.getTrackPublicationBySid(V.sid);if(W)W.updateInfo(V);else{const K=Track.kindFromProto(V.type);if(!K)return;W=new RemoteTrackPublication(K,V,(j=this.signalClient.connectOptions)===null||j===void 0?void 0:j.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:($=this.loggerOptions)===null||$===void 0?void 0:$.loggerName}),W.updateInfo(V),q.set(V.sid,W);const G=Array.from(this.trackPublications.values()).find(Q=>Q.source===(W==null?void 0:W.source));G&&W.source!==Track.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(W.source),Object.assign(Object.assign({},this.logContext),{oldTrack:getLogContextFromTrack(G),newTrack:getLogContextFromTrack(W)})),this.addTrackPublication(W)}U.set(V.sid,W)}),this.trackPublications.forEach(V=>{U.has(V.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(V))),this.unpublishTrack(V.trackSid,!0))}),q.forEach(V=>{this.emit(ParticipantEvent.TrackPublished,V)}),!0}unpublishTrack(F,U){const q=this.trackPublications.get(F);if(!q)return;const{track:V}=q;switch(V&&(V.stop(),q.setTrack(void 0)),this.trackPublications.delete(F),q.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(F);break;case Track.Kind.Video:this.videoTrackPublications.delete(F);break}U&&this.emit(ParticipantEvent.TrackUnpublished,q)}setAudioOutput(F){return __awaiter$1(this,void 0,void 0,function*(){this.audioOutput=F;const U=[];this.audioTrackPublications.forEach(q=>{var V;isAudioTrack(q.track)&&isRemoteTrack(q.track)&&U.push(q.track.setSinkId((V=F.deviceId)!==null&&V!==void 0?V:"default"))}),yield Promise.all(U)})}emit(F){for(var U=arguments.length,q=new Array(U>1?U-1:0),V=1;V<U;V++)q[V-1]=arguments[V];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:F,args:q})),super.emit(F,...q)}}var ConnectionState;(function(B){B.Disconnected="disconnected",B.Connecting="connecting",B.Connected="connected",B.Reconnecting="reconnecting",B.SignalReconnecting="signalReconnecting"})(ConnectionState||(ConnectionState={}));const connectionReconcileFrequency=4*1e3;class Room extends eventsExports.EventEmitter{constructor(F){var U,q,V,j;if(super(),U=this,this.state=ConnectionState.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=livekitLogger,this.bufferedEvents=[],this.isResuming=!1,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map,this.rpcHandlers=new Map,this.connect=($,W,K)=>__awaiter$1(this,void 0,void 0,function*(){var G;if(!isBrowserSupported())throw isReactNative()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const Q=yield this.disconnectLock.lock();if(this.state===ConnectionState.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),Q(),Promise.resolve();if(this.connectFuture)return Q(),this.connectFuture.promise;this.setAndEmitConnectionState(ConnectionState.Connecting),((G=this.regionUrlProvider)===null||G===void 0?void 0:G.getServerUrl().toString())!==$&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),isCloud(new URL($))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new RegionUrlProvider($,W):this.regionUrlProvider.updateToken(W),this.regionUrlProvider.fetchRegionSettings().then(Y=>{var X;(X=this.regionUrlProvider)===null||X===void 0||X.setServerReportedRegions(Y)}).catch(Y=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:Y}))}));const z=(Y,X,Z)=>__awaiter$1(this,void 0,void 0,function*(){var ie,ee;this.abortController&&this.abortController.abort();const te=new AbortController;this.abortController=te,Q==null||Q();try{yield this.attemptConnection(Z??$,W,K,te),this.abortController=void 0,Y()}catch(re){if(this.regionUrlProvider&&re instanceof ConnectionError&&re.reason!==ConnectionErrorReason.Cancelled&&re.reason!==ConnectionErrorReason.NotAllowed){let ne=null;try{ne=yield this.regionUrlProvider.getNextBestRegionUrl((ie=this.abortController)===null||ie===void 0?void 0:ie.signal)}catch(se){if(se instanceof ConnectionError&&(se.status===401||se.reason===ConnectionErrorReason.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),X(se);return}}ne&&!(!((ee=this.abortController)===null||ee===void 0)&&ee.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(re.message,". Retrying with another region: ").concat(ne),this.logContext),this.recreateEngine(),yield z(Y,X,ne)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,getDisconnectReasonFromConnectionError(re)),X(re))}else{let ne=DisconnectReason.UNKNOWN_REASON;re instanceof ConnectionError&&(ne=getDisconnectReasonFromConnectionError(re)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,ne),X(re)}}}),H=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Future((Y,X)=>{z(Y,X,H)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=($,W,K,G,Q,z)=>__awaiter$1(this,void 0,void 0,function*(){var H,Y,X;const Z=yield K.join($,W,{autoSubscribe:G.autoSubscribe,adaptiveStream:typeof Q.adaptiveStream=="object"?!0:Q.adaptiveStream,maxRetries:G.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:G.websocketTimeout},z.signal);let ie=Z.serverInfo;if(ie||(ie={version:Z.serverVersion,region:Z.serverRegion}),this.serverInfo=ie,this.log.debug("connected to Livekit Server ".concat(Object.entries(ie).map(ee=>{let[te,re]=ee;return"".concat(te,": ").concat(re)}).join(", ")),{room:(H=Z.room)===null||H===void 0?void 0:H.name,roomSid:(Y=Z.room)===null||Y===void 0?void 0:Y.sid,identity:(X=Z.participant)===null||X===void 0?void 0:X.identity}),!ie.version)throw new UnsupportedServer("unknown server version");return ie.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),Q.dynacast=!1),Z}),this.applyJoinResponse=$=>{const W=$.participant;if(this.localParticipant.sid=W.sid,this.localParticipant.identity=W.identity,this.localParticipant.setEnabledPublishCodecs($.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer($.sifTrailer)}catch(K){this.log.error(K instanceof Error?K.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:K}))}this.handleParticipantUpdates([W,...$.otherParticipants]),$.room&&this.handleRoomUpdate($.room)},this.attemptConnection=($,W,K,G)=>__awaiter$1(this,void 0,void 0,function*(){var Q,z;this.state===ConnectionState.Reconnecting||this.isResuming||!((Q=this.engine)===null||Q===void 0)&&Q.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((z=this.regionUrlProvider)===null||z===void 0)&&z.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},roomConnectOptionDefaults),K),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const H=yield this.connectSignal($,W,this.engine,this.connOptions,this.options,G);this.applyJoinResponse(H),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected)}catch(H){yield this.engine.close(),this.recreateEngine();const Y=new ConnectionError("could not establish signal connection",ConnectionErrorReason.ServerUnreachable);throw H instanceof Error&&(Y.message="".concat(Y.message,": ").concat(H.message)),H instanceof ConnectionError&&(Y.reason=H.reason,Y.status=H.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:H})),Y}if(G.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new ConnectionError("Connection attempt aborted",ConnectionErrorReason.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,G)}catch(H){throw yield this.engine.close(),this.recreateEngine(),H}isWeb()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),isWeb()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var $=arguments.length,W=new Array($),K=0;K<$;K++)W[K]=arguments[K];return __awaiter$1(U,[...W],void 0,function(){var G=this;let Q=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var z,H,Y,X;const Z=yield G.disconnectLock.lock();try{if(G.state===ConnectionState.Disconnected){G.log.debug("already disconnected",G.logContext);return}G.log.info("disconnect from room",Object.assign({},G.logContext)),(G.state===ConnectionState.Connecting||G.state===ConnectionState.Reconnecting||G.isResuming)&&(G.log.warn("abort connection attempt",G.logContext),(z=G.abortController)===null||z===void 0||z.abort(),(Y=(H=G.connectFuture)===null||H===void 0?void 0:H.reject)===null||Y===void 0||Y.call(H,new ConnectionError("Client initiated disconnect",ConnectionErrorReason.Cancelled)),G.connectFuture=void 0),!((X=G.engine)===null||X===void 0)&&X.client.isDisconnected||(yield G.engine.client.sendLeave()),G.engine&&(yield G.engine.close()),G.handleDisconnect(Q,DisconnectReason.CLIENT_INITIATED),G.engine=void 0}finally{Z()}}()})},this.onPageLeave=()=>__awaiter$1(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>__awaiter$1(this,void 0,void 0,function*(){const $=[],W=getBrowser();if(W&&W.os==="iOS"){const K="livekit-dummy-audio-el";let G=document.getElementById(K);if(!G){G=document.createElement("audio"),G.id=K,G.autoplay=!0,G.hidden=!0;const Q=getEmptyAudioStreamTrack();Q.enabled=!0;const z=new MediaStream([Q]);G.srcObject=z,document.addEventListener("visibilitychange",()=>{G&&(G.srcObject=document.hidden?null:z,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(G),this.once(RoomEvent.Disconnected,()=>{G==null||G.remove(),G=null})}$.push(G)}this.remoteParticipants.forEach(K=>{K.audioTrackPublications.forEach(G=>{G.track&&G.track.attachedElements.forEach(Q=>{$.push(Q)})})});try{yield Promise.all([this.acquireAudioContext(),...$.map(K=>(K.muted=!1,K.play()))]),this.handleAudioPlaybackStarted()}catch(K){throw this.handleAudioPlaybackFailed(K),K}}),this.startVideo=()=>__awaiter$1(this,void 0,void 0,function*(){const $=[];for(const W of this.remoteParticipants.values())W.videoTrackPublications.forEach(K=>{var G;(G=K.track)===null||G===void 0||G.attachedElements.forEach(Q=>{$.includes(Q)||$.push(Q)})});yield Promise.all($.map(W=>W.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(W=>{W.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const $ of this.remoteParticipants.values())this.handleParticipantDisconnected($.identity,$);this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)},this.handleSignalRestarted=$=>__awaiter$1(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat($.serverRegion),Object.assign(Object.assign({},this.logContext),{region:$.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse($);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(W){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:W}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:$.serverRegion}))}catch{return}this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=$=>{$.forEach(W=>{var K;if(W.identity===this.localParticipant.identity){this.localParticipant.updateInfo(W);return}W.identity===""&&(W.identity=(K=this.sidToIdentity.get(W.sid))!==null&&K!==void 0?K:"");let G=this.remoteParticipants.get(W.identity);W.state===ParticipantInfo_State.DISCONNECTED?this.handleParticipantDisconnected(W.identity,G):G=this.getOrCreateParticipant(W.identity,W)})},this.handleActiveSpeakersUpdate=$=>{const W=[],K={};$.forEach(G=>{if(K[G.sid]=!0,G.sid===this.localParticipant.sid)this.localParticipant.audioLevel=G.level,this.localParticipant.setIsSpeaking(!0),W.push(this.localParticipant);else{const Q=this.getRemoteParticipantBySid(G.sid);Q&&(Q.audioLevel=G.level,Q.setIsSpeaking(!0),W.push(Q))}}),K[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(G=>{K[G.sid]||(G.audioLevel=0,G.setIsSpeaking(!1))}),this.activeSpeakers=W,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,W)},this.handleSpeakersChanged=$=>{const W=new Map;this.activeSpeakers.forEach(G=>{const Q=this.remoteParticipants.get(G.identity);Q&&Q.sid!==G.sid||W.set(G.sid,G)}),$.forEach(G=>{let Q=this.getRemoteParticipantBySid(G.sid);G.sid===this.localParticipant.sid&&(Q=this.localParticipant),Q&&(Q.audioLevel=G.level,Q.setIsSpeaking(G.active),G.active?W.set(G.sid,Q):W.delete(G.sid))});const K=Array.from(W.values());K.sort((G,Q)=>Q.audioLevel-G.audioLevel),this.activeSpeakers=K,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,K)},this.handleStreamStateUpdate=$=>{$.streamStates.forEach(W=>{const K=this.getRemoteParticipantBySid(W.participantSid);if(!K)return;const G=K.getTrackPublicationBySid(W.trackSid);if(!G||!G.track)return;const Q=Track.streamStateFromProto(W.state);Q!==G.track.streamState&&(G.track.streamState=Q,K.emit(ParticipantEvent.TrackStreamStateChanged,G,G.track.streamState),this.emitWhenConnected(RoomEvent.TrackStreamStateChanged,G,G.track.streamState,K))})},this.handleSubscriptionPermissionUpdate=$=>{const W=this.getRemoteParticipantBySid($.participantSid);if(!W)return;const K=W.getTrackPublicationBySid($.trackSid);K&&K.setAllowed($.allowed)},this.handleSubscriptionError=$=>{const W=Array.from(this.remoteParticipants.values()).find(G=>G.trackPublications.has($.trackSid));if(!W)return;const K=W.getTrackPublicationBySid($.trackSid);K&&K.setSubscriptionError($.err)},this.handleDataPacket=$=>{const W=this.remoteParticipants.get($.participantIdentity);if($.value.case==="user")this.handleUserPacket(W,$.value.value,$.kind);else if($.value.case==="transcription")this.handleTranscription(W,$.value.value);else if($.value.case==="sipDtmf")this.handleSipDtmf(W,$.value.value);else if($.value.case==="chatMessage")this.handleChatMessage(W,$.value.value);else if($.value.case==="metrics")this.handleMetrics($.value.value,W);else if($.value.case==="streamHeader")this.handleStreamHeader($.value.value,$.participantIdentity);else if($.value.case==="streamChunk")this.handleStreamChunk($.value.value);else if($.value.case==="streamTrailer")this.handleStreamTrailer($.value.value);else if($.value.case==="rpcRequest"){const K=$.value.value;this.handleIncomingRpcRequest($.participantIdentity,K.id,K.method,K.payload,K.responseTimeoutMs,K.version)}},this.handleUserPacket=($,W,K)=>{this.emit(RoomEvent.DataReceived,W.payload,$,K,W.topic),$==null||$.emit(ParticipantEvent.DataReceived,W.payload,K)},this.handleSipDtmf=($,W)=>{this.emit(RoomEvent.SipDTMFReceived,W,$),$==null||$.emit(ParticipantEvent.SipDTMFReceived,W)},this.bufferedSegments=new Map,this.handleTranscription=($,W)=>{const K=W.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(W.transcribedParticipantIdentity),G=K==null?void 0:K.trackPublications.get(W.trackId),Q=extractTranscriptionSegments(W,this.transcriptionReceivedTimes);G==null||G.emit(TrackEvent.TranscriptionReceived,Q),K==null||K.emit(ParticipantEvent.TranscriptionReceived,Q,G),this.emit(RoomEvent.TranscriptionReceived,Q,K,G)},this.handleChatMessage=($,W)=>{const K=extractChatMessage(W);this.emit(RoomEvent.ChatMessage,K,$)},this.handleMetrics=($,W)=>{this.emit(RoomEvent.MetricsReceived,$,W)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(RoomEvent.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=$=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:$})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(RoomEvent.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(RoomEvent.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(RoomEvent.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>__awaiter$1(this,void 0,void 0,function*(){var $;(($=getBrowser())===null||$===void 0?void 0:$.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(RoomEvent.MediaDevicesChanged)}),this.handleRoomUpdate=$=>{const W=this.roomInfo;this.roomInfo=$,W&&W.metadata!==$.metadata&&this.emitWhenConnected(RoomEvent.RoomMetadataChanged,$.metadata),(W==null?void 0:W.activeRecording)!==$.activeRecording&&this.emitWhenConnected(RoomEvent.RecordingStatusChanged,$.activeRecording)},this.handleConnectionQualityUpdate=$=>{$.updates.forEach(W=>{if(W.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(W.quality);return}const K=this.getRemoteParticipantBySid(W.participantSid);K&&K.setConnectionQuality(W.quality)})},this.onLocalParticipantMetadataChanged=$=>{this.emit(RoomEvent.ParticipantMetadataChanged,$,this.localParticipant)},this.onLocalParticipantNameChanged=$=>{this.emit(RoomEvent.ParticipantNameChanged,$,this.localParticipant)},this.onLocalAttributesChanged=$=>{this.emit(RoomEvent.ParticipantAttributesChanged,$,this.localParticipant)},this.onLocalTrackMuted=$=>{this.emit(RoomEvent.TrackMuted,$,this.localParticipant)},this.onLocalTrackUnmuted=$=>{this.emit(RoomEvent.TrackUnmuted,$,this.localParticipant)},this.onTrackProcessorUpdate=$=>{var W;(W=$==null?void 0:$.onPublish)===null||W===void 0||W.call($,this)},this.onLocalTrackPublished=$=>__awaiter$1(this,void 0,void 0,function*(){var W,K,G,Q,z,H;(W=$.track)===null||W===void 0||W.on(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(K=$.track)===null||K===void 0||K.on(TrackEvent.Restarted,this.onLocalTrackRestarted),(z=(Q=(G=$.track)===null||G===void 0?void 0:G.getProcessor())===null||Q===void 0?void 0:Q.onPublish)===null||z===void 0||z.call(Q,this),this.emit(RoomEvent.LocalTrackPublished,$,this.localParticipant),isLocalAudioTrack($.track)&&(yield $.track.checkForSilence())&&this.emit(RoomEvent.LocalAudioSilenceDetected,$);const Y=yield(H=$.track)===null||H===void 0?void 0:H.getDeviceId(!1),X=sourceToKind($.source);X&&Y&&Y!==this.localParticipant.activeDeviceMap.get(X)&&(this.localParticipant.activeDeviceMap.set(X,Y),this.emit(RoomEvent.ActiveDeviceChanged,X,Y))}),this.onLocalTrackUnpublished=$=>{var W,K;(W=$.track)===null||W===void 0||W.off(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(K=$.track)===null||K===void 0||K.off(TrackEvent.Restarted,this.onLocalTrackRestarted),this.emit(RoomEvent.LocalTrackUnpublished,$,this.localParticipant)},this.onLocalTrackRestarted=$=>__awaiter$1(this,void 0,void 0,function*(){const W=yield $.getDeviceId(!1),K=sourceToKind($.source);K&&W&&W!==this.localParticipant.activeDeviceMap.get(K)&&(this.log.debug("local track restarted, setting ".concat(K," ").concat(W," active"),this.logContext),this.localParticipant.activeDeviceMap.set(K,W),this.emit(RoomEvent.ActiveDeviceChanged,K,W))}),this.onLocalConnectionQualityChanged=$=>{this.emit(RoomEvent.ConnectionQualityChanged,$,this.localParticipant)},this.onMediaDevicesError=($,W)=>{this.emit(RoomEvent.MediaDevicesError,$,W)},this.onLocalParticipantPermissionsChanged=$=>{this.emit(RoomEvent.ParticipantPermissionsChanged,$,this.localParticipant)},this.onLocalChatMessageSent=$=>{this.emit(RoomEvent.ChatMessage,$,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},roomOptionDefaults),F),this.log=getLogger((q=this.options.loggerName)!==null&&q!==void 0?q:LoggerNames.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},audioDefaults),F==null?void 0:F.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},videoDefaults),F==null?void 0:F.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},publishDefaults),F==null?void 0:F.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new _$1,this.localParticipant=new LocalParticipant("","",this.engine,this.options,this.rpcHandlers),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",unwrapConstraint(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",unwrapConstraint(this.options.audioCaptureDefaults.deviceId)),!((V=this.options.audioOutput)===null||V===void 0)&&V.deviceId&&this.switchActiveDevice("audiooutput",unwrapConstraint(this.options.audioOutput.deviceId)).catch($=>this.log.warn("Could not set audio output: ".concat($.message),this.logContext)),this.options.e2ee&&this.setupE2EE(),isWeb()){const $=new AbortController;(j=navigator.mediaDevices)===null||j===void 0||j.addEventListener("devicechange",this.handleDeviceChange,{signal:$.signal}),Room.cleanupRegistry&&Room.cleanupRegistry.register(this,()=>{$.abort()})}}registerTextStreamHandler(F,U){if(this.textStreamHandlers.has(F))throw new TypeError('A text stream handler for topic "'.concat(F,'" has already been set.'));this.textStreamHandlers.set(F,U)}unregisterTextStreamHandler(F){this.textStreamHandlers.delete(F)}registerByteStreamHandler(F,U){if(this.byteStreamHandlers.has(F))throw new TypeError('A byte stream handler for topic "'.concat(F,'" has already been set.'));this.byteStreamHandlers.set(F,U)}unregisterByteStreamHandler(F){this.byteStreamHandlers.delete(F)}registerRpcMethod(F,U){if(this.rpcHandlers.has(F))throw Error("RPC handler already registered for method ".concat(F,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(F,U)}unregisterRpcMethod(F){this.rpcHandlers.delete(F)}handleIncomingRpcRequest(F,U,q,V,j,$){return __awaiter$1(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(F,U),$!==1){yield this.engine.publishRpcResponse(F,U,null,RpcError.builtIn("UNSUPPORTED_VERSION"));return}const W=this.rpcHandlers.get(q);if(!W){yield this.engine.publishRpcResponse(F,U,null,RpcError.builtIn("UNSUPPORTED_METHOD"));return}let K=null,G=null;try{const Q=yield W({requestId:U,callerIdentity:F,payload:V,responseTimeout:j});byteLength(Q)>MAX_PAYLOAD_BYTES?(K=RpcError.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(q))):G=Q}catch(Q){Q instanceof RpcError?K=Q:(console.warn("Uncaught error returned by RPC handler for ".concat(q,". Returning APPLICATION_ERROR instead."),Q),K=RpcError.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(F,U,G,K)})}setE2EEEnabled(F){return __awaiter$1(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(F)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(F,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var F;this.options.e2ee&&("e2eeManager"in this.options.e2ee?this.e2eeManager=this.options.e2ee.e2eeManager:this.e2eeManager=new E2EEManager(this.options.e2ee),this.e2eeManager.on(EncryptionEvent.ParticipantEncryptionStatusChanged,(U,q)=>{isLocalParticipant(q)&&(this.isE2EEEnabled=U),this.emit(RoomEvent.ParticipantEncryptionStatusChanged,U,q)}),this.e2eeManager.on(EncryptionEvent.EncryptionError,U=>this.emit(RoomEvent.EncryptionError,U)),(F=this.e2eeManager)===null||F===void 0||F.setup(this))}get logContext(){var F;return{room:this.name,roomID:(F=this.roomInfo)===null||F===void 0?void 0:F.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var F,U;return(U=(F=this.roomInfo)===null||F===void 0?void 0:F.activeRecording)!==null&&U!==void 0?U:!1}getSid(){return __awaiter$1(this,void 0,void 0,function*(){return this.state===ConnectionState.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((F,U)=>{const q=V=>{V.sid!==""&&(this.engine.off(EngineEvent.RoomUpdate,q),F(V.sid))};this.engine.on(EngineEvent.RoomUpdate,q),this.once(RoomEvent.Disconnected,()=>{this.engine.off(EngineEvent.RoomUpdate,q),U("Room disconnected before room server id was available")})})})}get name(){var F,U;return(U=(F=this.roomInfo)===null||F===void 0?void 0:F.name)!==null&&U!==void 0?U:""}get metadata(){var F;return(F=this.roomInfo)===null||F===void 0?void 0:F.metadata}get numParticipants(){var F,U;return(U=(F=this.roomInfo)===null||F===void 0?void 0:F.numParticipants)!==null&&U!==void 0?U:0}get numPublishers(){var F,U;return(U=(F=this.roomInfo)===null||F===void 0?void 0:F.numPublishers)!==null&&U!==void 0?U:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new RTCEngine(this.options),this.engine.on(EngineEvent.ParticipantUpdate,this.handleParticipantUpdates).on(EngineEvent.RoomUpdate,this.handleRoomUpdate).on(EngineEvent.SpeakersChanged,this.handleSpeakersChanged).on(EngineEvent.StreamStateChanged,this.handleStreamStateUpdate).on(EngineEvent.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(EngineEvent.SubscriptionError,this.handleSubscriptionError).on(EngineEvent.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(EngineEvent.MediaTrackAdded,(F,U,q)=>{this.onTrackAdded(F,U,q)}).on(EngineEvent.Disconnected,F=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,F)}).on(EngineEvent.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(EngineEvent.DataPacketReceived,this.handleDataPacket).on(EngineEvent.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(ConnectionState.SignalReconnecting)&&this.emit(RoomEvent.SignalReconnecting)}).on(EngineEvent.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(ConnectionState.Connected)&&this.emit(RoomEvent.Reconnected)}).on(EngineEvent.SignalResumed,()=>{this.bufferedEvents=[],(this.state===ConnectionState.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(EngineEvent.Restarting,this.handleRestarting).on(EngineEvent.SignalRestarted,this.handleSignalRestarted).on(EngineEvent.Offline,()=>{this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)}).on(EngineEvent.DCBufferStatusChanged,(F,U)=>{this.emit(RoomEvent.DCBufferStatusChanged,F,U)}).on(EngineEvent.LocalTrackSubscribed,F=>{const U=this.localParticipant.getTrackPublications().find(q=>{let{trackSid:V}=q;return V===F});if(!U){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(ParticipantEvent.LocalTrackSubscribed,U),this.emitWhenConnected(RoomEvent.LocalTrackSubscribed,U,this.localParticipant)}).on(EngineEvent.RoomMoved,F=>{this.log.debug("room moved",F),F.room&&this.handleRoomUpdate(F.room),this.remoteParticipants.forEach((U,q)=>{this.handleParticipantDisconnected(q,U)}),this.emit(RoomEvent.Moved,F.room.name,F.token),F.participant?this.handleParticipantUpdates([F.participant,...F.otherParticipants]):this.handleParticipantUpdates(F.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices(F){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return DeviceManager.getInstance().getDevices(F,U)}prepareConnection(F,U){return __awaiter$1(this,void 0,void 0,function*(){if(this.state===ConnectionState.Disconnected){this.log.debug("prepareConnection to ".concat(F),this.logContext);try{if(isCloud(new URL(F))&&U){this.regionUrlProvider=new RegionUrlProvider(F,U);const q=yield this.regionUrlProvider.getNextBestRegionUrl();q&&this.state===ConnectionState.Disconnected&&(this.regionUrl=q,yield fetch(toHttpUrl(q),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(q),this.logContext))}else yield fetch(toHttpUrl(F),{method:"HEAD"})}catch(q){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:q}))}}})}getParticipantByIdentity(F){return this.localParticipant.identity===F?this.localParticipant:this.remoteParticipants.get(F)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(F,U){return __awaiter$1(this,void 0,void 0,function*(){let q=()=>{},V;switch(F){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":V=new SimulateScenario({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":V=new SimulateScenario({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":V=new SimulateScenario({scenario:{case:"serverLeave",value:!0}});break;case"migration":V=new SimulateScenario({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":q=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),V=new SimulateScenario({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":q=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),V=new SimulateScenario({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":V=new SimulateScenario({scenario:{case:"switchCandidateProtocol",value:F==="force-tls"?2:1}}),q=()=>__awaiter$1(this,void 0,void 0,function*(){const j=this.engine.client.onLeave;j&&j(new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.RECONNECT}))});break;case"subscriber-bandwidth":if(U===void 0||typeof U!="number")throw new Error("subscriber-bandwidth requires a number as argument");V=new SimulateScenario({scenario:{case:"subscriberBandwidth",value:numberToBigInt(U)}});break;case"leave-full-reconnect":V=new SimulateScenario({scenario:{case:"leaveRequestFullReconnect",value:!0}})}V&&(yield this.engine.client.sendSimulateScenario(V),yield q())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(F){return this.localParticipant.activeDeviceMap.get(F)}switchActiveDevice(F,U){return __awaiter$1(this,arguments,void 0,function(q,V){var j=this;let $=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return function*(){var W,K,G,Q,z,H,Y,X;let Z=!0,ie=!1;const ee=$?{exact:V}:V;if(q==="audioinput"){ie=j.localParticipant.audioTrackPublications.size===0;const te=(W=j.getActiveDevice(q))!==null&&W!==void 0?W:j.options.audioCaptureDefaults.deviceId;j.options.audioCaptureDefaults.deviceId=ee;const re=Array.from(j.localParticipant.audioTrackPublications.values()).filter(ne=>ne.source===Track.Source.Microphone);try{Z=(yield Promise.all(re.map(ne=>{var se;return(se=ne.audioTrack)===null||se===void 0?void 0:se.setDeviceId(ee)}))).every(ne=>ne===!0)}catch(ne){throw j.options.audioCaptureDefaults.deviceId=te,ne}}else if(q==="videoinput"){ie=j.localParticipant.videoTrackPublications.size===0;const te=(K=j.getActiveDevice(q))!==null&&K!==void 0?K:j.options.videoCaptureDefaults.deviceId;j.options.videoCaptureDefaults.deviceId=ee;const re=Array.from(j.localParticipant.videoTrackPublications.values()).filter(ne=>ne.source===Track.Source.Camera);try{Z=(yield Promise.all(re.map(ne=>{var se;return(se=ne.videoTrack)===null||se===void 0?void 0:se.setDeviceId(ee)}))).every(ne=>ne===!0)}catch(ne){throw j.options.videoCaptureDefaults.deviceId=te,ne}}else if(q==="audiooutput"){if(!supportsSetSinkId()&&!j.options.webAudioMix||j.options.webAudioMix&&j.audioContext&&!("setSinkId"in j.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");j.options.webAudioMix&&(V=(G=yield DeviceManager.getInstance().normalizeDeviceId("audiooutput",V))!==null&&G!==void 0?G:""),(Q=(X=j.options).audioOutput)!==null&&Q!==void 0||(X.audioOutput={});const te=(z=j.getActiveDevice(q))!==null&&z!==void 0?z:j.options.audioOutput.deviceId;j.options.audioOutput.deviceId=V;try{j.options.webAudioMix&&((H=j.audioContext)===null||H===void 0||H.setSinkId(V)),yield Promise.all(Array.from(j.remoteParticipants.values()).map(re=>re.setAudioOutput({deviceId:V})))}catch(re){throw j.options.audioOutput.deviceId=te,re}}return(ie||q==="audiooutput")&&(j.localParticipant.activeDeviceMap.set(q,q==="audiooutput"&&((Y=j.options.audioOutput)===null||Y===void 0?void 0:Y.deviceId)||V),j.emit(RoomEvent.ActiveDeviceChanged,q,V)),Z}()})}setupLocalParticipantEvents(){this.localParticipant.on(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).on(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).on(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).on(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).on(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).on(ParticipantEvent.AudioStreamAcquired,this.startAudio).on(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).on(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var F;(F=this.engine)===null||F===void 0||F.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(F,U,q){if(this.state===ConnectionState.Connecting||this.state===ConnectionState.Reconnecting){const Q=()=>{this.onTrackAdded(F,U,q),z()},z=()=>{this.off(RoomEvent.Reconnected,Q),this.off(RoomEvent.Connected,Q),this.off(RoomEvent.Disconnected,z)};this.once(RoomEvent.Reconnected,Q),this.once(RoomEvent.Connected,Q),this.once(RoomEvent.Disconnected,z);return}if(this.state===ConnectionState.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(F.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const V=unpackStreamId(U.id),j=V[0];let $=V[1],W=F.id;if($&&$.startsWith("TR")&&(W=$),j===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const K=Array.from(this.remoteParticipants.values()).find(Q=>Q.sid===j);if(!K){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(j),this.logContext);return}let G;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?G=this.options.adaptiveStream:G={}),K.addSubscribedMediaTrack(F,W,U,q,G)}handleDisconnect(){let F=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,U=arguments.length>1?arguments[1]:void 0;var q;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.state!==ConnectionState.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(V=>{V.trackPublications.forEach(j=>{V.unpublishTrack(j.trackSid)})}),this.localParticipant.trackPublications.forEach(V=>{var j,$,W;V.track&&this.localParticipant.unpublishTrack(V.track,F),F?((j=V.track)===null||j===void 0||j.detach(),($=V.track)===null||$===void 0||$.stop()):(W=V.track)===null||W===void 0||W.stopMonitor()}),this.localParticipant.off(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).off(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).off(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).off(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).off(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).off(ParticipantEvent.AudioStreamAcquired,this.startAudio).off(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).off(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),isWeb()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(q=navigator.mediaDevices)===null||q===void 0||q.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(ConnectionState.Disconnected),this.emit(RoomEvent.Disconnected,U)}}}handleParticipantDisconnected(F,U){var q;this.remoteParticipants.delete(F),U&&(U.trackPublications.forEach(V=>{U.unpublishTrack(V.trackSid,!0)}),this.emit(RoomEvent.ParticipantDisconnected,U),U.setDisconnected(),(q=this.localParticipant)===null||q===void 0||q.handleParticipantDisconnected(U.identity))}handleStreamHeader(F,U){return __awaiter$1(this,void 0,void 0,function*(){var q;if(F.contentHeader.case==="byteHeader"){const V=this.byteStreamHandlers.get(F.topic);if(!V){this.log.debug("ignoring incoming byte stream due to no handler for topic",F.topic);return}let j;const $={id:F.streamId,name:(q=F.contentHeader.value.name)!==null&&q!==void 0?q:"unknown",mimeType:F.mimeType,size:F.totalLength?Number(F.totalLength):void 0,topic:F.topic,timestamp:bigIntToNumber(F.timestamp),attributes:F.attributes},W=new ReadableStream({start:K=>{j=K,this.byteStreamControllers.set(F.streamId,{info:$,controller:j,startTime:Date.now()})}});V(new ByteStreamReader($,W,bigIntToNumber(F.totalLength)),{identity:U})}else if(F.contentHeader.case==="textHeader"){const V=this.textStreamHandlers.get(F.topic);if(!V){this.log.debug("ignoring incoming text stream due to no handler for topic",F.topic);return}let j;const $={id:F.streamId,mimeType:F.mimeType,size:F.totalLength?Number(F.totalLength):void 0,topic:F.topic,timestamp:Number(F.timestamp),attributes:F.attributes},W=new ReadableStream({start:K=>{j=K,this.textStreamControllers.set(F.streamId,{info:$,controller:j,startTime:Date.now()})}});V(new TextStreamReader($,W,bigIntToNumber(F.totalLength)),{identity:U})}})}handleStreamChunk(F){const U=this.byteStreamControllers.get(F.streamId);U&&F.content.length>0&&U.controller.enqueue(F);const q=this.textStreamControllers.get(F.streamId);q&&F.content.length>0&&q.controller.enqueue(F)}handleStreamTrailer(F){const U=this.textStreamControllers.get(F.streamId);U&&(U.info.attributes=Object.assign(Object.assign({},U.info.attributes),F.attributes),U.controller.close(),this.textStreamControllers.delete(F.streamId));const q=this.byteStreamControllers.get(F.streamId);q&&(q.info.attributes=Object.assign(Object.assign({},q.info.attributes),F.attributes),q.controller.close(),this.byteStreamControllers.delete(F.streamId))}selectDefaultDevices(){return __awaiter$1(this,void 0,void 0,function*(){var F,U,q;const V=DeviceManager.getInstance().previousDevices,j=yield DeviceManager.getInstance().getDevices(void 0,!1),$=getBrowser();if(($==null?void 0:$.name)==="Chrome"&&$.os!=="iOS")for(let K of j){const G=V.find(Q=>Q.deviceId===K.deviceId);G&&G.label!==""&&G.kind===K.kind&&G.label!==K.label&&this.getActiveDevice(K.kind)==="default"&&this.emit(RoomEvent.ActiveDeviceChanged,K.kind,K.deviceId)}const W=["audiooutput","audioinput","videoinput"];for(let K of W){const G=kindToSource(K),Q=this.localParticipant.getTrackPublication(G);if(Q&&(!((F=Q.track)===null||F===void 0)&&F.isUserProvided))continue;const z=j.filter(Y=>Y.kind===K),H=this.getActiveDevice(K);if(H===((U=V.filter(Y=>Y.kind===K)[0])===null||U===void 0?void 0:U.deviceId)&&z.length>0&&((q=z[0])===null||q===void 0?void 0:q.deviceId)!==H){yield this.switchActiveDevice(K,z[0].deviceId);continue}K==="audioinput"&&!isSafariBased()||K==="videoinput"||z.length>0&&!z.find(Y=>Y.deviceId===this.getActiveDevice(K))&&(K!=="audiooutput"||!isSafariBased())&&(yield this.switchActiveDevice(K,z[0].deviceId))}})}acquireAudioContext(){return __awaiter$1(this,void 0,void 0,function*(){var F,U;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(F=getNewAudioContext())!==null&&F!==void 0?F:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(V=>V.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),sleep$1(200)])}catch(V){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:V}))}const q=((U=this.audioContext)===null||U===void 0?void 0:U.state)==="running";q!==this.canPlaybackAudio&&(this.audioEnabled=q,this.emit(RoomEvent.AudioPlaybackStatusChanged,q))})}createParticipant(F,U){var q;let V;return U?V=RemoteParticipant.fromParticipantInfo(this.engine.client,U,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):V=new RemoteParticipant(this.engine.client,"",F,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&V.setAudioContext(this.audioContext),!((q=this.options.audioOutput)===null||q===void 0)&&q.deviceId&&V.setAudioOutput(this.options.audioOutput).catch(j=>this.log.warn("Could not set audio output: ".concat(j.message),this.logContext)),V}getOrCreateParticipant(F,U){if(this.remoteParticipants.has(F)){const V=this.remoteParticipants.get(F);return U&&V.updateInfo(U)&&this.sidToIdentity.set(U.sid,U.identity),V}const q=this.createParticipant(F,U);return this.remoteParticipants.set(F,q),this.sidToIdentity.set(U.sid,U.identity),this.emitWhenConnected(RoomEvent.ParticipantConnected,q),q.on(ParticipantEvent.TrackPublished,V=>{this.emitWhenConnected(RoomEvent.TrackPublished,V,q)}).on(ParticipantEvent.TrackSubscribed,(V,j)=>{V.kind===Track.Kind.Audio?(V.on(TrackEvent.AudioPlaybackStarted,this.handleAudioPlaybackStarted),V.on(TrackEvent.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):V.kind===Track.Kind.Video&&(V.on(TrackEvent.VideoPlaybackFailed,this.handleVideoPlaybackFailed),V.on(TrackEvent.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(RoomEvent.TrackSubscribed,V,j,q)}).on(ParticipantEvent.TrackUnpublished,V=>{this.emit(RoomEvent.TrackUnpublished,V,q)}).on(ParticipantEvent.TrackUnsubscribed,(V,j)=>{this.emit(RoomEvent.TrackUnsubscribed,V,j,q)}).on(ParticipantEvent.TrackMuted,V=>{this.emitWhenConnected(RoomEvent.TrackMuted,V,q)}).on(ParticipantEvent.TrackUnmuted,V=>{this.emitWhenConnected(RoomEvent.TrackUnmuted,V,q)}).on(ParticipantEvent.ParticipantMetadataChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantMetadataChanged,V,q)}).on(ParticipantEvent.ParticipantNameChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantNameChanged,V,q)}).on(ParticipantEvent.AttributesChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantAttributesChanged,V,q)}).on(ParticipantEvent.ConnectionQualityChanged,V=>{this.emitWhenConnected(RoomEvent.ConnectionQualityChanged,V,q)}).on(ParticipantEvent.ParticipantPermissionsChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantPermissionsChanged,V,q)}).on(ParticipantEvent.TrackSubscriptionStatusChanged,(V,j)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionStatusChanged,V,j,q)}).on(ParticipantEvent.TrackSubscriptionFailed,(V,j)=>{this.emit(RoomEvent.TrackSubscriptionFailed,V,q,j)}).on(ParticipantEvent.TrackSubscriptionPermissionChanged,(V,j)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionPermissionChanged,V,j,q)}).on(ParticipantEvent.Active,()=>{this.emitWhenConnected(RoomEvent.ParticipantActive,q),q.kind===ParticipantInfo_Kind.AGENT&&this.localParticipant.setActiveAgent(q)}),U&&q.updateInfo(U),q}sendSyncState(){const F=Array.from(this.remoteParticipants.values()).reduce((q,V)=>(q.push(...V.getTrackPublications()),q),[]),U=this.localParticipant.getTrackPublications();this.engine.sendSyncState(F,U)}updateSubscriptions(){for(const F of this.remoteParticipants.values())for(const U of F.videoTrackPublications.values())U.isSubscribed&&isRemotePub(U)&&U.emitTrackUpdate()}getRemoteParticipantBySid(F){const U=this.sidToIdentity.get(F);if(U)return this.remoteParticipants.get(U)}registerConnectionReconcile(){this.clearConnectionReconcile();let F=0;this.connectionReconcileInterval=CriticalTimers.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(F++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:F,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),F>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,DisconnectReason.STATE_MISMATCH))):F=0},connectionReconcileFrequency)}clearConnectionReconcile(){this.connectionReconcileInterval&&CriticalTimers.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(F){return F===this.state?!1:(this.state=F,this.emit(RoomEvent.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(F=>{let[U,q]=F;this.emit(U,...q)}),this.bufferedEvents=[]}emitWhenConnected(F){for(var U=arguments.length,q=new Array(U>1?U-1:0),V=1;V<U;V++)q[V-1]=arguments[V];if(this.state===ConnectionState.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([F,q]);else if(this.state===ConnectionState.Connected)return this.emit(F,...q);return!1}simulateParticipants(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q;const V=Object.assign({audio:!0,video:!0,useRealTracks:!1},F.publish),j=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},F.participants);if(this.handleDisconnect(),this.roomInfo=new Room$1({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:protoInt64.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ParticipantInfo({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected),this.emit(RoomEvent.Connected),this.setAndEmitConnectionState(ConnectionState.Connected),V.video){const $=new LocalTrackPublication(Track.Kind.Video,new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO,name:"video-dummy"}),new LocalVideoTrack(V.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:createDummyVideoStreamTrack(160*((U=j.aspectRatios[0])!==null&&U!==void 0?U:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication($),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,$)}if(V.audio){const $=new LocalTrackPublication(Track.Kind.Audio,new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO}),new LocalAudioTrack(V.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:getEmptyAudioStreamTrack(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication($),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,$)}for(let $=0;$<j.count-1;$+=1){let W=new ParticipantInfo({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat($),state:ParticipantInfo_State.ACTIVE,tracks:[],joinedAt:protoInt64.parse(Date.now())});const K=this.getOrCreateParticipant(W.identity,W);if(j.video){const G=createDummyVideoStreamTrack(160*((q=j.aspectRatios[$%j.aspectRatios.length])!==null&&q!==void 0?q:1),160,!1,!0),Q=new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});K.addSubscribedMediaTrack(G,Q.sid,new MediaStream([G]),new RTCRtpReceiver),W.tracks=[...W.tracks,Q]}if(j.audio){const G=getEmptyAudioStreamTrack(),Q=new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});K.addSubscribedMediaTrack(G,Q.sid,new MediaStream([G]),new RTCRtpReceiver),W.tracks=[...W.tracks,Q]}K.updateInfo(W)}})}emit(F){for(var U=arguments.length,q=new Array(U>1?U-1:0),V=1;V<U;V++)q[V-1]=arguments[V];if(F!==RoomEvent.ActiveSpeakersChanged&&F!==RoomEvent.TranscriptionReceived){const j=mapArgs(q).filter($=>$!==void 0);this.log.debug("room event ".concat(F),Object.assign(Object.assign({},this.logContext),{event:F,args:j}))}return super.emit(F,...q)}}Room.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(B=>{B()});function mapArgs(B){return B.map(F=>{if(F)return Array.isArray(F)?mapArgs(F):typeof F=="object"?"logContext"in F?F.logContext:void 0:F})}var CheckStatus;(function(B){B[B.IDLE=0]="IDLE",B[B.RUNNING=1]="RUNNING",B[B.SKIPPED=2]="SKIPPED",B[B.SUCCESS=3]="SUCCESS",B[B.FAILED=4]="FAILED"})(CheckStatus||(CheckStatus={}));class Checker extends eventsExports.EventEmitter{constructor(F,U){let q=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=CheckStatus.IDLE,this.logs=[],this.options={},this.url=F,this.token=U,this.name=this.constructor.name,this.room=new Room(q.roomOptions),this.connectOptions=q.connectOptions,this.options=q}run(F){return __awaiter$1(this,void 0,void 0,function*(){if(this.status!==CheckStatus.IDLE)throw Error("check is running already");this.setStatus(CheckStatus.RUNNING);try{yield this.perform()}catch(U){U instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(U.message):this.appendError(U.message))}return yield this.disconnect(),yield new Promise(U=>setTimeout(U,500)),this.status!==CheckStatus.SKIPPED&&this.setStatus(this.isSuccess()?CheckStatus.SUCCESS:CheckStatus.FAILED),F&&F(),this.getInfo()})}isSuccess(){return!this.logs.some(F=>F.level==="error")}connect(F){return __awaiter$1(this,void 0,void 0,function*(){return this.room.state===ConnectionState.Connected?this.room:(F||(F=this.url),yield this.room.connect(F,this.token,this.connectOptions),this.room)})}disconnect(){return __awaiter$1(this,void 0,void 0,function*(){this.room&&this.room.state!==ConnectionState.Disconnected&&(yield this.room.disconnect(),yield new Promise(F=>setTimeout(F,500)))})}skip(){this.setStatus(CheckStatus.SKIPPED)}switchProtocol(F){return __awaiter$1(this,void 0,void 0,function*(){let U=!1,q=!1;if(this.room.on(RoomEvent.Reconnecting,()=>{U=!0}),this.room.once(RoomEvent.Reconnected,()=>{q=!0}),this.room.simulateScenario("force-".concat(F)),yield new Promise(j=>setTimeout(j,1e3)),!U)return;const V=Date.now()+1e4;for(;Date.now()<V;){if(q)return;yield sleep$1(100)}throw new Error("Could not reconnect using ".concat(F," protocol after 10 seconds"))})}appendMessage(F){this.logs.push({level:"info",message:F}),this.emit("update",this.getInfo())}appendWarning(F){this.logs.push({level:"warning",message:F}),this.emit("update",this.getInfo())}appendError(F){this.logs.push({level:"error",message:F}),this.emit("update",this.getInfo())}setStatus(F){this.status=F,this.emit("update",this.getInfo())}get engine(){var F;return(F=this.room)===null||F===void 0?void 0:F.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class CloudRegionCheck extends Checker{get description(){return"Cloud regions"}perform(){return __awaiter$1(this,void 0,void 0,function*(){const F=new RegionUrlProvider(this.url,this.token);if(!F.isCloud()){this.skip();return}const U=[],q=new Set;for(let j=0;j<3;j++){const $=yield F.getNextBestRegionUrl();if(!$)break;if(q.has($))continue;q.add($);const W=yield this.checkCloudRegion($);this.appendMessage("".concat(W.region," RTT: ").concat(W.rtt,"ms, duration: ").concat(W.duration,"ms")),U.push(W)}U.sort((j,$)=>(j.duration-$.duration)*.5+(j.rtt-$.rtt)*.5);const V=U[0];this.bestStats=V,this.appendMessage("best Cloud region: ".concat(V.region))})}getInfo(){const F=super.getInfo();return F.data=this.bestStats,F}checkCloudRegion(F){return __awaiter$1(this,void 0,void 0,function*(){var U,q;yield this.connect(F),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const V=(U=this.room.serverInfo)===null||U===void 0?void 0:U.region;if(!V)throw new Error("Region not found");const j=yield this.room.localParticipant.streamText({topic:"test"}),$=1e3,K=1e6/$,G="A".repeat($),Q=Date.now();for(let X=0;X<K;X++)yield j.write(G);yield j.close();const z=Date.now(),H=yield(q=this.room.engine.pcManager)===null||q===void 0?void 0:q.publisher.getStats(),Y={region:V,rtt:1e4,duration:z-Q};return H==null||H.forEach(X=>{X.type==="candidate-pair"&&X.nominated&&(Y.rtt=X.currentRoundTripTime*1e3)}),yield this.disconnect(),Y})}}const TEST_DURATION=1e4;class ConnectionProtocolCheck extends Checker{get description(){return"Connection via UDP vs TCP"}perform(){return __awaiter$1(this,void 0,void 0,function*(){const F=yield this.checkConnectionProtocol("udp"),U=yield this.checkConnectionProtocol("tcp");this.bestStats=F,F.qualityLimitationDurations.bandwidth-U.qualityLimitationDurations.bandwidth>.5||(F.packetsLost-U.packetsLost)/F.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=U):this.appendMessage("best connection quality via udp");const q=this.bestStats;this.appendMessage("upstream bitrate: ".concat((q.bitrateTotal/q.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((q.rttTotal/q.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((q.jitterTotal/q.count*1e3).toFixed(2)," ms")),q.packetsLost>0&&this.appendWarning("packets lost: ".concat((q.packetsLost/q.packetsSent*100).toFixed(2),"%")),q.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((q.qualityLimitationDurations.bandwidth/(TEST_DURATION/1e3)*100).toFixed(2),"%")),q.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((q.qualityLimitationDurations.cpu/(TEST_DURATION/1e3)*100).toFixed(2),"%"))})}getInfo(){const F=super.getInfo();return F.data=this.bestStats,F}checkConnectionProtocol(F){return __awaiter$1(this,void 0,void 0,function*(){yield this.connect(),F==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const U=document.createElement("canvas");U.width=1280,U.height=720;const q=U.getContext("2d");if(!q)throw new Error("Could not get canvas context");let V=0;const j=()=>{V=(V+1)%360,q.fillStyle="hsl(".concat(V,", 100%, 50%)"),q.fillRect(0,0,U.width,U.height),requestAnimationFrame(j)};j();const W=U.captureStream(30).getVideoTracks()[0],G=(yield this.room.localParticipant.publishTrack(W,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,Q={protocol:F,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},z=setInterval(()=>__awaiter$1(this,void 0,void 0,function*(){const H=yield G.getRTCStatsReport();H==null||H.forEach(Y=>{Y.type==="outbound-rtp"?(Q.packetsSent=Y.packetsSent,Q.qualityLimitationDurations=Y.qualityLimitationDurations,Q.bitrateTotal+=Y.targetBitrate,Q.count++):Y.type==="remote-inbound-rtp"&&(Q.packetsLost=Y.packetsLost,Q.rttTotal+=Y.roundTripTime,Q.jitterTotal+=Y.jitter)})}),1e3);return yield new Promise(H=>setTimeout(H,TEST_DURATION)),clearInterval(z),W.stop(),U.remove(),yield this.disconnect(),Q})}}class PublishAudioCheck extends Checker{get description(){return"Can publish audio"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var F;const U=yield this.connect(),q=yield createLocalAudioTrack();if(yield detectSilence(q,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),U.localParticipant.publishTrack(q),yield new Promise(W=>setTimeout(W,3e3));const j=yield(F=q.sender)===null||F===void 0?void 0:F.getStats();if(!j)throw new Error("Could not get RTCStats");let $=0;if(j.forEach(W=>{W.type==="outbound-rtp"&&(W.kind==="audio"||!W.kind&&W.mediaType==="audio")&&($=W.packetsSent)}),$===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat($," audio packets"))})}}class PublishVideoCheck extends Checker{get description(){return"Can publish video"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var F;const U=yield this.connect(),q=yield createLocalVideoTrack();yield this.checkForVideo(q.mediaStreamTrack),U.localParticipant.publishTrack(q),yield new Promise($=>setTimeout($,5e3));const V=yield(F=q.sender)===null||F===void 0?void 0:F.getStats();if(!V)throw new Error("Could not get RTCStats");let j=0;if(V.forEach($=>{$.type==="outbound-rtp"&&($.kind==="video"||!$.kind&&$.mediaType==="video")&&(j+=$.packetsSent)}),j===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(j," video packets"))})}checkForVideo(F){return __awaiter$1(this,void 0,void 0,function*(){const U=new MediaStream;U.addTrack(F.clone());const q=document.createElement("video");q.srcObject=U,q.muted=!0,yield new Promise(V=>{q.onplay=()=>{setTimeout(()=>{var j,$,W,K;const G=document.createElement("canvas"),Q=F.getSettings(),z=($=(j=Q.width)!==null&&j!==void 0?j:q.videoWidth)!==null&&$!==void 0?$:1280,H=(K=(W=Q.height)!==null&&W!==void 0?W:q.videoHeight)!==null&&K!==void 0?K:720;G.width=z,G.height=H;const Y=G.getContext("2d");Y.drawImage(q,0,0);const Z=Y.getImageData(0,0,G.width,G.height).data;let ie=!0;for(let ee=0;ee<Z.length;ee+=4)if(Z[ee]!==0||Z[ee+1]!==0||Z[ee+2]!==0){ie=!1;break}ie?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),V()},1e3)},q.play()}),q.remove()})}}class ReconnectCheck extends Checker{get description(){return"Resuming connection after interruption"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var F;const U=yield this.connect();let q=!1,V=!1,j;const $=new Promise(G=>{setTimeout(G,5e3),j=G}),W=()=>{q=!0};U.on(RoomEvent.SignalReconnecting,W).on(RoomEvent.Reconnecting,W).on(RoomEvent.Reconnected,()=>{V=!0,j(!0)}),(F=U.engine.client.ws)===null||F===void 0||F.close();const K=U.engine.client.onClose;if(K&&K(""),yield $,q){if(!V||U.state!==ConnectionState.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class TURNCheck extends Checker{get description(){return"Can connect via TURN"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var F,U;const q=new SignalClient,V=yield q.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let j=!1,$=!1,W=!1;for(let K of V.iceServers)for(let G of K.urls)G.startsWith("turn:")?($=!0,W=!0):G.startsWith("turns:")&&($=!0,W=!0,j=!0),G.startsWith("stun:")&&(W=!0);W?$&&!j&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield q.close(),!((U=(F=this.connectOptions)===null||F===void 0?void 0:F.rtcConfig)===null||U===void 0)&&U.iceServers||$?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(K=>setTimeout(K,0)))})}}class WebRTCCheck extends Checker{get description(){return"Establishing WebRTC connection"}perform(){return __awaiter$1(this,void 0,void 0,function*(){let F=!1,U=!1;this.room.on(RoomEvent.SignalConnected,()=>{const q=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(V,j)=>{if(V.candidate){const $=new RTCIceCandidate(V);let W="".concat($.protocol," ").concat($.address,":").concat($.port," ").concat($.type);$.address&&(isIPPrivate($.address)?W+=" (private)":$.protocol==="tcp"&&$.tcpType==="passive"?(F=!0,W+=" (passive)"):$.protocol==="udp"&&(U=!0)),this.appendMessage(W)}q&&q(V,j)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=V=>{V instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(V.errorCode," ").concat(V.errorText," ").concat(V.url))})});try{yield this.connect(),livekitLogger.info("now the room is connected")}catch(q){throw this.appendWarning("ports need to be open on firewall in order to connect."),q}F||this.appendWarning("Server is not configured for ICE/TCP"),U||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function isIPPrivate(B){const F=B.split(".");if(F.length===4){if(F[0]==="10")return!0;if(F[0]==="192"&&F[1]==="168")return!0;if(F[0]==="172"){const U=parseInt(F[1],10);if(U>=16&&U<=31)return!0}}return!1}class WebSocketCheck extends Checker{get description(){return"Connecting to signal connection via WebSocket"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var F,U,q;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let V=new SignalClient;const j=yield V.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(j.serverVersion,".")),((F=j.serverInfo)===null||F===void 0?void 0:F.edition)===ServerInfo_Edition.Cloud&&(!((U=j.serverInfo)===null||U===void 0)&&U.region)&&this.appendMessage("LiveKit Cloud: ".concat((q=j.serverInfo)===null||q===void 0?void 0:q.region)),yield V.close()})}}class ConnectionCheck extends eventsExports.EventEmitter{constructor(F,U){let q=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=F,this.token=U,this.options=q}getNextCheckId(){const F=this.checkResults.size;return this.checkResults.set(F,{logs:[],status:CheckStatus.IDLE,name:"",description:""}),F}updateCheck(F,U){this.checkResults.set(F,U),this.emit("checkUpdate",F,U)}isSuccess(){return Array.from(this.checkResults.values()).every(F=>F.status!==CheckStatus.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(F){return __awaiter$1(this,void 0,void 0,function*(){const U=this.getNextCheckId(),q=new F(this.url,this.token,this.options),V=$=>{this.updateCheck(U,$)};q.on("update",V);const j=yield q.run();return q.off("update",V),j})}checkWebsocket(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(WebSocketCheck)})}checkWebRTC(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(WebRTCCheck)})}checkTURN(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(TURNCheck)})}checkReconnect(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(ReconnectCheck)})}checkPublishAudio(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishAudioCheck)})}checkPublishVideo(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishVideoCheck)})}checkConnectionProtocol(){return __awaiter$1(this,void 0,void 0,function*(){const F=yield this.createAndRunCheck(ConnectionProtocolCheck);if(F.data&&"protocol"in F.data){const U=F.data;this.options.protocol=U.protocol}return F})}checkCloudRegion(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(CloudRegionCheck)})}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(B){return B&&B.__esModule&&Object.prototype.hasOwnProperty.call(B,"default")?B.default:B}var src={exports:{}},indexLight={exports:{}},indexMinimal={},minimal={},aspromise,hasRequiredAspromise;function requireAspromise(){if(hasRequiredAspromise)return aspromise;hasRequiredAspromise=1,aspromise=B;function B(F,U){for(var q=new Array(arguments.length-1),V=0,j=2,$=!0;j<arguments.length;)q[V++]=arguments[j++];return new Promise(function(K,G){q[V]=function(z){if($)if($=!1,z)G(z);else{for(var H=new Array(arguments.length-1),Y=0;Y<H.length;)H[Y++]=arguments[Y];K.apply(null,H)}};try{F.apply(U||null,q)}catch(Q){$&&($=!1,G(Q))}})}return aspromise}var base64={},hasRequiredBase64;function requireBase64(){return hasRequiredBase64||(hasRequiredBase64=1,function(B){var F=B;F.length=function(W){var K=W.length;if(!K)return 0;for(var G=0;--K%4>1&&W.charAt(K)==="=";)++G;return Math.ceil(W.length*3)/4-G};for(var U=new Array(64),q=new Array(123),V=0;V<64;)q[U[V]=V<26?V+65:V<52?V+71:V<62?V-4:V-59|43]=V++;F.encode=function(W,K,G){for(var Q=null,z=[],H=0,Y=0,X;K<G;){var Z=W[K++];switch(Y){case 0:z[H++]=U[Z>>2],X=(Z&3)<<4,Y=1;break;case 1:z[H++]=U[X|Z>>4],X=(Z&15)<<2,Y=2;break;case 2:z[H++]=U[X|Z>>6],z[H++]=U[Z&63],Y=0;break}H>8191&&((Q||(Q=[])).push(String.fromCharCode.apply(String,z)),H=0)}return Y&&(z[H++]=U[X],z[H++]=61,Y===1&&(z[H++]=61)),Q?(H&&Q.push(String.fromCharCode.apply(String,z.slice(0,H))),Q.join("")):String.fromCharCode.apply(String,z.slice(0,H))};var j="invalid encoding";F.decode=function(W,K,G){for(var Q=G,z=0,H,Y=0;Y<W.length;){var X=W.charCodeAt(Y++);if(X===61&&z>1)break;if((X=q[X])===void 0)throw Error(j);switch(z){case 0:H=X,z=1;break;case 1:K[G++]=H<<2|(X&48)>>4,H=X,z=2;break;case 2:K[G++]=(H&15)<<4|(X&60)>>2,H=X,z=3;break;case 3:K[G++]=(H&3)<<6|X,z=0;break}}if(z===1)throw Error(j);return G-Q},F.test=function(W){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(W)}}(base64)),base64}var eventemitter,hasRequiredEventemitter;function requireEventemitter(){if(hasRequiredEventemitter)return eventemitter;hasRequiredEventemitter=1,eventemitter=B;function B(){this._listeners={}}return B.prototype.on=function(U,q,V){return(this._listeners[U]||(this._listeners[U]=[])).push({fn:q,ctx:V||this}),this},B.prototype.off=function(U,q){if(U===void 0)this._listeners={};else if(q===void 0)this._listeners[U]=[];else for(var V=this._listeners[U],j=0;j<V.length;)V[j].fn===q?V.splice(j,1):++j;return this},B.prototype.emit=function(U){var q=this._listeners[U];if(q){for(var V=[],j=1;j<arguments.length;)V.push(arguments[j++]);for(j=0;j<q.length;)q[j].fn.apply(q[j++].ctx,V)}return this},eventemitter}var float,hasRequiredFloat;function requireFloat(){if(hasRequiredFloat)return float;hasRequiredFloat=1,float=B(B);function B(j){return typeof Float32Array<"u"?function(){var $=new Float32Array([-0]),W=new Uint8Array($.buffer),K=W[3]===128;function G(Y,X,Z){$[0]=Y,X[Z]=W[0],X[Z+1]=W[1],X[Z+2]=W[2],X[Z+3]=W[3]}function Q(Y,X,Z){$[0]=Y,X[Z]=W[3],X[Z+1]=W[2],X[Z+2]=W[1],X[Z+3]=W[0]}j.writeFloatLE=K?G:Q,j.writeFloatBE=K?Q:G;function z(Y,X){return W[0]=Y[X],W[1]=Y[X+1],W[2]=Y[X+2],W[3]=Y[X+3],$[0]}function H(Y,X){return W[3]=Y[X],W[2]=Y[X+1],W[1]=Y[X+2],W[0]=Y[X+3],$[0]}j.readFloatLE=K?z:H,j.readFloatBE=K?H:z}():function(){function $(K,G,Q,z){var H=G<0?1:0;if(H&&(G=-G),G===0)K(1/G>0?0:2147483648,Q,z);else if(isNaN(G))K(2143289344,Q,z);else if(G>34028234663852886e22)K((H<<31|2139095040)>>>0,Q,z);else if(G<11754943508222875e-54)K((H<<31|Math.round(G/1401298464324817e-60))>>>0,Q,z);else{var Y=Math.floor(Math.log(G)/Math.LN2),X=Math.round(G*Math.pow(2,-Y)*8388608)&8388607;K((H<<31|Y+127<<23|X)>>>0,Q,z)}}j.writeFloatLE=$.bind(null,F),j.writeFloatBE=$.bind(null,U);function W(K,G,Q){var z=K(G,Q),H=(z>>31)*2+1,Y=z>>>23&255,X=z&8388607;return Y===255?X?NaN:H*(1/0):Y===0?H*1401298464324817e-60*X:H*Math.pow(2,Y-150)*(X+8388608)}j.readFloatLE=W.bind(null,q),j.readFloatBE=W.bind(null,V)}(),typeof Float64Array<"u"?function(){var $=new Float64Array([-0]),W=new Uint8Array($.buffer),K=W[7]===128;function G(Y,X,Z){$[0]=Y,X[Z]=W[0],X[Z+1]=W[1],X[Z+2]=W[2],X[Z+3]=W[3],X[Z+4]=W[4],X[Z+5]=W[5],X[Z+6]=W[6],X[Z+7]=W[7]}function Q(Y,X,Z){$[0]=Y,X[Z]=W[7],X[Z+1]=W[6],X[Z+2]=W[5],X[Z+3]=W[4],X[Z+4]=W[3],X[Z+5]=W[2],X[Z+6]=W[1],X[Z+7]=W[0]}j.writeDoubleLE=K?G:Q,j.writeDoubleBE=K?Q:G;function z(Y,X){return W[0]=Y[X],W[1]=Y[X+1],W[2]=Y[X+2],W[3]=Y[X+3],W[4]=Y[X+4],W[5]=Y[X+5],W[6]=Y[X+6],W[7]=Y[X+7],$[0]}function H(Y,X){return W[7]=Y[X],W[6]=Y[X+1],W[5]=Y[X+2],W[4]=Y[X+3],W[3]=Y[X+4],W[2]=Y[X+5],W[1]=Y[X+6],W[0]=Y[X+7],$[0]}j.readDoubleLE=K?z:H,j.readDoubleBE=K?H:z}():function(){function $(K,G,Q,z,H,Y){var X=z<0?1:0;if(X&&(z=-z),z===0)K(0,H,Y+G),K(1/z>0?0:2147483648,H,Y+Q);else if(isNaN(z))K(0,H,Y+G),K(2146959360,H,Y+Q);else if(z>17976931348623157e292)K(0,H,Y+G),K((X<<31|2146435072)>>>0,H,Y+Q);else{var Z;if(z<22250738585072014e-324)Z=z/5e-324,K(Z>>>0,H,Y+G),K((X<<31|Z/4294967296)>>>0,H,Y+Q);else{var ie=Math.floor(Math.log(z)/Math.LN2);ie===1024&&(ie=1023),Z=z*Math.pow(2,-ie),K(Z*4503599627370496>>>0,H,Y+G),K((X<<31|ie+1023<<20|Z*1048576&1048575)>>>0,H,Y+Q)}}}j.writeDoubleLE=$.bind(null,F,0,4),j.writeDoubleBE=$.bind(null,U,4,0);function W(K,G,Q,z,H){var Y=K(z,H+G),X=K(z,H+Q),Z=(X>>31)*2+1,ie=X>>>20&2047,ee=4294967296*(X&1048575)+Y;return ie===2047?ee?NaN:Z*(1/0):ie===0?Z*5e-324*ee:Z*Math.pow(2,ie-1075)*(ee+4503599627370496)}j.readDoubleLE=W.bind(null,q,0,4),j.readDoubleBE=W.bind(null,V,4,0)}(),j}function F(j,$,W){$[W]=j&255,$[W+1]=j>>>8&255,$[W+2]=j>>>16&255,$[W+3]=j>>>24}function U(j,$,W){$[W]=j>>>24,$[W+1]=j>>>16&255,$[W+2]=j>>>8&255,$[W+3]=j&255}function q(j,$){return(j[$]|j[$+1]<<8|j[$+2]<<16|j[$+3]<<24)>>>0}function V(j,$){return(j[$]<<24|j[$+1]<<16|j[$+2]<<8|j[$+3])>>>0}return float}var inquire_1,hasRequiredInquire;function requireInquire(){if(hasRequiredInquire)return inquire_1;hasRequiredInquire=1,inquire_1=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(B){}return null}return inquire_1}var utf8={},hasRequiredUtf8;function requireUtf8(){return hasRequiredUtf8||(hasRequiredUtf8=1,function(B){var F=B;F.length=function(q){for(var V=0,j=0,$=0;$<q.length;++$)j=q.charCodeAt($),j<128?V+=1:j<2048?V+=2:(j&64512)===55296&&(q.charCodeAt($+1)&64512)===56320?(++$,V+=4):V+=3;return V},F.read=function(q,V,j){var $=j-V;if($<1)return"";for(var W=null,K=[],G=0,Q;V<j;)Q=q[V++],Q<128?K[G++]=Q:Q>191&&Q<224?K[G++]=(Q&31)<<6|q[V++]&63:Q>239&&Q<365?(Q=((Q&7)<<18|(q[V++]&63)<<12|(q[V++]&63)<<6|q[V++]&63)-65536,K[G++]=55296+(Q>>10),K[G++]=56320+(Q&1023)):K[G++]=(Q&15)<<12|(q[V++]&63)<<6|q[V++]&63,G>8191&&((W||(W=[])).push(String.fromCharCode.apply(String,K)),G=0);return W?(G&&W.push(String.fromCharCode.apply(String,K.slice(0,G))),W.join("")):String.fromCharCode.apply(String,K.slice(0,G))},F.write=function(q,V,j){for(var $=j,W,K,G=0;G<q.length;++G)W=q.charCodeAt(G),W<128?V[j++]=W:W<2048?(V[j++]=W>>6|192,V[j++]=W&63|128):(W&64512)===55296&&((K=q.charCodeAt(G+1))&64512)===56320?(W=65536+((W&1023)<<10)+(K&1023),++G,V[j++]=W>>18|240,V[j++]=W>>12&63|128,V[j++]=W>>6&63|128,V[j++]=W&63|128):(V[j++]=W>>12|224,V[j++]=W>>6&63|128,V[j++]=W&63|128);return j-$}}(utf8)),utf8}var pool_1,hasRequiredPool;function requirePool(){if(hasRequiredPool)return pool_1;hasRequiredPool=1,pool_1=B;function B(F,U,q){var V=q||8192,j=V>>>1,$=null,W=V;return function(G){if(G<1||G>j)return F(G);W+G>V&&($=F(V),W=0);var Q=U.call($,W,W+=G);return W&7&&(W=(W|7)+1),Q}}return pool_1}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=F;var B=requireMinimal();function F(j,$){this.lo=j>>>0,this.hi=$>>>0}var U=F.zero=new F(0,0);U.toNumber=function(){return 0},U.zzEncode=U.zzDecode=function(){return this},U.length=function(){return 1};var q=F.zeroHash="\0\0\0\0\0\0\0\0";F.fromNumber=function($){if($===0)return U;var W=$<0;W&&($=-$);var K=$>>>0,G=($-K)/4294967296>>>0;return W&&(G=~G>>>0,K=~K>>>0,++K>4294967295&&(K=0,++G>4294967295&&(G=0))),new F(K,G)},F.from=function($){if(typeof $=="number")return F.fromNumber($);if(B.isString($))if(B.Long)$=B.Long.fromString($);else return F.fromNumber(parseInt($,10));return $.low||$.high?new F($.low>>>0,$.high>>>0):U},F.prototype.toNumber=function($){if(!$&&this.hi>>>31){var W=~this.lo+1>>>0,K=~this.hi>>>0;return W||(K=K+1>>>0),-(W+K*4294967296)}return this.lo+this.hi*4294967296},F.prototype.toLong=function($){return B.Long?new B.Long(this.lo|0,this.hi|0,!!$):{low:this.lo|0,high:this.hi|0,unsigned:!!$}};var V=String.prototype.charCodeAt;return F.fromHash=function($){return $===q?U:new F((V.call($,0)|V.call($,1)<<8|V.call($,2)<<16|V.call($,3)<<24)>>>0,(V.call($,4)|V.call($,5)<<8|V.call($,6)<<16|V.call($,7)<<24)>>>0)},F.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},F.prototype.zzEncode=function(){var $=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^$)>>>0,this.lo=(this.lo<<1^$)>>>0,this},F.prototype.zzDecode=function(){var $=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^$)>>>0,this.hi=(this.hi>>>1^$)>>>0,this},F.prototype.length=function(){var $=this.lo,W=(this.lo>>>28|this.hi<<4)>>>0,K=this.hi>>>24;return K===0?W===0?$<16384?$<128?1:2:$<2097152?3:4:W<16384?W<128?5:6:W<2097152?7:8:K<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,function(B){var F=B;F.asPromise=requireAspromise(),F.base64=requireBase64(),F.EventEmitter=requireEventemitter(),F.float=requireFloat(),F.inquire=requireInquire(),F.utf8=requireUtf8(),F.pool=requirePool(),F.LongBits=requireLongbits(),F.isNode=!!(typeof commonjsGlobal<"u"&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),F.global=F.isNode&&commonjsGlobal||typeof window<"u"&&window||typeof self<"u"&&self||minimal,F.emptyArray=Object.freeze?Object.freeze([]):[],F.emptyObject=Object.freeze?Object.freeze({}):{},F.isInteger=Number.isInteger||function(j){return typeof j=="number"&&isFinite(j)&&Math.floor(j)===j},F.isString=function(j){return typeof j=="string"||j instanceof String},F.isObject=function(j){return j&&typeof j=="object"},F.isset=F.isSet=function(j,$){var W=j[$];return W!=null&&j.hasOwnProperty($)?typeof W!="object"||(Array.isArray(W)?W.length:Object.keys(W).length)>0:!1},F.Buffer=function(){try{var V=F.inquire("buffer").Buffer;return V.prototype.utf8Write?V:null}catch{return null}}(),F._Buffer_from=null,F._Buffer_allocUnsafe=null,F.newBuffer=function(j){return typeof j=="number"?F.Buffer?F._Buffer_allocUnsafe(j):new F.Array(j):F.Buffer?F._Buffer_from(j):typeof Uint8Array>"u"?j:new Uint8Array(j)},F.Array=typeof Uint8Array<"u"?Uint8Array:Array,F.Long=F.global.dcodeIO&&F.global.dcodeIO.Long||F.global.Long||F.inquire("long"),F.key2Re=/^true|false|0|1$/,F.key32Re=/^-?(?:0|[1-9][0-9]*)$/,F.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,F.longToHash=function(j){return j?F.LongBits.from(j).toHash():F.LongBits.zeroHash},F.longFromHash=function(j,$){var W=F.LongBits.fromHash(j);return F.Long?F.Long.fromBits(W.lo,W.hi,$):W.toNumber(!!$)};function U(V,j,$){for(var W=Object.keys(j),K=0;K<W.length;++K)(V[W[K]]===void 0||!$)&&(V[W[K]]=j[W[K]]);return V}F.merge=U,F.lcFirst=function(j){return j.charAt(0).toLowerCase()+j.substring(1)};function q(V){function j($,W){if(!(this instanceof j))return new j($,W);Object.defineProperty(this,"message",{get:function(){return $}}),Error.captureStackTrace?Error.captureStackTrace(this,j):Object.defineProperty(this,"stack",{value:new Error().stack||""}),W&&U(this,W)}return j.prototype=Object.create(Error.prototype,{constructor:{value:j,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return V},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),j}F.newError=q,F.ProtocolError=q("ProtocolError"),F.oneOfGetter=function(j){for(var $={},W=0;W<j.length;++W)$[j[W]]=1;return function(){for(var K=Object.keys(this),G=K.length-1;G>-1;--G)if($[K[G]]===1&&this[K[G]]!==void 0&&this[K[G]]!==null)return K[G]}},F.oneOfSetter=function(j){return function($){for(var W=0;W<j.length;++W)j[W]!==$&&delete this[j[W]]}},F.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},F._configure=function(){var V=F.Buffer;if(!V){F._Buffer_from=F._Buffer_allocUnsafe=null;return}F._Buffer_from=V.from!==Uint8Array.from&&V.from||function($,W){return new V($,W)},F._Buffer_allocUnsafe=V.allocUnsafe||function($){return new V($)}}}(minimal)),minimal}var writer,hasRequiredWriter;function requireWriter(){if(hasRequiredWriter)return writer;hasRequiredWriter=1,writer=K;var B=requireMinimal(),F,U=B.LongBits,q=B.base64,V=B.utf8;function j(ie,ee,te){this.fn=ie,this.len=ee,this.next=void 0,this.val=te}function $(){}function W(ie){this.head=ie.head,this.tail=ie.tail,this.len=ie.len,this.next=ie.states}function K(){this.len=0,this.head=new j($,0,0),this.tail=this.head,this.states=null}var G=function(){return B.Buffer?function(){return(K.create=function(){return new F})()}:function(){return new K}};K.create=G(),K.alloc=function(ee){return new B.Array(ee)},B.Array!==Array&&(K.alloc=B.pool(K.alloc,B.Array.prototype.subarray)),K.prototype._push=function(ee,te,re){return this.tail=this.tail.next=new j(ee,te,re),this.len+=te,this};function Q(ie,ee,te){ee[te]=ie&255}function z(ie,ee,te){for(;ie>127;)ee[te++]=ie&127|128,ie>>>=7;ee[te]=ie}function H(ie,ee){this.len=ie,this.next=void 0,this.val=ee}H.prototype=Object.create(j.prototype),H.prototype.fn=z,K.prototype.uint32=function(ee){return this.len+=(this.tail=this.tail.next=new H((ee=ee>>>0)<128?1:ee<16384?2:ee<2097152?3:ee<268435456?4:5,ee)).len,this},K.prototype.int32=function(ee){return ee<0?this._push(Y,10,U.fromNumber(ee)):this.uint32(ee)},K.prototype.sint32=function(ee){return this.uint32((ee<<1^ee>>31)>>>0)};function Y(ie,ee,te){for(;ie.hi;)ee[te++]=ie.lo&127|128,ie.lo=(ie.lo>>>7|ie.hi<<25)>>>0,ie.hi>>>=7;for(;ie.lo>127;)ee[te++]=ie.lo&127|128,ie.lo=ie.lo>>>7;ee[te++]=ie.lo}K.prototype.uint64=function(ee){var te=U.from(ee);return this._push(Y,te.length(),te)},K.prototype.int64=K.prototype.uint64,K.prototype.sint64=function(ee){var te=U.from(ee).zzEncode();return this._push(Y,te.length(),te)},K.prototype.bool=function(ee){return this._push(Q,1,ee?1:0)};function X(ie,ee,te){ee[te]=ie&255,ee[te+1]=ie>>>8&255,ee[te+2]=ie>>>16&255,ee[te+3]=ie>>>24}K.prototype.fixed32=function(ee){return this._push(X,4,ee>>>0)},K.prototype.sfixed32=K.prototype.fixed32,K.prototype.fixed64=function(ee){var te=U.from(ee);return this._push(X,4,te.lo)._push(X,4,te.hi)},K.prototype.sfixed64=K.prototype.fixed64,K.prototype.float=function(ee){return this._push(B.float.writeFloatLE,4,ee)},K.prototype.double=function(ee){return this._push(B.float.writeDoubleLE,8,ee)};var Z=B.Array.prototype.set?function(ee,te,re){te.set(ee,re)}:function(ee,te,re){for(var ne=0;ne<ee.length;++ne)te[re+ne]=ee[ne]};return K.prototype.bytes=function(ee){var te=ee.length>>>0;if(!te)return this._push(Q,1,0);if(B.isString(ee)){var re=K.alloc(te=q.length(ee));q.decode(ee,re,0),ee=re}return this.uint32(te)._push(Z,te,ee)},K.prototype.string=function(ee){var te=V.length(ee);return te?this.uint32(te)._push(V.write,te,ee):this._push(Q,1,0)},K.prototype.fork=function(){return this.states=new W(this),this.head=this.tail=new j($,0,0),this.len=0,this},K.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new j($,0,0),this.len=0),this},K.prototype.ldelim=function(){var ee=this.head,te=this.tail,re=this.len;return this.reset().uint32(re),re&&(this.tail.next=ee.next,this.tail=te,this.len+=re),this},K.prototype.finish=function(){for(var ee=this.head.next,te=this.constructor.alloc(this.len),re=0;ee;)ee.fn(ee.val,te,re),re+=ee.len,ee=ee.next;return te},K._configure=function(ie){F=ie,K.create=G(),F._configure()},writer}var writer_buffer,hasRequiredWriter_buffer;function requireWriter_buffer(){if(hasRequiredWriter_buffer)return writer_buffer;hasRequiredWriter_buffer=1,writer_buffer=U;var B=requireWriter();(U.prototype=Object.create(B.prototype)).constructor=U;var F=requireMinimal();function U(){B.call(this)}U._configure=function(){U.alloc=F._Buffer_allocUnsafe,U.writeBytesBuffer=F.Buffer&&F.Buffer.prototype instanceof Uint8Array&&F.Buffer.prototype.set.name==="set"?function(j,$,W){$.set(j,W)}:function(j,$,W){if(j.copy)j.copy($,W,0,j.length);else for(var K=0;K<j.length;)$[W++]=j[K++]}},U.prototype.bytes=function(j){F.isString(j)&&(j=F._Buffer_from(j,"base64"));var $=j.length>>>0;return this.uint32($),$&&this._push(U.writeBytesBuffer,$,j),this};function q(V,j,$){V.length<40?F.utf8.write(V,j,$):j.utf8Write?j.utf8Write(V,$):j.write(V,$)}return U.prototype.string=function(j){var $=F.Buffer.byteLength(j);return this.uint32($),$&&this._push(q,$,j),this},U._configure(),writer_buffer}var reader,hasRequiredReader;function requireReader(){if(hasRequiredReader)return reader;hasRequiredReader=1,reader=j;var B=requireMinimal(),F,U=B.LongBits,q=B.utf8;function V(z,H){return RangeError("index out of range: "+z.pos+" + "+(H||1)+" > "+z.len)}function j(z){this.buf=z,this.pos=0,this.len=z.length}var $=typeof Uint8Array<"u"?function(H){if(H instanceof Uint8Array||Array.isArray(H))return new j(H);throw Error("illegal buffer")}:function(H){if(Array.isArray(H))return new j(H);throw Error("illegal buffer")},W=function(){return B.Buffer?function(Y){return(j.create=function(Z){return B.Buffer.isBuffer(Z)?new F(Z):$(Z)})(Y)}:$};j.create=W(),j.prototype._slice=B.Array.prototype.subarray||B.Array.prototype.slice,j.prototype.uint32=function(){var H=4294967295;return function(){if(H=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(H=(H|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(H=(H|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(H=(H|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(H=(H|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return H;if((this.pos+=5)>this.len)throw this.pos=this.len,V(this,10);return H}}(),j.prototype.int32=function(){return this.uint32()|0},j.prototype.sint32=function(){var H=this.uint32();return H>>>1^-(H&1)|0};function K(){var z=new U(0,0),H=0;if(this.len-this.pos>4){for(;H<4;++H)if(z.lo=(z.lo|(this.buf[this.pos]&127)<<H*7)>>>0,this.buf[this.pos++]<128)return z;if(z.lo=(z.lo|(this.buf[this.pos]&127)<<28)>>>0,z.hi=(z.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return z;H=0}else{for(;H<3;++H){if(this.pos>=this.len)throw V(this);if(z.lo=(z.lo|(this.buf[this.pos]&127)<<H*7)>>>0,this.buf[this.pos++]<128)return z}return z.lo=(z.lo|(this.buf[this.pos++]&127)<<H*7)>>>0,z}if(this.len-this.pos>4){for(;H<5;++H)if(z.hi=(z.hi|(this.buf[this.pos]&127)<<H*7+3)>>>0,this.buf[this.pos++]<128)return z}else for(;H<5;++H){if(this.pos>=this.len)throw V(this);if(z.hi=(z.hi|(this.buf[this.pos]&127)<<H*7+3)>>>0,this.buf[this.pos++]<128)return z}throw Error("invalid varint encoding")}j.prototype.bool=function(){return this.uint32()!==0};function G(z,H){return(z[H-4]|z[H-3]<<8|z[H-2]<<16|z[H-1]<<24)>>>0}j.prototype.fixed32=function(){if(this.pos+4>this.len)throw V(this,4);return G(this.buf,this.pos+=4)},j.prototype.sfixed32=function(){if(this.pos+4>this.len)throw V(this,4);return G(this.buf,this.pos+=4)|0};function Q(){if(this.pos+8>this.len)throw V(this,8);return new U(G(this.buf,this.pos+=4),G(this.buf,this.pos+=4))}return j.prototype.float=function(){if(this.pos+4>this.len)throw V(this,4);var H=B.float.readFloatLE(this.buf,this.pos);return this.pos+=4,H},j.prototype.double=function(){if(this.pos+8>this.len)throw V(this,4);var H=B.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,H},j.prototype.bytes=function(){var H=this.uint32(),Y=this.pos,X=this.pos+H;if(X>this.len)throw V(this,H);if(this.pos+=H,Array.isArray(this.buf))return this.buf.slice(Y,X);if(Y===X){var Z=B.Buffer;return Z?Z.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,Y,X)},j.prototype.string=function(){var H=this.bytes();return q.read(H,0,H.length)},j.prototype.skip=function(H){if(typeof H=="number"){if(this.pos+H>this.len)throw V(this,H);this.pos+=H}else do if(this.pos>=this.len)throw V(this);while(this.buf[this.pos++]&128);return this},j.prototype.skipType=function(z){switch(z){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(z=this.uint32()&7)!==4;)this.skipType(z);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+z+" at offset "+this.pos)}return this},j._configure=function(z){F=z,j.create=W(),F._configure();var H=B.Long?"toLong":"toNumber";B.merge(j.prototype,{int64:function(){return K.call(this)[H](!1)},uint64:function(){return K.call(this)[H](!0)},sint64:function(){return K.call(this).zzDecode()[H](!1)},fixed64:function(){return Q.call(this)[H](!0)},sfixed64:function(){return Q.call(this)[H](!1)}})},reader}var reader_buffer,hasRequiredReader_buffer;function requireReader_buffer(){if(hasRequiredReader_buffer)return reader_buffer;hasRequiredReader_buffer=1,reader_buffer=U;var B=requireReader();(U.prototype=Object.create(B.prototype)).constructor=U;var F=requireMinimal();function U(q){B.call(this,q)}return U._configure=function(){F.Buffer&&(U.prototype._slice=F.Buffer.prototype.slice)},U.prototype.string=function(){var V=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+V,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+V,this.len))},U._configure(),reader_buffer}var rpc={},service$1,hasRequiredService$1;function requireService$1(){if(hasRequiredService$1)return service$1;hasRequiredService$1=1,service$1=F;var B=requireMinimal();(F.prototype=Object.create(B.EventEmitter.prototype)).constructor=F;function F(U,q,V){if(typeof U!="function")throw TypeError("rpcImpl must be a function");B.EventEmitter.call(this),this.rpcImpl=U,this.requestDelimited=!!q,this.responseDelimited=!!V}return F.prototype.rpcCall=function U(q,V,j,$,W){if(!$)throw TypeError("request must be specified");var K=this;if(!W)return B.asPromise(U,K,q,V,j,$);if(!K.rpcImpl){setTimeout(function(){W(Error("already ended"))},0);return}try{return K.rpcImpl(q,V[K.requestDelimited?"encodeDelimited":"encode"]($).finish(),function(Q,z){if(Q)return K.emit("error",Q,q),W(Q);if(z===null){K.end(!0);return}if(!(z instanceof j))try{z=j[K.responseDelimited?"decodeDelimited":"decode"](z)}catch(H){return K.emit("error",H,q),W(H)}return K.emit("data",z,q),W(null,z)})}catch(G){K.emit("error",G,q),setTimeout(function(){W(G)},0);return}},F.prototype.end=function(q){return this.rpcImpl&&(q||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},service$1}var hasRequiredRpc;function requireRpc(){return hasRequiredRpc||(hasRequiredRpc=1,function(B){var F=B;F.Service=requireService$1()}(rpc)),rpc}var roots,hasRequiredRoots;function requireRoots(){return hasRequiredRoots||(hasRequiredRoots=1,roots={}),roots}var hasRequiredIndexMinimal;function requireIndexMinimal(){return hasRequiredIndexMinimal||(hasRequiredIndexMinimal=1,function(B){var F=B;F.build="minimal",F.Writer=requireWriter(),F.BufferWriter=requireWriter_buffer(),F.Reader=requireReader(),F.BufferReader=requireReader_buffer(),F.util=requireMinimal(),F.rpc=requireRpc(),F.roots=requireRoots(),F.configure=U;function U(){F.util._configure(),F.Writer._configure(F.BufferWriter),F.Reader._configure(F.BufferReader)}U()}(indexMinimal)),indexMinimal}var types={},util={exports:{}},codegen_1,hasRequiredCodegen;function requireCodegen(){if(hasRequiredCodegen)return codegen_1;hasRequiredCodegen=1,codegen_1=B;function B(F,U){typeof F=="string"&&(U=F,F=void 0);var q=[];function V($){if(typeof $!="string"){var W=j();if(B.verbose&&console.log("codegen: "+W),W="return "+W,$){for(var K=Object.keys($),G=new Array(K.length+1),Q=new Array(K.length),z=0;z<K.length;)G[z]=K[z],Q[z]=$[K[z++]];return G[z]=W,Function.apply(null,G).apply(null,Q)}return Function(W)()}for(var H=new Array(arguments.length-1),Y=0;Y<H.length;)H[Y]=arguments[++Y];if(Y=0,$=$.replace(/%([%dfijs])/g,function(Z,ie){var ee=H[Y++];switch(ie){case"d":case"f":return String(Number(ee));case"i":return String(Math.floor(ee));case"j":return JSON.stringify(ee);case"s":return String(ee)}return"%"}),Y!==H.length)throw Error("parameter count mismatch");return q.push($),V}function j($){return"function "+($||U||"")+"("+(F&&F.join(",")||"")+`){
  `+q.join(`
  `)+`
}`}return V.toString=j,V}return B.verbose=!1,codegen_1}var fetch_1,hasRequiredFetch;function requireFetch(){if(hasRequiredFetch)return fetch_1;hasRequiredFetch=1,fetch_1=q;var B=requireAspromise(),F=requireInquire(),U=F("fs");function q(V,j,$){return typeof j=="function"?($=j,j={}):j||(j={}),$?!j.xhr&&U&&U.readFile?U.readFile(V,function(K,G){return K&&typeof XMLHttpRequest<"u"?q.xhr(V,j,$):K?$(K):$(null,j.binary?G:G.toString("utf8"))}):q.xhr(V,j,$):B(q,this,V,j)}return q.xhr=function(j,$,W){var K=new XMLHttpRequest;K.onreadystatechange=function(){if(K.readyState===4){if(K.status!==0&&K.status!==200)return W(Error("status "+K.status));if($.binary){var Q=K.response;if(!Q){Q=[];for(var z=0;z<K.responseText.length;++z)Q.push(K.responseText.charCodeAt(z)&255)}return W(null,typeof Uint8Array<"u"?new Uint8Array(Q):Q)}return W(null,K.responseText)}},$.binary&&("overrideMimeType"in K&&K.overrideMimeType("text/plain; charset=x-user-defined"),K.responseType="arraybuffer"),K.open("GET",j),K.send()},fetch_1}var path={},hasRequiredPath;function requirePath(){return hasRequiredPath||(hasRequiredPath=1,function(B){var F=B,U=F.isAbsolute=function(j){return/^(?:\/|\w+:)/.test(j)},q=F.normalize=function(j){j=j.replace(/\\/g,"/").replace(/\/{2,}/g,"/");var $=j.split("/"),W=U(j),K="";W&&(K=$.shift()+"/");for(var G=0;G<$.length;)$[G]===".."?G>0&&$[G-1]!==".."?$.splice(--G,2):W?$.splice(G,1):++G:$[G]==="."?$.splice(G,1):++G;return K+$.join("/")};F.resolve=function(j,$,W){return W||($=q($)),U($)?$:(W||(j=q(j)),(j=j.replace(/(?:\/|^)[^/]+$/,"")).length?q(j+"/"+$):$)}}(path)),path}var namespace,hasRequiredNamespace;function requireNamespace(){if(hasRequiredNamespace)return namespace;hasRequiredNamespace=1,namespace=K;var B=requireObject();((K.prototype=Object.create(B.prototype)).constructor=K).className="Namespace";var F=requireField(),U=requireUtil(),q=requireOneof(),V,j,$;K.fromJSON=function(z,H){return new K(z,H.options).addJSON(H.nested)};function W(Q,z){if(Q&&Q.length){for(var H={},Y=0;Y<Q.length;++Y)H[Q[Y].name]=Q[Y].toJSON(z);return H}}K.arrayToJSON=W,K.isReservedId=function(z,H){if(z){for(var Y=0;Y<z.length;++Y)if(typeof z[Y]!="string"&&z[Y][0]<=H&&z[Y][1]>H)return!0}return!1},K.isReservedName=function(z,H){if(z){for(var Y=0;Y<z.length;++Y)if(z[Y]===H)return!0}return!1};function K(Q,z){B.call(this,Q,z),this.nested=void 0,this._nestedArray=null,this._lookupCache={},this._needsRecursiveFeatureResolution=!0,this._needsRecursiveResolve=!0}function G(Q){Q._nestedArray=null,Q._lookupCache={};for(var z=Q;z=z.parent;)z._lookupCache={};return Q}return Object.defineProperty(K.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=U.toArray(this.nested))}}),K.prototype.toJSON=function(z){return U.toObject(["options",this.options,"nested",W(this.nestedArray,z)])},K.prototype.addJSON=function(z){var H=this;if(z)for(var Y=Object.keys(z),X=0,Z;X<Y.length;++X)Z=z[Y[X]],H.add((Z.fields!==void 0?V.fromJSON:Z.values!==void 0?$.fromJSON:Z.methods!==void 0?j.fromJSON:Z.id!==void 0?F.fromJSON:K.fromJSON)(Y[X],Z));return this},K.prototype.get=function(z){return this.nested&&this.nested[z]||null},K.prototype.getEnum=function(z){if(this.nested&&this.nested[z]instanceof $)return this.nested[z].values;throw Error("no such enum: "+z)},K.prototype.add=function(z){if(!(z instanceof F&&z.extend!==void 0||z instanceof V||z instanceof q||z instanceof $||z instanceof j||z instanceof K))throw TypeError("object must be a valid nested object");if(!this.nested)this.nested={};else{var H=this.get(z.name);if(H)if(H instanceof K&&z instanceof K&&!(H instanceof V||H instanceof j)){for(var Y=H.nestedArray,X=0;X<Y.length;++X)z.add(Y[X]);this.remove(H),this.nested||(this.nested={}),z.setOptions(H.options,!0)}else throw Error("duplicate name '"+z.name+"' in "+this)}this.nested[z.name]=z,this instanceof V||this instanceof j||this instanceof $||this instanceof F||z._edition||(z._edition=z._defaultEdition),this._needsRecursiveFeatureResolution=!0,this._needsRecursiveResolve=!0;for(var Z=this;Z=Z.parent;)Z._needsRecursiveFeatureResolution=!0,Z._needsRecursiveResolve=!0;return z.onAdd(this),G(this)},K.prototype.remove=function(z){if(!(z instanceof B))throw TypeError("object must be a ReflectionObject");if(z.parent!==this)throw Error(z+" is not a member of "+this);return delete this.nested[z.name],Object.keys(this.nested).length||(this.nested=void 0),z.onRemove(this),G(this)},K.prototype.define=function(z,H){if(U.isString(z))z=z.split(".");else if(!Array.isArray(z))throw TypeError("illegal path");if(z&&z.length&&z[0]==="")throw Error("path must be relative");for(var Y=this;z.length>0;){var X=z.shift();if(Y.nested&&Y.nested[X]){if(Y=Y.nested[X],!(Y instanceof K))throw Error("path conflicts with non-namespace objects")}else Y.add(Y=new K(X))}return H&&Y.addJSON(H),Y},K.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;this._resolveFeaturesRecursive(this._edition);var z=this.nestedArray,H=0;for(this.resolve();H<z.length;)z[H]instanceof K?z[H++].resolveAll():z[H++].resolve();return this._needsRecursiveResolve=!1,this},K.prototype._resolveFeaturesRecursive=function(z){return this._needsRecursiveFeatureResolution?(this._needsRecursiveFeatureResolution=!1,z=this._edition||z,B.prototype._resolveFeaturesRecursive.call(this,z),this.nestedArray.forEach(H=>{H._resolveFeaturesRecursive(z)}),this):this},K.prototype.lookup=function(z,H,Y){if(typeof H=="boolean"?(Y=H,H=void 0):H&&!Array.isArray(H)&&(H=[H]),U.isString(z)&&z.length){if(z===".")return this.root;z=z.split(".")}else if(!z.length)return this;var X=z.join(".");if(z[0]==="")return this.root.lookup(z.slice(1),H);var Z=this.root._fullyQualifiedObjects&&this.root._fullyQualifiedObjects["."+X];if(Z&&(!H||H.indexOf(Z.constructor)>-1)||(Z=this._lookupImpl(z,X),Z&&(!H||H.indexOf(Z.constructor)>-1)))return Z;if(Y)return null;for(var ie=this;ie.parent;){if(Z=ie.parent._lookupImpl(z,X),Z&&(!H||H.indexOf(Z.constructor)>-1))return Z;ie=ie.parent}return null},K.prototype._lookupImpl=function(z,H){if(Object.prototype.hasOwnProperty.call(this._lookupCache,H))return this._lookupCache[H];var Y=this.get(z[0]),X=null;if(Y)z.length===1?X=Y:Y instanceof K&&(z=z.slice(1),X=Y._lookupImpl(z,z.join(".")));else for(var Z=0;Z<this.nestedArray.length;++Z)this._nestedArray[Z]instanceof K&&(Y=this._nestedArray[Z]._lookupImpl(z,H))&&(X=Y);return this._lookupCache[H]=X,X},K.prototype.lookupType=function(z){var H=this.lookup(z,[V]);if(!H)throw Error("no such type: "+z);return H},K.prototype.lookupEnum=function(z){var H=this.lookup(z,[$]);if(!H)throw Error("no such Enum '"+z+"' in "+this);return H},K.prototype.lookupTypeOrEnum=function(z){var H=this.lookup(z,[V,$]);if(!H)throw Error("no such Type or Enum '"+z+"' in "+this);return H},K.prototype.lookupService=function(z){var H=this.lookup(z,[j]);if(!H)throw Error("no such Service '"+z+"' in "+this);return H},K._configure=function(Q,z,H){V=Q,j=z,$=H},namespace}var mapfield,hasRequiredMapfield;function requireMapfield(){if(hasRequiredMapfield)return mapfield;hasRequiredMapfield=1,mapfield=q;var B=requireField();((q.prototype=Object.create(B.prototype)).constructor=q).className="MapField";var F=requireTypes(),U=requireUtil();function q(V,j,$,W,K,G){if(B.call(this,V,j,W,void 0,void 0,K,G),!U.isString($))throw TypeError("keyType must be a string");this.keyType=$,this.resolvedKeyType=null,this.map=!0}return q.fromJSON=function(j,$){return new q(j,$.id,$.keyType,$.type,$.options,$.comment)},q.prototype.toJSON=function(j){var $=j?!!j.keepComments:!1;return U.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",$?this.comment:void 0])},q.prototype.resolve=function(){if(this.resolved)return this;if(F.mapKey[this.keyType]===void 0)throw Error("invalid key type: "+this.keyType);return B.prototype.resolve.call(this)},q.d=function(j,$,W){return typeof W=="function"?W=U.decorateType(W).name:W&&typeof W=="object"&&(W=U.decorateEnum(W).name),function(G,Q){U.decorateType(G.constructor).add(new q(Q,j,$,W))}},mapfield}var method,hasRequiredMethod;function requireMethod(){if(hasRequiredMethod)return method;hasRequiredMethod=1,method=U;var B=requireObject();((U.prototype=Object.create(B.prototype)).constructor=U).className="Method";var F=requireUtil();function U(q,V,j,$,W,K,G,Q,z){if(F.isObject(W)?(G=W,W=K=void 0):F.isObject(K)&&(G=K,K=void 0),!(V===void 0||F.isString(V)))throw TypeError("type must be a string");if(!F.isString(j))throw TypeError("requestType must be a string");if(!F.isString($))throw TypeError("responseType must be a string");B.call(this,q,G),this.type=V||"rpc",this.requestType=j,this.requestStream=W?!0:void 0,this.responseType=$,this.responseStream=K?!0:void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=Q,this.parsedOptions=z}return U.fromJSON=function(V,j){return new U(V,j.type,j.requestType,j.responseType,j.requestStream,j.responseStream,j.options,j.comment,j.parsedOptions)},U.prototype.toJSON=function(V){var j=V?!!V.keepComments:!1;return F.toObject(["type",this.type!=="rpc"&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",j?this.comment:void 0,"parsedOptions",this.parsedOptions])},U.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),B.prototype.resolve.call(this))},method}var service,hasRequiredService;function requireService(){if(hasRequiredService)return service;hasRequiredService=1,service=V;var B=requireNamespace();((V.prototype=Object.create(B.prototype)).constructor=V).className="Service";var F=requireMethod(),U=requireUtil(),q=requireRpc();function V($,W){B.call(this,$,W),this.methods={},this._methodsArray=null}V.fromJSON=function(W,K){var G=new V(W,K.options);if(K.methods)for(var Q=Object.keys(K.methods),z=0;z<Q.length;++z)G.add(F.fromJSON(Q[z],K.methods[Q[z]]));return K.nested&&G.addJSON(K.nested),K.edition&&(G._edition=K.edition),G.comment=K.comment,G._defaultEdition="proto3",G},V.prototype.toJSON=function(W){var K=B.prototype.toJSON.call(this,W),G=W?!!W.keepComments:!1;return U.toObject(["edition",this._editionToJSON(),"options",K&&K.options||void 0,"methods",B.arrayToJSON(this.methodsArray,W)||{},"nested",K&&K.nested||void 0,"comment",G?this.comment:void 0])},Object.defineProperty(V.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=U.toArray(this.methods))}});function j($){return $._methodsArray=null,$}return V.prototype.get=function(W){return this.methods[W]||B.prototype.get.call(this,W)},V.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;B.prototype.resolve.call(this);for(var W=this.methodsArray,K=0;K<W.length;++K)W[K].resolve();return this},V.prototype._resolveFeaturesRecursive=function(W){return this._needsRecursiveFeatureResolution?(W=this._edition||W,B.prototype._resolveFeaturesRecursive.call(this,W),this.methodsArray.forEach(K=>{K._resolveFeaturesRecursive(W)}),this):this},V.prototype.add=function(W){if(this.get(W.name))throw Error("duplicate name '"+W.name+"' in "+this);return W instanceof F?(this.methods[W.name]=W,W.parent=this,j(this)):B.prototype.add.call(this,W)},V.prototype.remove=function(W){if(W instanceof F){if(this.methods[W.name]!==W)throw Error(W+" is not a member of "+this);return delete this.methods[W.name],W.parent=null,j(this)}return B.prototype.remove.call(this,W)},V.prototype.create=function(W,K,G){for(var Q=new q.Service(W,K,G),z=0,H;z<this.methodsArray.length;++z){var Y=U.lcFirst((H=this._methodsArray[z]).resolve().name).replace(/[^$\w_]/g,"");Q[Y]=U.codegen(["r","c"],U.isReserved(Y)?Y+"_":Y)("return this.rpcCall(m,q,s,r,c)")({m:H,q:H.resolvedRequestType.ctor,s:H.resolvedResponseType.ctor})}return Q},service}var message,hasRequiredMessage;function requireMessage(){if(hasRequiredMessage)return message;hasRequiredMessage=1,message=F;var B=requireMinimal();function F(U){if(U)for(var q=Object.keys(U),V=0;V<q.length;++V)this[q[V]]=U[q[V]]}return F.create=function(q){return this.$type.create(q)},F.encode=function(q,V){return this.$type.encode(q,V)},F.encodeDelimited=function(q,V){return this.$type.encodeDelimited(q,V)},F.decode=function(q){return this.$type.decode(q)},F.decodeDelimited=function(q){return this.$type.decodeDelimited(q)},F.verify=function(q){return this.$type.verify(q)},F.fromObject=function(q){return this.$type.fromObject(q)},F.toObject=function(q,V){return this.$type.toObject(q,V)},F.prototype.toJSON=function(){return this.$type.toObject(this,B.toJSONOptions)},message}var decoder_1,hasRequiredDecoder;function requireDecoder(){if(hasRequiredDecoder)return decoder_1;hasRequiredDecoder=1,decoder_1=V;var B=require_enum(),F=requireTypes(),U=requireUtil();function q(j){return"missing required '"+j.name+"'"}function V(j){for(var $=U.codegen(["r","l","e"],j.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(j.fieldsArray.filter(function(H){return H.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()")("if(t===e)")("break")("switch(t>>>3){"),W=0;W<j.fieldsArray.length;++W){var K=j._fieldsArray[W].resolve(),G=K.resolvedType instanceof B?"int32":K.type,Q="m"+U.safeProp(K.name);$("case %i: {",K.id),K.map?($("if(%s===util.emptyObject)",Q)("%s={}",Q)("var c2 = r.uint32()+r.pos"),F.defaults[K.keyType]!==void 0?$("k=%j",F.defaults[K.keyType]):$("k=null"),F.defaults[G]!==void 0?$("value=%j",F.defaults[G]):$("value=null"),$("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",K.keyType)("case 2:"),F.basic[G]===void 0?$("value=types[%i].decode(r,r.uint32())",W):$("value=r.%s()",G),$("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),F.long[K.keyType]!==void 0?$('%s[typeof k==="object"?util.longToHash(k):k]=value',Q):$("%s[k]=value",Q)):K.repeated?($("if(!(%s&&%s.length))",Q,Q)("%s=[]",Q),F.packed[G]!==void 0&&$("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",Q,G)("}else"),F.basic[G]===void 0?$(K.delimited?"%s.push(types[%i].decode(r,undefined,((t&~7)|4)))":"%s.push(types[%i].decode(r,r.uint32()))",Q,W):$("%s.push(r.%s())",Q,G)):F.basic[G]===void 0?$(K.delimited?"%s=types[%i].decode(r,undefined,((t&~7)|4))":"%s=types[%i].decode(r,r.uint32())",Q,W):$("%s=r.%s()",Q,G),$("break")("}")}for($("default:")("r.skipType(t&7)")("break")("}")("}"),W=0;W<j._fieldsArray.length;++W){var z=j._fieldsArray[W];z.required&&$("if(!m.hasOwnProperty(%j))",z.name)("throw util.ProtocolError(%j,{instance:m})",q(z))}return $("return m")}return decoder_1}var verifier_1,hasRequiredVerifier;function requireVerifier(){if(hasRequiredVerifier)return verifier_1;hasRequiredVerifier=1,verifier_1=j;var B=require_enum(),F=requireUtil();function U($,W){return $.name+": "+W+($.repeated&&W!=="array"?"[]":$.map&&W!=="object"?"{k:"+$.keyType+"}":"")+" expected"}function q($,W,K,G){if(W.resolvedType)if(W.resolvedType instanceof B){$("switch(%s){",G)("default:")("return%j",U(W,"enum value"));for(var Q=Object.keys(W.resolvedType.values),z=0;z<Q.length;++z)$("case %i:",W.resolvedType.values[Q[z]]);$("break")("}")}else $("{")("var e=types[%i].verify(%s);",K,G)("if(e)")("return%j+e",W.name+".")("}");else switch(W.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":$("if(!util.isInteger(%s))",G)("return%j",U(W,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":$("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",G,G,G,G)("return%j",U(W,"integer|Long"));break;case"float":case"double":$('if(typeof %s!=="number")',G)("return%j",U(W,"number"));break;case"bool":$('if(typeof %s!=="boolean")',G)("return%j",U(W,"boolean"));break;case"string":$("if(!util.isString(%s))",G)("return%j",U(W,"string"));break;case"bytes":$('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',G,G,G)("return%j",U(W,"buffer"));break}return $}function V($,W,K){switch(W.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":$("if(!util.key32Re.test(%s))",K)("return%j",U(W,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":$("if(!util.key64Re.test(%s))",K)("return%j",U(W,"integer|Long key"));break;case"bool":$("if(!util.key2Re.test(%s))",K)("return%j",U(W,"boolean key"));break}return $}function j($){var W=F.codegen(["m"],$.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),K=$.oneofsArray,G={};K.length&&W("var p={}");for(var Q=0;Q<$.fieldsArray.length;++Q){var z=$._fieldsArray[Q].resolve(),H="m"+F.safeProp(z.name);if(z.optional&&W("if(%s!=null&&m.hasOwnProperty(%j)){",H,z.name),z.map)W("if(!util.isObject(%s))",H)("return%j",U(z,"object"))("var k=Object.keys(%s)",H)("for(var i=0;i<k.length;++i){"),V(W,z,"k[i]"),q(W,z,Q,H+"[k[i]]")("}");else if(z.repeated)W("if(!Array.isArray(%s))",H)("return%j",U(z,"array"))("for(var i=0;i<%s.length;++i){",H),q(W,z,Q,H+"[i]")("}");else{if(z.partOf){var Y=F.safeProp(z.partOf.name);G[z.partOf.name]===1&&W("if(p%s===1)",Y)("return%j",z.partOf.name+": multiple values"),G[z.partOf.name]=1,W("p%s=1",Y)}q(W,z,Q,H)}z.optional&&W("}")}return W("return null")}return verifier_1}var converter={},hasRequiredConverter;function requireConverter(){return hasRequiredConverter||(hasRequiredConverter=1,function(B){var F=B,U=require_enum(),q=requireUtil();function V($,W,K,G){var Q=!1;if(W.resolvedType)if(W.resolvedType instanceof U){$("switch(d%s){",G);for(var z=W.resolvedType.values,H=Object.keys(z),Y=0;Y<H.length;++Y)z[H[Y]]===W.typeDefault&&!Q&&($("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',G,G,G),W.repeated||$("break"),Q=!0),$("case%j:",H[Y])("case %i:",z[H[Y]])("m%s=%j",G,z[H[Y]])("break");$("}")}else $('if(typeof d%s!=="object")',G)("throw TypeError(%j)",W.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",G,K,G);else{var X=!1;switch(W.type){case"double":case"float":$("m%s=Number(d%s)",G,G);break;case"uint32":case"fixed32":$("m%s=d%s>>>0",G,G);break;case"int32":case"sint32":case"sfixed32":$("m%s=d%s|0",G,G);break;case"uint64":X=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":$("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",G,G,X)('else if(typeof d%s==="string")',G)("m%s=parseInt(d%s,10)",G,G)('else if(typeof d%s==="number")',G)("m%s=d%s",G,G)('else if(typeof d%s==="object")',G)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",G,G,G,X?"true":"");break;case"bytes":$('if(typeof d%s==="string")',G)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",G,G,G)("else if(d%s.length >= 0)",G)("m%s=d%s",G,G);break;case"string":$("m%s=String(d%s)",G,G);break;case"bool":$("m%s=Boolean(d%s)",G,G);break}}return $}F.fromObject=function(W){var K=W.fieldsArray,G=q.codegen(["d"],W.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!K.length)return G("return new this.ctor");G("var m=new this.ctor");for(var Q=0;Q<K.length;++Q){var z=K[Q].resolve(),H=q.safeProp(z.name);z.map?(G("if(d%s){",H)('if(typeof d%s!=="object")',H)("throw TypeError(%j)",z.fullName+": object expected")("m%s={}",H)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",H),V(G,z,Q,H+"[ks[i]]")("}")("}")):z.repeated?(G("if(d%s){",H)("if(!Array.isArray(d%s))",H)("throw TypeError(%j)",z.fullName+": array expected")("m%s=[]",H)("for(var i=0;i<d%s.length;++i){",H),V(G,z,Q,H+"[i]")("}")("}")):(z.resolvedType instanceof U||G("if(d%s!=null){",H),V(G,z,Q,H),z.resolvedType instanceof U||G("}"))}return G("return m")};function j($,W,K,G){if(W.resolvedType)W.resolvedType instanceof U?$("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",G,K,G,G,K,G,G):$("d%s=types[%i].toObject(m%s,o)",G,K,G);else{var Q=!1;switch(W.type){case"double":case"float":$("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",G,G,G,G);break;case"uint64":Q=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":$('if(typeof m%s==="number")',G)("d%s=o.longs===String?String(m%s):m%s",G,G,G)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",G,G,G,G,Q?"true":"",G);break;case"bytes":$("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",G,G,G,G,G);break;default:$("d%s=m%s",G,G);break}}return $}F.toObject=function(W){var K=W.fieldsArray.slice().sort(q.compareFieldsById);if(!K.length)return q.codegen()("return {}");for(var G=q.codegen(["m","o"],W.name+"$toObject")("if(!o)")("o={}")("var d={}"),Q=[],z=[],H=[],Y=0;Y<K.length;++Y)K[Y].partOf||(K[Y].resolve().repeated?Q:K[Y].map?z:H).push(K[Y]);if(Q.length){for(G("if(o.arrays||o.defaults){"),Y=0;Y<Q.length;++Y)G("d%s=[]",q.safeProp(Q[Y].name));G("}")}if(z.length){for(G("if(o.objects||o.defaults){"),Y=0;Y<z.length;++Y)G("d%s={}",q.safeProp(z[Y].name));G("}")}if(H.length){for(G("if(o.defaults){"),Y=0;Y<H.length;++Y){var X=H[Y],Z=q.safeProp(X.name);if(X.resolvedType instanceof U)G("d%s=o.enums===String?%j:%j",Z,X.resolvedType.valuesById[X.typeDefault],X.typeDefault);else if(X.long)G("if(util.Long){")("var n=new util.Long(%i,%i,%j)",X.typeDefault.low,X.typeDefault.high,X.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",Z)("}else")("d%s=o.longs===String?%j:%i",Z,X.typeDefault.toString(),X.typeDefault.toNumber());else if(X.bytes){var ie="["+Array.prototype.slice.call(X.typeDefault).join(",")+"]";G("if(o.bytes===String)d%s=%j",Z,String.fromCharCode.apply(String,X.typeDefault))("else{")("d%s=%s",Z,ie)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",Z,Z)("}")}else G("d%s=%j",Z,X.typeDefault)}G("}")}var ee=!1;for(Y=0;Y<K.length;++Y){var X=K[Y],te=W._fieldsArray.indexOf(X),Z=q.safeProp(X.name);X.map?(ee||(ee=!0,G("var ks2")),G("if(m%s&&(ks2=Object.keys(m%s)).length){",Z,Z)("d%s={}",Z)("for(var j=0;j<ks2.length;++j){"),j(G,X,te,Z+"[ks2[j]]")("}")):X.repeated?(G("if(m%s&&m%s.length){",Z,Z)("d%s=[]",Z)("for(var j=0;j<m%s.length;++j){",Z),j(G,X,te,Z+"[j]")("}")):(G("if(m%s!=null&&m.hasOwnProperty(%j)){",Z,X.name),j(G,X,te,Z),X.partOf&&G("if(o.oneofs)")("d%s=%j",q.safeProp(X.partOf.name),X.name)),G("}")}return G("return d")}}(converter)),converter}var wrappers={},hasRequiredWrappers;function requireWrappers(){return hasRequiredWrappers||(hasRequiredWrappers=1,function(B){var F=B,U=requireMessage();F[".google.protobuf.Any"]={fromObject:function(q){if(q&&q["@type"]){var V=q["@type"].substring(q["@type"].lastIndexOf("/")+1),j=this.lookup(V);if(j){var $=q["@type"].charAt(0)==="."?q["@type"].slice(1):q["@type"];return $.indexOf("/")===-1&&($="/"+$),this.create({type_url:$,value:j.encode(j.fromObject(q)).finish()})}}return this.fromObject(q)},toObject:function(q,V){var j="type.googleapis.com/",$="",W="";if(V&&V.json&&q.type_url&&q.value){W=q.type_url.substring(q.type_url.lastIndexOf("/")+1),$=q.type_url.substring(0,q.type_url.lastIndexOf("/")+1);var K=this.lookup(W);K&&(q=K.decode(q.value))}if(!(q instanceof this.ctor)&&q instanceof U){var G=q.$type.toObject(q,V),Q=q.$type.fullName[0]==="."?q.$type.fullName.slice(1):q.$type.fullName;return $===""&&($=j),W=$+Q,G["@type"]=W,G}return this.toObject(q,V)}}}(wrappers)),wrappers}var type,hasRequiredType;function requireType(){if(hasRequiredType)return type;hasRequiredType=1,type=Z;var B=requireNamespace();((Z.prototype=Object.create(B.prototype)).constructor=Z).className="Type";var F=require_enum(),U=requireOneof(),q=requireField(),V=requireMapfield(),j=requireService(),$=requireMessage(),W=requireReader(),K=requireWriter(),G=requireUtil(),Q=requireEncoder(),z=requireDecoder(),H=requireVerifier(),Y=requireConverter(),X=requireWrappers();function Z(ee,te){B.call(this,ee,te),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}Object.defineProperties(Z.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var ee=Object.keys(this.fields),te=0;te<ee.length;++te){var re=this.fields[ee[te]],ne=re.id;if(this._fieldsById[ne])throw Error("duplicate id "+ne+" in "+this);this._fieldsById[ne]=re}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=G.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=G.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=Z.generateConstructor(this)())},set:function(ee){var te=ee.prototype;te instanceof $||((ee.prototype=new $).constructor=ee,G.merge(ee.prototype,te)),ee.$type=ee.prototype.$type=this,G.merge(ee,$,!0),this._ctor=ee;for(var re=0;re<this.fieldsArray.length;++re)this._fieldsArray[re].resolve();var ne={};for(re=0;re<this.oneofsArray.length;++re)ne[this._oneofsArray[re].resolve().name]={get:G.oneOfGetter(this._oneofsArray[re].oneof),set:G.oneOfSetter(this._oneofsArray[re].oneof)};re&&Object.defineProperties(ee.prototype,ne)}}}),Z.generateConstructor=function(te){for(var re=G.codegen(["p"],te.name),ne=0,se;ne<te.fieldsArray.length;++ne)(se=te._fieldsArray[ne]).map?re("this%s={}",G.safeProp(se.name)):se.repeated&&re("this%s=[]",G.safeProp(se.name));return re("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")};function ie(ee){return ee._fieldsById=ee._fieldsArray=ee._oneofsArray=null,delete ee.encode,delete ee.decode,delete ee.verify,ee}return Z.fromJSON=function(te,re){var ne=new Z(te,re.options);ne.extensions=re.extensions,ne.reserved=re.reserved;for(var se=Object.keys(re.fields),oe=0;oe<se.length;++oe)ne.add((typeof re.fields[se[oe]].keyType<"u"?V.fromJSON:q.fromJSON)(se[oe],re.fields[se[oe]]));if(re.oneofs)for(se=Object.keys(re.oneofs),oe=0;oe<se.length;++oe)ne.add(U.fromJSON(se[oe],re.oneofs[se[oe]]));if(re.nested)for(se=Object.keys(re.nested),oe=0;oe<se.length;++oe){var fe=re.nested[se[oe]];ne.add((fe.id!==void 0?q.fromJSON:fe.fields!==void 0?Z.fromJSON:fe.values!==void 0?F.fromJSON:fe.methods!==void 0?j.fromJSON:B.fromJSON)(se[oe],fe))}return re.extensions&&re.extensions.length&&(ne.extensions=re.extensions),re.reserved&&re.reserved.length&&(ne.reserved=re.reserved),re.group&&(ne.group=!0),re.comment&&(ne.comment=re.comment),re.edition&&(ne._edition=re.edition),ne._defaultEdition="proto3",ne},Z.prototype.toJSON=function(te){var re=B.prototype.toJSON.call(this,te),ne=te?!!te.keepComments:!1;return G.toObject(["edition",this._editionToJSON(),"options",re&&re.options||void 0,"oneofs",B.arrayToJSON(this.oneofsArray,te),"fields",B.arrayToJSON(this.fieldsArray.filter(function(se){return!se.declaringField}),te)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",re&&re.nested||void 0,"comment",ne?this.comment:void 0])},Z.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;B.prototype.resolveAll.call(this);var te=this.oneofsArray;for(ne=0;ne<te.length;)te[ne++].resolve();for(var re=this.fieldsArray,ne=0;ne<re.length;)re[ne++].resolve();return this},Z.prototype._resolveFeaturesRecursive=function(te){return this._needsRecursiveFeatureResolution?(te=this._edition||te,B.prototype._resolveFeaturesRecursive.call(this,te),this.oneofsArray.forEach(re=>{re._resolveFeatures(te)}),this.fieldsArray.forEach(re=>{re._resolveFeatures(te)}),this):this},Z.prototype.get=function(te){return this.fields[te]||this.oneofs&&this.oneofs[te]||this.nested&&this.nested[te]||null},Z.prototype.add=function(te){if(this.get(te.name))throw Error("duplicate name '"+te.name+"' in "+this);if(te instanceof q&&te.extend===void 0){if(this._fieldsById?this._fieldsById[te.id]:this.fieldsById[te.id])throw Error("duplicate id "+te.id+" in "+this);if(this.isReservedId(te.id))throw Error("id "+te.id+" is reserved in "+this);if(this.isReservedName(te.name))throw Error("name '"+te.name+"' is reserved in "+this);return te.parent&&te.parent.remove(te),this.fields[te.name]=te,te.message=this,te.onAdd(this),ie(this)}return te instanceof U?(this.oneofs||(this.oneofs={}),this.oneofs[te.name]=te,te.onAdd(this),ie(this)):B.prototype.add.call(this,te)},Z.prototype.remove=function(te){if(te instanceof q&&te.extend===void 0){if(!this.fields||this.fields[te.name]!==te)throw Error(te+" is not a member of "+this);return delete this.fields[te.name],te.parent=null,te.onRemove(this),ie(this)}if(te instanceof U){if(!this.oneofs||this.oneofs[te.name]!==te)throw Error(te+" is not a member of "+this);return delete this.oneofs[te.name],te.parent=null,te.onRemove(this),ie(this)}return B.prototype.remove.call(this,te)},Z.prototype.isReservedId=function(te){return B.isReservedId(this.reserved,te)},Z.prototype.isReservedName=function(te){return B.isReservedName(this.reserved,te)},Z.prototype.create=function(te){return new this.ctor(te)},Z.prototype.setup=function(){for(var te=this.fullName,re=[],ne=0;ne<this.fieldsArray.length;++ne)re.push(this._fieldsArray[ne].resolve().resolvedType);this.encode=Q(this)({Writer:K,types:re,util:G}),this.decode=z(this)({Reader:W,types:re,util:G}),this.verify=H(this)({types:re,util:G}),this.fromObject=Y.fromObject(this)({types:re,util:G}),this.toObject=Y.toObject(this)({types:re,util:G});var se=X[te];if(se){var oe=Object.create(this);oe.fromObject=this.fromObject,this.fromObject=se.fromObject.bind(oe),oe.toObject=this.toObject,this.toObject=se.toObject.bind(oe)}return this},Z.prototype.encode=function(te,re){return this.setup().encode(te,re)},Z.prototype.encodeDelimited=function(te,re){return this.encode(te,re&&re.len?re.fork():re).ldelim()},Z.prototype.decode=function(te,re){return this.setup().decode(te,re)},Z.prototype.decodeDelimited=function(te){return te instanceof W||(te=W.create(te)),this.decode(te,te.uint32())},Z.prototype.verify=function(te){return this.setup().verify(te)},Z.prototype.fromObject=function(te){return this.setup().fromObject(te)},Z.prototype.toObject=function(te,re){return this.setup().toObject(te,re)},Z.d=function(te){return function(ne){G.decorateType(ne,te)}},type}var root,hasRequiredRoot;function requireRoot(){if(hasRequiredRoot)return root;hasRequiredRoot=1,root=K;var B=requireNamespace();((K.prototype=Object.create(B.prototype)).constructor=K).className="Root";var F=requireField(),U=require_enum(),q=requireOneof(),V=requireUtil(),j,$,W;function K(H){B.call(this,"",H),this.deferred=[],this.files=[],this._edition="proto2",this._fullyQualifiedObjects={}}K.fromJSON=function(Y,X){return X||(X=new K),Y.options&&X.setOptions(Y.options),X.addJSON(Y.nested).resolveAll()},K.prototype.resolvePath=V.path.resolve,K.prototype.fetch=V.fetch;function G(){}K.prototype.load=function H(Y,X,Z){typeof X=="function"&&(Z=X,X=void 0);var ie=this;if(!Z)return V.asPromise(H,ie,Y,X);var ee=Z===G;function te(le,he){if(Z){if(ee)throw le;he&&he.resolveAll();var ae=Z;Z=null,ae(le,he)}}function re(le){var he=le.lastIndexOf("google/protobuf/");if(he>-1){var ae=le.substring(he);if(ae in W)return ae}return null}function ne(le,he){try{if(V.isString(he)&&he.charAt(0)==="{"&&(he=JSON.parse(he)),!V.isString(he))ie.setOptions(he.options).addJSON(he.nested);else{$.filename=le;var ae=$(he,ie,X),ye,Ce=0;if(ae.imports)for(;Ce<ae.imports.length;++Ce)(ye=re(ae.imports[Ce])||ie.resolvePath(le,ae.imports[Ce]))&&se(ye);if(ae.weakImports)for(Ce=0;Ce<ae.weakImports.length;++Ce)(ye=re(ae.weakImports[Ce])||ie.resolvePath(le,ae.weakImports[Ce]))&&se(ye,!0)}}catch(me){te(me)}!ee&&!oe&&te(null,ie)}function se(le,he){if(le=re(le)||le,!(ie.files.indexOf(le)>-1)){if(ie.files.push(le),le in W){ee?ne(le,W[le]):(++oe,setTimeout(function(){--oe,ne(le,W[le])}));return}if(ee){var ae;try{ae=V.fs.readFileSync(le).toString("utf8")}catch(ye){he||te(ye);return}ne(le,ae)}else++oe,ie.fetch(le,function(ye,Ce){if(--oe,!!Z){if(ye){he?oe||te(null,ie):te(ye);return}ne(le,Ce)}})}}var oe=0;V.isString(Y)&&(Y=[Y]);for(var fe=0,pe;fe<Y.length;++fe)(pe=ie.resolvePath("",Y[fe]))&&se(pe);return ee?(ie.resolveAll(),ie):(oe||te(null,ie),ie)},K.prototype.loadSync=function(Y,X){if(!V.isNode)throw Error("not supported");return this.load(Y,X,G)},K.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(Y){return"'extend "+Y.extend+"' in "+Y.parent.fullName}).join(", "));return B.prototype.resolveAll.call(this)};var Q=/^[A-Z]/;function z(H,Y){var X=Y.parent.lookup(Y.extend);if(X){var Z=new F(Y.fullName,Y.id,Y.type,Y.rule,void 0,Y.options);return X.get(Z.name)||(Z.declaringField=Y,Y.extensionField=Z,X.add(Z)),!0}return!1}return K.prototype._handleAdd=function(Y){if(Y instanceof F)Y.extend!==void 0&&!Y.extensionField&&(z(this,Y)||this.deferred.push(Y));else if(Y instanceof U)Q.test(Y.name)&&(Y.parent[Y.name]=Y.values);else if(!(Y instanceof q)){if(Y instanceof j)for(var X=0;X<this.deferred.length;)z(this,this.deferred[X])?this.deferred.splice(X,1):++X;for(var Z=0;Z<Y.nestedArray.length;++Z)this._handleAdd(Y._nestedArray[Z]);Q.test(Y.name)&&(Y.parent[Y.name]=Y)}(Y instanceof j||Y instanceof U||Y instanceof F)&&(this._fullyQualifiedObjects[Y.fullName]=Y)},K.prototype._handleRemove=function(Y){if(Y instanceof F){if(Y.extend!==void 0)if(Y.extensionField)Y.extensionField.parent.remove(Y.extensionField),Y.extensionField=null;else{var X=this.deferred.indexOf(Y);X>-1&&this.deferred.splice(X,1)}}else if(Y instanceof U)Q.test(Y.name)&&delete Y.parent[Y.name];else if(Y instanceof B){for(var Z=0;Z<Y.nestedArray.length;++Z)this._handleRemove(Y._nestedArray[Z]);Q.test(Y.name)&&delete Y.parent[Y.name]}delete this._fullyQualifiedObjects[Y.fullName]},K._configure=function(H,Y,X){j=H,$=Y,W=X},root}var hasRequiredUtil;function requireUtil(){if(hasRequiredUtil)return util.exports;hasRequiredUtil=1;var B=util.exports=requireMinimal(),F=requireRoots(),U,q;B.codegen=requireCodegen(),B.fetch=requireFetch(),B.path=requirePath(),B.fs=B.inquire("fs"),B.toArray=function(G){if(G){for(var Q=Object.keys(G),z=new Array(Q.length),H=0;H<Q.length;)z[H]=G[Q[H++]];return z}return[]},B.toObject=function(G){for(var Q={},z=0;z<G.length;){var H=G[z++],Y=G[z++];Y!==void 0&&(Q[H]=Y)}return Q};var V=/\\/g,j=/"/g;B.isReserved=function(G){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(G)},B.safeProp=function(G){return!/^[$\w_]+$/.test(G)||B.isReserved(G)?'["'+G.replace(V,"\\\\").replace(j,'\\"')+'"]':"."+G},B.ucFirst=function(G){return G.charAt(0).toUpperCase()+G.substring(1)};var $=/_([a-z])/g;B.camelCase=function(G){return G.substring(0,1)+G.substring(1).replace($,function(Q,z){return z.toUpperCase()})},B.compareFieldsById=function(G,Q){return G.id-Q.id},B.decorateType=function(G,Q){if(G.$type)return Q&&G.$type.name!==Q&&(B.decorateRoot.remove(G.$type),G.$type.name=Q,B.decorateRoot.add(G.$type)),G.$type;U||(U=requireType());var z=new U(Q||G.name);return B.decorateRoot.add(z),z.ctor=G,Object.defineProperty(G,"$type",{value:z,enumerable:!1}),Object.defineProperty(G.prototype,"$type",{value:z,enumerable:!1}),z};var W=0;return B.decorateEnum=function(G){if(G.$type)return G.$type;q||(q=require_enum());var Q=new q("Enum"+W++,G);return B.decorateRoot.add(Q),Object.defineProperty(G,"$type",{value:Q,enumerable:!1}),Q},B.setProperty=function(G,Q,z,H){function Y(X,Z,ie){var ee=Z.shift();if(ee==="__proto__"||ee==="prototype")return X;if(Z.length>0)X[ee]=Y(X[ee]||{},Z,ie);else{var te=X[ee];if(te&&H)return X;te&&(ie=[].concat(te).concat(ie)),X[ee]=ie}return X}if(typeof G!="object")throw TypeError("dst must be an object");if(!Q)throw TypeError("path must be specified");return Q=Q.split("."),Y(G,Q,z)},Object.defineProperty(B,"decorateRoot",{get:function(){return F.decorated||(F.decorated=new(requireRoot()))}}),util.exports}var hasRequiredTypes;function requireTypes(){return hasRequiredTypes||(hasRequiredTypes=1,function(B){var F=B,U=requireUtil(),q=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function V(j,$){var W=0,K={};for($|=0;W<j.length;)K[q[W+$]]=j[W++];return K}F.basic=V([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),F.defaults=V([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",U.emptyArray,null]),F.long=V([0,0,0,1,1],7),F.mapKey=V([0,0,0,5,5,0,0,0,1,1,0,2],2),F.packed=V([1,5,0,0,0,5,5,0,0,0,1,1,0])}(types)),types}var field,hasRequiredField;function requireField(){if(hasRequiredField)return field;hasRequiredField=1,field=$;var B=requireObject();(($.prototype=Object.create(B.prototype)).constructor=$).className="Field";var F=require_enum(),U=requireTypes(),q=requireUtil(),V,j=/^required|optional|repeated$/;$.fromJSON=function(K,G){var Q=new $(K,G.id,G.type,G.rule,G.extend,G.options,G.comment);return G.edition&&(Q._edition=G.edition),Q._defaultEdition="proto3",Q};function $(W,K,G,Q,z,H,Y){if(q.isObject(Q)?(Y=z,H=Q,Q=z=void 0):q.isObject(z)&&(Y=H,H=z,z=void 0),B.call(this,W,H),!q.isInteger(K)||K<0)throw TypeError("id must be a non-negative integer");if(!q.isString(G))throw TypeError("type must be a string");if(Q!==void 0&&!j.test(Q=Q.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(z!==void 0&&!q.isString(z))throw TypeError("extend must be a string");Q==="proto3_optional"&&(Q="optional"),this.rule=Q&&Q!=="optional"?Q:void 0,this.type=G,this.id=K,this.extend=z||void 0,this.repeated=Q==="repeated",this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=q.Long?U.long[G]!==void 0:!1,this.bytes=G==="bytes",this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.comment=Y}return Object.defineProperty($.prototype,"required",{get:function(){return this._features.field_presence==="LEGACY_REQUIRED"}}),Object.defineProperty($.prototype,"optional",{get:function(){return!this.required}}),Object.defineProperty($.prototype,"delimited",{get:function(){return this.resolvedType instanceof V&&this._features.message_encoding==="DELIMITED"}}),Object.defineProperty($.prototype,"packed",{get:function(){return this._features.repeated_field_encoding==="PACKED"}}),Object.defineProperty($.prototype,"hasPresence",{get:function(){return this.repeated||this.map?!1:this.partOf||this.declaringField||this.extensionField||this._features.field_presence!=="IMPLICIT"}}),$.prototype.setOption=function(K,G,Q){return B.prototype.setOption.call(this,K,G,Q)},$.prototype.toJSON=function(K){var G=K?!!K.keepComments:!1;return q.toObject(["edition",this._editionToJSON(),"rule",this.rule!=="optional"&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",G?this.comment:void 0])},$.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=U.defaults[this.type])===void 0?(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof V?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&this.options.default!=null&&(this.typeDefault=this.options.default,this.resolvedType instanceof F&&typeof this.typeDefault=="string"&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(this.options.packed!==void 0&&this.resolvedType&&!(this.resolvedType instanceof F)&&delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=q.Long.fromNumber(this.typeDefault,this.type.charAt(0)==="u"),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&typeof this.typeDefault=="string"){var K;q.base64.test(this.typeDefault)?q.base64.decode(this.typeDefault,K=q.newBuffer(q.base64.length(this.typeDefault)),0):q.utf8.write(this.typeDefault,K=q.newBuffer(q.utf8.length(this.typeDefault)),0),this.typeDefault=K}return this.map?this.defaultValue=q.emptyObject:this.repeated?this.defaultValue=q.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof V&&(this.parent.ctor.prototype[this.name]=this.defaultValue),B.prototype.resolve.call(this)},$.prototype._inferLegacyProtoFeatures=function(K){if(K!=="proto2"&&K!=="proto3")return{};var G={};if(this.rule==="required"&&(G.field_presence="LEGACY_REQUIRED"),this.parent&&U.defaults[this.type]===void 0){var Q=this.parent.get(this.type.split(".").pop());Q&&Q instanceof V&&Q.group&&(G.message_encoding="DELIMITED")}return this.getOption("packed")===!0?G.repeated_field_encoding="PACKED":this.getOption("packed")===!1&&(G.repeated_field_encoding="EXPANDED"),G},$.prototype._resolveFeatures=function(K){return B.prototype._resolveFeatures.call(this,this._edition||K)},$.d=function(K,G,Q,z){return typeof G=="function"?G=q.decorateType(G).name:G&&typeof G=="object"&&(G=q.decorateEnum(G).name),function(Y,X){q.decorateType(Y.constructor).add(new $(X,K,G,Q,{default:z}))}},$._configure=function(K){V=K},field}var oneof,hasRequiredOneof;function requireOneof(){if(hasRequiredOneof)return oneof;hasRequiredOneof=1,oneof=q;var B=requireObject();((q.prototype=Object.create(B.prototype)).constructor=q).className="OneOf";var F=requireField(),U=requireUtil();function q(j,$,W,K){if(Array.isArray($)||(W=$,$=void 0),B.call(this,j,W),!($===void 0||Array.isArray($)))throw TypeError("fieldNames must be an Array");this.oneof=$||[],this.fieldsArray=[],this.comment=K}q.fromJSON=function($,W){return new q($,W.oneof,W.options,W.comment)},q.prototype.toJSON=function($){var W=$?!!$.keepComments:!1;return U.toObject(["options",this.options,"oneof",this.oneof,"comment",W?this.comment:void 0])};function V(j){if(j.parent)for(var $=0;$<j.fieldsArray.length;++$)j.fieldsArray[$].parent||j.parent.add(j.fieldsArray[$])}return q.prototype.add=function($){if(!($ instanceof F))throw TypeError("field must be a Field");return $.parent&&$.parent!==this.parent&&$.parent.remove($),this.oneof.push($.name),this.fieldsArray.push($),$.partOf=this,V(this),this},q.prototype.remove=function($){if(!($ instanceof F))throw TypeError("field must be a Field");var W=this.fieldsArray.indexOf($);if(W<0)throw Error($+" is not a member of "+this);return this.fieldsArray.splice(W,1),W=this.oneof.indexOf($.name),W>-1&&this.oneof.splice(W,1),$.partOf=null,this},q.prototype.onAdd=function($){B.prototype.onAdd.call(this,$);for(var W=this,K=0;K<this.oneof.length;++K){var G=$.get(this.oneof[K]);G&&!G.partOf&&(G.partOf=W,W.fieldsArray.push(G))}V(this)},q.prototype.onRemove=function($){for(var W=0,K;W<this.fieldsArray.length;++W)(K=this.fieldsArray[W]).parent&&K.parent.remove(K);B.prototype.onRemove.call(this,$)},Object.defineProperty(q.prototype,"isProto3Optional",{get:function(){if(this.fieldsArray==null||this.fieldsArray.length!==1)return!1;var j=this.fieldsArray[0];return j.options!=null&&j.options.proto3_optional===!0}}),q.d=function(){for(var $=new Array(arguments.length),W=0;W<arguments.length;)$[W]=arguments[W++];return function(G,Q){U.decorateType(G.constructor).add(new q(Q,$)),Object.defineProperty(G,Q,{get:U.oneOfGetter($),set:U.oneOfSetter($)})}},oneof}var object,hasRequiredObject;function requireObject(){if(hasRequiredObject)return object;hasRequiredObject=1,object=$,$.className="ReflectionObject";const B=requireOneof();var F=requireUtil(),U,q={enum_type:"OPEN",field_presence:"EXPLICIT",json_format:"ALLOW",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"PACKED",utf8_validation:"VERIFY"},V={enum_type:"CLOSED",field_presence:"EXPLICIT",json_format:"LEGACY_BEST_EFFORT",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"EXPANDED",utf8_validation:"NONE"},j={enum_type:"OPEN",field_presence:"IMPLICIT",json_format:"ALLOW",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"PACKED",utf8_validation:"VERIFY"};function $(W,K){if(!F.isString(W))throw TypeError("name must be a string");if(K&&!F.isObject(K))throw TypeError("options must be an object");this.options=K,this.parsedOptions=null,this.name=W,this._edition=null,this._defaultEdition="proto2",this._features={},this._featuresResolved=!1,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}return Object.defineProperties($.prototype,{root:{get:function(){for(var W=this;W.parent!==null;)W=W.parent;return W}},fullName:{get:function(){for(var W=[this.name],K=this.parent;K;)W.unshift(K.name),K=K.parent;return W.join(".")}}}),$.prototype.toJSON=function(){throw Error()},$.prototype.onAdd=function(K){this.parent&&this.parent!==K&&this.parent.remove(this),this.parent=K,this.resolved=!1;var G=K.root;G instanceof U&&G._handleAdd(this)},$.prototype.onRemove=function(K){var G=K.root;G instanceof U&&G._handleRemove(this),this.parent=null,this.resolved=!1},$.prototype.resolve=function(){return this.resolved?this:(this.root instanceof U&&(this.resolved=!0),this)},$.prototype._resolveFeaturesRecursive=function(K){return this._resolveFeatures(this._edition||K)},$.prototype._resolveFeatures=function(K){if(!this._featuresResolved){var G={};if(!K)throw new Error("Unknown edition for "+this.fullName);var Q=Object.assign(this.options?Object.assign({},this.options.features):{},this._inferLegacyProtoFeatures(K));if(this._edition){if(K==="proto2")G=Object.assign({},V);else if(K==="proto3")G=Object.assign({},j);else if(K==="2023")G=Object.assign({},q);else throw new Error("Unknown edition: "+K);this._features=Object.assign(G,Q||{}),this._featuresResolved=!0;return}if(this.partOf instanceof B){var z=Object.assign({},this.partOf._features);this._features=Object.assign(z,Q||{})}else if(!this.declaringField)if(this.parent){var H=Object.assign({},this.parent._features);this._features=Object.assign(H,Q||{})}else throw new Error("Unable to find a parent for "+this.fullName);this.extensionField&&(this.extensionField._features=this._features),this._featuresResolved=!0}},$.prototype._inferLegacyProtoFeatures=function(){return{}},$.prototype.getOption=function(K){if(this.options)return this.options[K]},$.prototype.setOption=function(K,G,Q){return this.options||(this.options={}),/^features\./.test(K)?F.setProperty(this.options,K,G,Q):(!Q||this.options[K]===void 0)&&(this.getOption(K)!==G&&(this.resolved=!1),this.options[K]=G),this},$.prototype.setParsedOption=function(K,G,Q){this.parsedOptions||(this.parsedOptions=[]);var z=this.parsedOptions;if(Q){var H=z.find(function(Z){return Object.prototype.hasOwnProperty.call(Z,K)});if(H){var Y=H[K];F.setProperty(Y,Q,G)}else H={},H[K]=F.setProperty({},Q,G),z.push(H)}else{var X={};X[K]=G,z.push(X)}return this},$.prototype.setOptions=function(K,G){if(K)for(var Q=Object.keys(K),z=0;z<Q.length;++z)this.setOption(Q[z],K[Q[z]],G);return this},$.prototype.toString=function(){var K=this.constructor.className,G=this.fullName;return G.length?K+" "+G:K},$.prototype._editionToJSON=function(){if(!(!this._edition||this._edition==="proto3"))return this._edition},$._configure=function(W){U=W},object}var _enum,hasRequired_enum;function require_enum(){if(hasRequired_enum)return _enum;hasRequired_enum=1,_enum=q;var B=requireObject();((q.prototype=Object.create(B.prototype)).constructor=q).className="Enum";var F=requireNamespace(),U=requireUtil();function q(V,j,$,W,K,G){if(B.call(this,V,$),j&&typeof j!="object")throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=W,this.comments=K||{},this.valuesOptions=G,this._valuesFeatures={},this.reserved=void 0,j)for(var Q=Object.keys(j),z=0;z<Q.length;++z)typeof j[Q[z]]=="number"&&(this.valuesById[this.values[Q[z]]=j[Q[z]]]=Q[z])}return q.prototype._resolveFeatures=function(j){return j=this._edition||j,B.prototype._resolveFeatures.call(this,j),Object.keys(this.values).forEach($=>{var W=Object.assign({},this._features);this._valuesFeatures[$]=Object.assign(W,this.valuesOptions&&this.valuesOptions[$]&&this.valuesOptions[$].features)}),this},q.fromJSON=function(j,$){var W=new q(j,$.values,$.options,$.comment,$.comments);return W.reserved=$.reserved,$.edition&&(W._edition=$.edition),W._defaultEdition="proto3",W},q.prototype.toJSON=function(j){var $=j?!!j.keepComments:!1;return U.toObject(["edition",this._editionToJSON(),"options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",$?this.comment:void 0,"comments",$?this.comments:void 0])},q.prototype.add=function(j,$,W,K){if(!U.isString(j))throw TypeError("name must be a string");if(!U.isInteger($))throw TypeError("id must be an integer");if(this.values[j]!==void 0)throw Error("duplicate name '"+j+"' in "+this);if(this.isReservedId($))throw Error("id "+$+" is reserved in "+this);if(this.isReservedName(j))throw Error("name '"+j+"' is reserved in "+this);if(this.valuesById[$]!==void 0){if(!(this.options&&this.options.allow_alias))throw Error("duplicate id "+$+" in "+this);this.values[j]=$}else this.valuesById[this.values[j]=$]=j;return K&&(this.valuesOptions===void 0&&(this.valuesOptions={}),this.valuesOptions[j]=K||null),this.comments[j]=W||null,this},q.prototype.remove=function(j){if(!U.isString(j))throw TypeError("name must be a string");var $=this.values[j];if($==null)throw Error("name '"+j+"' does not exist in "+this);return delete this.valuesById[$],delete this.values[j],delete this.comments[j],this.valuesOptions&&delete this.valuesOptions[j],this},q.prototype.isReservedId=function(j){return F.isReservedId(this.reserved,j)},q.prototype.isReservedName=function(j){return F.isReservedName(this.reserved,j)},_enum}var encoder_1,hasRequiredEncoder;function requireEncoder(){if(hasRequiredEncoder)return encoder_1;hasRequiredEncoder=1,encoder_1=V;var B=require_enum(),F=requireTypes(),U=requireUtil();function q(j,$,W,K){return $.delimited?j("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",W,K,($.id<<3|3)>>>0,($.id<<3|4)>>>0):j("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",W,K,($.id<<3|2)>>>0)}function V(j){for(var $=U.codegen(["m","w"],j.name+"$encode")("if(!w)")("w=Writer.create()"),W,K,G=j.fieldsArray.slice().sort(U.compareFieldsById),W=0;W<G.length;++W){var Q=G[W].resolve(),z=j._fieldsArray.indexOf(Q),H=Q.resolvedType instanceof B?"int32":Q.type,Y=F.basic[H];K="m"+U.safeProp(Q.name),Q.map?($("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",K,Q.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",K)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(Q.id<<3|2)>>>0,8|F.mapKey[Q.keyType],Q.keyType),Y===void 0?$("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",z,K):$(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|Y,H,K),$("}")("}")):Q.repeated?($("if(%s!=null&&%s.length){",K,K),Q.packed&&F.packed[H]!==void 0?$("w.uint32(%i).fork()",(Q.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",K)("w.%s(%s[i])",H,K)("w.ldelim()"):($("for(var i=0;i<%s.length;++i)",K),Y===void 0?q($,Q,z,K+"[i]"):$("w.uint32(%i).%s(%s[i])",(Q.id<<3|Y)>>>0,H,K)),$("}")):(Q.optional&&$("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",K,Q.name),Y===void 0?q($,Q,z,K):$("w.uint32(%i).%s(%s)",(Q.id<<3|Y)>>>0,H,K))}return $("return w")}return encoder_1}var hasRequiredIndexLight;function requireIndexLight(){if(hasRequiredIndexLight)return indexLight.exports;hasRequiredIndexLight=1;var B=indexLight.exports=requireIndexMinimal();B.build="light";function F(q,V,j){return typeof V=="function"?(j=V,V=new B.Root):V||(V=new B.Root),V.load(q,j)}B.load=F;function U(q,V){return V||(V=new B.Root),V.loadSync(q)}return B.loadSync=U,B.encoder=requireEncoder(),B.decoder=requireDecoder(),B.verifier=requireVerifier(),B.converter=requireConverter(),B.ReflectionObject=requireObject(),B.Namespace=requireNamespace(),B.Root=requireRoot(),B.Enum=require_enum(),B.Type=requireType(),B.Field=requireField(),B.OneOf=requireOneof(),B.MapField=requireMapfield(),B.Service=requireService(),B.Method=requireMethod(),B.Message=requireMessage(),B.wrappers=requireWrappers(),B.types=requireTypes(),B.util=requireUtil(),B.ReflectionObject._configure(B.Root),B.Namespace._configure(B.Type,B.Service,B.Enum),B.Root._configure(B.Type),B.Field._configure(B.Type),indexLight.exports}var tokenize_1,hasRequiredTokenize;function requireTokenize(){if(hasRequiredTokenize)return tokenize_1;hasRequiredTokenize=1,tokenize_1=Q;var B=/[\s{}=;:[\],'"()<>]/g,F=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,U=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,q=/^ *[*/]+ */,V=/^\s*\*?\/*/,j=/\n/g,$=/\s/,W=/\\(.?)/g,K={0:"\0",r:"\r",n:`
`,t:"	"};function G(z){return z.replace(W,function(H,Y){switch(Y){case"\\":case"":return Y;default:return K[Y]||""}})}Q.unescape=G;function Q(z,H){z=z.toString();var Y=0,X=z.length,Z=1,ie=0,ee={},te=[],re=null;function ne(ke){return Error("illegal "+ke+" (line "+Z+")")}function se(){var ke=re==="'"?U:F;ke.lastIndex=Y-1;var Ee=ke.exec(z);if(!Ee)throw ne("string");return Y=ke.lastIndex,ae(re),re=null,G(Ee[1])}function oe(ke){return z.charAt(ke)}function fe(ke,Ee,_e){var Oe={type:z.charAt(ke++),lineEmpty:!1,leading:_e},Le;H?Le=2:Le=3;var we=ke-Le,Ae;do if(--we<0||(Ae=z.charAt(we))===`
`){Oe.lineEmpty=!0;break}while(Ae===" "||Ae==="	");for(var Fe=z.substring(ke,Ee).split(j),Be=0;Be<Fe.length;++Be)Fe[Be]=Fe[Be].replace(H?V:q,"").trim();Oe.text=Fe.join(`
`).trim(),ee[Z]=Oe,ie=Z}function pe(ke){var Ee=le(ke),_e=z.substring(ke,Ee),Oe=/^\s*\/\//.test(_e);return Oe}function le(ke){for(var Ee=ke;Ee<X&&oe(Ee)!==`
`;)Ee++;return Ee}function he(){if(te.length>0)return te.shift();if(re)return se();var ke,Ee,_e,Oe,Le,we=Y===0;do{if(Y===X)return null;for(ke=!1;$.test(_e=oe(Y));)if(_e===`
`&&(we=!0,++Z),++Y===X)return null;if(oe(Y)==="/"){if(++Y===X)throw ne("comment");if(oe(Y)==="/")if(H){if(Oe=Y,Le=!1,pe(Y-1)){Le=!0;do if(Y=le(Y),Y===X||(Y++,!we))break;while(pe(Y))}else Y=Math.min(X,le(Y)+1);Le&&(fe(Oe,Y,we),we=!0),Z++,ke=!0}else{for(Le=oe(Oe=Y+1)==="/";oe(++Y)!==`
`;)if(Y===X)return null;++Y,Le&&(fe(Oe,Y-1,we),we=!0),++Z,ke=!0}else if((_e=oe(Y))==="*"){Oe=Y+1,Le=H||oe(Oe)==="*";do{if(_e===`
`&&++Z,++Y===X)throw ne("comment");Ee=_e,_e=oe(Y)}while(Ee!=="*"||_e!=="/");++Y,Le&&(fe(Oe,Y-2,we),we=!0),ke=!0}else return"/"}}while(ke);var Ae=Y;B.lastIndex=0;var Fe=B.test(oe(Ae++));if(!Fe)for(;Ae<X&&!B.test(oe(Ae));)++Ae;var Be=z.substring(Y,Y=Ae);return(Be==='"'||Be==="'")&&(re=Be),Be}function ae(ke){te.push(ke)}function ye(){if(!te.length){var ke=he();if(ke===null)return null;ae(ke)}return te[0]}function Ce(ke,Ee){var _e=ye(),Oe=_e===ke;if(Oe)return he(),!0;if(!Ee)throw ne("token '"+_e+"', '"+ke+"' expected");return!1}function me(ke){var Ee=null,_e;return ke===void 0?(_e=ee[Z-1],delete ee[Z-1],_e&&(H||_e.type==="*"||_e.lineEmpty)&&(Ee=_e.leading?_e.text:null)):(ie<ke&&ye(),_e=ee[ke],delete ee[ke],_e&&!_e.lineEmpty&&(H||_e.type==="/")&&(Ee=_e.leading?null:_e.text)),Ee}return Object.defineProperty({next:he,peek:ye,push:ae,skip:Ce,cmnt:me},"line",{get:function(){return Z}})}return tokenize_1}var parse_1,hasRequiredParse;function requireParse(){if(hasRequiredParse)return parse_1;hasRequiredParse=1,parse_1=se,se.filename=null,se.defaults={keepCase:!1};var B=requireTokenize(),F=requireRoot(),U=requireType(),q=requireField(),V=requireMapfield(),j=requireOneof(),$=require_enum(),W=requireService(),K=requireMethod(),G=requireObject(),Q=requireTypes(),z=requireUtil(),H=/^[1-9][0-9]*$/,Y=/^-?[1-9][0-9]*$/,X=/^0[x][0-9a-fA-F]+$/,Z=/^-?0[x][0-9a-fA-F]+$/,ie=/^0[0-7]+$/,ee=/^-?0[0-7]+$/,te=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,re=/^[a-zA-Z_][a-zA-Z_0-9]*$/,ne=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/;function se(oe,fe,pe){fe instanceof F||(pe=fe,fe=new F),pe||(pe=se.defaults);var le=pe.preferTrailingComment||!1,he=B(oe,pe.alternateCommentMode||!1),ae=he.next,ye=he.push,Ce=he.peek,me=he.skip,ke=he.cmnt,Ee=!0,_e,Oe,Le,we="proto2",Ae=fe,Fe=[],Be={},Ye=pe.keepCase?function(ue){return ue}:z.camelCase;function pt(){Fe.forEach(ue=>{ue._edition=we,Object.keys(Be).forEach(ce=>{ue.getOption(ce)===void 0&&ue.setOption(ce,Be[ce],!0)})})}function be(ue,ce,de){var ge=se.filename;return de||(se.filename=null),Error("illegal "+(ce||"token")+" '"+ue+"' ("+(ge?ge+", ":"")+"line "+he.line+")")}function mt(){var ue=[],ce;do{if((ce=ae())!=='"'&&ce!=="'")throw be(ce);ue.push(ae()),me(ce),ce=Ce()}while(ce==='"'||ce==="'");return ue.join("")}function bt(ue){var ce=ae();switch(ce){case"'":case'"':return ye(ce),mt();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return It(ce,!0)}catch{if(ne.test(ce))return ce;throw be(ce,"value")}}function vt(ue,ce){var de,ge;do if(ce&&((de=Ce())==='"'||de==="'")){var ve=mt();if(ue.push(ve),we>=2023)throw be(ve,"id")}else try{ue.push([ge=Xe(ae()),me("to",!0)?Xe(ae()):ge])}catch(De){if(ce&&ne.test(de)&&we>=2023)ue.push(de);else throw De}while(me(",",!0));var Se={options:void 0};Se.setOption=function(De,qe){this.options===void 0&&(this.options={}),this.options[De]=qe},$e(Se,function(qe){if(qe==="option")We(Se,qe),me(";");else throw be(qe)},function(){yt(Se)})}function It(ue,ce){var de=1;switch(ue.charAt(0)==="-"&&(de=-1,ue=ue.substring(1)),ue){case"inf":case"INF":case"Inf":return de*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(H.test(ue))return de*parseInt(ue,10);if(X.test(ue))return de*parseInt(ue,16);if(ie.test(ue))return de*parseInt(ue,8);if(te.test(ue))return de*parseFloat(ue);throw be(ue,"number",ce)}function Xe(ue,ce){switch(ue){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!ce&&ue.charAt(0)==="-")throw be(ue,"id");if(Y.test(ue))return parseInt(ue,10);if(Z.test(ue))return parseInt(ue,16);if(ee.test(ue))return parseInt(ue,8);throw be(ue,"id")}function Ot(){if(_e!==void 0)throw be("package");if(_e=ae(),!ne.test(_e))throw be(_e,"name");Ae=Ae.define(_e),me(";")}function At(){var ue=Ce(),ce;switch(ue){case"weak":ce=Le||(Le=[]),ae();break;case"public":ae();default:ce=Oe||(Oe=[]);break}ue=mt(),me(";"),ce.push(ue)}function Dt(){if(me("="),we=mt(),we<2023)throw be(we,"syntax");me(";")}function xt(){if(me("="),we=mt(),!["2023"].includes(we))throw be(we,"edition");me(";")}function Tt(ue,ce){switch(ce){case"option":return We(ue,ce),me(";"),!0;case"message":return _t(ue,ce),!0;case"enum":return Et(ue,ce),!0;case"service":return qt(ue,ce),!0;case"extend":return Vt(ue,ce),!0}return!1}function $e(ue,ce,de){var ge=he.line;if(ue&&(typeof ue.comment!="string"&&(ue.comment=ke()),ue.filename=se.filename),me("{",!0)){for(var ve;(ve=ae())!=="}";)ce(ve);me(";",!0)}else de&&de(),me(";"),ue&&(typeof ue.comment!="string"||le)&&(ue.comment=ke(ge)||ue.comment)}function _t(ue,ce){if(!re.test(ce=ae()))throw be(ce,"type name");var de=new U(ce);$e(de,function(ve){if(!Tt(de,ve))switch(ve){case"map":Mt(de);break;case"required":if(we!=="proto2")throw be(ve);case"repeated":je(de,ve);break;case"optional":if(we==="proto3")je(de,"proto3_optional");else{if(we!=="proto2")throw be(ve);je(de,"optional")}break;case"oneof":Nt(de,ve);break;case"extensions":vt(de.extensions||(de.extensions=[]));break;case"reserved":vt(de.reserved||(de.reserved=[]),!0);break;default:if(we==="proto2"||!ne.test(ve))throw be(ve);ye(ve),je(de,"optional");break}}),ue.add(de),ue===Ae&&Fe.push(de)}function je(ue,ce,de){var ge=ae();if(ge==="group"){Lt(ue,ce);return}for(;ge.endsWith(".")||Ce().startsWith(".");)ge+=ae();if(!ne.test(ge))throw be(ge,"type");var ve=ae();if(!re.test(ve))throw be(ve,"name");ve=Ye(ve),me("=");var Se=new q(ve,Xe(ae()),ge,ce,de);if($e(Se,function(Ve){if(Ve==="option")We(Se,Ve),me(";");else throw be(Ve)},function(){yt(Se)}),ce==="proto3_optional"){var De=new j("_"+ve);Se.setOption("proto3_optional",!0),De.add(Se),ue.add(De)}else ue.add(Se);ue===Ae&&Fe.push(Se)}function Lt(ue,ce){if(we>=2023)throw be("group");var de=ae();if(!re.test(de))throw be(de,"name");var ge=z.lcFirst(de);de===ge&&(de=z.ucFirst(de)),me("=");var ve=Xe(ae()),Se=new U(de);Se.group=!0;var De=new q(ge,ve,de,ce);De.filename=se.filename,$e(Se,function(Ve){switch(Ve){case"option":We(Se,Ve),me(";");break;case"required":case"repeated":je(Se,Ve);break;case"optional":we==="proto3"?je(Se,"proto3_optional"):je(Se,"optional");break;case"message":_t(Se,Ve);break;case"enum":Et(Se,Ve);break;case"reserved":vt(Se.reserved||(Se.reserved=[]),!0);break;default:throw be(Ve)}}),ue.add(Se).add(De)}function Mt(ue){me("<");var ce=ae();if(Q.mapKey[ce]===void 0)throw be(ce,"type");me(",");var de=ae();if(!ne.test(de))throw be(de,"type");me(">");var ge=ae();if(!re.test(ge))throw be(ge,"name");me("=");var ve=new V(Ye(ge),Xe(ae()),ce,de);$e(ve,function(De){if(De==="option")We(ve,De),me(";");else throw be(De)},function(){yt(ve)}),ue.add(ve)}function Nt(ue,ce){if(!re.test(ce=ae()))throw be(ce,"name");var de=new j(Ye(ce));$e(de,function(ve){ve==="option"?(We(de,ve),me(";")):(ye(ve),je(de,"optional"))}),ue.add(de)}function Et(ue,ce){if(!re.test(ce=ae()))throw be(ce,"name");var de=new $(ce);$e(de,function(ve){switch(ve){case"option":We(de,ve),me(";");break;case"reserved":vt(de.reserved||(de.reserved=[]),!0),de.reserved===void 0&&(de.reserved=[]);break;default:Ft(de,ve)}}),ue.add(de),ue===Ae&&Fe.push(de)}function Ft(ue,ce){if(!re.test(ce))throw be(ce,"name");me("=");var de=Xe(ae(),!0),ge={options:void 0};ge.getOption=function(ve){return this.options[ve]},ge.setOption=function(ve,Se){G.prototype.setOption.call(ge,ve,Se)},ge.setParsedOption=function(){},$e(ge,function(Se){if(Se==="option")We(ge,Se),me(";");else throw be(Se)},function(){yt(ge)}),ue.add(ce,de,ge.comment,ge.parsedOptions||ge.options)}function We(ue,ce){var de,ge,ve=!0;for(ce==="option"&&(ce=ae());ce!=="=";){if(ce==="("){var Se=ae();me(")"),ce="("+Se+")"}if(ve){if(ve=!1,ce.includes(".")&&!ce.includes("(")){var De=ce.split(".");de=De[0]+".",ce=De[1];continue}de=ce}else ge=ge?ge+=ce:ce;ce=ae()}var qe=ge?de.concat(ge):de,Ve=wt(ue,qe);ge=ge&&ge[0]==="."?ge.slice(1):ge,de=de&&de[de.length-1]==="."?de.slice(0,-1):de,Ut(ue,de,Ve,ge)}function wt(ue,ce){if(me("{",!0)){for(var de={};!me("}",!0);){if(!re.test(Ue=ae()))throw be(Ue,"name");if(Ue===null)throw be(Ue,"end of input");var ge,ve=Ue;if(me(":",!0),Ce()==="{")ge=wt(ue,ce+"."+Ue);else if(Ce()==="["){ge=[];var Se;if(me("[",!0)){do Se=bt(),ge.push(Se);while(me(",",!0));me("]"),typeof Se<"u"&&St(ue,ce+"."+Ue,Se)}}else ge=bt(),St(ue,ce+"."+Ue,ge);var De=de[ve];De&&(ge=[].concat(De).concat(ge)),de[ve]=ge,me(",",!0),me(";",!0)}return de}var qe=bt();return St(ue,ce,qe),qe}function St(ue,ce,de){if(Ae===ue&&/^features\./.test(ce)){Be[ce]=de;return}ue.setOption&&ue.setOption(ce,de)}function Ut(ue,ce,de,ge){ue.setParsedOption&&ue.setParsedOption(ce,de,ge)}function yt(ue){if(me("[",!0)){do We(ue,"option");while(me(",",!0));me("]")}return ue}function qt(ue,ce){if(!re.test(ce=ae()))throw be(ce,"service name");var de=new W(ce);$e(de,function(ve){if(!Tt(de,ve))if(ve==="rpc")Bt(de,ve);else throw be(ve)}),ue.add(de),ue===Ae&&Fe.push(de)}function Bt(ue,ce){var de=ke(),ge=ce;if(!re.test(ce=ae()))throw be(ce,"name");var ve=ce,Se,De,qe,Ve;if(me("("),me("stream",!0)&&(De=!0),!ne.test(ce=ae())||(Se=ce,me(")"),me("returns"),me("("),me("stream",!0)&&(Ve=!0),!ne.test(ce=ae())))throw be(ce);qe=ce,me(")");var kt=new K(ve,ge,Se,qe,De,Ve);kt.comment=de,$e(kt,function(Ct){if(Ct==="option")We(kt,Ct),me(";");else throw be(Ct)}),ue.add(kt)}function Vt(ue,ce){if(!ne.test(ce=ae()))throw be(ce,"reference");var de=ce;$e(null,function(ve){switch(ve){case"required":case"repeated":je(ue,ve,de);break;case"optional":we==="proto3"?je(ue,"proto3_optional",de):je(ue,"optional",de);break;default:if(we==="proto2"||!ne.test(ve))throw be(ve);ye(ve),je(ue,"optional",de);break}})}for(var Ue;(Ue=ae())!==null;)switch(Ue){case"package":if(!Ee)throw be(Ue);Ot();break;case"import":if(!Ee)throw be(Ue);At();break;case"syntax":if(!Ee)throw be(Ue);Dt();break;case"edition":if(!Ee)throw be(Ue);xt();break;case"option":We(Ae,Ue),me(";",!0);break;default:if(Tt(Ae,Ue)){Ee=!1;continue}throw be(Ue)}return pt(),se.filename=null,{package:_e,imports:Oe,weakImports:Le,root:fe}}return parse_1}var common_1,hasRequiredCommon;function requireCommon(){if(hasRequiredCommon)return common_1;hasRequiredCommon=1,common_1=F;var B=/\/|\./;function F(q,V){B.test(q)||(q="google/protobuf/"+q+".proto",V={nested:{google:{nested:{protobuf:{nested:V}}}}}),F[q]=V}F("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}});var U;return F("duration",{Duration:U={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),F("timestamp",{Timestamp:U}),F("empty",{Empty:{fields:{}}}),F("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),F("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),F("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),F.get=function(V){return F[V]||null},common_1}var hasRequiredSrc;function requireSrc(){if(hasRequiredSrc)return src.exports;hasRequiredSrc=1;var B=src.exports=requireIndexLight();return B.build="full",B.tokenize=requireTokenize(),B.parse=requireParse(),B.common=requireCommon(),B.Root._configure(B.Type,B.parse,B.common),src.exports}var protobufjs,hasRequiredProtobufjs;function requireProtobufjs(){return hasRequiredProtobufjs||(hasRequiredProtobufjs=1,protobufjs=requireSrc()),protobufjs}var protobufjsExports=requireProtobufjs();const protobuf=getDefaultExportFromCjs(protobufjsExports);var extendStatics=function(B,F){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(U,q){U.__proto__=q}||function(U,q){for(var V in q)Object.prototype.hasOwnProperty.call(q,V)&&(U[V]=q[V])},extendStatics(B,F)};function __extends(B,F){if(typeof F!="function"&&F!==null)throw new TypeError("Class extends value "+String(F)+" is not a constructor or null");extendStatics(B,F);function U(){this.constructor=B}B.prototype=F===null?Object.create(F):(U.prototype=F.prototype,new U)}var __assign=function(){return __assign=Object.assign||function(F){for(var U,q=1,V=arguments.length;q<V;q++){U=arguments[q];for(var j in U)Object.prototype.hasOwnProperty.call(U,j)&&(F[j]=U[j])}return F},__assign.apply(this,arguments)};function __awaiter(B,F,U,q){function V(j){return j instanceof U?j:new U(function($){$(j)})}return new(U||(U=Promise))(function(j,$){function W(Q){try{G(q.next(Q))}catch(z){$(z)}}function K(Q){try{G(q.throw(Q))}catch(z){$(z)}}function G(Q){Q.done?j(Q.value):V(Q.value).then(W,K)}G((q=q.apply(B,F||[])).next())})}function __generator(B,F){var U={label:0,sent:function(){if(j[0]&1)throw j[1];return j[1]},trys:[],ops:[]},q,V,j,$;return $={next:W(0),throw:W(1),return:W(2)},typeof Symbol=="function"&&($[Symbol.iterator]=function(){return this}),$;function W(G){return function(Q){return K([G,Q])}}function K(G){if(q)throw new TypeError("Generator is already executing.");for(;$&&($=0,G[0]&&(U=0)),U;)try{if(q=1,V&&(j=G[0]&2?V.return:G[0]?V.throw||((j=V.return)&&j.call(V),0):V.next)&&!(j=j.call(V,G[1])).done)return j;switch(V=0,j&&(G=[G[0]&2,j.value]),G[0]){case 0:case 1:j=G;break;case 4:return U.label++,{value:G[1],done:!1};case 5:U.label++,V=G[1],G=[0];continue;case 7:G=U.ops.pop(),U.trys.pop();continue;default:if(j=U.trys,!(j=j.length>0&&j[j.length-1])&&(G[0]===6||G[0]===2)){U=0;continue}if(G[0]===3&&(!j||G[1]>j[0]&&G[1]<j[3])){U.label=G[1];break}if(G[0]===6&&U.label<j[1]){U.label=j[1],j=G;break}if(j&&U.label<j[2]){U.label=j[2],U.ops.push(G);break}j[2]&&U.ops.pop(),U.trys.pop();continue}G=F.call(B,U)}catch(Q){G=[6,Q],V=0}finally{q=j=0}if(G[0]&5)throw G[1];return{value:G[0]?G[1]:void 0,done:!0}}}typeof SuppressedError=="function"&&SuppressedError;var options={syntax:"proto3"},nested={pipecat:{nested:{TextFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3}}},AudioRawFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},audio:{type:"bytes",id:3},sampleRate:{type:"uint32",id:4},numChannels:{type:"uint32",id:5}}},TranscriptionFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3},userId:{type:"string",id:4},timestamp:{type:"string",id:5}}},Frame:{oneofs:{frame:{oneof:["text","audio","transcription"]}},fields:{text:{type:"TextFrame",id:1},audio:{type:"AudioRawFrame",id:2},transcription:{type:"TranscriptionFrame",id:3}}}}}},jsonDescriptor={options,nested},ConnectionQuality;(function(B){B.UNKNOWN="UNKNOWN",B.GOOD="GOOD",B.BAD="BAD"})(ConnectionQuality||(ConnectionQuality={}));var AbstractConnectionQualityIndicator=function(){function B(F){this._connectionQuality=ConnectionQuality.UNKNOWN,this.onConnectionQualityChanged=F}return Object.defineProperty(B.prototype,"connectionQuality",{get:function(){return this._connectionQuality},enumerable:!1,configurable:!0}),B.prototype.handleStatsChanged=function(){var F=this.calculateConnectionQuality();F!==this._connectionQuality&&(this._connectionQuality=F,this.onConnectionQualityChanged(F))},B.prototype.start=function(F){this.stop(!0),this._start(F)},B.prototype.stop=function(F){F===void 0&&(F=!1),this._stop(),this._connectionQuality=ConnectionQuality.UNKNOWN,F||this.onConnectionQualityChanged(ConnectionQuality.UNKNOWN)},B}();function QualityIndicatorMixer(){for(var B=[],F=0;F<arguments.length;F++)B[F]=arguments[F];var U=function(q){__extends(V,q);function V(j){var $=q.call(this,j)||this;return $.childTrackers=B.map(function(W){var K=W.getParams,G=W.TrackerClass;return{tracker:new G(function(){return $.handleStatsChanged()}),getParams:K}}),$}return V.prototype.calculateConnectionQuality=function(){var j=this.childTrackers.map(function($){var W=$.tracker;return W.connectionQuality});return j.some(function($){return $===ConnectionQuality.BAD})?ConnectionQuality.BAD:j.every(function($){return $===ConnectionQuality.UNKNOWN})?ConnectionQuality.UNKNOWN:ConnectionQuality.GOOD},V.prototype._start=function(j){this.childTrackers.forEach(function($){var W=$.tracker,K=$.getParams;return W.start(K(j))})},V.prototype._stop=function(){this.childTrackers.forEach(function(j){var $=j.tracker;return $.stop(!0)})},V}(AbstractConnectionQualityIndicator);return U}var LiveKitConnectionQualityIndicator=function(B){__extends(F,B);function F(){var U=B!==null&&B.apply(this,arguments)||this;return U.room=null,U.liveKitConnectionQuality=ConnectionQuality$2.Unknown,U.liveKitConnectionState=null,U.handleConnectionQualityChanged=function(q){U.liveKitConnectionQuality=q,U.handleStatsChanged()},U.handleConnectionStateChanged=function(q){U.liveKitConnectionState=q,U.handleStatsChanged()},U}return F.prototype._start=function(U){this.room=U,this.room.localParticipant.on(ParticipantEvent.ConnectionQualityChanged,this.handleConnectionQualityChanged),this.room.on(RoomEvent.ConnectionStateChanged,this.handleConnectionStateChanged)},F.prototype._stop=function(){this.room&&(this.room.localParticipant.off(RoomEvent.ConnectionQualityChanged,this.handleConnectionQualityChanged),this.room.off(RoomEvent.ConnectionStateChanged,this.handleConnectionStateChanged))},F.prototype.calculateConnectionQuality=function(){return[ConnectionQuality$2.Lost,ConnectionQuality$2.Poor].includes(this.liveKitConnectionQuality)||this.liveKitConnectionState&&[ConnectionState.Disconnected,ConnectionState.Reconnecting,ConnectionState.SignalReconnecting].includes(this.liveKitConnectionState)?ConnectionQuality.BAD:ConnectionQuality.GOOD},F}(AbstractConnectionQualityIndicator),t,e,s,n;function r(){}function o(){o.init.call(this)}function i(B){return B._maxListeners===void 0?o.defaultMaxListeners:B._maxListeners}function a(B,F,U){if(F)B.call(U);else for(var q=B.length,V=m(B,q),j=0;j<q;++j)V[j].call(U)}function c(B,F,U,q){if(F)B.call(U,q);else for(var V=B.length,j=m(B,V),$=0;$<V;++$)j[$].call(U,q)}function d(B,F,U,q,V){if(F)B.call(U,q,V);else for(var j=B.length,$=m(B,j),W=0;W<j;++W)$[W].call(U,q,V)}function u(B,F,U,q,V,j){if(F)B.call(U,q,V,j);else for(var $=B.length,W=m(B,$),K=0;K<$;++K)W[K].call(U,q,V,j)}function h(B,F,U,q){if(F)B.apply(U,q);else for(var V=B.length,j=m(B,V),$=0;$<V;++$)j[$].apply(U,q)}function l(B,F,U,q){var V,j,$,W;if(typeof U!="function")throw new TypeError('"listener" argument must be a function');if((j=B._events)?(j.newListener&&(B.emit("newListener",F,U.listener?U.listener:U),j=B._events),$=j[F]):(j=B._events=new r,B._eventsCount=0),$){if(typeof $=="function"?$=j[F]=q?[U,$]:[$,U]:q?$.unshift(U):$.push(U),!$.warned&&(V=i(B))&&V>0&&$.length>V){$.warned=!0;var K=new Error("Possible EventEmitter memory leak detected. "+$.length+" "+F+" listeners added. Use emitter.setMaxListeners() to increase limit");K.name="MaxListenersExceededWarning",K.emitter=B,K.type=F,K.count=$.length,W=K,typeof console.warn=="function"?console.warn(W):console.log(W)}}else $=j[F]=U,++B._eventsCount;return B}function p(B,F,U){var q=!1;function V(){B.removeListener(F,V),q||(q=!0,U.apply(B,arguments))}return V.listener=U,V}function f(B){var F=this._events;if(F){var U=F[B];if(typeof U=="function")return 1;if(U)return U.length}return 0}function m(B,F){for(var U=new Array(F);F--;)U[F]=B[F];return U}r.prototype=Object.create(null),o.EventEmitter=o,o.usingDomains=!1,o.prototype.domain=void 0,o.prototype._events=void 0,o.prototype._maxListeners=void 0,o.defaultMaxListeners=10,o.init=function(){this.domain=null,o.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new r,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(B){if(typeof B!="number"||B<0||isNaN(B))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=B,this},o.prototype.getMaxListeners=function(){return i(this)},o.prototype.emit=function(B){var F,U,q,V,j,$,W,K=B==="error";if($=this._events)K=K&&$.error==null;else if(!K)return!1;if(W=this.domain,K){if(F=arguments[1],!W){if(F instanceof Error)throw F;var G=new Error('Uncaught, unspecified "error" event. ('+F+")");throw G.context=F,G}return F||(F=new Error('Uncaught, unspecified "error" event')),F.domainEmitter=this,F.domain=W,F.domainThrown=!1,W.emit("error",F),!1}if(!(U=$[B]))return!1;var Q=typeof U=="function";switch(q=arguments.length){case 1:a(U,Q,this);break;case 2:c(U,Q,this,arguments[1]);break;case 3:d(U,Q,this,arguments[1],arguments[2]);break;case 4:u(U,Q,this,arguments[1],arguments[2],arguments[3]);break;default:for(V=new Array(q-1),j=1;j<q;j++)V[j-1]=arguments[j];h(U,Q,this,V)}return!0},o.prototype.addListener=function(B,F){return l(this,B,F,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(B,F){return l(this,B,F,!0)},o.prototype.once=function(B,F){if(typeof F!="function")throw new TypeError('"listener" argument must be a function');return this.on(B,p(this,B,F)),this},o.prototype.prependOnceListener=function(B,F){if(typeof F!="function")throw new TypeError('"listener" argument must be a function');return this.prependListener(B,p(this,B,F)),this},o.prototype.removeListener=function(B,F){var U,q,V,j,$;if(typeof F!="function")throw new TypeError('"listener" argument must be a function');if(!(q=this._events))return this;if(!(U=q[B]))return this;if(U===F||U.listener&&U.listener===F)--this._eventsCount==0?this._events=new r:(delete q[B],q.removeListener&&this.emit("removeListener",B,U.listener||F));else if(typeof U!="function"){for(V=-1,j=U.length;j-- >0;)if(U[j]===F||U[j].listener&&U[j].listener===F){$=U[j].listener,V=j;break}if(V<0)return this;if(U.length===1){if(U[0]=void 0,--this._eventsCount==0)return this._events=new r,this;delete q[B]}else(function(W,K){for(var G=K,Q=G+1,z=W.length;Q<z;G+=1,Q+=1)W[G]=W[Q];W.pop()})(U,V);q.removeListener&&this.emit("removeListener",B,$||F)}return this},o.prototype.off=function(B,F){return this.removeListener(B,F)},o.prototype.removeAllListeners=function(B){var F,U;if(!(U=this._events))return this;if(!U.removeListener)return arguments.length===0?(this._events=new r,this._eventsCount=0):U[B]&&(--this._eventsCount==0?this._events=new r:delete U[B]),this;if(arguments.length===0){for(var q,V=Object.keys(U),j=0;j<V.length;++j)(q=V[j])!=="removeListener"&&this.removeAllListeners(q);return this.removeAllListeners("removeListener"),this._events=new r,this._eventsCount=0,this}if(typeof(F=U[B])=="function")this.removeListener(B,F);else if(F)do this.removeListener(B,F[F.length-1]);while(F[0]);return this},o.prototype.listeners=function(B){var F,U=this._events;return U&&(F=U[B])?typeof F=="function"?[F.listener||F]:function(q){for(var V=new Array(q.length),j=0;j<V.length;++j)V[j]=q[j].listener||q[j];return V}(F):[]},o.listenerCount=function(B,F){return typeof B.listenerCount=="function"?B.listenerCount(F):f.call(B,F)},o.prototype.listenerCount=f,o.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class g extends o{}(function(B){B.Issue="issue",B.NetworkScoresUpdated="network-scores-updated",B.StatsParsingFinished="stats-parsing-finished"})(t||(t={})),function(B){B.Network="network",B.CPU="cpu",B.Server="server",B.Stream="stream"}(e||(e={})),function(B){B.OutboundNetworkQuality="outbound-network-quality",B.InboundNetworkQuality="inbound-network-quality",B.OutboundNetworkMediaLatency="outbound-network-media-latency",B.InboundNetworkMediaLatency="inbound-network-media-latency",B.NetworkMediaSyncFailure="network-media-sync-failure",B.OutboundNetworkThroughput="outbound-network-throughput",B.InboundNetworkThroughput="inbound-network-throughput",B.EncoderCPUThrottling="encoder-cpu-throttling",B.DecoderCPUThrottling="decoder-cpu-throttling",B.ServerIssue="server-issue",B.UnknownVideoDecoderIssue="unknown-video-decoder",B.LowInboundMOS="low-inbound-mean-opinion-score",B.LowOutboundMOS="low-outbound-mean-opinion-score",B.FrozenVideoTrack="frozen-video-track",B.MissingVideoStreamData="missing-video-stream-data",B.MissingAudioStreamData="missing-audio-stream-data"}(s||(s={})),function(B){B[B.BAD=2.1]="BAD",B[B.POOR=2.6]="POOR",B[B.FAIR=3.1]="FAIR",B[B.GOOD=3.8]="GOOD",B[B.EXCELLENT=4.3]="EXCELLENT"}(n||(n={}));const Re=class Re extends o{constructor(U){super();Ne(this,"isStopped",!1);Ne(this,"reportTimer");Ne(this,"getStatsInterval");Ne(this,"compositeStatsParser");this.compositeStatsParser=U.compositeStatsParser,this.getStatsInterval=U.getStatsInterval??1e4}get isRunning(){return!!this.reportTimer&&!this.isStopped}startReporting(){if(this.reportTimer)return;const U=()=>setTimeout(()=>{this.isStopped?this.reportTimer=void 0:this.parseReports().finally(()=>{this.reportTimer=U()})},this.getStatsInterval);this.isStopped=!1,this.reportTimer=U()}stopReporting(){this.isStopped=!0,this.reportTimer&&(clearTimeout(this.reportTimer),this.reportTimer=void 0)}async parseReports(){const U=Date.now(),q=await this.compositeStatsParser.parse(),V=Date.now()-U;this.emit(Re.STATS_REPORTS_PARSED,{timeTaken:V,reportItems:q}),q.forEach(j=>{this.emit(Re.STATS_REPORT_READY_EVENT,j)})}};Ne(Re,"STATS_REPORT_READY_EVENT","stats-report-ready"),Ne(Re,"STATS_REPORTS_PARSED","stats-reports-parsed");let S=Re;const v=(()=>{const B=new Map;return F=>{const{taskId:U,delayMs:q,maxJitterMs:V,callback:j}=F,$=Math.ceil(Math.random()*(V||0)),W=B.get(U);W&&clearTimeout(W);const K=setTimeout(()=>{j(),B.delete(U)},q+$);B.set(U,K)}})();class k{constructor(){xe(this,Pe,{})}calculate(F){const{connection:{id:U}}=F,{mos:q,stats:V}=this.calculateOutboundScore(F)||{},{mos:j,stats:$}=this.calculateInboundScore(F)||{};return Te(this,Pe)[U]=F,v({taskId:U,delayMs:35e3,callback:()=>delete Te(this,Pe)[U]}),{outbound:q,inbound:j,connectionId:U,statsSamples:{inboundStatsSample:$,outboundStatsSample:V}}}calculateOutboundScore(F){var X,Z,ie,ee;const U=[...((X=F.remote)==null?void 0:X.audio.inbound)||[],...((Z=F.remote)==null?void 0:Z.video.inbound)||[]];if(!U.length)return;const q=Te(this,Pe)[F.connection.id];if(!q)return;const V=[...((ie=q.remote)==null?void 0:ie.audio.inbound)||[],...((ee=q.remote)==null?void 0:ee.video.inbound)||[]],{packetsSent:j}=F.connection,$=q.connection.packetsSent,W=U.reduce((te,re)=>{const ne=V.find(se=>se.ssrc===re.ssrc);return{sumJitter:te.sumJitter+re.jitter,packetsLost:te.packetsLost+re.packetsLost,lastPacketsLost:te.lastPacketsLost+((ne==null?void 0:ne.packetsLost)||0)}},{sumJitter:0,packetsLost:0,lastPacketsLost:0}),K=1e3*F.connection.currentRoundTripTime||0,{sumJitter:G}=W,Q=G/U.length,z=j-$,H=W.packetsLost-W.lastPacketsLost,Y=z&&H?Math.round(100*H/(z+H)):0;return{mos:this.calculateMOS({avgJitter:Q,rtt:K,packetsLoss:Y}),stats:{avgJitter:Q,rtt:K,packetsLoss:Y}}}calculateInboundScore(F){var X,Z,ie,ee;const U=[...(X=F.audio)==null?void 0:X.inbound,...(Z=F.video)==null?void 0:Z.inbound];if(!U.length)return;const q=Te(this,Pe)[F.connection.id];if(!q)return;const V=[...(ie=q.video)==null?void 0:ie.inbound,...(ee=q.audio)==null?void 0:ee.inbound],{packetsReceived:j}=F.connection,$=q.connection.packetsReceived,W=U.reduce((te,re)=>{const ne=V.find(se=>se.ssrc===re.ssrc);return{sumJitter:te.sumJitter+re.jitter,packetsLost:te.packetsLost+re.packetsLost,lastPacketsLost:te.lastPacketsLost+((ne==null?void 0:ne.packetsLost)||0)}},{sumJitter:0,packetsLost:0,lastPacketsLost:0}),K=1e3*F.connection.currentRoundTripTime||0,{sumJitter:G}=W,Q=G/U.length,z=j-$,H=W.packetsLost-W.lastPacketsLost,Y=z&&H?Math.round(100*H/(z+H)):0;return{mos:this.calculateMOS({avgJitter:Q,rtt:K,packetsLoss:Y}),stats:{avgJitter:Q,rtt:K,packetsLoss:Y}}}calculateMOS({avgJitter:F,rtt:U,packetsLoss:q}){const V=U+2*F+10;let j=V<160?93.2-V/40:93.2-V/120-10;return j-=2.5*q,1+.035*j+7e-6*j*(j-60)*(100-j)}}Pe=new WeakMap;class y{constructor(F={}){xe(this,Ie,new Map);xe(this,Ge);xe(this,Ze);Me(this,Ge,F.statsCleanupTtlMs??35e3),Me(this,Ze,F.maxParsedStatsStorageSize??5)}detect(F,U){const q={...F,networkScores:{...U,statsSamples:(U==null?void 0:U.statsSamples)||{}}},V=this.performDetection(q);return this.setLastProcessedStats(F.connection.id,q),this.performPrevStatsCleanup({connectionId:F.connection.id}),V}performPrevStatsCleanup(F){const{connectionId:U,cleanupCallback:q}=F;Te(this,Ie).has(U)&&v({taskId:U,delayMs:Te(this,Ge),callback:()=>{this.deleteLastProcessedStats(U),typeof q=="function"&&q()}})}setLastProcessedStats(F,U){if(!F||U.connection.id!==F)return;const q=Te(this,Ie).get(F)??[];q.push(U),q.length>Te(this,Ze)&&q.shift(),Te(this,Ie).set(F,q)}getLastProcessedStats(F){const U=Te(this,Ie).get(F);return U==null?void 0:U[U.length-1]}getAllLastProcessedStats(F){return Te(this,Ie).get(F)??[]}deleteLastProcessedStats(F){Te(this,Ie).delete(F)}}Ie=new WeakMap,Ge=new WeakMap,Ze=new WeakMap;class w extends y{constructor(U={}){super(U);xe(this,et);Me(this,et,U.availableOutgoingBitrateThreshold??1e5)}performDetection(U){const q=[],{availableOutgoingBitrate:V}=U.connection;if(V===void 0)return q;const j=U.audio.outbound.reduce((K,G)=>K+G.targetBitrate,0),$=U.video.outbound.reduce((K,G)=>K+G.bitrate,0);if(!j&&!$)return q;const W={availableOutgoingBitrate:V,videoStreamsTotalBitrate:$,audioStreamsTotalTargetBitrate:j};return(j>V||$>0&&V<Te(this,et))&&q.push({statsSample:W,type:e.Network,reason:s.OutboundNetworkThroughput}),q}}et=new WeakMap;class b extends y{constructor(U={}){super();xe(this,tt);xe(this,it);xe(this,nt);xe(this,rt);Me(this,tt,U.highPacketLossThresholdPct??5),Me(this,it,U.highJitterThreshold??200),Me(this,nt,U.highJitterBufferDelayThresholdMs??500),Me(this,rt,U.highRttThresholdMs??250)}performDetection(U){return this.processData(U)}processData(U){var he,ae,ye,Ce;const q=[],V=[...(he=U.audio)==null?void 0:he.inbound,...(ae=U.video)==null?void 0:ae.inbound];if(!V.length)return q;const j=this.getLastProcessedStats(U.connection.id);if(!j)return q;const $=[...(ye=j.video)==null?void 0:ye.inbound,...(Ce=j.audio)==null?void 0:Ce.inbound],{packetsReceived:W}=U.connection,K=j.connection.packetsReceived,G=V.reduce((me,ke)=>{const Ee=$.find(Fe=>Fe.ssrc===ke.ssrc),_e=(Ee==null?void 0:Ee.jitterBufferDelay)||0,Oe=(Ee==null?void 0:Ee.jitterBufferEmittedCount)||0,Le=ke.jitterBufferDelay-_e,we=ke.jitterBufferEmittedCount-Oe,Ae=Le&&we?1e3*Le/we:0;return{sumJitter:me.sumJitter+ke.jitter,sumJitterBufferDelayMs:me.sumJitterBufferDelayMs+Ae,packetsLost:me.packetsLost+ke.packetsLost,lastPacketsLost:me.lastPacketsLost+((Ee==null?void 0:Ee.packetsLost)||0)}},{sumJitter:0,sumJitterBufferDelayMs:0,packetsLost:0,lastPacketsLost:0}),Q=1e3*U.connection.currentRoundTripTime||0,{sumJitter:z,sumJitterBufferDelayMs:H}=G,Y=z/V.length,X=H/V.length,Z=W-K,ie=G.packetsLost-G.lastPacketsLost,ee=Z&&ie?Math.round(100*ie/(Z+ie)):0,te=ee>Te(this,tt),re=Y>=Te(this,it),ne=Q>=Te(this,rt),se=X>Te(this,nt),oe=ne&&!re&&!te,fe=te&&re,pe=re&&se,le={rtt:Q,packetLossPct:ee,avgJitter:Y,avgJitterBufferDelay:X};return(re||te)&&q.push({statsSample:le,type:e.Network,reason:s.InboundNetworkQuality,iceCandidate:U.connection.local.id}),oe&&q.push({statsSample:le,type:e.Server,reason:s.ServerIssue,iceCandidate:U.connection.remote.id}),fe&&q.push({statsSample:le,type:e.Network,reason:s.InboundNetworkMediaLatency,iceCandidate:U.connection.local.id}),pe&&q.push({statsSample:le,type:e.Network,reason:s.NetworkMediaSyncFailure,iceCandidate:U.connection.local.id}),q}}tt=new WeakMap,it=new WeakMap,nt=new WeakMap,rt=new WeakMap;class P extends y{constructor(U={}){super();xe(this,st);Me(this,st,U.correctedSamplesThresholdPct??5)}performDetection(U){return this.processData(U)}processData(U){var $;const q=U.audio.inbound,V=[],j=($=this.getLastProcessedStats(U.connection.id))==null?void 0:$.audio.inbound;return j&&q.forEach(W=>{const K=j.find(Z=>Z.ssrc===W.ssrc);if(!K)return;const G=W.track.insertedSamplesForDeceleration+W.track.removedSamplesForAcceleration,Q=K.track.insertedSamplesForDeceleration+K.track.removedSamplesForAcceleration;if(G===Q)return;const z=W.track.totalSamplesReceived-K.track.totalSamplesReceived,H=G-Q,Y=Math.round(100*H/z),X={correctedSamplesPct:Y};Y>Te(this,st)&&V.push({statsSample:X,type:e.Network,reason:s.NetworkMediaSyncFailure,ssrc:W.ssrc})}),V}}st=new WeakMap;class T extends y{constructor(U={}){super();xe(this,ot);xe(this,at);Me(this,ot,U.highPacketLossThresholdPct??5),Me(this,at,U.highJitterThreshold??200)}performDetection(U){return this.processData(U)}processData(U){var ne,se,oe,fe;const q=[],V=[...((ne=U.remote)==null?void 0:ne.audio.inbound)||[],...((se=U.remote)==null?void 0:se.video.inbound)||[]];if(!V.length)return q;const j=this.getLastProcessedStats(U.connection.id);if(!j)return q;const $=[...((oe=j.remote)==null?void 0:oe.audio.inbound)||[],...((fe=j.remote)==null?void 0:fe.video.inbound)||[]],{packetsSent:W}=U.connection,K=j.connection.packetsSent,G=V.reduce((pe,le)=>{const he=$.find(ae=>ae.ssrc===le.ssrc);return{sumJitter:pe.sumJitter+le.jitter,packetsLost:pe.packetsLost+le.packetsLost,lastPacketsLost:pe.lastPacketsLost+((he==null?void 0:he.packetsLost)||0)}},{sumJitter:0,packetsLost:0,lastPacketsLost:0}),Q=1e3*U.connection.currentRoundTripTime||0,{sumJitter:z}=G,H=z/V.length,Y=W-K,X=G.packetsLost-G.lastPacketsLost,Z=Y&&X?Math.round(100*X/(Y+X)):0,ie=Z>Te(this,ot),ee=H>=Te(this,at),te=!ie&&ee||ee||ie,re={rtt:Q,avgJitter:H,packetLossPct:Z};return ie&&ee&&q.push({statsSample:re,type:e.Network,reason:s.OutboundNetworkMediaLatency,iceCandidate:U.connection.local.id}),te&&q.push({statsSample:re,type:e.Network,reason:s.OutboundNetworkQuality,iceCandidate:U.connection.local.id}),q}}ot=new WeakMap,at=new WeakMap;class L extends y{performDetection(F){return this.processData(F)}processData(F){var j;const U=F.video.outbound.filter($=>$.qualityLimitationReason!=="none"),q=[],V=(j=this.getLastProcessedStats(F.connection.id))==null?void 0:j.video.outbound;return V&&U.forEach($=>{const W=V.find(G=>G.ssrc===$.ssrc);if(!W)return;const K={qualityLimitationReason:$.qualityLimitationReason};$.framesSent>W.framesSent||($.qualityLimitationReason==="cpu"&&q.push({statsSample:K,type:e.CPU,reason:s.EncoderCPUThrottling,ssrc:$.ssrc}),$.qualityLimitationReason==="bandwidth"&&q.push({statsSample:K,type:e.Network,reason:s.OutboundNetworkThroughput,ssrc:$.ssrc}))}),q}}class D extends y{constructor(){super(...arguments);Ne(this,"UNKNOWN_DECODER","unknown");xe(this,Qe,{})}performDetection(U){return this.processData(U)}performPrevStatsCleanup(U){const{connectionId:q,cleanupCallback:V}=U;super.performPrevStatsCleanup({...U,cleanupCallback:()=>{delete Te(this,Qe)[q],typeof V=="function"&&V()}})}processData(U){var $;const q=[],{id:V}=U.connection,j=($=this.getLastProcessedStats(V))==null?void 0:$.video.inbound;return U.video.inbound.forEach(W=>{const{decoderImplementation:K,ssrc:G}=W;if(j==null?void 0:j.find(z=>z.ssrc===G))if(K===this.UNKNOWN_DECODER){if(!this.hadLastDecoderWithIssue(V,G)){this.setLastDecoderWithIssue(V,G,this.UNKNOWN_DECODER);const z={mimeType:W.mimeType,decoderImplementation:K};q.push({ssrc:G,statsSample:z,type:e.Stream,reason:s.UnknownVideoDecoderIssue,trackIdentifier:W.track.trackIdentifier})}}else this.setLastDecoderWithIssue(V,G,void 0)}),q}setLastDecoderWithIssue(U,q,V){const j=Te(this,Qe)[U]??{};V===void 0?delete j[q]:j[q]=V,Te(this,Qe)[U]=j}hadLastDecoderWithIssue(U,q){const V=Te(this,Qe)[U];return(V&&V[q])===this.UNKNOWN_DECODER}}Qe=new WeakMap;const C=B=>B.reduce((F,U)=>F+U,0)/B.length,R=(B,F,U=30)=>{var V,j,$,W,K;const q=[];for(let G=1;G<F.length-1;G+=1){const Q=(j=(V=F[G])==null?void 0:V.video)==null?void 0:j.inbound.find(X=>X.ssrc===B);if(!Q)continue;const z=(K=(W=($=F[G-1])==null?void 0:$.video)==null?void 0:W.inbound)==null?void 0:K.find(X=>X.ssrc===B);if(!Q||!z)continue;const H=Q.timestamp-z.timestamp,Y=Q.framesDecoded-z.framesDecoded;if(Y>0){const X=H/Y;q.push(X)}}return q.length<=1?!1:(G=>{const Q=((z,H)=>H.reduce((Y,X)=>Y+(X-z)**2,0)/H.length)(C(G),G);return Math.sqrt(Q)})(q)>U},M=(B,F)=>{for(let U=1;U<F.length;U+=1){const q=F[U].video.inbound.find(W=>W.ssrc===B);if(!q)continue;const V=F[U-1].video.inbound.find(W=>W.ssrc===B),j=q.frameWidth!==(V==null?void 0:V.frameWidth),$=q.frameHeight!==(V==null?void 0:V.frameHeight);if(j||$)return!0}return!1};class I extends y{constructor(U={}){super();xe(this,ct);xe(this,ut);xe(this,dt);Me(this,ct,U.avgFreezeDurationThresholdMs??1e3),Me(this,ut,U.frozenDurationThresholdPct??30),Me(this,dt,U.minMosQuality??n.BAD)}performDetection(U){const q=U.networkScores.inbound;return q!==void 0&&q<=Te(this,dt)?[]:this.processData(U)}processData(U){const q=[],V=this.getAllLastProcessedStats(U.connection.id);if(V.length===0)return[];const j=U.video.inbound.map($=>{const W=V[V.length-1].video.inbound.find(H=>H.ssrc===$.ssrc);if(!W||M($.ssrc,[V[V.length-1],U])||R($.ssrc,V))return;const K=$.freezeCount-(W.freezeCount??0),G=1e3*($.totalFreezesDuration-(W.totalFreezesDuration??0)),Q=K>0?G/K:0,z=G/($.timestamp-W.timestamp)*100;return z>Te(this,ut)||Q>Te(this,ct)?{ssrc:$.ssrc,avgFreezeDurationMs:Q,frozenDurationPct:z}:void 0}).filter($=>$!==void 0);return j.length>0&&(q.push({type:e.Stream,reason:s.FrozenVideoTrack,statsSample:{ssrcs:j.map($=>$.ssrc)}}),this.deleteLastProcessedStats(U.connection.id)),q}}ct=new WeakMap,ut=new WeakMap,dt=new WeakMap;class E extends y{constructor(U={}){super(U);xe(this,lt);xe(this,ht);xe(this,ft);Me(this,lt,U.volatilityThreshold??8),Me(this,ht,U.affectedStreamsPercentThreshold??30),Me(this,ft,U.minMosQuality??n.BAD)}performDetection(U){return[...this.getAllLastProcessedStats(U.connection.id),U].find(q=>q.networkScores.inbound!==void 0&&q.networkScores.inbound<=Te(this,ft))?[]:this.processData(U)}processData(U){const q=[],V=[...this.getAllLastProcessedStats(U.connection.id),U],j=U.video.inbound.map(W=>{if(V.length<5||M(W.ssrc,V))return;const K=[];for(let Q=0;Q<V.length-1;Q+=1){const z=V[Q].video.inbound.find(H=>H.ssrc===W.ssrc);(z==null?void 0:z.framesPerSecond)!==void 0&&K.push(z.framesPerSecond)}if(K.length<5||R(W.ssrc,V))return;const G=(Q=>{if(Q.length===0)throw new Error("Cannot calculate volatility for empty array");const z=C(Q);return Q.reduce((H,Y)=>H+Math.abs(Y-z),0)/Q.length*100/z})(K);return G>Te(this,lt)?{ssrc:W.ssrc,allFps:K,volatility:G}:void 0}).filter(W=>!!W);if(j.length===0)return q;const $=j.length/(U.video.inbound.length/100);return $>Te(this,ht)&&(q.push({type:e.CPU,reason:s.DecoderCPUThrottling,statsSample:{affectedStreamsPercent:$,throtthedStreams:j}}),this.deleteLastProcessedStats(U.connection.id)),q}}lt=new WeakMap,ht=new WeakMap,ft=new WeakMap;const N=B=>B.iceConnectionState==="closed"||B.connectionState==="closed",_=(B,F,U)=>8*((q,V,j)=>{if(!V)return 0;const $=q[j],W=V[j];if($==null||W==null)return 0;const K=Math.floor(q.timestamp)-Math.floor(V.timestamp);return K===0?0:(Number($)-Number(W))/K*1e3})(B,F,U);class A{constructor(F){Ne(this,"connections",[]);Ne(this,"statsParser");this.statsParser=F.statsParser}listConnections(){return[...this.connections]}addPeerConnection(F){this.connections.push({id:F.id??String(Date.now()+Math.random().toString(32)),pc:F.pc})}removePeerConnection(F){const U=this.connections.findIndex(({pc:q})=>q===F.pc);U>=0&&this.removeConnectionsByIndexes([U])}async parse(){const F=[],U=this.connections.map(async(q,V)=>{if(!N(q.pc))return this.statsParser.parse(q);F.unshift(V)});return F.length&&this.removeConnectionsByIndexes(F),(await Promise.all(U)).filter(q=>q!==void 0)}removeConnectionsByIndexes(F){F.forEach(U=>{this.connections.splice(U,1)})}}class O{constructor(F){Ne(this,"prevStats",new Map);Ne(this,"allowedReportTypes",new Set(["candidate-pair","inbound-rtp","outbound-rtp","remote-outbound-rtp","remote-inbound-rtp","track","transport"]));Ne(this,"ignoreSSRCList");Ne(this,"logger");this.ignoreSSRCList=F.ignoreSSRCList??[],this.logger=F.logger}get previouslyParsedStatsConnectionsIds(){return[...this.prevStats.keys()]}async parse(F){if(!N(F.pc))return this.getConnectionStats(F);this.logger.debug("Skip stats parsing. Connection is closed.",{connection:F})}async getConnectionStats(F){const{pc:U,id:q}=F;try{const V=Date.now(),j=U.getReceivers().filter(G=>{var Q;return(Q=G.track)==null?void 0:Q.enabled}),$=U.getSenders().filter(G=>{var Q;return(Q=G.track)==null?void 0:Q.enabled}),W=await Promise.all(j.map(G=>G.getStats())),K=await Promise.all($.map(G=>G.getStats()));return{id:q,stats:this.mapReportsStats([...W,...K],F),timeTaken:Date.now()-V}}catch(V){return void this.logger.error("Failed to get stats for PC",{id:q,pc:U,error:V})}}mapReportsStats(F,U){const q={audio:{inbound:[],outbound:[]},video:{inbound:[],outbound:[]},connection:{},remote:{video:{inbound:[],outbound:[]},audio:{inbound:[],outbound:[]}}};F.forEach($=>{$.forEach(W=>{this.allowedReportTypes.has(W.type)&&this.updateMappedStatsWithReportItemData(W,q,$)})});const{id:V}=U,j=this.prevStats.get(V);return j&&this.propagateStatsWithRateValues(q,j.stats),this.prevStats.set(V,{stats:q,ts:Date.now()}),v({taskId:V,delayMs:35e3,callback:()=>this.prevStats.delete(V)}),q}updateMappedStatsWithReportItemData(F,U,q){const V=F.type;if(V==="candidate-pair"&&F.state==="succeeded"&&F.nominated)return void(U.connection=this.prepareConnectionStats(F,q));const j=this.getMediaType(F);if(!j)return;const $=F.ssrc;if(!$||!this.ignoreSSRCList.includes($))if(V!=="outbound-rtp")if(V!=="inbound-rtp")V!=="remote-outbound-rtp"?V==="remote-inbound-rtp"&&(this.mapConnectionStatsIfNecessary(U,F,q),U.remote[j].inbound.push({...F})):U.remote[j].outbound.push({...F});else{const W=q.get(F.trackId)||q.get(F.mediaSourceId)||{};this.mapConnectionStatsIfNecessary(U,F,q);const K={...F,track:{...W}};U[j].inbound.push(K)}else{const W=q.get(F.trackId)||q.get(F.mediaSourceId)||{},K={...F,track:{...W}};U[j].outbound.push(K)}}getMediaType(F){const U=F.mediaType||F.kind;if(!["audio","video"].includes(U)){const{id:q}=F;return q?String(q).includes("Video")?"video":String(q).includes("Audio")?"audio":void 0:void 0}return U}propagateStatsWithRateValues(F,U){F.audio.inbound.forEach(q=>{const V=U.audio.inbound.find(({id:j})=>j===q.id);q.bitrate=_(q,V,"bytesReceived"),q.packetRate=_(q,V,"packetsReceived")}),F.audio.outbound.forEach(q=>{const V=U.audio.outbound.find(({id:j})=>j===q.id);q.bitrate=_(q,V,"bytesSent"),q.packetRate=_(q,V,"packetsSent")}),F.video.inbound.forEach(q=>{const V=U.video.inbound.find(({id:j})=>j===q.id);q.bitrate=_(q,V,"bytesReceived"),q.packetRate=_(q,V,"packetsReceived")}),F.video.outbound.forEach(q=>{const V=U.video.outbound.find(({id:j})=>j===q.id);q.bitrate=_(q,V,"bytesSent"),q.packetRate=_(q,V,"packetsSent")})}mapConnectionStatsIfNecessary(F,U,q){if(F.connection.id||!U.transportId)return;const V=q.get(U.transportId);if(V&&V.selectedCandidatePairId){const j=q.get(V.selectedCandidatePairId);F.connection=this.prepareConnectionStats(j,q)}}prepareConnectionStats(F,U){if(!F||!U)return{};const q={...F};if(q.remoteCandidateId){const V=U.get(q.remoteCandidateId);q.remote={...V}}if(q.localCandidateId){const V=U.get(q.localCandidateId);q.local={...V}}return q}}const gt=class gt extends y{constructor(U={}){super();xe(this,Je,new Map);xe(this,ze);xe(this,He);Me(this,ze,U.timeoutMs??15e3),Me(this,He,U.steps??3)}performDetection(U){return this.processData(U)}processData(U){const q=[],V=[...this.getAllLastProcessedStats(U.connection.id),U];if(V.length<Te(this,He))return q;const j=V.slice(-Te(this,He)),$=j.map(K=>K.video.inbound),W=j.map(K=>K.audio.inbound);return q.push(...this.detectMissingData(W,e.Stream,s.MissingAudioStreamData)),q.push(...this.detectMissingData($,e.Stream,s.MissingVideoStreamData)),new Set(Te(this,Je).keys()).forEach(K=>{const G=Te(this,Je).get(K);G&&Date.now()-G>Te(this,ze)&&this.removeMarkedIssue(K)}),q}detectMissingData(U,q,V){const j=[],$=U.pop(),W=gt.mapStatsByTrackId(U);return $.forEach(K=>{const G=K.track.trackIdentifier,Q=W.get(G);if(!Array.isArray(Q)||Q.length===0||K.track.detached||K.track.ended)return;if(!gt.isAllBytesReceivedDidntChange(K.bytesReceived,Q))return void this.removeMarkedIssue(G);if(!this.markIssue(G))return;const z={bytesReceived:K.bytesReceived};j.push({type:q,reason:V,statsSample:z,trackIdentifier:G})}),j}static mapStatsByTrackId(U){const q=new Map;return U.forEach(V=>{V.forEach(j=>{const $=q.get(j.track.trackIdentifier)||[];$.push(j),q.set(j.track.trackIdentifier,$)})}),q}static isAllBytesReceivedDidntChange(U,q){for(let V=0;V<q.length;V+=1)if(q[V].bytesReceived!==U)return!1;return!0}markIssue(U){const q=Date.now(),V=Te(this,Je).get(U);return(!V||q-V>Te(this,ze))&&(Te(this,Je).set(U,q),!0)}removeMarkedIssue(U){Te(this,Je).delete(U)}};Je=new WeakMap,ze=new WeakMap,He=new WeakMap;let J=gt;class x{constructor(F){Ne(this,"eventEmitter");xe(this,Ke,!1);Ne(this,"detectors",[]);Ne(this,"networkScoresCalculator");Ne(this,"statsReporter");Ne(this,"compositeStatsParser");Ne(this,"logger");Ne(this,"autoAddPeerConnections");this.logger=F.logger??{debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},this.eventEmitter=F.issueEmitter??new g,F.onIssues&&this.eventEmitter.on(t.Issue,F.onIssues),F.onNetworkScoresUpdated&&this.eventEmitter.on(t.NetworkScoresUpdated,F.onNetworkScoresUpdated),this.detectors=F.detectors??[new L,new b,new T,new P,new w,new D,new I,new E,new J],this.networkScoresCalculator=F.networkScoresCalculator??new k,this.compositeStatsParser=F.compositeStatsParser??new A({statsParser:new O({ignoreSSRCList:F.ignoreSSRCList,logger:this.logger})}),this.statsReporter=F.statsReporter??new S({compositeStatsParser:this.compositeStatsParser,getStatsInterval:F.getStatsInterval??5e3}),window.wid=this,this.autoAddPeerConnections=F.autoAddPeerConnections??!0,this.autoAddPeerConnections&&this.wrapRTCPeerConnection(),this.statsReporter.on(S.STATS_REPORT_READY_EVENT,U=>{const q=this.calculateNetworkScores(U.stats);this.detectIssues({data:U.stats},q)}),this.statsReporter.on(S.STATS_REPORTS_PARSED,U=>{const q={timeTaken:U.timeTaken,ts:Date.now()};F.onStats&&F.onStats(U.reportItems),this.eventEmitter.emit(t.StatsParsingFinished,q)})}watchNewPeerConnections(){if(!this.autoAddPeerConnections)throw new Error("Auto add peer connections was disabled in the constructor.");Te(this,Ke)?this.logger.warn("WebRTCIssueDetector is already started. Skip processing"):(this.logger.info("Start watching peer connections"),Me(this,Ke,!0),this.statsReporter.startReporting())}stopWatchingNewPeerConnections(){Te(this,Ke)?(this.logger.info("Stop watching peer connections"),Me(this,Ke,!1),this.statsReporter.stopReporting()):this.logger.warn("WebRTCIssueDetector is already stopped. Skip processing")}handleNewPeerConnection(F,U){Te(this,Ke)||!this.autoAddPeerConnections?(Te(this,Ke)||this.autoAddPeerConnections!==!1||(this.logger.info("Starting stats reporting for new peer connection"),Me(this,Ke,!0),this.statsReporter.startReporting()),this.logger.debug("Handling new peer connection",F),this.compositeStatsParser.addPeerConnection({pc:F,id:U})):this.logger.debug("Skip handling new peer connection. Detector is not running",F)}emitIssues(F){this.eventEmitter.emit(t.Issue,F)}detectIssues({data:F},U){const q=this.detectors.reduce((V,j)=>[...V,...j.detect(F,U)],[]);q.length>0&&this.emitIssues(q)}calculateNetworkScores(F){const U=this.networkScoresCalculator.calculate(F);return this.eventEmitter.emit(t.NetworkScoresUpdated,U),U}wrapRTCPeerConnection(){if(!window.RTCPeerConnection)return void this.logger.warn("No RTCPeerConnection found in browser window. Skipping");const F=window.RTCPeerConnection,U=V=>this.handleNewPeerConnection(V);function q(V){const j=new F(V);return U(j),j}q.prototype=F.prototype,window.RTCPeerConnection=q}}Ke=new WeakMap;var WebRTCConnectionQualityIndicator=function(B){__extends(F,B);function F(){var U=B!==null&&B.apply(this,arguments)||this;return U.issueDetector=null,U.mosScores=null,U}return F.prototype._start=function(U){var q=this;this.issueDetector=new x({autoAddPeerConnections:!1,getStatsInterval:3e3,onNetworkScoresUpdated:function(V){q.mosScores=V,q.handleStatsChanged()}}),this.issueDetector.handleNewPeerConnection(U)},F.prototype._stop=function(){this.issueDetector&&(this.issueDetector.stopWatchingNewPeerConnections(),this.issueDetector=null),this.mosScores=null},F.prototype.calculateConnectionQuality=function(){return!this.mosScores||this.mosScores.inbound&&this.mosScores.outbound?ConnectionQuality.UNKNOWN:this.mosScores.inbound&&this.mosScores.inbound<3||this.mosScores.outbound&&this.mosScores.outbound<3?ConnectionQuality.BAD:ConnectionQuality.GOOD},F}(AbstractConnectionQualityIndicator),VoiceChatState;(function(B){B.INACTIVE="inactive",B.STARTING="starting",B.ACTIVE="started",B.STOPPING="stopping"})(VoiceChatState||(VoiceChatState={}));var AbstractVoiceChat=function(){function B(){}return B}(),AbstractVoiceChatImplementation=function(B){__extends(F,B);function F(){var U=B!==null&&B.apply(this,arguments)||this;return U._isMuted=!0,U.state=VoiceChatState.INACTIVE,U}return Object.defineProperty(F.prototype,"isMuted",{get:function(){return this._isMuted},enumerable:!1,configurable:!0}),Object.defineProperty(F.prototype,"isVoiceChatting",{get:function(){return this.state!==VoiceChatState.INACTIVE},enumerable:!1,configurable:!0}),F.prototype.startVoiceChat=function(U){return __awaiter(this,void 0,void 0,function(){var q;return __generator(this,function(V){switch(V.label){case 0:return this.state===VoiceChatState.INACTIVE?[3,2]:[4,this.stopVoiceChat()];case 1:V.sent(),V.label=2;case 2:return V.trys.push([2,4,,6]),this.state=VoiceChatState.STARTING,[4,this._startVoiceChat(U)];case 3:return V.sent(),this.state=VoiceChatState.ACTIVE,[3,6];case 4:return q=V.sent(),[4,this.stopVoiceChat()];case 5:throw V.sent(),q;case 6:return[2]}})})},F.prototype.stopVoiceChat=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(U){switch(U.label){case 0:return this.state===VoiceChatState.INACTIVE?[2]:(this.state=VoiceChatState.STOPPING,[4,this._stopVoiceChat()]);case 1:return U.sent(),this._isMuted=!0,this.state=VoiceChatState.INACTIVE,[2]}})})},F.prototype._mute=function(){},F.prototype._unmute=function(){},F.prototype.mute=function(){this.isVoiceChatting&&(this._mute(),this._isMuted=!0)},F.prototype.unmute=function(){this.isVoiceChatting&&(this._unmute(),this._isMuted=!1)},F}(AbstractVoiceChat);function sleep(B){return new Promise(function(F){return setTimeout(F,B)})}function convertFloat32ToS16PCM(B){for(var F=new Int16Array(B.length),U=0;U<B.length;U++){var q=Math.max(-1,Math.min(1,B[U]));F[U]=q<0?q*32768:q*32767}return F}var LivekitVoiceChat=function(B){__extends(F,B);function F(){var U=B!==null&&B.apply(this,arguments)||this;return U.room=null,U.track=null,U}return F.prototype._startVoiceChat=function(U){return __awaiter(this,void 0,void 0,function(){var q,V;return __generator(this,function(j){switch(j.label){case 0:return this.room=U.room,q=this,[4,createLocalAudioTrack({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0})];case 1:return q.track=j.sent(),[4,this.room.localParticipant.publishTrack(this.track)];case 2:return j.sent(),!((V=U.config)===null||V===void 0)&&V.defaultMuted?this.mute():this.unmute(),[4,sleep(4e3)];case 3:return j.sent(),[2]}})})},F.prototype._stopVoiceChat=function(){return __awaiter(this,void 0,void 0,function(){var U;return __generator(this,function(q){return!((U=this.room)===null||U===void 0)&&U.localParticipant&&this.room.localParticipant.getTrackPublications().forEach(function(V){V.track&&V.track.kind===Track.Kind.Audio&&V.track.stop()}),this.track&&(this.track.stop(),this.track=null),[2]})})},F.prototype._mute=function(){this.track&&!this.track.isMuted&&this.track.mute()},F.prototype._unmute=function(){this.track&&this.track.isMuted&&this.track.unmute()},F}(AbstractVoiceChatImplementation),WebSocketVoiceChat=function(B){__extends(F,B);function F(){var U=B!==null&&B.apply(this,arguments)||this;return U.audioContext=null,U.webSocket=null,U.scriptProcessor=null,U.mediaStreamAudioSource=null,U.mediaDevicesStream=null,U.audioRawFrame=null,U}return F.prototype._startVoiceChat=function(U){return __awaiter(this,void 0,void 0,function(){var q,V=this,j,$,W,K;return __generator(this,function(G){switch(G.label){case 0:if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Cannot start voice chat without media devices");return this.webSocket=U.webSocket,this.audioRawFrame=U.audioRawFrame,this.audioContext=new window.AudioContext({latencyHint:"interactive",sampleRate:16e3}),!((j=U.config)===null||j===void 0)&&j.defaultMuted||this.unmute(),[4,navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}})];case 1:return q=G.sent(),this.mediaDevicesStream=q,this.mediaStreamAudioSource=($=this.audioContext)===null||$===void 0?void 0:$.createMediaStreamSource(q),this.scriptProcessor=(W=this.audioContext)===null||W===void 0?void 0:W.createScriptProcessor(512,1,1),this.mediaStreamAudioSource.connect(this.scriptProcessor),this.scriptProcessor.connect((K=this.audioContext)===null||K===void 0?void 0:K.destination),this.scriptProcessor.onaudioprocess=function(Q){var z;if(!(!V.webSocket||!V.audioRawFrame)){var H;V.isMuted?H=new Float32Array(512):H=Q.inputBuffer.getChannelData(0);var Y=convertFloat32ToS16PCM(H),X=new Uint8Array(Y.buffer),Z=V.audioRawFrame.create({audio:{audio:Array.from(X),sampleRate:16e3,numChannels:1}}),ie=new Uint8Array(V.audioRawFrame.encode(Z).finish());(z=V.webSocket)===null||z===void 0||z.send(ie)}},[4,sleep(2e3)];case 2:return G.sent(),[2]}})})},F.prototype._stopVoiceChat=function(){return __awaiter(this,void 0,void 0,function(){var U,q;return __generator(this,function(V){return this.audioContext&&(this.audioContext=null),this.scriptProcessor&&(this.scriptProcessor.disconnect(),this.scriptProcessor=null),this.mediaStreamAudioSource&&(this.mediaStreamAudioSource.disconnect(),this.mediaStreamAudioSource=null),this.mediaDevicesStream&&((q=(U=this.mediaDevicesStream)===null||U===void 0?void 0:U.getTracks())===null||q===void 0||q.forEach(function(j){return j.stop()}),this.mediaDevicesStream=null),[2]})})},F}(AbstractVoiceChatImplementation),VoiceChatTransport;(function(B){B.LIVEKIT="livekit",B.WEBSOCKET="websocket"})(VoiceChatTransport||(VoiceChatTransport={}));var VoiceChatFactory=function(B){__extends(F,B);function F(U){var q=U.voiceChatInstance,V=U.initialConfig,j=B.call(this)||this;return j.initialConfig=V,j.voiceChat=q,j}return Object.defineProperty(F.prototype,"isMuted",{get:function(){return this.voiceChat.isMuted},enumerable:!1,configurable:!0}),Object.defineProperty(F.prototype,"isVoiceChatting",{get:function(){return this.voiceChat.isVoiceChatting},enumerable:!1,configurable:!0}),F.prototype.startVoiceChat=function(U){return __awaiter(this,arguments,void 0,function(q){var V=q.config;return __generator(this,function(j){switch(j.label){case 0:return[4,this.voiceChat.startVoiceChat(__assign(__assign({},this.initialConfig),{config:V}))];case 1:return j.sent(),[2]}})})},F.prototype.stopVoiceChat=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(U){switch(U.label){case 0:return[4,this.voiceChat.stopVoiceChat()];case 1:return U.sent(),[2]}})})},F.prototype.mute=function(){this.voiceChat.mute()},F.prototype.unmute=function(){this.voiceChat.unmute()},F.createLiveKitVoiceChat=function(U){return new this({voiceChatInstance:new LivekitVoiceChat,initialConfig:U})},F.createWebSocketVoiceChat=function(U){return new this({voiceChatInstance:new WebSocketVoiceChat,initialConfig:U})},F}(AbstractVoiceChat),AvatarQuality;(function(B){B.Low="low",B.Medium="medium",B.High="high"})(AvatarQuality||(AvatarQuality={}));var VoiceEmotion;(function(B){B.EXCITED="excited",B.SERIOUS="serious",B.FRIENDLY="friendly",B.SOOTHING="soothing",B.BROADCASTER="broadcaster"})(VoiceEmotion||(VoiceEmotion={}));var ElevenLabsModel;(function(B){B.eleven_flash_v2_5="eleven_flash_v2_5",B.eleven_multilingual_v2="eleven_multilingual_v2"})(ElevenLabsModel||(ElevenLabsModel={}));var STTProvider;(function(B){B.DEEPGRAM="deepgram",B.GLADIA="gladia"})(STTProvider||(STTProvider={}));var TaskType;(function(B){B.TALK="talk",B.REPEAT="repeat"})(TaskType||(TaskType={}));var TaskMode;(function(B){B.SYNC="sync",B.ASYNC="async"})(TaskMode||(TaskMode={}));var StreamingEvents;(function(B){B.AVATAR_START_TALKING="avatar_start_talking",B.AVATAR_STOP_TALKING="avatar_stop_talking",B.AVATAR_TALKING_MESSAGE="avatar_talking_message",B.AVATAR_END_MESSAGE="avatar_end_message",B.USER_TALKING_MESSAGE="user_talking_message",B.USER_END_MESSAGE="user_end_message",B.USER_START="user_start",B.USER_STOP="user_stop",B.USER_SILENCE="user_silence",B.STREAM_READY="stream_ready",B.STREAM_DISCONNECTED="stream_disconnected",B.CONNECTION_QUALITY_CHANGED="connection_quality_changed"})(StreamingEvents||(StreamingEvents={}));var APIError=function(B){__extends(F,B);function F(U,q,V){var j=B.call(this,U)||this;return j.name="APIError",j.status=q,j.responseText=V,j}return F}(Error),ConnectionQualityIndicatorClass=QualityIndicatorMixer({TrackerClass:LiveKitConnectionQualityIndicator,getParams:function(B){return B}},{TrackerClass:WebRTCConnectionQualityIndicator,getParams:function(B){var F;return((F=B.engine.pcManager)===null||F===void 0?void 0:F.subscriber)._pc}}),StreamingAvatar=function(){function B(F){var U=F.token,q=F.basePath,V=q===void 0?"https://api.heygen.com":q,j=this;this.room=null,this.mediaStream=null,this.eventTarget=new EventTarget,this.webSocket=null,this.sessionId=null,this.voiceChat=null,this.isLiveKitTransport=!1,this.token=U,this.basePath=V,this.connectionQualityIndicator=new ConnectionQualityIndicatorClass(function($){return j.emit(StreamingEvents.CONNECTION_QUALITY_CHANGED,$)})}return Object.defineProperty(B.prototype,"connectionQuality",{get:function(){return this.connectionQualityIndicator.connectionQuality},enumerable:!1,configurable:!0}),Object.defineProperty(B.prototype,"isInputAudioMuted",{get:function(){var F,U;return(U=(F=this.voiceChat)===null||F===void 0?void 0:F.isMuted)!==null&&U!==void 0?U:!0},enumerable:!1,configurable:!0}),B.prototype.muteInputAudio=function(){var F;(F=this.voiceChat)===null||F===void 0||F.mute()},B.prototype.unmuteInputAudio=function(){var F;(F=this.voiceChat)===null||F===void 0||F.unmute()},B.prototype.createStartAvatar=function(F){return __awaiter(this,void 0,void 0,function(){var U;return __generator(this,function(q){switch(q.label){case 0:return[4,this.newSession(F)];case 1:return U=q.sent(),[2,this.startAvatar(F,U)]}})})},B.prototype.startAvatar=function(F,U){return __awaiter(this,void 0,void 0,function(){var q,V,j=this;return __generator(this,function($){switch($.label){case 0:this.sessionId=U.session_id,this.isLiveKitTransport=F.voiceChatTransport===VoiceChatTransport.LIVEKIT,q=new Room({adaptiveStream:!0,dynacast:!0,videoCaptureDefaults:{resolution:VideoPresets.h720.resolution}}),this.room=q,this.mediaStream=null,q.on(RoomEvent.DataReceived,function(W){var K=null;try{var G=new TextDecoder().decode(W);K=JSON.parse(G)}catch(Q){console.error(Q)}K&&j.emit(K.type,K)}),V=new MediaStream,q.on(RoomEvent.TrackSubscribed,function(W){if(W.kind==="video"||W.kind==="audio"){V.addTrack(W.mediaStreamTrack);var K=V.getVideoTracks().length>0,G=V.getAudioTracks().length>0;K&&G&&!j.mediaStream&&(j.mediaStream=V,j.emit(StreamingEvents.STREAM_READY,j.mediaStream))}}),q.on(RoomEvent.TrackUnsubscribed,function(W){var K=W.mediaStreamTrack;K&&V.removeTrack(K)}),q.on(RoomEvent.Disconnected,function(W){j.emit(StreamingEvents.STREAM_DISCONNECTED,W)}),$.label=1;case 1:return $.trys.push([1,3,,4]),[4,q.prepareConnection(U.url,U.access_token)];case 2:return $.sent(),[3,4];case 3:return $.sent(),[3,4];case 4:return[4,this.startSession()];case 5:return $.sent(),[4,q.connect(U.url,U.access_token)];case 6:return $.sent(),[4,this.connectWebSocket({useSilencePrompt:!!F.useSilencePrompt})];case 7:return $.sent(),this.initVoiceChat(F.voiceChatTransport||VoiceChatTransport.WEBSOCKET),this.connectionQualityIndicator.start(q),[2,U]}})})},B.prototype.startVoiceChat=function(){return __awaiter(this,arguments,void 0,function(F){var U,q=F===void 0?{}:F,V=q.isInputAudioMuted;return __generator(this,function(j){switch(j.label){case 0:return[4,(U=this.voiceChat)===null||U===void 0?void 0:U.startVoiceChat({config:{defaultMuted:V}})];case 1:return j.sent(),[2]}})})},B.prototype.closeVoiceChat=function(){return __awaiter(this,void 0,void 0,function(){var F;return __generator(this,function(U){switch(U.label){case 0:return[4,(F=this.voiceChat)===null||F===void 0?void 0:F.stopVoiceChat()];case 1:return U.sent(),[2]}})})},B.prototype.newSession=function(F){return __awaiter(this,void 0,void 0,function(){var U,q,V,j,$;return __generator(this,function(W){return[2,this.request("/v1/streaming.new",{avatar_name:F.avatarName,quality:F.quality,knowledge_base_id:F.knowledgeId,knowledge_base:F.knowledgeBase,voice:{voice_id:(U=F.voice)===null||U===void 0?void 0:U.voiceId,rate:(q=F.voice)===null||q===void 0?void 0:q.rate,emotion:(V=F.voice)===null||V===void 0?void 0:V.emotion,elevenlabs_settings:__assign(__assign({},(j=F==null?void 0:F.voice)===null||j===void 0?void 0:j.elevenlabsSettings),{model_id:($=F.voice)===null||$===void 0?void 0:$.model})},language:F.language,version:"v2",video_encoding:"H264",source:"sdk",disable_idle_timeout:F.disableIdleTimeout,stt_settings:F.sttSettings,ia_is_livekit_transport:F.voiceChatTransport===VoiceChatTransport.LIVEKIT,silence_response:F.useSilencePrompt,activity_idle_timeout:F.activityIdleTimeout})]})})},B.prototype.startSession=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(F){return[2,this.request("/v1/streaming.start",{session_id:this.sessionId})]})})},B.prototype.speak=function(F){return __awaiter(this,void 0,void 0,function(){var U,q;return __generator(this,function(V){if(U=F.taskType||F.task_type||TaskType.TALK,q=F.taskMode||TaskMode.ASYNC,U===TaskType.TALK&&q===TaskMode.ASYNC){if(this.isLiveKitTransport&&this.room)return this.sendLivekitMessage(F.text),[2];if(!this.isLiveKitTransport&&this.webSocket&&this.audioRawFrame)return this.sendWebsocketMessage(F.text),[2]}return[2,this.request("/v1/streaming.task",{text:F.text,session_id:this.sessionId,task_mode:F.taskMode,task_type:F.taskType})]})})},B.prototype.startListening=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(F){return[2,this.request("/v1/streaming.start_listening",{session_id:this.sessionId})]})})},B.prototype.stopListening=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(F){return[2,this.request("/v1/streaming.stop_listening",{session_id:this.sessionId})]})})},B.prototype.interrupt=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(F){return[2,this.request("/v1/streaming.interrupt",{session_id:this.sessionId})]})})},B.prototype.stopAvatar=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(F){return this.closeVoiceChat(),this.connectionQualityIndicator.stop(),this.voiceChat=null,this.webSocket&&(this.webSocket.close(),this.webSocket=null),[2,this.request("/v1/streaming.stop",{session_id:this.sessionId})]})})},B.prototype.keepAlive=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(F){return[2,this.request("/v1/streaming.keep_alive",{session_id:this.sessionId})]})})},B.prototype.on=function(F,U){return this.eventTarget.addEventListener(F,U),this},B.prototype.off=function(F,U){return this.eventTarget.removeEventListener(F,U),this},B.prototype.sendLivekitMessage=function(F){return __awaiter(this,void 0,void 0,function(){var U;return __generator(this,function(q){return this.room?(U=new TextEncoder().encode(JSON.stringify(F)),this.room.localParticipant.publishData(U,{reliable:!0}),[2]):[2]})})},B.prototype.sendWebsocketMessage=function(F){return __awaiter(this,void 0,void 0,function(){var U,q,V,j;return __generator(this,function($){return!this.webSocket||!this.audioRawFrame?[2]:(U=(V=this.audioRawFrame)===null||V===void 0?void 0:V.create({text:{text:F}}),q=new Uint8Array((j=this.audioRawFrame)===null||j===void 0?void 0:j.encode(U).finish()),this.webSocket.send(q),[2])})})},B.prototype.initVoiceChat=function(F){if(F===VoiceChatTransport.WEBSOCKET){if(this.loadAudioRawFrame(),!this.audioRawFrame||!this.webSocket)return;this.voiceChat=VoiceChatFactory.createWebSocketVoiceChat({webSocket:this.webSocket,audioRawFrame:this.audioRawFrame})}else{if(!this.room)return;this.voiceChat=VoiceChatFactory.createLiveKitVoiceChat({room:this.room})}},B.prototype.request=function(F,U,q){return __awaiter(this,void 0,void 0,function(){var V,j,$,W;return __generator(this,function(K){switch(K.label){case 0:return K.trys.push([0,5,,6]),[4,fetch(this.getRequestUrl(F),{method:"POST",headers:{Authorization:"Bearer ".concat(this.token),"Content-Type":"application/json"},body:JSON.stringify(U)})];case 1:return V=K.sent(),V.ok?[3,3]:[4,V.text()];case 2:throw j=K.sent(),new APIError("API request failed with status ".concat(V.status),V.status,j);case 3:return[4,V.json()];case 4:return $=K.sent(),[2,$.data];case 5:throw W=K.sent(),W;case 6:return[2]}})})},B.prototype.emit=function(F,U){var q=new CustomEvent(F,{detail:U});this.eventTarget.dispatchEvent(q)},B.prototype.getRequestUrl=function(F){return"".concat(this.basePath).concat(F)},B.prototype.connectWebSocket=function(F){return __awaiter(this,void 0,void 0,function(){var U,q=this;return __generator(this,function(V){return U="wss://".concat(new URL(this.basePath).hostname,"/v1/ws/streaming.chat?session_id=").concat(this.sessionId,"&session_token=").concat(this.token).concat(this.isLiveKitTransport?"&arch_version=v2":"","&silence_response=").concat(F.useSilencePrompt),this.webSocket=new WebSocket(U),this.webSocket.addEventListener("message",function(j){var $=null;try{$=JSON.parse(j.data)}catch(W){console.error(W);return}$&&q.emit($.event_type,$)}),this.webSocket.addEventListener("close",function(j){q.webSocket=null}),[2,new Promise(function(j,$){var W,K;(W=q.webSocket)===null||W===void 0||W.addEventListener("error",function(G){q.webSocket=null,$(G)}),(K=q.webSocket)===null||K===void 0||K.addEventListener("open",function(){j(!0)})})]})})},B.prototype.loadAudioRawFrame=function(){return __awaiter(this,void 0,void 0,function(){var F;return __generator(this,function(U){return this.audioRawFrame||(F=protobuf.Root.fromJSON(jsonDescriptor),this.audioRawFrame=F==null?void 0:F.lookupType("pipecat.Frame")),[2]})})},B}();(async function(){async function B(){return(await(await fetch("/.netlify/functions/token",{method:"POST"})).json()).token}const F={token:await B(),avatarName:window.heygenAvatarId,quality:AvatarQuality.Low,logUrl:window.heygenAnalyticsEndpoint,clientId:window.heygenClientId};function U(q,V={}){F.logUrl&&fetch(F.logUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({eventType:q,clientId:F.clientId,sessionId:window._sessionId,...V})})}window.HeyGenAnalytics={async start(){const q=await B(),V=new StreamingAvatar({token:q});V.on(StreamingEvents.STREAM_READY,()=>U("stream_ready")),V.on(StreamingEvents.AVATAR_START_TALKING,()=>U("start_talking")),V.on(StreamingEvents.AVATAR_STOP_TALKING,()=>U("stop_talking")),V.on(StreamingEvents.STREAM_DISCONNECTED,()=>U("stream_disconnected"));const j=await V.createStartAvatar({avatarName:F.avatarName,quality:F.quality});window._avatarInstance=V,window._sessionId=j.session_id,U("session_started",{sessionId:j.session_id})},async speak(q){window._avatarInstance&&(await window._avatarInstance.speak({sessionId:window._sessionId,text:q}),U("speak",{text:q}))},async end(){window._avatarInstance&&(await window._avatarInstance.stopAvatar(),U("session_ended"))}}})()})();

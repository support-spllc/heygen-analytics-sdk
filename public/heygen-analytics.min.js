!function(t){let s={apiToken:"YTJhOTM3NDNlOTYyNDVhNGE0OWNkOTg0YzliYTJhYzctMTc0Mzk4NjEyNw==",analyticsEndpoint:"/.netlify/functions/log",clientId:t.heygenClientId||"client_"+Math.random().toString(36).substr(2,9),avatarName:"d0498c23d9154c4da2d899af45924fe2",quality:"medium",debug:!1};t.heygenAnalytics=new class s{constructor(s){this.config=s,this.avatar=null,this.sessionData={sessionId:null,startTime:null,endTime:null,interactions:[],errors:[],metadata:{userAgent:navigator.userAgent,timestamp:new Date().toISOString(),clientId:s.clientId,url:t.location.href}},this.isSessionActive=!1,this.loadSDK()}async loadSDK(){if(t.StreamingAvatar){this.initAvatar();return}let s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/@heygen/streaming-avatar@2.0.14/dist/index.umd.js",s.onload=()=>this.initAvatar(),s.onerror=()=>this.trackError("sdk_load_failed",Error("Failed to load HeyGen SDK")),document.head.appendChild(s)}initAvatar(){try{this.avatar=new t.StreamingAvatar({token:this.config.apiToken}),this.setupEventListeners(),this.log("Avatar SDK loaded successfully")}catch(s){this.trackError("avatar_init_failed",s)}}setupEventListeners(){this.avatar&&(this.avatar.on("avatar_start_talking",()=>{this.trackEvent("avatar_start_talking",{timestamp:Date.now()})}),this.avatar.on("avatar_stop_talking",()=>{this.trackEvent("avatar_stop_talking",{timestamp:Date.now()})}),this.avatar.on("stream_ready",()=>{this.trackEvent("stream_ready",{timestamp:Date.now()})}),this.avatar.on("stream_disconnected",t=>{this.trackEvent("stream_disconnected",{timestamp:Date.now(),reason:t?.reason})}))}async startSession(){if(!this.avatar)throw Error("Avatar SDK not loaded");try{this.sessionData.startTime=Date.now();let t=await this.avatar.createStartAvatar({avatarName:this.config.avatarName,quality:this.config.quality});return this.sessionData.sessionId=t.session_id,this.isSessionActive=!0,this.trackEvent("session_started",{sessionId:t.session_id,avatarName:this.config.avatarName,quality:this.config.quality}),t}catch(s){throw this.trackError("session_start_failed",s),s}}async speak(t,s={}){if(!this.isSessionActive)throw Error("Session not active");let a=Date.now();try{let e=await this.avatar.speak({sessionId:this.sessionData.sessionId,text:t,task_type:s.taskType||"REPEAT"}),i=Date.now()-a;return this.trackInteraction({type:"user_message",text:t,timestamp:a,responseTime:i,success:!0}),e}catch(n){throw this.trackError("speak_failed",n,{text:t,options:s}),n}}async endSession(){if(this.isSessionActive)try{this.sessionData.endTime=Date.now();let t=this.sessionData.endTime-this.sessionData.startTime,s=this.calculateMetrics(t);await this.sendAnalytics("session_complete",{...this.sessionData,duration:t,metrics:s}),this.avatar&&this.avatar.stopAvatar&&await this.avatar.stopAvatar(),this.isSessionActive=!1}catch(a){this.trackError("session_end_failed",a)}}calculateMetrics(t){let s=this.sessionData.interactions.filter(t=>"user_message"===t.type),a=this.sessionData.errors;return{totalDuration:t,totalInteractions:s.length,totalErrors:a.length,avgResponseTime:s.length>0?s.reduce((t,s)=>t+(s.responseTime||0),0)/s.length:0,errorRate:s.length>0?a.length/s.length:0}}trackInteraction(t){this.sessionData.interactions.push({...t,timestamp:t.timestamp||Date.now()}),this.sendAnalytics("interaction",t)}trackEvent(t,s){let a={type:t,data:s,timestamp:Date.now()};this.sessionData.interactions.push(a),this.sendAnalytics("event",a)}trackError(t,s,a={}){let e={type:t,message:s.message,stack:s.stack,context:a,timestamp:Date.now()};this.sessionData.errors.push(e),this.sendAnalytics("error",e)}async sendAnalytics(t,s){try{let a={clientId:this.config.clientId,sessionId:this.sessionData.sessionId,type:t,data:s,metadata:this.sessionData.metadata};await fetch(this.config.analyticsEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}catch(e){this.log("Analytics failed:",e)}}log(...t){this.config.debug&&console.log("[HeyGen Analytics]",...t)}}(s),t.addEventListener("beforeunload",()=>{t.heygenAnalytics&&t.heygenAnalytics.isSessionActive&&navigator.sendBeacon(s.analyticsEndpoint,JSON.stringify({type:"session_abandoned",sessionId:t.heygenAnalytics.sessionData.sessionId,clientId:s.clientId,duration:Date.now()-t.heygenAnalytics.sessionData.startTime}))}),t.HeyGenAnalytics={start:()=>t.heygenAnalytics.startSession(),speak:(s,a)=>t.heygenAnalytics.speak(s,a),end:()=>t.heygenAnalytics.endSession(),isActive:()=>t.heygenAnalytics.isSessionActive,getStats(){let s=t.heygenAnalytics;if(!s.isSessionActive)return null;let a=Date.now()-s.sessionData.startTime;return{sessionId:s.sessionData.sessionId,duration:Math.round(a/1e3),interactions:s.sessionData.interactions.filter(t=>"user_message"===t.type).length,errors:s.sessionData.errors.length,isActive:s.isSessionActive}}},console.log("\uD83E\uDD16 HeyGen Analytics SDK loaded. Use window.HeyGenAnalytics to interact with your avatar.")}(globalThis);